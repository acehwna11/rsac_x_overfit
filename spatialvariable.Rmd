---
title: Effects of eigenfunction-based spatial variables on the prediction and interpretation
  of species distribution modeling
author: "전청옥 서울대학교 지리학과"
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    highlight: haddock
    self_contained: yes
    gallery: yes
    number_sections: yes
    pandoc_args: --number-offset=0
    code_folding: show
    toc_depth: 4
    lightbox: yes
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
require(knitr); require(rmdformats); require("DT")

options(width="480"); options(max.print="75")
options(digits=3); options(scipen=1000)
options(DT.options = list(class="display compact nowrap hover",
                          rownames=FALSE));
options(encoding = 'EUC-KR')
knitr::opts_chunk$set(
   echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE,
   comment = ":)  ", collapse = FALSE, prompt = FALSE, tidy = FALSE,
   fig.align="center", fig.retina=2.5,
 aliases=c(h = 'fig.height', w = 'fig.width')
)

knitr::opts_knit$set(width=75)
```   

# WRANGLING

# CH.1 Get gbif data

```{r}
library(tidyverse)
library(readxl)
library(data.table)
```



```{r read target species list}
specieslist_mammal <- readxl::read_xlsx("species.xlsx", sheet = 1)
specieslist_reptile <- readxl::read_xlsx("species.xlsx", sheet = 2)
specieslist_amphibian <- readxl::read_xlsx("species.xlsx", sheet = 3)
specieslist_aves <- readxl::read_xlsx("species.xlsx", sheet = 4)
```


```{r mammal dataset}
#bind two mammal dataset
mammal.csv <- data.table::fread(file = "out/mammal/realout_mammal.csv")
reptile.csv. <- data.table::fread(file = "out/reptile/realout_reptile.csv")
amphibian.csv <- data.table::fread(file = "out/amphibian/realout_amphibian.csv")
mammal.csv <- data.table::fread(file = "out/mammal/realout_mammal.csv")

##coordinate NAs removal
mammal.csv <- filter(mammal.csv, complete.cases(mammal.csv$decimalLatitude))
reptile.csv <- filter(reptile.csv, complete.cases(reptile.csv$decimalLatitude))
amphibian.csv <- filter(amphibian.csv, complete.cases(amphibian.csv$decimalLatitude))

#decimal lower removal
decimalplaces <- function(x) {
  ifelse(abs(x - round(x)) > .Machine$double.eps^0.5,
         nchar(sub('^\\d+\\.', '', sub('0+$', '', as.character(x)))),
         0)
}

#filter long, lat lower than 3 decimal places
filter_longd3 <- function(x){filter(x, decimalplaces(decimalLongitude) >= 3)}
filter_lad3 <- function(x){filter(x, decimalplaces(decimalLatitude) >= 3)}

mammal.csv <- filter_longd3(mammal.csv)
mammal.csv <- filter_lad3(mammal.csv)

reptile.csv <- filter_longd3(reptile.csv)
reptile.csv <- filter_lad3(reptile.csv)

amphibian.csv <- filter_longd3(amphibian.csv)
amphibian.csv <- filter_lad3(amphibian.csv)

mammal.csv <- filter_longd3(mammal.csv)
mammal.csv <- filter_lad3(mammal.csv)

#add decimal palces column 
mutate_long <- function(x){mutate(x, decimalplaces_long = decimalplaces(decimalLongitude))}
mutate_lat <- function(x){mutate(x, decimalplaces_lat = decimalplaces(decimalLatitude))}

mammal.csv <- mutate_long(mammal.csv)
mammal.csv <- mutate_lat(mammal.csv)

reptile.csv <- mutate_long(reptile.csv)
reptile.csv <- mutate_lat(reptile.csv)

amphibian.csv <- mutate_long(amphibian.csv)
amphibian.csv <- mutate_lat(amphibian.csv)

#find duplicated points
unique.longlat <- function(x){dplyr::distinct(x, decimalLongitude, decimalLatitude, .keep_all = T)}

mammal.csv <- unique.longlat(mammal.csv)
reptile.csv <- unique.longlat(reptile.csv)
amphibian.csv <- unique.longlat(amphibian.csv)

#1st wrangling score
ggplot(mammal.csv, aes(x = species)) +
  geom_bar(stat = "count")+ 
  theme(axis.text.x=element_text(angle=45, hjust=1))
  
ggplot(reptile.csv, aes(x = species)) +
  geom_bar(stat = "count")+ 
  theme(axis.text.x=element_text(angle=45, hjust=1))

#save to list.


dt.mammal <- list()
for (i in 1:nrow(specieslist_mammal[,1])){
 dt.mammal[[i]] <- filter(mammal.csv, species == specieslist_mammal[[1]][i])
}

dt.reptile <- list()
for (i in 1:nrow(specieslist_reptile[,1])){
 dt.reptile[[i]] <- filter(reptile.csv, species == specieslist_reptile[[1]][i])
}

dt.amphibian <- list()
for (i in 1:nrow(specieslist_amphibian[,1])){
 dt.amphibian[[i]] <- filter(amphibian.csv, species == specieslist_amphibian[[1]][i])
}
```

> group_by(mammal.csv, species)
# A tibble: 984,384 x 52
# Groups:   species [35]

mammal은 35종류로 나눠 떨어지지만

> group_by(reptile.csv, species)
# A tibble: 787,244 x 52
# Groups:   species [106]

파충류는 애초에 96종을 요청했음에도 종이 106종이다. 아종이 분리된 것이다.
이들을 묶어야한다.

원인은 Ameiva ameiva였다. 

```{r}
reptile.csv %>% 
  group_by(species) %>%
  summarise(n = length(species))
```
다 더해도 얼마 안되므로(601) 묶기 귀찮으니 그냥 다 버린다.


map_int(dt.mammal, nrow)
[1]   3807   5517 108791   1643  12515 116916   4316  76928   6348   2376  31175  27682
[13]   4779  13967   8347    941  14988   3670  53991   9536  24653  92944  34289  31080
[25]  16946   3751   2664   7028   3084  41293  25914  33268  43682   7778 107777
```{r}
specieslist_mammal[16,1]
```
박쥐라서 중복 위치가 많았나보다. 조금 부족하지만 넘어간다.

map_int(dt.reptile, nrow)
[1]  6669 12821   108 23189 23335  1793 22379  4341  5187 10406  2785  5821  9006 16858
[15]  2942 21560     0  7326  5486  8903  9851  4744  5877  3296  2261  2261  4718  9328
[29]  1813  3283 10400   685  2015  1814  4511   163  3909  6618  3938  8696  3053  8894
[43]  3338  1833  9973  9654 12511  5102  8299  1983  1624  1613  2118  1933 13672  4554
[57]  9970 16386  5037 12509  7216  4268   547 19513  5406   673 19646  3999 15467  3222
[71]  7607  4441 39003  7222  5171   196  2506  9442  7113  1068 15816  2955  8097  6240
[85] 30793  7767 16408  3048 36902 21514  4356 10760  2363 14640  2277 24127
```{r}

specieslist_reptile[c(3,17,32,36,76),1]
```
백 단위가 몇종 보이긴 하지만 넘어간다. Cnemidophorus exsanguis가 0개다. 

```{r}
reptile.csv %>% 
  filter(taxonKey == 5227545)
```
Aspidoscelis exsanguis란다.. 
넣어주자..remove Ameiva too

```{r}
dt.reptile[[17]] <- reptile.csv %>% 
  filter(taxonKey == 5227545)

dt.reptile[[3]] <- NULL
```

map_int(dt.mammal, nrow)

 [1]   2009   3817 108759   1577  11105 116715   4269  76878   6348   2023  31150  27682
[13]   3643  12450   6676    860  14965   3276  50943   9536  24118  92891  34159  31080
[25]  16946   3690   2344   7025   3081  40339  25012  33204  43682   6629 106409

map_int(dt.reptile, nrow)

[1]  6669 12821 23189 23335  1793 22379  4341  5187 10406  2785  5821  9006 16858  2942
[15] 21560   350  7326  5486  8903  9851  4744  5877  3296  2261  2261  4718  9328  1813
[29]  3283 10400   685  2015  1814  4511   163  3909  6618  3938  8696  3053  8894  3338
[43]  1833  9973  9654 12511  5102  8299  1983  1624  1613  2118  1933 13672  4554  9970
[57] 16386  5037 12509  7216  4268   547 19513  5406   673 19646  3999 15467  3222  7607
[71]  4441 39003  7222  5171   196  2506  9442  7113  1068 15816  2955  8097  6240 30793
[85]  7767 16408  3048 36902 21514  4356 10760  2363 14640  2277 24127

이제 양서류를 해보자

map_int(dt.amphibian, nrow)
 [1]  3650  5869  2307  2440 26501  6934  3156  1998 46021 41418  2901  1672  1521   704  7879
[16]  3451  2725  3327  2564  8792  5121  1453 14405  7362 23759 28652 23035     0 10082 13624
[31]   456 12899  5778 10270 15027  3407   676   512  1688  8769  7528  2267 55643 16139 12288
[46]  1855  4162  5433 29245  1464

28번째 양서류 종이 0개가 나왔다. 
```{r}
specieslist_amphibian[28,1]
```

내가 요청했던건 리토리아 였고

```{r}
amphibian.csv %>% 
  group_by(species) %>%
  summarise(n = length(species))
```

받아온 자료에는 43번째에 Ranoidea aurea로 되어있었다. 종명이 개정된듯하다.
요청종 엑셀 목록을 수정한다.



24, 25번 종의 수가 겹친다. 엑셀에서 중복 열이 두개 있어서 그랬다.
같은 종이 두번 필터된 것이다. 하나를 제거한다.

포유류 35종, 파충류 94종. 양서류 50종. 503950
2,273,256개.

```{r}
#save to sp
library(sp)

sp.wgs84 <- function(x){
    SpatialPointsDataFrame(coords = x[,22:23], 
                  proj4string=CRS("+proj=longlat +datum=WGS84"), 
                  data = x[,1:52])
  }

sp_mammal <- list()
for (i in 1:length(dt.mammal)){
  sp_mammal[[i]] <- sp.wgs84(dt.mammal[[i]])
} 

sp_reptile <- list()
for (i in 1:length(dt.reptile)){
  sp_reptile[[i]] <- sp.wgs84(dt.reptile[[i]])
} 

sp_amphibian <- list()
for (i in 1:length(dt.amphibian)){
  sp_amphibian[[i]] <- sp.wgs84(dt.amphibian[[i]])
} 

#save to sf
library(sf)

sf_df <- function(x){sf::st_as_sf(x, 
                                  coords = c("decimalLongitude", "decimalLatitude"), 
                                  crs = 4326,
                                  remove = F)
}

sf_mammal <- map(dt.mammal, sf_df)
sf_reptile <- map(dt.reptile, sf_df)
sf_amphibian <- map(dt.amphibian, sf_df)

##cut geographical outliers - QGIS cut

sf_mammal.q<- list()
for (i in 1:length(sf_mammal)){
sf_mammal.q[[i]] <- sf_mammal[[i]][,53]
}

sf_reptile.q <- list()
for (i in 1:length(sf_reptile)){
sf_reptile.q[[i]] <- sf_reptile[[i]][,53]
}

sf_amphibian.q<- list()
for (i in 1:length(sf_amphibian)){
sf_amphibian.q[[i]] <- sf_amphibian[[i]][,53]
}

for (i in 1:length(sf_mammal)){
sf::write_sf(sf_mammal.q[[i]], paste0("shp/sf_mammal/",sf_mammal[[i]]$species[1],".shp"))
}

for (i in 1:length(sf_reptile.q)){
sf::write_sf(sf_reptile.q[[i]], paste0("shp/sf_reptile/",sf_reptile[[i]]$species[1],".shp"))
}

for (i in 1:length(sf_amphibian)){
sf::write_sf(sf_amphibian.q[[i]], paste0("shp/sf_amphibian/",sf_amphibian[[i]]$species[1],".shp"))
}

sf_mammal.q <- list()
for (i in 1:35){
sf_mammal.q[[i]] <- sf::st_read(dsn = paste0("shp/sf_mammal/",sf_mammal[[i]]$species[1],".shp"))
}

sf_reptile.q <- list()
for (i in 1:length(sf_reptile)){
sf_reptile.q[[i]] <- sf::st_read(dsn = paste0("shp/sf_reptile/",sf_reptile[[i]]$species[1],".shp"))
}

sf_amphibian.q <- list()
for (i in 1:length(sf_amphibian)){
sf_amphibian.q[[i]] <- sf::st_read(dsn = paste0("shp/sf_amphibian/",sf_amphibian[[i]]$species[1],".shp"))
}

# How much % points we cutted
( unlist(map(sf_mammal, nrow)) - unlist(map(sf_mammal.q, nrow)) ) / map_int(sf_mammal, nrow) *100
( unlist(map(sf_reptile, nrow)) - unlist(map(sf_reptile.q, nrow)) ) / map_int(sf_reptile, nrow) *100
( unlist(map(sf_amphibian, nrow)) - unlist(map(sf_amphibian.q, nrow)) ) / map_int(sf_amphibian, nrow) *100

# confirm ? to use sf_species.q ????
# Y? N?

```

```{r confirm}
sf_mammal <- sf_mammal.q
rm(sf_mammal.q)
rm(sf_mammal.)

sp_mammal <- map(sf_mammal.q, as_Spatial)

sf_reptile <- sf_reptile.q
rm(sf_reptile.q)
rm(sf_reptile.)

sp_reptile <- map(sf_reptile.q, as_Spatial)

sp_amphibian <- map(sf_amphibian.q, as_Spatial)



```

removed list from sf_reptile
17 Cnemidophorus exsanguis has zero record.
32 Emoia caeruleocauda 677
36 Gekko japonicus 162
63 Phyllodactylus tuberculosus 545 
66 Podarcis hispanicus 673
76 Sphaerodactylus macrolepis 196 

total 90 reptile species passed wrangling.




# CH.n Load bio-climate data
```{r bring data : bio climate}
library(raster)

biopath <- paste0("bios/", list.files(pattern="*.tif", path = "bios/"))
stackbio <- raster::stack(biopath)
bio1 <- raster::stack(biopath[1])
```



```{r data munging : random points for background}
library(dismo)

random_bg1x <- function(x,y){randomPoints(stackbio, n = length(x), p = x, ext = y, excludep = TRUE)}

# r is a raster, n is the number of points requested
fastRandomPoints <- function(r, n) {
  if(raster::nlayers(r) > 1) r <- r[[1]]
  v <- raster::getValues(r)
  v.notNA <- which(!is.na(v))
  x <- sample(v.notNA, n)
  pts <- raster::xyFromCell(r, x)
  return(pts)
}

bbox_mammal <- list()
for (i in 1:length(sf_mammal)){
  bbox_mammal[[i]] <- sf::st_bbox(sf_mammal.q[[i]])}

bbox_reptile <- list()
for (i in 1:length(sf_reptile)){
  bbox_reptile[[i]] <- sf::st_bbox(sf_reptile.q[[i]])}

bbox_amphibian <- list()
for (i in 1:length(sf_amphibian)){
  bbox_amphibian[[i]] <- sf::st_bbox(sf_amphibian.q[[i]])}

bbox_aves <- list()
for (i in 1:length(sf_aves)){
  bbox_aves[[i]] <- sf::st_bbox(sf_aves.q[[i]])}


library(furrr)
plan(multisession, workers = 50)
furrr::future_map2(a, b, random_bg1x, .progress = T)

a <- list()
a[[1]] <- sp_mammal[[1]]
b <- list()
b[[1]] <- bbox_mammal[[1]]

bg1x_mammal <- furrr::future_map2(sp_mammal, bbox_mammal, random_bg1x, .options = furrr_options(seed = TRUE))


bg1x_reptile <- furrr::future_map2(sp_reptile, bbox_reptile, random_bg1x, .options = furrr_options(seed = TRUE), .progress = T)

bg1x_amphibian <- furrr::future_map2(sp_amphibian, bbox_amphibian, random_bg1x, .options = furrr_options(seed = TRUE), .progress = T)


bg2x_amphibian <- furrr::future_map2(list_spatial_amphibian, bbox_amphibian, random_bg2x)
bg2x_aves <- furrr::future_map2(list_spatial_aves, bbox_aves, random_bg2x)
bg2x_mammal_pilot <- furrr::future_map2(sp_mammal_pilot, bbox_mammal_pilot, random_bg2x)

sf_bg <- function(x){sf::st_as_sf(x, coords = c("x", "y"), crs = 4326)}

bg1x_mammal. <- map(map(bg1x_mammal, as.data.frame), sf_bg)
bg1x_reptile. <- map(map(bg1x_reptile, as.data.frame), sf_bg)
bg1x_amphibian. <- map(map(bg1x_amphibian, as.data.frame), sf_bg)

for (i in 1:length(bg1x_mammal.)){
sf::write_sf(bg1x_mammal.[[i]], paste0("shp/sf_mammal/bg1x_mammal/bg1x_",sf_mammal[[i]]$species[1],".shp"))
}

for (i in 1:length(bg1x_reptile.)){
sf::write_sf(bg1x_reptile.[[i]], paste0("shp/sf_reptile/bg1x_reptile/bg1x_",sf_reptile[[i]]$species[1],".shp"))
}

for (i in 1:length(bg1x_amphibian.)){
sf::write_sf(bg1x_amphibian.[[i]], paste0("shp/sf_amphibian/bg1x_amphibian/bg1x_",sf_amphibian[[i]]$species[1],".shp"))
}



bg1x_reptile. <- map(map(bg1x_reptile, as.data.frame), sf_bg)

for (i in 1:length(bg1x_reptile.)){
sf::write_sf(bg1x_reptile.[[i]], paste0("shp/",i,".shp"))
}


```

```{r}
cores <- parallel::detectCores() - 1
cluster <- parallel::makeCluster(spec = cores)
doParallel::registerDoParallel(cl = cluster)

tic()
bg2x_mammal <- list()
foreach (i = 1:length(list_spatial_mammal), .packages='dismo') %dopar% {
  bg2x_mammal[[i]] <- random_bg2x(list_spatial_mammal[[i]], bbox_mammal[[i]])}
toc()

bg2x.pilot.df <- as.data.frame(bg2x_mammal_pilot[[1]])
bg2x.pilot.sf <- sf::st_as_sf(bg2x.pilot.df, coords = c("x", "y"), crs = 4326)
test2 <- sf_mammal[[1]]["geometry"]

sf::write_sf(bg2x.pilot.sf, "test.shp")
```



```{r d}
sf_bg <- function(x){sf::st_as_sf(x, coords = c("long", "lat"), crs = 4326)}
bg1x_mammal <- map(map(bg2x_mammal, as.data.frame), sf_bg)
bg1x_reptile <- map(map(bg2x_reptile, as.data.frame), sf_bg)
bg1x_amphibian <- map(map(bg2x_amphibian, as.data.frame), sf_bg)

for (i in 1:length(sf_mammal)){
  sf::write_sf(bg1x_mammal[[i]], paste0(sf_mammal[[i]]$species[1],"bg1x.shp"))
}

for (i in 1:length(sf_reptile)){
  sf::write_sf(bg1x_reptile[[i]], paste0(sf_reptile[[i]]$species[1],"_bg1x.shp"))
}

for (i in 1:length(sf_amphibian)){
  sf::write_sf(bg1x_amphibian[[i]], paste0(sf_amphibian[[i]]$species[1],"_bg1x.shp"))
}

# write shp
sfbg_amphibian <- map(map(sf_amphibian, as.data.frame), sf_bg)
for (i in 1:length(sfbg_amphibian)){
  sfbg_amphibian[[i]] <- sfbg_amphibian[[i]][,82] 
}

for (i in 1:length(sf_amphibian)){
  sf::write_sf(sfbg_amphibian[[i]], paste0(sf_amphibian[[i]]$species[1],"_sfd.shp"))
}


for (i in 1:length(sf_reptile)){
  sf::write_sf(sfbg_reptile[[i]], paste0("sf_reptile/shp/",sf_reptile[[i]]$species[1],"._sfd.shp"))
}

sfbg_reptile <- map(map(sf_reptile, as.data.frame), sf_bg)
for (i in 1:length(sfbg_reptile)){
  sfbg_reptile[[i]] <- sfbg_reptile[[i]][,82] 
}


```



# SDMtune:: 

멋진 건 줄 알고 비볐는데 진짜 원시적인 프로그램이다. ^^ 
데이터 세팅을 저장할수도 없고 다시 입력할수도 없다.

오로지 xy 좌표랑 래스터 스택만 가져오면 된다.


```{r}
bg1x_mammal <- paste0("C:/Users/lophital/Documents/rsac_x_overfit/shp/sf_mammal/bg1x_mammal/", list.files(pattern="*.shp", path = "C:/Users/lophital/Documents/rsac_x_overfit/shp/sf_mammal/bg1x_mammal"))

bg1x_reptile <- paste0("C:/Users/lophital/Documents/rsac_x_overfit/shp/sf_reptile/bg1x_reptile/", list.files(pattern="*.shp", path = "C:/Users/lophital/Documents/rsac_x_overfit/shp/sf_reptile/bg1x_reptile"))

bg1x_amphibian <- paste0("C:/Users/lophital/Documents/rsac_x_overfit/shp/sf_amphibian/bg1x_amphibian/", list.files(pattern="*.shp", path = "C:/Users/lophital/Documents/rsac_x_overfit/shp/sf_amphibian/bg1x_amphibian"))

bg1x_mammal <- map(bg1x_mammal, sf::st_read)
bg1x_reptile <- map(bg1x_reptile, sf::st_read)
bg1x_amphibian <- map(bg1x_amphibian, sf::st_read)  

for (i in 1:length(bg1x_mammal)){bg1x_mammal[[i]] <- sf::st_coordinates(bg1x_mammal[[i]])}
for (i in 1:length(bg1x_reptile)){bg1x_reptile[[i]] <- sf::st_coordinates(bg1x_reptile[[i]])}
for (i in 1:length(bg1x_amphibian)){bg1x_amphibian[[i]] <- sf::st_coordinates(bg1x_amphibian[[i]])}

```

```{r}
sfd_mammal <- list()
for (i in 1:length(sf_mammal.q)){
sfd_mammal[[i]] <- data.frame(st_coordinates(sf_mammal.q[[i]])) %>%
  mutate(species = sf_mammal[[i]][[10]][1])
}

sfd_reptile <- list()
for (i in 1:length(sf_reptile.q)){
sfd_reptile[[i]] <- data.frame(st_coordinates(sf_reptile.q[[i]])) %>%
  mutate(species = sf_reptile[[i]][[10]][1])
}


sfd_amphibian <- list()
for (i in 1:length(sf_amphibian.q)){
sfd_amphibian[[i]] <- data.frame(st_coordinates(sf_amphibian.q[[i]])) %>%
  mutate(species = specieslist_amphibian[[1]][i])
}

```







```{r model data : prepareSWD}

data.mammal_pilot <- list()
for (i in 1:length(sf_mammal_pilot)){data.mammal_pilot[[i]] <- SDMtune::prepareSWD(
  species = sf_mammal_pilot[[i]]$species[1], 
  p = sfd_mammal_pilot[[i]][,83:84], 
  a = bg2x_mammal_pilot[[i]], 
  env = stackbio)}

data.mammal <- list()
for (i in 1:length(sf_mammal)){data.mammal[[i]] <- SDMtune::prepareSWD(
  species = sf_mammal[[i]]$species[1], 
  p = sfd_mammal[[i]][,83:84], 
  a = bg1x_mammal[[i]], 
  env = stackbio)}

swdmaker <- function(x,y){SDMtune::prepareSWD(
  species = x$species[1], 
  p = x[,1:2], 
  a = y, 
  env = stackbio)}





data.mammal <- furrr::future_map2(sfd_mammal, bg1x_mammal, swdmaker, .options = furrr_options(seed = TRUE), .progress = T)
data.reptile <- furrr::future_map2(sfd_reptile, bg1x_reptile, swdmaker, .options = furrr_options(seed = TRUE), .progress = T)
data.amphibian <- furrr::future_map2(sfd_amphibian, bg1x_amphibian, swdmaker)


data.reptile <- list()
for (i in 1:length(sf_reptile)){data.reptile[[i]] <- SDMtune::prepareSWD(
  species = sf_reptile[[i]]$species[1], 
  p = sfd_reptile[[i]][,83:84], 
  a = bg1x_reptile[[i]], 
  env = stackbio)}

data.amphibian <- list()
for (i in 1:length(sf_amphibian.q)){data.amphibian[[i]] <- SDMtune::prepareSWD(
  species = sf_amphibian[[i]]$species[1], 
  p = sfd_amphibian[[i]][,83:84], 
  a = bg1x_amphibian[[i]], 
  env = stackbio)}



swd2csv(data, file_name = "data.csv")
```

# CH.n Save all data into rdata
```{r}

save(list_spatial_amphibian, file = "E:/sdmtune/rdata/list_spatial_amphibian.rdata")

save(list_xy)

save(sfd_mammal, file = "E:/sdmtune/rdata/sfd_mammal.rdata")
save(sfd_reptile, file = "E:/sdmtune/rdata/sfd_reptile.rdata")
save(sfd_amphibian, file = "E:/sdmtune/rdata/sfd_amphibian.rdata")


save(specieslist_mammal, file = "E:/sdmtune/rdata/specieslist_mammal.rdata")
save(specieslist_reptile, file = "E:/sdmtune/rdata/specieslist_reptile.rdata")
save(specieslist_amphibian, file = "E:/sdmtune/rdata/specieslist_amphibian.rdata")
save(specieslist_aves, file = "E:/sdmtune/rdata/specieslist_aves.rdata")

save(stackbio, file = "E:/sdmtune/rdata/stackbio.rdata")

save(t.t.mammal_0.2, file = "E:/sdmtune/rdata/t.t.mammal_0.2.rdata")
```

```{r}
save(bg1x_mammal, file = "E:/sdmtune/rdata/bg1x_mammal.rdata")
save(bg1x_reptile, file = "E:/sdmtune/rdata/bg1x_reptile.rdata")
save(bg1x_amphibian, file = "E:/sdmtune/rdata/bg1x_amphibian.rdata")

save(bbox_mammal, file = "E:/sdmtune/rdata/bbox_mammal.rdata")
save(bbox_reptile, file = "E:/sdmtune/rdata/bbox_reptile.rdata")
save(bbox_amphibian, file = "E:/sdmtune/rdata/bbox_amphibian.rdata")
save(bbox_aves, file = "E:/sdmtune/rdata/bbox_aves.rdata")

save(data_frame_mammal, file = "E:/sdmtune/rdata/data_frane_mammal.rdata")
save(data_frame_reptile, file = "E:/sdmtune/rdata/data_frame_reptile.rdata")
save(data_frame_amphibian, file = "E:/sdmtune/rdata/data_frame_amphibian.rdata")
save(data_frame_aves, file = "E:/sdmtune/rdata/data_frame_aves.rdata")


save(data.mammal, file = "E:/sdmtune/rdata/data.mammal.rdata")
save(data.reptile, file = "E:/sdmtune/rdata/data.reptile.rdata")
save(data.amphibian, file = "E:/sdmtune/rdata/data.amphibian.rdata")

save(list_longlat_mammal, file = "E:/sdmtune/rdata/list_longlat_mammal.rdata")
save(list_longlat_reptile, file = "E:/sdmtune/rdata/list_longlat_reptile.rdata")
save(list_longlat_amphibian, file = "E:/sdmtune/rdata/list_longlat_amphibian.rdata")
save(list_longlat_aves, file = "E:/sdmtune/rdata/list_longlat_aves.rdata")

save(list_spatial_mammal, file = "E:/sdmtune/rdata/list_spatial_mammal.rdata")
save(list_spatial_reptile, file = "E:/sdmtune/rdata/list_spatial_reptile.rdata")
save(list_spatial_amphibian, file = "E:/sdmtune/rdata/list_spatial_amphibian.rdata")
save(list_spatial_aves, file = "E:/sdmtune/rdata/list_spatial_aves.rdata")

save(list_xy_mammal, file = "E:/sdmtune/rdata/list_xy_mammal.rdata")
save(list_xy_reptile, file = "E:/sdmtune/rdata/list_xy_reptile.rdata")
save(list_xy_amphibian, file = "E:/sdmtune/rdata/list_xy_amphibian.rdata")
save(list_xy_aves, file = "E:/sdmtune/rdata/list_xy_aves.rdata")

save(sf_mammal, file = "E:/sdmtune/rdata/list_xy_mammal.rdata")
save(sf_reptile, file = "E:/sdmtune/rdata/list_xy_reptile.rdata")
save(sf_amphibian, file = "E:/sdmtune/rdata/list_xy_amphibian.rdata")
save(sf_aves, file = "E:/sdmtune/rdata/list_xy_aves.rdata")

save(sfd_mammal, file = "E:/sdmtune/rdata/list_xy_mammal.rdata")
save(sfd_reptile, file = "E:/sdmtune/rdata/list_xy_reptile.rdata")
save(sfd_amphibian, file = "E:/sdmtune/rdata/list_xy_amphibian.rdata")
save(sfd_aves, file = "E:/sdmtune/rdata/list_xy_aves.rdata")

save(specieslist_mammal, file = "E:/sdmtune/rdata/list_xy_mammal.rdata")
save(specieslist_reptile, file = "E:/sdmtune/rdata/list_xy_reptile.rdata")
save(specieslist_amphibian, file = "E:/sdmtune/rdata/list_xy_amphibian.rdata")
save(specieslist_aves, file = "E:/sdmtune/rdata/list_xy_aves.rdata")

save(stackbio, file = "E:/sdmtune/rdata/stackbio.rdata")

save(t.t.mammal_0.2, file = "E:/sdmtune/rdata/t.t.mammal_0.2.rdata")
```


```{r}
library(sf)
library(readr)
library(dplyr)
library(purrr)

data.mammal <- read_rds("data/data.mammal.rds")
data.reptile <- read_rds("data/data.reptile.rds")
data.amphibian <- read_rds("data/data.amphibian.rds")

name.mammal <- vector()
for(i in 1:length(data.mammal)){
 name.mammal[i] <- data.mammal[[i]]@species
}
name.reptile <- vector()
for(i in 1:length(data.reptile)){
 name.reptile[i] <- data.reptile[[i]]@species
}
name.amphibian <- vector()
for(i in 1:length(data.amphibian)){
 name.amphibian[i] <- data.amphibian[[i]]@species
}



ANURA <- sf::st_read(dsn = "IUCN_range/ANURA.shp")
CAUDATA <- sf::st_read(dsn = "IUCN_range/CAUDATA.shp")
CHAMELEONS <- sf::st_read(dsn = "IUCN_range/CHAMELEONS.shp")
CROCODILES_ALLIGATORS <- sf::st_read(dsn = "IUCN_range/CROCODILES_ALLIGATORS.shp")
GYMNOPHIONA <- sf::st_read(dsn = "IUCN_range/GYMNOPHIONA.shp")
MAMMALS_TERRESTRIAL <- sf::st_read(dsn = "IUCN_range/MAMMALS_TERRESTRIAL_ONLY.shp")
REPTILES <- sf::st_read(dsn = "IUCN_range/REPTILES.shp")


range.ANURA <- list()
for(i in 1:length(name.amphibian)){
range.ANURA[[i]] <- ANURA %>% dplyr::filter(binomial == name.amphibian[i])
}

range.CAUDATA <- list()
for(i in 1:length(name.amphibian)){
range.CAUDATA[[i]] <- CAUDATA %>% dplyr::filter(binomial == name.amphibian[i])
}

range.CHAMELONES <- list()
for(i in 1:length(name.reptile)){
range.CHAMELONES[[i]] <- CHAMELEONS %>% dplyr::filter(binomial == name.reptile[i])
}

range.CROCODILES_ALLIGATORS <- list()
for(i in 1:length(name.reptile)){
range.CROCODILES_ALLIGATORS[[i]] <- CROCODILES_ALLIGATORS %>% dplyr::filter(binomial == name.reptile[i])
}

range.GYMNOPHIONA <- list()
for(i in 1:length(name.amphibian)){
range.GYMNOPHIONA[[i]] <- GYMNOPHIONA %>% dplyr::filter(binomial == name.amphibian[i])
}

range.MAMMALS_TERRESTRIAL <- list()
for(i in 1:length(name.mammal)){
range.MAMMALS_TERRESTRIAL[[i]] <- MAMMALS_TERRESTRIAL %>% dplyr::filter(binomial == name.mammal[i])
}

range.REPTILES <- list()
for(i in 1:length(name.reptile)){
range.REPTILES[[i]] <- REPTILES %>% dplyr::filter(binomial == name.reptile[i])
}

map_int(range.ANURA, nrow)
map_int(range.CAUDATA, nrow)
map_int(range.GYMNOPHIONA, nrow)

map_int(range.CHAMELONES, nrow)
map_int(range.CROCODILES_ALLIGATORS, nrow)
map_int(range.REPTILES, nrow)

map_int(range.MAMMALS_TERRESTRIAL, nrow)

range.amphibian.check <- data.frame(ANURA = map_int(range.ANURA, nrow),
                              CAUDATA = map_int(range.CAUDATA, nrow),
                              GYMNOPHIONA = map_int(range.GYMNOPHIONA, nrow))

range.reptile.check <- data.frame(CHAMELONES = map_int(range.CHAMELONES, nrow),
                              CROCODILES_ALLIGATORS = map_int(range.CROCODILES_ALLIGATORS, nrow),
                              REPTILES = map_int(range.REPTILES, nrow))
r#all overlap. same thing. 
range.reptile <- range.REPTILES

#match. append
range.amphibian <- range.ANURA

for(i in which(range.amphibian.check$ANURA == 0)){
  range.amphibian[[i]] <- range.CAUDATA[[i]]
}

map_dbl(range.amphibian, nrow)

#ONLY 43. species dont have range

for(i in 1:length(data.mammal)){
sf::write_sf(range.MAMMALS_TERRESTRIAL[[i]], paste0("shp/range/range_",name.mammal[i],".shp"))
}

for(i in 1:length(data.reptile)){
sf::write_sf(range.reptile[[i]], paste0("shp/range_reptile/range_",name.reptile[i],".shp"))
}

for(i in 1:length(data.amphibian)){
sf::write_sf(range.amphibian[[i]], paste0("shp/range_amphibian/range_",name.amphibian[i],".shp"))
}

```

```{r}
which(map_dbl(range.MAMMALS_TERRESTRIAL, nrow) == 0) # 20

which(map_dbl(range.reptile, nrow) == 0) #  3  5  7 11 13 15 17 30 32 35 48 52 55 56 68 75 79 87 92
which(map_dbl(range.amphibian, nrow) == 0) # 43
```

```{r combine features}

range.mammal <- list()
for(i in 1:length(range.MAMMALS_TERRESTRIAL)){
  range.mammal[[i]] <- st_combine(range.MAMMALS_TERRESTRIAL[[i]])
}

for(i in 1:length(range.reptile)){
  range.reptile[[i]] <- st_combine(range.reptile[[i]])
}

for(i in 1:length(range.amphibian)){
  range.amphibian[[i]] <- st_combine(range.amphibian[[i]])
}



```
write range polygon that is combined, at range.mix_taxa
```{r}
for(i in 1:length(data.mammal)){
sf::write_sf(range.mammal[[i]], paste0("shp/range.mix_mammal/range_",name.mammal[i],".shp"))
}

for(i in 1:length(data.reptile)){
sf::write_sf(range.reptile[[i]], paste0("shp/range_reptile/range_",name.reptile[i],".shp"))
}

for(i in 1:length(data.amphibian)){
sf::write_sf(range.amphibian[[i]], paste0("shp/range_amphibian/range_",name.amphibian[i],".shp"))
}

```


```{r}
my.bg10k <- function(x){st_sample(x, size = 10000, 
                                  type = "random", 
                                  exact = T, 
                                  by_polygon = F 
                                  )}

my.bg30k <- function(x){st_sample(x, size = 30000, 
                                  type = "random", 
                                  exact = T, 
                                  by_polygon = F 
                                  )}

my.bg100k <- function(x){st_sample(x, size = 100000, 
                                  type = "random", 
                                  exact = T, 
                                  by_polygon = F 
)}



cropbio.path_reptile <- list.files(path = "D:/bio_crop/reptile")
cropbio_reptile <- list()
for(i in 1:length(cropbio.path_reptile)){
cropbio_reptile[[i]] <- raster::stack(paste0("D:/bio_crop/reptile/",cropbio.path_reptile[i]))}

my.random_bg30k <- function(x,y){randomPoints(stackbio, n = length(x), p = x, ext = y, excludep = TRUE)}



bg10k_mammal <- list()
for(i in 21:length(range.mammal)){
  bg10k_mammal[[i]] <- my.bg10k(range.mammal[[i]])}

#14 mustela got error so done in QGIS
#35 vulpes got error so done in QGIS
#20 dont have IUCN range
#Import 14 QGIS bg10k

bg10k_mammal[[14]] <- sf::st_read("shp/sf_mammal/bg10k_mammal/m14_mustela.shp")
bg10k_mammal[[35]] <- sf::st_read("shp/sf_mammal/bg10k_mammal/m35_vulpes.shp")
bg10k_mammal[[20]] <- sf::st_read("shp/sf_mammal/bg10k_mammal/m20_Ornithorhynchus.shp")

#convert to sf to extract from raster
for(i in 21:35){
  bg10k_mammal[[i]] <- sf::st_sf(bg10k_mammal[[i]])
}

```

20 have no IUCN list, using MCP
```{r}
library(adehabitatHR)

my.pseperate <- function(x){dplyr::bind_cols(dplyr::slice(x@coords, 1:which(x@pa==0)[1]-1),
                                             dplyr::slice(x@data, 1:which(x@pa==0)[1]-1))}

p.data.mammal <- map(data.mammal, my.pseperate)
p.data.reptile <- map(data.reptile, my.pseperate)
p.data.amphibian <- map(data.amphibian, my.pseperate)

sf_df <- function(x){sf::st_as_sf(x, 
                                  coords = c("X", "Y"), 
                                  crs = 4326,
                                  remove = F)
}

sf_p_mammal <- map(p.data.mammal, sf_df)
sp_p_mammal <- map(sf_p_mammal, as_Spatial)

sf_p_reptile <- map(p.data.reptile, sf_df)
sp_p_reptile <- map(sf_p_reptile, as_Spatial)

sf_p_amphibian <- map(p.data.amphibian, sf_df)
sp_p_amphibian <- map(sf_p_amphibian, as_Spatial)

mcp_20 <- mcp(sp_p_mammal[[20]])
sf_mcp_20 <- sf::st_as_sf(mcp_20)
range.mammal[[20]] <- sf_mcp_20
bg10k_mammal[[20]] <- my.bg10k(range.mammal[[20]])
bg10k_mammal[[20]] <- sf::st_sf(bg10k_mammal[[20]])

rgdal::writeOGR(mcp_20, "mcp_20.13k.shp", driver = "ESRI Shapefile", layer = "mcp_20.13k")


sp_bg10k_mammal <- map(bg10k_mammal, as_Spatial)
```



```{r}
my.extract <- function(x){raster::extract(stackbio, x)}

bg10k_mammal.bio <- future_map(sp_bg10k_mammal, my.extract)


```

```{r}
my.nacheck <- function(x){sum(is.na(x[,1]))}

map_dbl(bg10k_mammal.bio, my.nacheck)
map_dbl(bg10k_amphibian.bio, my.nacheck)
```
```{r}
for (i in 1:length(bg10k_mammal)){
sf::write_sf(bg10k_mammal[[i]], paste0("shp/sf_mammal/bg10k_mammal/",data.mammal[[i]]@species,".shp"))
}
```


reptile no range in 3  5  7 11 13 15 17 30 32 35 48 52 55 56 68 75 79 87 92
make range for them with MCP
```{r}
for(i in c(3, 5, 7, 11, 13, 15, 17, 30, 32, 35, 48, 52, 55, 56, 68, 75, 79, 87, 92)){
  range.reptile[[i]] <- sf::st_as_sfc(mcp(sp_p_reptile[[i]]))
}

range.amphibian[[43]] <- sf::st_as_sfc(mcp(sp_p_amphibian[[43]]))

```


```{r}
bg10k_reptile <- list()
for(i in 37:length(range.reptile)){
  bg10k_reptile[[i]] <- my.bg10k(range.reptile[[i]])}

bg30k_reptile <- list()
for(i in 1:length(range.reptile)){
  bg30k_reptile[[i]] <- my.bg30k(range.reptile[[i]])}

bg100k_reptile <- furrr::future_map(range.reptile, my.bg30k, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)


#12 is SEA TURTLE
#36 got error so done in QGIS
bg10k_reptile[[36]] <- sf::st_read("shp/sf_reptile/bg10k_reptile/bg10k_hemidactylus frenatus.shp")

#conver sf to extract
for(i in 13:94){
  bg10k_reptile[[i]] <- sf::st_sf(bg10k_reptile[[i]])
}

# - 12
bg10k_reptile[[12]] <- NULL

sp_bg10k_reptile <- map(bg10k_reptile, as_Spatial)

bg10k_reptile.bio <- future_map(sp_bg10k_reptile, my.extract)
```

```{r}
bg10k_amphibian <- furrr::future_map(range.amphibian, my.bg10k, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

sp_bg10k_amphibian <- map(bg10k_amphibian, as_Spatial)

bg10k_amphibian.bio <- furrr::future_map(sp_bg10k_amphibian, my.extract)
```


```{r}
map_dbl(bg10k_reptile.bio, my.nacheck)
```

```{r}

cropbio.path_mammal <- list.files(path = "D:/bio_crop/mammal")
cropbio_mammal <- list()
for(i in 1:length(cropbio.path_mammal)){
cropbio_mammal[[i]] <- raster::stack(paste0("D:/bio_crop/mammal/",cropbio.path_mammal[i]))}

cropbiodf.path <- vector()
for(i in 1:35){
cropbiodf.path[i] <- paste0("D:/bio_crop/mammal/",data.mammal[[i]]@species,".csv")
}

for(i in 1:length(cropbio_mammal)){
write_csv(raster::as.data.frame(cropbio_mammal[[i]]), cropbiodf.path[i])  
}
```

```{r}
bg10k_mammal.bio <- readr::read_rds("bg10k_mammal.bio.rds")
biocolnames <- c("wc2.1_30s_bio_01",
              "wc2.1_30s_bio_02",
              "wc2.1_30s_bio_03",
              "wc2.1_30s_bio_04",
              "wc2.1_30s_bio_05",
              "wc2.1_30s_bio_06",
              "wc2.1_30s_bio_07",
              "wc2.1_30s_bio_08",
              "wc2.1_30s_bio_09",
              "wc2.1_30s_bio_10",
              "wc2.1_30s_bio_11",
              "wc2.1_30s_bio_12",
              "wc2.1_30s_bio_13",
              "wc2.1_30s_bio_14",
              "wc2.1_30s_bio_15",
              "wc2.1_30s_bio_16",
              "wc2.1_30s_bio_17",
              "wc2.1_30s_bio_18",
              "wc2.1_30s_bio_19")

b.data.mammal <- list()
for(i in 1:length(bg10k_mammal.bio)){
  b.data.mammal[[i]] <- data.frame(wc2.1_30s_bio_01 = bg10k_mammal.bio[[i]][,1],
                                   wc2.1_30s_bio_02 = bg10k_mammal.bio[[i]][,2],
                                   wc2.1_30s_bio_03 = bg10k_mammal.bio[[i]][,3],
                                   wc2.1_30s_bio_04 = bg10k_mammal.bio[[i]][,4],
                                   wc2.1_30s_bio_05 = bg10k_mammal.bio[[i]][,5],
                                   wc2.1_30s_bio_06 = bg10k_mammal.bio[[i]][,6],
                                   wc2.1_30s_bio_07 = bg10k_mammal.bio[[i]][,7],
                                   wc2.1_30s_bio_08 = bg10k_mammal.bio[[i]][,8],
                                   wc2.1_30s_bio_09 = bg10k_mammal.bio[[i]][,9],
                                   wc2.1_30s_bio_10 = bg10k_mammal.bio[[i]][,10],
                                   wc2.1_30s_bio_11 = bg10k_mammal.bio[[i]][,11],
                                   wc2.1_30s_bio_12 = bg10k_mammal.bio[[i]][,12],
                                   wc2.1_30s_bio_13 = bg10k_mammal.bio[[i]][,13],
                                   wc2.1_30s_bio_14 = bg10k_mammal.bio[[i]][,14],
                                   wc2.1_30s_bio_15 = bg10k_mammal.bio[[i]][,15],
                                   wc2.1_30s_bio_16 = bg10k_mammal.bio[[i]][,16],
                                   wc2.1_30s_bio_17 = bg10k_mammal.bio[[i]][,17],
                                   wc2.1_30s_bio_18 = bg10k_mammal.bio[[i]][,18],
                                   wc2.1_30s_bio_19 = bg10k_mammal.bio[[i]][,19],
                                   species = data.mammal[[i]]@species,
                                   type = "background")}
for(i in 1:35){
b.data.mammal[[i]]  <- tidyr::pivot_longer(b.data.mammal[[i]], 
                                            cols = 1:19, 
                                            names_to = "bio", 
                                            values_to = "covari")}

  readr::read_csv(cropbiodf.path[35], 
                  col_names = biocolnames,
                  skip = 1,
                  col_types = cols(wc2.1_30s_bio_01  = "d",
                                   wc2.1_30s_bio_02  = "d",
                                   wc2.1_30s_bio_03  = "d",
                                   wc2.1_30s_bio_04  = "d",
                                   wc2.1_30s_bio_05  = "d",
                                   wc2.1_30s_bio_06  = "d",
                                   wc2.1_30s_bio_07  = "d",
                                   wc2.1_30s_bio_08  = "d",
                                   wc2.1_30s_bio_09  = "d",
                                   wc2.1_30s_bio_10  = "d",
                                   wc2.1_30s_bio_11  = "d",
                                   wc2.1_30s_bio_12  = "d",
                                   wc2.1_30s_bio_13  = "d",
                                   wc2.1_30s_bio_14  = "d",
                                   wc2.1_30s_bio_15  = "d",
                                   wc2.1_30s_bio_16  = "d",
                                   wc2.1_30s_bio_17  = "d",
                                   wc2.1_30s_bio_18  = "d",
                                   wc2.1_30s_bio_19  = "d" ))  %>% 
    mutate(species = data.mammal[[35]]@species,
           type = "range") %>% 
  tidyr::pivot_longer( 
                      cols = 1:19, 
                      names_to = "bio", 
                      values_to = "covari") %>%
  dplyr::bind_rows(b.data.mammal[[i]]) %>%
  write_csv(., paste0("D:/viz_rb/mammal/",data.mammal[[35]]@species,".csv"))
  
}

```

```{r}
data.mammal <- readr::read_rds("data/newdata/data.mammal.rds")
data.reptile <- readr::read_rds("data/newdata/data.reptile.rds")
data.amphibian <- readr::read_rds("data/newdata/data.amphibian.rds")
```


```{r}
library(geosphere)

my.aseperate <- function(x){dplyr::bind_cols(dplyr::slice(x@coords, which(x@pa==0)[1]:nrow(x@coords)),
                                             dplyr::slice(x@data, which(x@pa==0)[1]:nrow(x@data)))}

a.data.mammal <- map(data.mammal, my.aseperate)
a.data.reptile <- map(data.reptile, my.aseperate)
a.data.amphibian <- map(data.amphibian, my.aseperate)

geodistm <- function(x){as.dist(geosphere::distm(x[,1:2], fun = distGeo))}

a.geodistm.mammal <- furrr::future_map(a.data.mammal, geodistm)
a.geodistm.reptile <- furrr::future_map(a.data.reptile, geodistm)
a.geodistm.amphibian <- furrr::future_map(a.data.amphibian, geodistm)


```


make table and histogram
```{r}
library(tidyverse)
library(hrbrthemes)
library(viridis)
library(forcats)


for(i in 1:length(biovalue_mammal)){
biovalue_mammal[[i]] %>% mutate(species = ,
                                type = "range") -> biovalue_mammal[[i]]
}


for(i in 1:length(bg10k_mammal.bio)){   
bg10k_mammal.bio[[i]] %>% mutate(species = ,
                                 type = "background") -> bg10k_mammal.bio[[i]]
}

# Load dataset from github
data <- data.frame(species = ,
                   type = c("range", "background"),
                   bio1 = ,
                   bio2 = ,
                   bio3 = ,
                   bio4 = ,
                   bio5 = ,
                   bio6 = ,
                   bio7 = ,
                   bio8 = ,
                   bio9 = , 
                   bio10 = ,
                   bio11 = ,
                   bio12 = ,
                   bio13 = ,
                   bio14 = ,
                   bio15 = ,
                   bio16 = ,
                   bio17 = ,
                   bio18 = ,
                   bio19 = )

# plot
p <- data %>%
  mutate(text = fct_reorder(text, value)) %>%
  ggplot( aes(x=value, color=text, fill=text)) +
    geom_histogram(alpha=0.6, binwidth = 5) +
    scale_fill_viridis(discrete=TRUE) +
    scale_color_viridis(discrete=TRUE) +
    geom_density(col=3) +
    theme_ipsum() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    ) +
    xlab("") +
    ylab("Assigned Probability (%)") +
    facet_wrap(~text)


ggplot2.histogram(data=weight, xName='weight',
        groupName='sex', legendPosition="top",
        alpha=0.5, position="stack")
```




KS test 
```{r}
ks_mammal <- vector()
for(i in 1:length(biovalue_mammal)){
ks_mammal[i] <- ks.test(biovalue_mammal[[i]], na.omit(bg10k_mammal.bio[[i]][,1]))$p.value
}

testbg30 <- sf::read_sf("testbg30.shp")
testbg30 <- my.bg100k(range.mammal[[3]])
sp.testbg30 <- as_Spatial(testbg30)
testbg30.bio <- my.extract(sp.testbg30)
ks.test(biovalue_mammal[[3]], na.omit(testbg30.bio))

ks.boot(biovalue_mammal[[3]], na.omit(testbg30.bio), nboots = 10000)



ks.test(m1df$bio1, b)

j <- geodistm(m1dfcd)
```


```{r}
sample1 <- biovalue_mammal[[3]]
sample2 <- na.omit(testbg30.bio)
group <- c(rep("sample1", length(sample1)), rep("sample2", length(sample2)))
dat <- data.frame(KSD = c(sample1,sample2), group = group)
# create ECDF of data
cdf1 <- ecdf(biovalue_mammal[[3]])
cdf2 <- ecdf(na.omit(testbg30.bio)) 
# find min and max statistics to draw line between points of greatest distance
minMax <- seq(min(sample1, sample2), max(sample1, sample2), length.out=length(sample1)) 
x0 <- minMax[which( abs(cdf1(minMax) - cdf2(minMax)) == max(abs(cdf1(minMax) - cdf2(minMax))) )] 
y0 <- cdf1(x0) 
y1 <- cdf2(x0) 
```



```{r}
ggplot(dat, aes(x = KSD, group = group, color = group))+
  stat_ecdf(size=1) +
    theme_bw(base_size = 28) +
    theme(legend.position ="top") +
    xlab("Sample") +
    ylab("ECDF") +
    #geom_line(size=1) +
    geom_segment(aes(x = x0[1], y = y0[1], xend = x0[1], yend = y1[1]),
        linetype = "dashed", color = "red") +
    geom_point(aes(x = x0[1] , y= y0[1]), color="red", size=8) +
    geom_point(aes(x = x0[1] , y= y1[1]), color="red", size=8) +
    ggtitle("K-S Test: Sample 1 / Sample 2") +
    theme(legend.title=element_blank())
```
```{r}
cucconi.test <- function(x, y, method = c("permutation", "bootstrap")){

  # Implementation of the Cucconi test for the two-sample location-scale problem
  # A permutation/bootstrap distribution of the test statistic (C) under the
  # null hypothesis is used to calculate the p-value.
  # Reference: Marozzi (2013), p. 1302-1303

  m <- length(x)
  n <- length(y)
  C <- cucconi.teststat(x = x, y = y, m = m, n = n)
  
  if(method[1] == "permutation"){
    h0dist <- cucconi.dist.perm(x = x, y = y)
  }
  
  if(method[1] == "bootstrap"){
    h0dist <- cucconi.dist.boot(x = x, y = y)
  }
  
  p.value <- length(h0dist[h0dist >= C]) / length(h0dist)
  
  cat("\nCucconi two-sample location-scale test\n")
  cat("\nNull hypothesis: The locations and scales of the two population distributions are equal.\n")
  cat("Alternative hypothesis: The locations and/or scales of the two population distributions differ.\n")
  cat(paste("\nC = ", round(C, 3), ", p-value = ", round(p.value, 4), "\n\n", sep=""))
  
  return(list(C = C,
              method = method[1],
              p.value = p.value))
}
```


# BG corrupted. NEW DATA. NEW MODEL.
```{r}
data.mammal <- readr::read_rds("data/data.mammal.rds")
data.reptile <- readr::read_rds("data/data.reptile.rds") #reptile 12번 거북이가 실려있다. 후에 뺀다.
data.amphibian <- readr::read_rds("data/data.amphibian.rds")

```


```{r}
reaarange <- function(x){dplyr::select(x@data, c(1,12,13,14,15,16,17,18,19,2,3,4,5,6,7,8,9,10,11))}

for (i in 1:length(data.mammal)){
data.mammal[[i]]@data <- reaarange(data.mammal[[i]])
}

for (i in 1:length(data.reptile)){
data.reptile[[i]]@data <- reaarange(data.reptile[[i]])
}

for (i in 1:length(data.amphibian)){
data.amphibian[[i]]@data <- reaarange(data.amphibian[[i]])
}

for (i in 1:length(data.mammal)){
names(data.mammal[[i]]@data) <- c("wc2.1_30s_bio_01", "wc2.1_30s_bio_02", "wc2.1_30s_bio_03", "wc2.1_30s_bio_04",
                                  "wc2.1_30s_bio_05", "wc2.1_30s_bio_06", "wc2.1_30s_bio_07", "wc2.1_30s_bio_08",
                                  "wc2.1_30s_bio_09", "wc2.1_30s_bio_10", "wc2.1_30s_bio_11", "wc2.1_30s_bio_12",
                                  "wc2.1_30s_bio_13", "wc2.1_30s_bio_14", "wc2.1_30s_bio_15", "wc2.1_30s_bio_16",
                                  "wc2.1_30s_bio_17", "wc2.1_30s_bio_18", "wc2.1_30s_bio_19")
}

for (i in 1:length(data.reptile)){
names(data.reptile[[i]]@data) <- c("wc2.1_30s_bio_01", "wc2.1_30s_bio_02", "wc2.1_30s_bio_03", "wc2.1_30s_bio_04",
                                   "wc2.1_30s_bio_05", "wc2.1_30s_bio_06", "wc2.1_30s_bio_07", "wc2.1_30s_bio_08",
                                   "wc2.1_30s_bio_09", "wc2.1_30s_bio_10", "wc2.1_30s_bio_11", "wc2.1_30s_bio_12",
                                   "wc2.1_30s_bio_13", "wc2.1_30s_bio_14", "wc2.1_30s_bio_15", "wc2.1_30s_bio_16",
                                   "wc2.1_30s_bio_17", "wc2.1_30s_bio_18", "wc2.1_30s_bio_19")
}

for (i in 1:length(data.amphibian)){
names(data.amphibian[[i]]@data) <- c("wc2.1_30s_bio_01", "wc2.1_30s_bio_02", "wc2.1_30s_bio_03", "wc2.1_30s_bio_04",
                                     "wc2.1_30s_bio_05", "wc2.1_30s_bio_06", "wc2.1_30s_bio_07", "wc2.1_30s_bio_08",
                                     "wc2.1_30s_bio_09", "wc2.1_30s_bio_10", "wc2.1_30s_bio_11", "wc2.1_30s_bio_12",
                                     "wc2.1_30s_bio_13", "wc2.1_30s_bio_14", "wc2.1_30s_bio_15", "wc2.1_30s_bio_16",
                                     "wc2.1_30s_bio_17", "wc2.1_30s_bio_18", "wc2.1_30s_bio_19")
}
```


```{r}
bg10kshp_mammal <- paste0("C:/Users/lophital/Documents/rsac_x_overfit/shp/sf_mammal/bg10k_mammal/",
                          list.files(path = "C:/Users/lophital/Documents/rsac_x_overfit/shp/sf_mammal/bg10k_mammal",
              pattern = "*.shp"))

bg10k_mammal <- list()
for(i in 1:length(data.mammal)){
bg10k_mammal[[i]] <-  sf::read_sf(bg10kshp_mammal[i])
}

bg10kcoord_mammal <- map(bg10k_mammal, st_coordinates)
bg10kcoord_mammal <- map(bg10kcoord_mammal, as.data.frame)
```

```{r}

# bg10k_reptile sf로 살아있다!

bg10kcoord_reptile <- map(bg10k_reptile, st_coordinates)
bg10kcoord_reptile <- map(bg10kcoord_reptile, as.data.frame)
```



load new background
```{r}
bg10k_mammal.bio <- readr::read_rds("bg10k_mammal.bio.rds")
bg10k_mammal.bio <- map(bg10k_mammal.bio, as.data.frame)
for(i in 1:length(bg10k_mammal.bio)){
  mutate(bg10k_mammal.bio[[i]],
         X = bg10kcoord_mammal[[i]]$X,
         Y = bg10kcoord_mammal[[i]]$Y) -> bg10k_mammal.bio[[i]]
}
bg10k_mammal.bio <- map(bg10k_mammal.bio, na.omit)
```

```{r}

bg10k_reptile.bio <- map(bg10k_reptile.bio, as.data.frame)

for(i in 1:length(bg10k_reptile.bio)){
  mutate(bg10k_reptile.bio[[i]],
         X = bg10kcoord_reptile[[i]]$X,
         Y = bg10kcoord_reptile[[i]]$Y) -> bg10k_reptile.bio[[i]]
}

bg10k_reptile.bio <- map(bg10k_reptile.bio, na.omit)
```

```{r}
bg10kcoord_amphibian <- map(bg10k_amphibian, st_coordinates)
bg10kcoord_amphibian <- map(bg10kcoord_amphibian, as.data.frame)

bg10k_amphibian.bio <- map(bg10k_amphibian.bio, as.data.frame)

for(i in 1:length(bg10k_amphibian.bio)){
  mutate(bg10k_amphibian.bio[[i]],
         X = bg10kcoord_amphibian[[i]]$X,
         Y = bg10kcoord_amphibian[[i]]$Y) -> bg10k_amphibian.bio[[i]]
}

bg10k_amphibian.bio <- map(bg10k_amphibian.bio, na.omit)
```



```{r}
my.pseperate <- function(x){dplyr::bind_cols(dplyr::slice(x@coords, 1:which(x@pa==0)[1]-1),
                                             dplyr::slice(x@data, 1:which(x@pa==0)[1]-1))}


p.data.mammal <- map(data.mammal, my.pseperate)

bg10kdata_mammal <- list()
for(i in 1:length(p.data.mammal)){
  bg10kdata_mammal[[i]] <- as.data.frame(
   rbind(p.data.mammal[[i]][,3:21], bg10k_mammal.bio[[i]][,1:19]))}

newcoord_mammal <- list()
for(i in 1:length(p.data.mammal)){
  newcoord_mammal[[i]] <-
   rbind(p.data.mammal[[i]][,1:2], bg10k_mammal.bio[[i]][,20:21])}

newpa_mammal <- list()
for(i in 1:length(p.data.mammal)){
newpa_mammal[[i]] <- c(rep(1, nrow(p.data.mammal[[i]])), 
                       rep(0, nrow(bg10k_mammal.bio[[i]])))}


for(i in 1:length(data.mammal)){
data.mammal[[i]]@data <- bg10kdata_mammal[[i]]
data.mammal[[i]]@coords <- newcoord_mammal[[i]]
data.mammal[[i]]@pa <- newpa_mammal[[i]]
}


```

```{r}
my.pseperate <- function(x){dplyr::bind_cols(dplyr::slice(x@coords, 1:which(x@pa==0)[1]-1),
                                             dplyr::slice(x@data, 1:which(x@pa==0)[1]-1))}

data.reptile[[12]] <- NULL

p.data.reptile <- map(data.reptile, my.pseperate)

bg10kdata_reptile <- list()
for(i in 1:length(p.data.reptile)){
  bg10kdata_reptile[[i]] <- as.data.frame(
   rbind(p.data.reptile[[i]][,3:21], bg10k_reptile.bio[[i]][,1:19]))}

newcoord_reptile <- list()
for(i in 1:length(p.data.reptile)){
  newcoord_reptile[[i]] <-
   rbind(p.data.reptile[[i]][,1:2], bg10k_reptile.bio[[i]][,20:21])}

newpa_reptile <- list()
for(i in 1:length(p.data.reptile)){
newpa_reptile[[i]] <- c(rep(1, nrow(p.data.reptile[[i]])), 
                       rep(0, nrow(bg10k_reptile.bio[[i]])))}


for(i in 1:length(data.reptile)){
data.reptile[[i]]@data <- bg10kdata_reptile[[i]]
data.reptile[[i]]@coords <- newcoord_reptile[[i]]
data.reptile[[i]]@pa <- newpa_reptile[[i]]
}

```

```{r}
my.pseperate <- function(x){dplyr::bind_cols(dplyr::slice(x@coords, 1:which(x@pa==0)[1]-1),
                                             dplyr::slice(x@data, 1:which(x@pa==0)[1]-1))}



p.data.amphibian <- map(data.amphibian, my.pseperate)

bg10kdata_amphibian <- list()
for(i in 1:length(p.data.amphibian)){
  bg10kdata_amphibian[[i]] <- as.data.frame(
   rbind(p.data.amphibian[[i]][,3:21], bg10k_amphibian.bio[[i]][,1:19]))}

newcoord_amphibian <- list()
for(i in 1:length(p.data.amphibian)){
  newcoord_amphibian[[i]] <-
   rbind(p.data.amphibian[[i]][,1:2], bg10k_amphibian.bio[[i]][,20:21])}

newpa_amphibian <- list()
for(i in 1:length(p.data.amphibian)){
newpa_amphibian[[i]] <- c(rep(1, nrow(p.data.amphibian[[i]])), 
                       rep(0, nrow(bg10k_amphibian.bio[[i]])))}


for(i in 1:length(data.amphibian)){
data.amphibian[[i]]@data <- bg10kdata_amphibian[[i]]
data.amphibian[[i]]@coords <- newcoord_amphibian[[i]]
data.amphibian[[i]]@pa <- newpa_amphibian[[i]]
}

```



```{r}
a <- vector()
for(i in 1:length(data.reptile)){
a[i] <- sum(data.reptile[[i]]@pa == 0)
}

a
```
```{r}
a <- vector()
for(i in 1:length(data.reptile)){
a[i] <- sum(data.reptile[[i]]@pa == 0)
}

a
```



```{r}
bg10k_mammal.xy <- list()
for(i in 1:length(bg10k_mammal.bio)){
bg10k_mammal.xy[[i]] <- bg10k_mammal.bio[[i]][,20:21]}

my.swdmaker <- function(x,y,z){SDMtune::prepareSWD(
  species = x@species, 
  p = y[,1:2], 
  a = z[,1:2], 
  env = stackbio)}

data.mammal <- furrr::future_map2(data.mammal, p.data.mammal, bg10k_mammal.xy,
                                  my.swdmaker, 
                                  .options = furrr_options(seed = TRUE), .progress = T)


```

# MODELLING

After data wrangling, move on to modelling process.
```{r}
library(tidyverse)
library(SDMtune)
library(blockCV)
library(ENMeval)
library(raster)
library(sf)
library(sp)
library(zeallot)
library(rJava)
library(dismo)
```

```{r parallel computing}
library(parallel) #parallel computing
library(foreach)
library(doParallel)
library(doSNOW)
library(furrr)

cores <- parallel::detectCores() - 1
cluster <- parallel::makeCluster(spec = cores)
doParallel::registerDoParallel(cl = cluster)
future::plan(multisession, workers = 32)
stopCluster(cl)
future:::ClusterRegistry("stop")
```

#35, 93, 50 species
```{r}
data.mammal <- readr::read_rds("data/newdata/data.mammal.rds")
data.reptile <- readr::read_rds("data/newdata/data.reptile.rds")
data.amphibian <- readr::read_rds("data/newdata/data.amphibian.rds")

```

not only mydas sea turtle, lugubris also out..
```{r}
data.reptile[[47]] <- NULL
t.t.reptile_0.2[[47]] <- NULL
```
total 92 reptile species



```{r}
reaarange <- function(x){dplyr::select(x@data, c(1,12,13,14,15,16,17,18,19,2,3,4,5,6,7,8,9,10,11))}

for (i in 1:length(data.mammal)){
data.mammal[[i]]@data <- reaarange(data.mammal[[i]])
}

for (i in 1:length(data.reptile)){
data.reptile[[i]]@data <- reaarange(data.reptile[[i]])
}

for (i in 1:length(data.amphibian)){
data.amphibian[[i]]@data <- reaarange(data.amphibian[[i]])
}

for (i in 1:length(data.mammal)){
names(data.mammal[[i]]@data) <- c("wc2.1_30s_bio_01", "wc2.1_30s_bio_02", "wc2.1_30s_bio_03", "wc2.1_30s_bio_04",
                                  "wc2.1_30s_bio_05", "wc2.1_30s_bio_06", "wc2.1_30s_bio_07", "wc2.1_30s_bio_08",
                                  "wc2.1_30s_bio_09", "wc2.1_30s_bio_10", "wc2.1_30s_bio_11", "wc2.1_30s_bio_12",
                                  "wc2.1_30s_bio_13", "wc2.1_30s_bio_14", "wc2.1_30s_bio_15", "wc2.1_30s_bio_16",
                                  "wc2.1_30s_bio_17", "wc2.1_30s_bio_18", "wc2.1_30s_bio_19")
}

for (i in 1:length(data.reptile)){
names(data.reptile[[i]]@data) <- c("wc2.1_30s_bio_01", "wc2.1_30s_bio_02", "wc2.1_30s_bio_03", "wc2.1_30s_bio_04",
                                   "wc2.1_30s_bio_05", "wc2.1_30s_bio_06", "wc2.1_30s_bio_07", "wc2.1_30s_bio_08",
                                   "wc2.1_30s_bio_09", "wc2.1_30s_bio_10", "wc2.1_30s_bio_11", "wc2.1_30s_bio_12",
                                   "wc2.1_30s_bio_13", "wc2.1_30s_bio_14", "wc2.1_30s_bio_15", "wc2.1_30s_bio_16",
                                   "wc2.1_30s_bio_17", "wc2.1_30s_bio_18", "wc2.1_30s_bio_19")
}

for (i in 1:length(data.amphibian)){
names(data.amphibian[[i]]@data) <- c("wc2.1_30s_bio_01", "wc2.1_30s_bio_02", "wc2.1_30s_bio_03", "wc2.1_30s_bio_04",
                                     "wc2.1_30s_bio_05", "wc2.1_30s_bio_06", "wc2.1_30s_bio_07", "wc2.1_30s_bio_08",
                                     "wc2.1_30s_bio_09", "wc2.1_30s_bio_10", "wc2.1_30s_bio_11", "wc2.1_30s_bio_12",
                                     "wc2.1_30s_bio_13", "wc2.1_30s_bio_14", "wc2.1_30s_bio_15", "wc2.1_30s_bio_16",
                                     "wc2.1_30s_bio_17", "wc2.1_30s_bio_18", "wc2.1_30s_bio_19")
}
```


```{r}
bg10kshp_mammal <- paste0("C:/Users/lophital/Documents/rsac_x_overfit/shp/sf_mammal/bg10k_mammal/",
                          list.files(path = "C:/Users/lophital/Documents/rsac_x_overfit/shp/sf_mammal/bg10k_mammal",
              pattern = "*.shp"))

bg10k_mammal <- list()
for(i in 1:length(data.mammal)){
bg10k_mammal[[i]] <-  sf::read_sf(bg10kshp_mammal[i])
}

bg10kcoord_mammal <- map(bg10k_mammal, st_coordinates)
bg10kcoord_mammal <- map(bg10kcoord_mammal, as.data.frame)
```


load new background
```{r}
bg10k_mammal.bio <- readr::read_rds("bg10k_mammal.bio.rds")
bg10k_mammal.bio <- map(bg10k_mammal.bio, as.data.frame)
for(i in 1:length(bg10k_mammal.bio)){
  mutate(bg10k_mammal.bio[[i]],
         X = bg10kcoord_mammal[[i]]$X,
         Y = bg10kcoord_mammal[[i]]$Y) -> bg10k_mammal.bio[[i]]
}
bg10k_mammal.bio <- map(bg10k_mammal.bio, na.omit)
```





```{r}
my.pseperate <- function(x){dplyr::bind_cols(dplyr::slice(x@coords, 1:which(x@pa==0)[1]-1),
                                             dplyr::slice(x@data, 1:which(x@pa==0)[1]-1))}


p.data.mammal <- map(data.mammal, my.pseperate)

bg10kdata_mammal <- list()
for(i in 1:length(p.data.mammal)){
  bg10kdata_mammal[[i]] <- as.data.frame(
   rbind(p.data.mammal[[i]][,3:21], bg10k_mammal.bio[[i]][,1:19]))}

newcoord_mammal <- list()
for(i in 1:length(p.data.mammal)){
  newcoord_mammal[[i]] <-
   rbind(p.data.mammal[[i]][,1:2], bg10k_mammal.bio[[i]][,20:21])}

newpa_mammal <- list()
for(i in 1:length(p.data.mammal)){
newpa_mammal[[i]] <- c(rep(1, nrow(p.data.mammal[[i]])), 
                       rep(0, nrow(bg10k_mammal.bio[[i]])))}


for(i in 1:length(data.mammal)){
data.mammal[[i]]@data <- bg10kdata_mammal[[i]]
data.mammal[[i]]@coords <- newcoord_mammal[[i]]
data.mammal[[i]]@pa <- newpa_mammal[[i]]
}


```


```{r}
bg10k_mammal.xy <- list()
for(i in 1:length(bg10k_mammal.bio)){
bg10k_mammal.xy[[i]] <- bg10k_mammal.bio[[i]][,20:21]}

my.swdmaker <- function(x,y,z){SDMtune::prepareSWD(
  species = x@species, 
  p = y[,1:2], 
  a = z[,1:2], 
  env = stackbio)}

data.mammal <- furrr::future_map2(data.mammal, p.data.mammal, bg10k_mammal.xy,
                                  my.swdmaker, 
                                  .options = furrr_options(seed = TRUE), .progress = T)


```


PCNM model 65 species
```{r}
data.reptile <- readr::read_rds("data/newdata/data.pcnm.reptile.rds")
data.amphibian <- readr::read_rds("data/newdata/data.pcnm.amphibian.rds")
```




데이터를 어떻게 쪼개느냐에 따라 모델 성능이 갈릴 것이다.
random k fold는 가진 모든 출현 데이터를 k개의 가짓수로 train과 test 셋으로 나눈다.
1000개에 5 fold 라면, 200개는 test셋이고 800개는 train 셋인데 
각각의 샘플이 한번씩 test에 들어가도록 구성해야 하니 5개의 조합이 나온다.

학습 데이터 조합은 5 조합이고
새로운 테스트 아니 벨리데이션 데이터셋도 5개가 생기는 셈이다.


```{r t.t.가져오기}
t.t.mammal_0.2 <- read_rds("t.t/newt.t/t.t.mammal_0.2.rds")
t.t.reptile_0.2 <- read_rds("t.t/newt.t/t.t.reptile_0.2.rds")
t.t.amphibian_0.2 <- read_rds("t.t/newt.t/t.t.amphibian_0.2.rds")

```





```{r}
t.t.name <- function(x){c(paste0("train_", x$species[1]), paste0("test_", x$species[1]))}
t.t.name_mammal <- map(sf_mammal, t.t.name)

```

```{r include=FALSE}
#split 3, train, test, validation
c(train, val, test) %<-% trainValTest(data.mammal_pilot[[1]], val = 0.2, test = 0.2, only_presence = TRUE, seed = 4839)

```

```{r train model : }

library(SDMtune)

#split 2, train, test

# 20 % for test
t.t.mammal_0.2 <- list()
for (i in 1:length(data.mammal)){
  t.t.mammal_0.2[[i]] <- trainValTest(data.mammal[[i]], 
                                      test = 0.2, 
                                      only_presence = TRUE, 
                                      seed = 1)}

t.t.reptile_0.2 <- list()
for (i in 1:length(data.reptile)){t.t.reptile_0.2[[i]] <- trainValTest(data.reptile[[i]], test = 0.2, only_presence = TRUE, seed = 1)}

t.t.amphibian_0.2 <- list()
for (i in 1:length(data.amphibian)){t.t.amphibian_0.2[[i]] <- trainValTest(data.amphibian[[i]], test = 0.2, only_presence = TRUE, seed = 1)}





folds.rnd5k_mammal <- list()
for (i in 1:length(t.t.mammal_0.2)){rnd5k_mammal[[i]] <- randomFolds(t.t.mammal_0.2[[i]][[1]], k = 5, only_presence = TRUE, seed = 3667)}




#Crude
#default_model <- train(method = "Maxent", data = data)
#default_model <- train(method = "Maxent", data = data, fc = "lqph", reg = 1, iter = 500)

#without validation set
#c(train, test) %<-% trainValTest(data, test = 0.2, only_presence = TRUE, seed = 25)
#maxnet_model <- train("Maxnet", data = train)

#random 4 fold cross validation


#purrr
rnd4k <- function(x){randomFolds(x[[1]], 
                                 k = 4,
                                 only_presence = TRUE,
                                 seed = 1)}

rnd5k <- function(x){randomFolds(x[[1]], 
                                 k = 5,
                                 only_presence = TRUE,
                                 seed = 3668)}

folds.rnd4k_mammal <- map(t.t.mammal_0.2, rnd4k)
folds.rnd5k_mammal <- map(t.t.mammal_0.2, rnd5k)

folds.rnd4k_reptile <- map(t.t.reptile_0.2, rnd4k)

folds.rnd4k_amphibian <- map(t.t.amphibian_0.2, rnd4k)


model_rndcv4k_mammal <- list()
for (i in 1:length(rnd4k_mammal)){model_rndcv4k_mammal[[i]] <- train("Maxnet", data =t.t.mammal_0.2[[i]][[1]], folds = rnd4k_mammal[[i]])}


#purrr

maxnet.train <- function(x, y){SDMtune::train("Maxnet",
                                               data = x[[1]],
                                               folds = y)}
maxent.train <- function(x, y){SDMtune::train("Maxent",
                                               data = x[[1]],
                                               folds = y)}




model_rndcv4k_mammal <- list()
for(i in 1:length(t.t.mammal_0.2)){
  model_rndcv4k_mammal[[i]] <- maxnet.train(t.t.mammal_0.2[[i]], folds.rnd4k_mammal[[i]])
}


test_t.t <- t.t.mammal_0.2[[1]]
test_fold <- folds.rnd4k_mammal[[1]]
test_t.t[[1]]@data <- test_t.t[[1]]@data[,1:3]
test_t.t[[2]]@data <- test_t.t[[2]]@data[,1:3]

test_t.t2 <- t.t.mammal_0.2[[1]]
test_fold2 <- folds.rnd4k_mammal[[1]]
test_t.t2[[1]]@data <- test_t.t2[[1]]@data[,1:4]
test_t.t2[[2]]@data <- test_t.t2[[2]]@data[,1:4]

test_t.t3 <- t.t.mammal_0.2[[1]]
test_fold3 <- folds.rnd4k_mammal[[1]]
test_t.t3[[1]]@data <- test_t.t3[[1]]@data[,c(1,2,3,5)]
test_t.t3[[2]]@data <- test_t.t3[[2]]@data[,c(1,2,3,5)]

ent1 <- vector()
for(i in 1:4){
   ent1[i] <- test_model@models[[i]]@model@model$entropy
}

ent2 <- vector()
for(i in 1:4){
   ent2[i] <- test_model2@models[[i]]@model@model$entropy
}

ent3 <- vector()
for(i in 1:4){
   ent3[i] <- test_model3@models[[i]]@model@model$entropy
}

model_rndcv4k_mammal <- future_map2(t.t.mammal_0.2, 
                                    folds.rnd4k_mammal, 
                                    maxnet.train, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

model_rndcv4k_reptile <- future_map2(t.t.reptile_0.2, 
                                    folds.rnd4k_reptile, 
                                    maxnet.train, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

model_rndcv4k_reptile2 <- future_map2(t.t.reptile_0.2, 
                                    folds.rnd4k_reptile, 
                                    maxent.train, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

model_rndcv4k_amphibian <- future_map2(t.t.amphibian_0.2, 
                                    folds.rnd4k_amphibian, 
                                    maxnet.train, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

model_rndcv4k_amphibian2 <- future_map2(t.t.amphibian_0.2, 
                                    folds.rnd4k_amphibian, 
                                    maxent.train, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)


```
while PCNM reptile.. 39 stil got glmnet error
```{r}
t.t.reptile_0.2_without39 <- t.t.reptile_0.2[-39]
folds.rnd4k_reptile_without39 <- folds.rnd4k_reptile[-39]
model_rndcv4k_reptile <- future_map2(t.t.reptile_0.2_without39, 
                                    folds.rnd4k_reptile_without39, 
                                    maxnet.train, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

model <- list()
for(i in 1:38){model[[i]] <- model_rndcv4k_reptile[[i]]}
model[[39]] <- model_rndcv4k_reptile2[[39]]
for(i in 39:64){model[[i+1]] <- model_rndcv4k_reptile[[i]]}

model_rndcv4k_reptile <- model
write_rds(model_rndcv4k_reptile, "model/newmodel/model_pcnm/model_rndcv4k_reptile.rds")
```

here 10th got glm error
```{r}
t.t.amphibian_0.2_without1023 <- t.t.amphibian_0.2[-c(10,23)]
folds.rnd4k_amphibian_without1023 <- folds.rnd4k_amphibian[-c(10,23)]
model_rndcv4k_amphibian <- future_map2(t.t.amphibian_0.2_without1023, 
                                    folds.rnd4k_amphibian_without1023, 
                                    maxnet.train, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

t.t.amphibian_0.2_without10 <- t.t.amphibian_0.2_without10[-22]#it was 23
folds.rnd4k_amphibian_without10 <- folds.rnd4k_amphibian_without10[-22]#it was 23
model_rndcv4k_amphibian <- future_map2(t.t.amphibian_0.2_without10, 
                                    folds.rnd4k_amphibian_without10, 
                                    maxnet.train, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T) 

model <- list()
for(i in 1:9){model[[i]] <- model_rndcv4k_amphibian[[i]]}
model[[10]] <- model_rndcv4k_amphibian2[[10]]
for(i in 10:21){model[[i+1]] <- model_rndcv4k_amphibian[[i]]}
model[[23]] <- model_rndcv4k_amphibian2[[23]]
for(i in 22:30){model[[i+2]] <- model_rndcv4k_amphibian[[i]]}
for(i in 1:32){print(model[[i]]@data@species)}

model_rndcv4k_amphibian <- model
write_rds(model_rndcv4k_amphibian, "model/newmodel/model_pcnm/model_rndcv4k_amphibian.rds")
```


```{r}
write_rds(t.t.reptile_0.2, "t.t/newt.t/t.t.pcnm.reptile_0.2.rds")
write_rds(t.t.amphibian_0.2, "t.t/newt.t/t.t.pcnm.amphibian_0.2.rds")


```



# spatial block cross validation model

```{r}
library(blockCV)
library(precrec)
```

Find proper size of spatial block.

load cropped raster
```{r}
bio_crop_mammal <- list()
for(i in 1:35){
list.files("D:/bio_crop/mammal", pattern = "*.tif", full.names = T)[i] %>% 
  raster::stack(.) -> bio_crop_mammal[[i]]}

bio_crop_reptile <- list()
for(i in 1:92){
list.files("D:/bio_crop/reptile2", pattern = "*.tif", full.names = T)[i] %>% 
  raster::stack(.) -> bio_crop_reptile[[i]]}

bio_crop_amphibian <- list()
for(i in 1:50){
list.files("D:/bio_crop/amphibian", pattern = "*.tif", full.names = T)[i] %>% 
  raster::stack(.) -> bio_crop_amphibian[[i]]}
```

Get the range of SA in range of habitat
```{r}
my.SARange <- function(x){blockCV::spatialAutoRange(rasterLayer = x,
                                          sampleNumber = 10000,
                                          doParallel = TRUE,
                                          showPlots = TRUE, 
                                          progress = T)}

SARange_mammal <- list()
for(i in 1:35){
  SARange_mammal[[i]] <- my.SARange(bio_crop_mammal[[i]])
}


SARange_reptile <- list()
for(i in 1:91){
  SARange_reptile[[i]] <- my.SARange(bio_crop_reptile[[i]])
}

SARange_amphibian <- list()
for(i in 1:50){
  SARange_amphibian[[i]] <- my.SARange(bio_crop_amphibian[[i]])
}

```

76 got error..Teira dugesii.. Tiny island lizzard. remove..
```{r}
SARange_reptile[[76]] <- NULL
bio_crop_reptile[[76]] <- NULL
data.reptile[[76]] <- NULL
t.t.reptile_0.2[[76]] <- NULL
```



```{r}
for(i in 77:92){
  SARange_reptile[[i]] <- my.SARange(bio_crop_reptile[[i]])
}

```




few of them fucked up.
In Conservative view, these are fucked up.
2, 3, 4, 5, 6, 7, 11, 15, 16, 17, 19, 20, 21, 23, 25, 26, 28, 29, 31, 32, 33, 34, 35
try more points
```{r}
test <- blockCV::spatialAutoRange(rasterLayer = bio_crop_mammal[[2]],
                                  sampleNumber = 10000,
                                  doParallel = TRUE,
                                  showPlots = TRUE,
                                  nCores = 60, 
                                  progress = TRUE)
```

more liberal, these are fucked up.
2, 3, 4, 5, 6, 7, 11, 15, 16, 17, 19, 20, 21, 28, 29, 33, 34

2 <- 1:4 1183532
3 <- 1:4 559611
4 <- 1:5 696445
5 <- 1:4 1622887(1404230)
6 <- 1:5 1312366
```{r}
blockCV::rangeExplorer(rasterLayer = bio_crop_mammal[[29]],
              speciesData = sf_train_mammal[[29]],
              species = "pa",
              rangeTable = NULL,
              minRange = 1000000, # limit the search domain
              maxRange = 3000000)
```

reptile fucked ups are



```{r}
library(automap)

plot(SARange_mammal[[5]]$variograms[[4]])
```
it seems first few rasters' ranges mean will works fine. 
so mean of 1:4 will be my range for those doesn't work well.

```{r}
good.range_mammal <- vector()
for(i in 1:length(SARange_mammal)){
  good.range_mammal[i] <- SARange_mammal[[i]]$range
}

for(i in c(2, 3, 4, 5, 6, 7, 11, 15, 16, 17, 19, 20, 21, 23, 25, 26, 28, 29, 31, 32, 33, 34, 35)){
  good.range_mammal[i] <- mean(SARange_mammal[[i]]$rangeTable$range[1:4])
}


good.range_reptile <- vector()
for(i in 1:length(SARange_reptile)){
  good.range_reptile[i] <- SARange_reptile[[i]]$range
}

for(i in c(1,2,7,8,9,10,11,12,13,15,16,17,19,20,22,23,24,25,26,31,32,33,34,35,38,39,42,43,44,45,47,48,51,52,54,56,57,58,60,61,62,66,67,69,70,71,73,76,78,80,81,83,84,86,87,91)){
  good.range_reptile[i] <- mean(SARange_reptile[[i]]$rangeTable$range[1:4])
}

good.range_amphibian <- vector()
for(i in 1:length(SARange_amphibian)){
  good.range_amphibian[i] <- SARange_amphibian[[i]]$range
}

for(i in c(2,4,5,6,9,11,12,16,17,18,20,23,25,27,28,29,30,31,33,34,35,39,40,41,42,49)){
  good.range_amphibian[i] <- mean(SARange_amphibian[[i]]$rangeTable$range[1:4])
}

```


```{r}
#10 keep getting error even low distance
blockCV::rangeExplorer(rasterLayer = bio_crop_reptile[[10]],
              speciesData = sf_train_reptile[[10]],
              species = "pa",
              rangeTable = NULL,
              minRange = 100000, # limit the search domain
              maxRange = 300000)
```

t.t as sf
it must include pa column
```{r}
tb_train_mammal <- list()
for(i in 1:length(t.t.mammal_0.2)){
tb_train_mammal[[i]] <- tibble(long = t.t.mammal_0.2[[i]][[1]]@coords$X,
                               lat = t.t.mammal_0.2[[i]][[1]]@coords$Y,
                               pa = t.t.mammal_0.2[[i]][[1]]@pa,
                               data = t.t.mammal_0.2[[i]][[1]]@data)
}

tb_train_reptile <- list()
for(i in 1:length(data.reptile)){
tb_train_reptile[[i]] <- tibble(long = t.t.reptile_0.2[[i]][[1]]@coords$X,
                               lat = t.t.reptile_0.2[[i]][[1]]@coords$Y,
                               pa = t.t.reptile_0.2[[i]][[1]]@pa,
                               data = t.t.reptile_0.2[[i]][[1]]@data)
}

tb_train_amphibian <- list()
for(i in 1:length(data.amphibian)){
tb_train_amphibian[[i]] <- tibble(long = t.t.amphibian_0.2[[i]][[1]]@coords$X,
                               lat = t.t.amphibian_0.2[[i]][[1]]@coords$Y,
                               pa = t.t.amphibian_0.2[[i]][[1]]@pa,
                               data = t.t.amphibian_0.2[[i]][[1]]@data)
}
  
sf_train_mammal <- list()
for(i in 1:length(tb_train_mammal)){
sf_train_mammal[[i]] <- sf::st_as_sf(tb_train_mammal[[i]],
                                coords = c(1,2), 
                                crs = 4326,
                                remove = F)
}

sf_train_reptile <- list()
for(i in 1:length(tb_train_reptile)){
sf_train_reptile[[i]] <- sf::st_as_sf(tb_train_reptile[[i]],
                                coords = c(1,2), 
                                crs = 4326,
                                remove = F)
}

sf_train_amphibian <- list()
for(i in 1:length(tb_train_amphibian)){
sf_train_amphibian[[i]] <- sf::st_as_sf(tb_train_amphibian[[i]],
                                coords = c(1,2), 
                                crs = 4326,
                                remove = F)
}
```

```{r}
folds.sp4k_mammal <- list()
folds.sp4k_mammal[[1]] <- blockCV::spatialBlock(speciesData = sf_train_mammal[[1]],
                                                  species = "pa",
                                                  rasterLayer = bio_crop_mammal[[1]],
                                                  theRange = good.range_mammal[1],
                                                  k = 4, 
                                                  selection = "random", 
                                                  numLimit = 0, 
                                                  iteration = 100, 
                                                  showBlocks = TRUE, 
                                                  biomod2Format = TRUE, 
                                                  progress = TRUE, 
                                                  verbose = TRUE)

my.spatialblock <- function(x, y, z){blockCV::spatialBlock(speciesData = x,
                                                  species = "pa",
                                                  rasterLayer = y,
                                                  theRange = z,
                                                  k = 4, 
                                                  selection = "random", 
                                                  numLimit = 0, 
                                                  iteration = 100, 
                                                  showBlocks = TRUE, 
                                                  biomod2Format = TRUE, 
                                                  progress = TRUE, 
                                                  verbose = TRUE)}

folds.sp4k_mammal <- furrr::future_pmap(sf_train_mammal,
                                         bio_crop_mammal,
                                         SARange_mammal)
folds.sp4k_mammal <- list()
for(i in 29:length(sf_train_mammal)){
folds.sp4k_mammal[[i]] <- blockCV::spatialBlock(speciesData = sf_train_mammal[[i]],
                                                  species = "pa",
                                                  rasterLayer = bio_crop_mammal[[i]],
                                                  theRange = good.range_mammal[i],
                                                  k = 4, 
                                                  selection = "random", 
                                                  numLimit = 0, 
                                                  iteration = 100, 
                                                  showBlocks = TRUE, 
                                                  biomod2Format = TRUE, 
                                                  progress = TRUE, 
                                                  verbose = TRUE)}

#11, 16, 20 is too small austarailia
#give it 1000000
good.range_mammal[11] <- 1000000
good.range_mammal[16] <- 1000000
good.range_mammal[20] <- 1000000
good.range_mammal[29] <- 2277277


folds.sp4k_reptile <- list()
for(i in 1:length(sf_train_reptile)){
folds.sp4k_reptile[[i]] <- blockCV::spatialBlock(speciesData = sf_train_reptile[[i]],
                                                  species = "pa",
                                                  rasterLayer = bio_crop_reptile[[i]],
                                                  theRange = good.range_reptile[i],
                                                  k = 4, 
                                                  selection = "random", 
                                                  numLimit = 0, 
                                                  iteration = 100, 
                                                  showBlocks = TRUE, 
                                                  biomod2Format = TRUE, 
                                                  progress = TRUE, 
                                                  verbose = TRUE)}



```
```{r}
#76 less block. decrease size to 1st range
good.range_reptile[76] <- 824164.8   

for(i in 76:length(sf_train_reptile)){
folds.sp4k_reptile[[i]] <- blockCV::spatialBlock(speciesData = sf_train_reptile[[i]],
                                                  species = "pa",
                                                  rasterLayer = bio_crop_reptile[[i]],
                                                  theRange = good.range_reptile[i],
                                                  k = 4, 
                                                  selection = "random", 
                                                  numLimit = 0, 
                                                  iteration = 100, 
                                                  showBlocks = TRUE, 
                                                  biomod2Format = TRUE, 
                                                  progress = TRUE, 
                                                  verbose = TRUE)}
```

load old folds
```{r}
folds.sp4k_reptile <- read_rds("folds/folds.sp4k_reptile.rds") #this is 91
folds.sp4k_amphibian <- read_rds("folds/folds.sp4k_amphibian.rds") #this is 50
```

my data is 65, 32.

find couples

sp block have 91. original as data

These are I cut from 91 to 70 to make distm
```{r}
folds.sp4k_reptile.copy <- folds.sp4k_reptile
folds.sp4k_reptile.copy[c(1,  5,  7,  8,  9, 10, 11, 12, 14, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 45, 46, 47, 48, 49, 50, 52, 53, 55, 57, 58, 59, 61, 62, 64, 66, 67, 68, 70, 71, 72, 73, 74, 75, 77, 78, 79, 81, 83, 86, 87, 88, 90)] -> folds.sp4k_reptile.copy
```

and these are I cut from 70 to 65 to get pcnm vectors that have at least 14
```{r}
folds.sp4k_reptile.copy[-c(22, 27, 58, 60, 61)] -> folds.sp4k_reptile.copy
```

about amphibian

```{r}
folds.sp4k_amphibian.copy <- folds.sp4k_amphibian
folds.sp4k_amphibian.copy[-c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] -> folds.sp4k_amphibian.copy
folds.sp4k_amphibian.copy[-c(11, 21, 25)] -> folds.sp4k_amphibian.copy
```




```{r}
nrow.spfold.reptile <- vector()
for(i in 1:length(folds.sp4k_reptile.copy)){
nrow.spfold.reptile[i] <- (folds.sp4k_reptile.copy[[i]]$records[1,2] + folds.sp4k_reptile.copy[[i]]$records[1,4])}

nrow.t.t.reptile <- vector()
for(i in 1:length(t.t.reptile_0.2)){
nrow.t.t.reptile[i] <- sum(t.t.reptile_0.2[[i]][[1]]@pa == 1)}

nrow.spfold.amphibian <- vector()
for(i in 1:length(folds.sp4k_amphibian.copy)){
nrow.spfold.amphibian[i] <- (folds.sp4k_amphibian.copy[[i]]$records[1,2] + folds.sp4k_amphibian.copy[[i]]$records[1,4])}

nrow.t.t.amphibian <- vector()
for(i in 1:length(t.t.amphibian_0.2)){
nrow.t.t.amphibian[i] <- sum(t.t.amphibian_0.2[[i]][[1]]@pa == 1)}

```

```{r}
nrow.spfold.reptile
```
```{r}
nrow.t.t.reptile
```
```{r}
which(nrow.spfold.reptile == nrow.t.t.reptile[7])
```




```{r}
nrow.spfold.amphibian
```

```{r}
nrow.t.t.amphibian
```


```{r}
model_spcv4k_mammal <- future_map2(t.t.mammal_0.2, 
                                    folds.sp4k_mammal, 
                                    maxnet.train,
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

model_spcv4k_reptile <- future_map2(t.t.reptile_0.2, 
                                    folds.sp4k_reptile.copy, 
                                    maxnet.train,
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

model_spcv4k_amphibian <- future_map2(t.t.amphibian_0.2, 
                                    folds.sp4k_amphibian.copy, 
                                    maxnet.train,
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)


```


62 got glm error... try without it
```{r}
t.t.reptile_0.2.test <- t.t.reptile_0.2
folds.sp4k_reptile.test <- folds.sp4k_reptile

t.t.reptile_0.2.test[[62]] <- t.t.reptile_0.2.test[[1]]
folds.sp4k_reptile.test[[62]] <- folds.sp4k_reptile.test[[1]]

model_spcv4k_reptile.test <- future_map2(t.t.reptile_0.2.test, 
                                    folds.sp4k_reptile.test, 
                                    maxnet.train,
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T) # it is done!
```

```{r}
t.t.62 <- t.t.reptile_0.2[[62]]
fold.62 <- folds.sp4k_reptile[[62]]

bgtest <- list(SDMtune::addSamplesToBg(t.t.62[[1]]),
               SDMtune::addSamplesToBg(t.t.62[[2]]))

model_spcv4k_reptile.test[[62]] <- maxnet.train(bgtest, fold.62)

```



```{r}
folds.sp4k_amphibian <- list()
for(i in 1:length(sf_train_amphibian)){
folds.sp4k_amphibian[[i]] <- blockCV::spatialBlock(speciesData = sf_train_amphibian[[i]],
                                                  species = "pa",
                                                  rasterLayer = bio_crop_amphibian[[i]],
                                                  theRange = good.range_amphibian[i],
                                                  k = 4, 
                                                  selection = "random", 
                                                  numLimit = 0, 
                                                  iteration = 100, 
                                                  showBlocks = TRUE, 
                                                  biomod2Format = TRUE, 
                                                  progress = TRUE, 
                                                  verbose = TRUE)}
```

amphibian sp cv 4k

```{r}
#49 got less block : 3
good.range_amphibian[49] <- 648399.2

for(i in 49:length(sf_train_amphibian)){
folds.sp4k_amphibian[[i]] <- blockCV::spatialBlock(speciesData = sf_train_amphibian[[i]],
                                                  species = "pa",
                                                  rasterLayer = bio_crop_amphibian[[i]],
                                                  theRange = good.range_amphibian[i],
                                                  k = 4, 
                                                  selection = "random", 
                                                  numLimit = 0, 
                                                  iteration = 100, 
                                                  showBlocks = TRUE, 
                                                  biomod2Format = TRUE, 
                                                  progress = TRUE, 
                                                  verbose = TRUE)}

```





```{r}
#cut only presence
for(i in 1:length(sf_train_mammal)){
sf_train_mammal[[i]] <- slice(sf_train_mammal[[i]], 1:which(t.t.mammal_0.2[[i]][[1]]@pa==0)[1]-1)
}

for(i in 1:length(sf_train_reptile)){
sf_train_reptile[[i]] <- slice(sf_train_reptile[[i]], 1:which(t.t.reptile_0.2[[i]][[1]]@pa==0)[1]-1)
}

for(i in 1:length(sf_train_amphibian)){
sf_train_amphibian[[i]] <- slice(sf_train_amphibian[[i]], 1:which(data.amphibian[[i]]@pa==0)[1]-1)
}

#env fold

folds.env_mammal <- list()
for(i in 1:length(sf_train_mammal)){
folds.env_mammal[[i]] <- my.env.block(rasterLayer = stackbio,
                                       speciesData = sf_train_mammal[[i]],
                                       species = "pa",
                                       k = 4,
                                       standardization = TRUE,
                                       rasterBlock = FALSE,
                                       ext = sf_train_mammal[[i]]$data)
}


folds.env_reptile <- list()
for(i in 1:length(sf_train_reptile)){
folds.env_reptile[[i]] <- my.env.block(rasterLayer = stackbio,
                                       speciesData = sf_train_reptile[[i]],
                                       species = "pa",
                                       k = 4,
                                       standardization = TRUE,
                                       rasterBlock = FALSE,
                                       ext = sf_train_reptile[[i]]$data)
}



folds.env_amphibian <- list()
for(i in 1:length(sf_train_amphibian)){
folds.env_amphibian[[i]] <- my.env.block(rasterLayer = stackbio,
                                       speciesData = sf_train_amphibian[[i]],
                                       species = "pa",
                                       k = 4,
                                       standardization = TRUE,
                                       rasterBlock = FALSE,
                                       ext = sf_train_amphibian[[i]]$data)
}


```

```{r}
a <- list()
for(i in 1:length(folds.env_reptile)){
  a[[i]] <- folds.env_reptile[[i]]$records
}


```






```{r}


folds.block_mammal <- list()
for(i in 1:length(data.mammal)){
  folds.block_mammal[[i]] <- get.block(occ = t.t.mammal_0.2[[i]][[1]]@data[t.t.mammal_0.2[[i]][[1]]@pa == 1,], 
                                       bg.coords = data.mammal[[i]]@data[data.mammal[[i]]@pa == 0, ])
}

folds.block_reptile <- list()
for(i in 1:length(data.reptile)){
  folds.block_reptile[[i]] <- ENMeval::get.block(occ = t.t.reptile_0.2[[i]][[1]]@data[t.t.reptile_0.2[[i]][[1]]@pa == 1,], 
                                       bg.coords = data.reptile[[i]]@data[data.reptile[[i]]@pa == 0, ])
}

folds.block_amphibian <- list()
for(i in 1:length(data.amphibian)){
  folds.block_amphibian[[i]] <- get.block(occ = t.t.amphibian_0.2[[i]][[1]]@data[t.t.amphibian_0.2[[i]][[1]]@pa == 1,], 
                                       bg.coords = data.amphibian[[i]]@data[data.amphibian[[i]]@pa == 0, ])
}



model_spcv4k_mammal <- future_map2(t.t.mammal_0.2, 
                                    folds.block_mammal, 
                                    maxnet.train,
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

model_spcv4k_reptile <- future_map2(t.t.reptile_0.2, 
                                    folds.block_reptile, 
                                    maxnet.train,
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

model_spcv4k_reptile <- list()
for(i in 1:length(t.t.reptile_0.2)){
  model_spcv4k_reptile[[i]] <- maxnet.train(t.t.reptile_0.2[[i]], folds.block_reptile[[i]])
}

model_spcv4k_amphibian <- future_map2(t.t.amphibian_0.2, 
                                    folds.block_amphibian, 
                                    maxnet.train,
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)


```


cb_folds <- get.checkerboard1(occ = data@data[data@pa == 1, ], 
                              env = predictors, 
                              bg.coords = data@data[data@pa == 0, ], 
                              aggregation.factor = 4)

model <- train(method = "Maxnet", data = data, fc = "l", reg = 0.8, folds = cb_folds)

# 3. Environmental block


```{r}
library(raster)
biopath <- paste0("bios/", list.files(pattern="*.tif", path = "bios/"))
stackbio <- raster::stack("stackbio.tif")
```


things are fucked up... make again
```{r}
for(i in 29:length(sf_train_mammal)){
folds.sp4k_mammal[[i]] <- blockCV::spatialBlock(speciesData = sf_train_mammal[[i]],
                                                  species = "pa",
                                                  rasterLayer = bio_crop_mammal[[i]],
                                                  theRange = good.range_mammal[i],
                                                  k = 4, 
                                                  selection = "random", 
                                                  numLimit = 0, 
                                                  iteration = 100, 
                                                  showBlocks = TRUE, 
                                                  biomod2Format = TRUE, 
                                                  progress = TRUE, 
                                                  verbose = TRUE)}
```


```{r}

folds.env_mammal <- list()
for(i in 1:35){
folds.env_mammal[[i]] <- blockCV:::envBlock(rasterLayer = stackbio,
                         speciesData = sf_train_mammal[[i]],
                         species = "pa",
                         k = 4,
                         standardization = "normal", #표준화
                         rasterBlock = FALSE,
                         numLimit = 100,
                         biomod2Format = T,
                         verbose = T)  
}

```


```{r}


# Create spatial points data frame
sp_mammal <- list()
for (i in 1:length(t.t.mammal_0.2)){
sp_mammal[[i]] <- SpatialPointsDataFrame(t.t.mammal_0.2[[i]][[1]]@coords, 
                                         data = data.frame(t.t.mammal_0.2[[i]][[1]]@pa),
                                         proj4string = CRS("+proj=longlat +datum=WGS84"))
}

for (i in 1:length(sp_mammal)){
names(sp_mammal[[i]]) <- "pa"
}  



model_envcv4k_mammal <- future_map2(t.t.mammal_0.2, 
                                    folds.env_mammal, 
                                    maxnet.train,
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

model_envcv4k_mammal <- list()
for(i in 20:length(t.t.mammal_0.2)){
  model_envcv4k_mammal[[i]] <- maxnet.train(t.t.mammal_0.2[[i]], folds.env_mammal[[i]])
}

model_envcv4k_mammal[[6]] <- maxnet.train(t.t.mammal_0.2[[6]], folds.env_mammal[[6]])

#3 got bound error
#6 got bound error
#8 got error
#19 got error
#22 got error 


model_envcv4k_reptile <- future_map2(t.t.reptile_0.2, 
                                    folds.env_reptile, 
                                    maxnet.train,
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

model_envcv4k_amphibian <- future_map2(t.t.amphibian_0.2, 
                                    folds.env_amphibian, 
                                    maxnet.train,
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

model_envcv4k_mammal <- future_map2(t.t.mammal_0.2, 
                                    folds.env_mammal, 
                                    maxnet.train,
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)


#reptile 8 got error

t.t.reptile_0.2.tmp <- t.t.reptile_0.2[-8]
folds.env_reptile.tmp <- folds.env_reptile[-8]

t.t.reptile_0.2.tmp <- t.t.reptile_0.2.tmp[-14]
folds.env_reptile.tmp <- folds.env_reptile.tmp[-14]

model_envcv4k_reptile.tmp <- future_map2(t.t.reptile_0.2.tmp, 
                                    folds.env_reptile.tmp, 
                                    maxnet.train,
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

```
```{r}

for(i in 9:length(t.t.reptile_0.2)){
  model_envcv4k_reptile[[i]] <- maxnet.train(t.t.reptile_0.2[[i]], folds.env_reptile[[i]])
}
```


































```{r}
new("standardGeneric", .Data = function (object, ...) 
standardGeneric("predict"), generic = "predict", package = "stats", 
  group = list(), valueClass = character(0), signature = "object", 
  default = new("derivedDefaultMethod", .Data = function (object, 
    ...) 
  UseMethod("predict"), target = new("signature", .Data = "ANY", 
    names = "object", package = "methods"), defined = new("signature", 
    .Data = "ANY", names = "object", package = "methods"), 
    generic = "predict"), skeleton = (new("derivedDefaultMethod", 
    .Data = function (object, ...) 
    UseMethod("predict"), target = new("signature", .Data = "ANY", 
      names = "object", package = "methods"), defined = new("signature", 
      .Data = "ANY", names = "object", package = "methods"), 
    generic = "predict"))(object, ...))

```







```{r}
predict.test <- function(x,y){
  SDMtune::predict(x,
                   data = y[[2]],
                   fun = "mean",
                   type = "cloglog")
}

predict.train <- function(x,y){
  SDMtune::predict(x,
                   data = y[[1]],
                   fun = "mean",
                   type = "cloglog")
}



test_spcv4k_mammal <- map2(model_spcv4k_mammal, 
                                   t.t.mammal_0.2, 
                                   predict.test 
                                   )

train_spcv4k_mammal <- map2(model_spcv4k_mammal, 
                                   t.t.mammal_0.2, 
                                   predict.train 
                                   )

test_rndcv4k_mammal <- map2(model_rndcv4k_mammal, 
                                   t.t.mammal_0.2, 
                                   predict.test 
                                   )

train_rndcv4k_mammal <- map2(model_rndcv4k_mammal, 
                                   t.t.mammal_0.2, 
                                   predict.train 
                                   )

test_envcv4k_mammal <- map2(model_envcv4k_mammal, 
                                   t.t.mammal_0.2, 
                                   predict.test 
                                   )


train_rndcv4k_reptile <- map2(model_rndcv4k_reptile, 
                                   t.t.reptile_0.2, 
                                   predict.train 
                                   )

test_rndcv4k_reptile <- map2(model_rndcv4k_reptile, 
                                   t.t.reptile_0.2, 
                                   predict.test 
                                   )

train_rndcv4k_amphibian <- map2(model_rndcv4k_amphibian, 
                                   t.t.amphibian_0.2, 
                                   predict.train 
                                   )

test_rndcv4k_amphibian <- map2(model_rndcv4k_amphibian, 
                                   t.t.amphibian_0.2, 
                                   predict.test 
                                   )


```








```{r}
rmse.train_rndcv4k_mammal <- vector()
for (i in 1:length(train_rndcv4k_mammal)){
 rmse.train_rndcv4k_mammal[i] <- sqrt(sum((1- train_rndcv4k_mammal[[i]])^2) / length(train_rndcv4k_mammal[[i]]))
}

rmse.test_rndcv4k_mammal <- vector()
for (i in 1:length(test_rndcv4k_mammal)){
 rmse.test_rndcv4k_mammal[i] <- sqrt(sum((1- test_rndcv4k_mammal[[i]])^2) / length(test_rndcv4k_mammal[[i]]))
}

rmse.train_spcv4k_mammal <- vector()
for (i in 1:length(train_spcv4k_mammal)){
 rmse.train_spcv4k_mammal[i] <- sqrt(sum((1- train_spcv4k_mammal[[i]])^2) / length(train_spcv4k_mammal[[i]]))
}

rmse.test_spcv4k_mammal <- vector()
for (i in 1:length(test_spcv4k_mammal)){
 rmse.test_spcv4k_mammal[i] <- sqrt(sum((1- test_spcv4k_mammal[[i]])^2) / length(test_spcv4k_mammal[[i]]))
}





rmse.train_rndcv4k_reptile <- vector()
for (i in 1:length(train_rndcv4k_reptile)){
 rmse.train_rndcv4k_reptile[i] <- sqrt(sum((1- train_rndcv4k_reptile[[i]])^2) / length(train_rndcv4k_reptile[[i]]))
}

rmse.test_rndcv4k_reptile <- vector()
for (i in 1:length(test_rndcv4k_reptile)){
 rmse.test_rndcv4k_reptile[i] <- sqrt(sum((1- test_rndcv4k_reptile[[i]])^2) / length(test_rndcv4k_reptile[[i]]))
}

rmse.train_spcv4k_reptile <- vector()
for (i in 1:length(train_spcv4k_reptile)){
 rmse.train_spcv4k_reptile[i] <- sqrt(sum((1- train_spcv4k_reptile[[i]])^2) / length(train_spcv4k_reptile[[i]]))
}

rmse.test_spcv4k_reptile <- vector()
for (i in 1:length(test_spcv4k_reptile)){
 rmse.test_spcv4k_reptile[i] <- sqrt(sum((1- test_spcv4k_reptile[[i]])^2) / length(test_spcv4k_reptile[[i]]))
}

rmse_rndcv4k_reptile <- vector()
for (i in 1:length(rndcv4k_reptile.df)){
 rmse_rndcv4k_reptile[i] <- sqrt(sum((1 - rndcv4k_reptile.df[[i]][,4])^2) / length(rndcv4k_reptile.df[[i]]))
}
```

```{r}
result_mammal <- readr::read_csv("result_mammal.csv")

n.points <- vector()
for(i in 1:length(data.mammal)){n.points[i] <- nrow(data.mammal[[i]]@data)}


result_mammal %>% mutate(rmse.test_rndcv4k = rmse.test_rndcv4k_mammal,
                         rmse.test_spcv4k = rmse.test_spcv4k_mammal,
                         rmse.train_rndcv4k = rmse.train_rndcv4k_mammal,
                         rmse.train_spcv4k = rmse.train_spcv4k_mammal,
                         n.points = n.points) -> result_mammal
readr::write_csv(result_mammal,"result_mammal.csv")


result_reptile <- readr::read_csv("result_reptile.csv")

n.points <- vector()
for(i in 1:length(data.reptile)){n.points[i] <- nrow(data.reptile[[i]]@data)}


result_reptile %>% mutate(rmse.test_rndcv4k = rmse.test_rndcv4k_reptile,
                          rmse.train_rndcv4k = rmse.train_rndcv4k_reptile,
                          rmse.all_rndcv4k = rmse_rndcv4k_reptile
                          ) -> result_reptile
readr::write_csv(result_reptile,"result_reptile.csv")


```





```{r}
qq <- ggplot(data = result_mammal) +
    geom_point(aes(x = rsac_rndcv4k_sph, y = rmse.train_rndcv4k_mammal, color = 1)) +
    geom_smooth(aes(x = rsac_rndcv4k_sph, y= rmse.train_rndcv4k_mammal), method = "lm")

qq <- ggplot(data = result_mammal) +
    geom_point(aes(x = nb_01, y = rmse.train_rndcv4k_mammal, color = 1)) +
    geom_smooth(aes(x = nb_01, y= rmse.train_rndcv4k_mammal), method = "lm") +
    geom_point(aes(x = nb_03, y = rmse.train_rndcv4k_mammal, color = 2)) +
    geom_smooth(aes(x = nb_03, y= rmse.train_rndcv4k_mammal), method = "lm") +
    geom_point(aes(x = nb_05, y = rmse.train_rndcv4k_mammal, color = 3)) +
    geom_smooth(aes(x = nb_05, y= rmse.train_rndcv4k_mammal), method = "lm") +
    geom_point(aes(x = nb_09, y = rmse.train_rndcv4k_mammal, color = 4)) +
    geom_smooth(aes(x = nb_09, y= rmse.train_rndcv4k_mammal), method = "lm")

```


```{r}
readr::write_rds(test_rndcv4k_mammal, file = "train_test/test_rndcv4k_mammal.rds")
readr::write_rds(test_spcv4k_mammal, file = "train_test/test_spcv4k_mammal.rds")
readr::write_rds(train_rndcv4k_mammal, file = "train_test/train_rndcv4k_mammal.rds")
readr::write_rds(train_spcv4k_mammal, file = "train_test/train_spcv4k_mammal.rds")

readr::write_rds(test_rndcv4k_mammal, file = "train_test/test_rndcv4k_mammal")
readr::write_rds(test_spcv4k_mammal, file = "train_test/test_rndcv4k_mammal")
readr::write_rds(train_rndcv4k_mammal, file = "train_test/train_rndcv4k_mammal")
readr::write_rds(train_spcv4k_mammal, file = "train_test/train_spcv4k_mammal")

readr::write_rds(test_rndcv4k_amphibian, file = "train_test/test_rndcv4k_amphibian")
readr::write_rds(train_rndcv4k_amphibian, file = "train_test/train_rndcv4k_amphibian")
```











































```{r predict with model : }
pred <- predict(default_model, data = data, type = "cloglog")
map <- predict(default_model, data = predictors, type = "cloglog")
map <- predict(default_model, data = predictors, type = "cloglog", file = "my_map", format = "GTiff")

p <- data@data[data@pa == 1, ]
pred <- predict(default_model, data = p, type = "cloglog")
tail(pred)
```

```{r}


test_xy_mammal <- list()
for (i in 1:length(t.t.mammal_0.2)){test_xy_mammal[[i]] <-
t.t.mammal_0.2[[i]][[2]]@coords %>% mutate(., 
                                           prediction = test_rndcv4k_mammal[[i]],
                                           pa = t.t.mammal_0.2[[i]][[2]]@pa) %>%
  filter(., pa == 1)

}

for (i in 1:length(test_xy_mammal)){
  write_csv(test_xy_mammal[[i]], file = paste0("model/test_xy_",t.t.mammal_0.2[[i]][[2]]@species,".csv"
  ))}

# add residual col

for (i in 1:length(test_xy_mammal)){
  test_xy_mammal[[i]] <- test_xy_mammal[[i]] %>% mutate(., 
                                 residual.1 = 1 - prediction)
}

for (i in 1:length(test_xy_reptile)){
  test_xy_reptile[[i]] <- test_xy_reptile[[i]] %>% mutate(., 
                                 residual.1 = 1 - prediction)
}

##

# fix sequence
for (i in 1:length(test_xy_mammal)){
  test_xy_mammal[[i]] <- test_xy_mammal[[i]][,c(1,2,3,5,4)]
}

for (i in 1:length(test_xy_reptile)){
  test_xy_reptile[[i]] <- test_xy_reptile[[i]][,c(1,2,3,5,4)]
}


#### reptile

test_rndcv4k_reptile <- list()
for (i in 1:length(model_rndcv4k_reptile)){
  test_rndcv4k_reptile[[i]] <- SDMtune::predict(model_rndcv4k_reptile[[i]],
                                               data = t.t.reptile_0.2[[i]][[2]],
                                               type = "cloglog")
}
test_xy_reptile <- list()
for (i in 1:length(t.t.reptile_0.2)){test_xy_reptile[[i]] <-
t.t.reptile_0.2[[i]][[2]]@coords %>% mutate(., 
                                           prediction = test_rndcv4k_reptile[[i]],
                                           pa = t.t.reptile_0.2[[i]][[2]]@pa) %>%
  filter(., pa == 1)

}

for (i in 1:length(test_xy_reptile)){
  write_csv(test_xy_reptile[[i]], file = paste0("model/test_xy_",t.t.reptile_0.2[[i]][[2]]@species,".csv"
                                               ))}
```

```{r}
cat("Training auc: ", auc(maxnet_model))
cat("Testing auc: ", auc(maxnet_model, test = test))

output <- data.frame(matrix(NA, nrow = 10, ncol = 3)) # Create an empty data.frame
colnames(output) <- c("seed", "trainAUC", "testAUC")
set.seed(25)
seeds <- sample.int(1000, 10) # Create 10 different random seeds
for (i in 1:length(seeds)) { # Loop through the seeds
  c(train, test) %<-% trainValTest(data, test = 0.2, seed = seeds[i], only_presence = TRUE) # Make the train/test split
  m <- train("Maxnet", data = train) # train the model
  # Populate the output data.frame
  output[i, 1] <- seeds[i]
  output[i, 2] <- auc(m)
  output[i, 3] <- auc(m, test = test)
}
```

```{r}
t.t.reptile_0.2 <- list()
for (i in 1:length(data.reptile)){t.t.reptile_0.2[[i]] <- trainValTest(data.reptile[[i]], test = 0.2, only_presence = TRUE, seed = 4839)}

rnd4k <- function(x){randomFolds(x[[1]], 
                                 k = 4,
                                 only_presence = TRUE,
                                 seed = 3668)}

folds.rnd4k_reptile <- map(t.t.reptile_0.2, rnd4k)

#h32 67-76
t.t.reptile_0.2.h32 <- list()
for (i in 67:76){
t.t.reptile_0.2.h32[[i-66]] <- t.t.reptile_0.2[[i]]
}

folds.rnd4k_reptile.h32 <- list()
for (i in 67:76){
folds.rnd4k_reptile.h32[[i-66]] <- folds.rnd4k_reptile[[i]]
}

maxnet.train <- function(x, y){train("Maxnet",
                                data = x[[1]],
                                folds = y)}

moedl_rndcv4k_reptile.h32 <- furrr::future_map2(t.t.reptile_0.2.h32, folds.rnd4k_reptile.h32, maxnet)

# h1
t.t.reptile_0.2.h1 <- list()
for (i in 15:25){
t.t.reptile_0.2.h1[[i-14]] <- t.t.reptile_0.2[[i]]
}

folds.rnd4k_reptile.h1 <- list()
for (i in 15:25){
folds.rnd4k_reptile.h1[[i-14]] <- folds.rnd4k_reptile[[i]]
}

moedl_rndcv4k_reptile.h1 <- furrr::future_map2(t.t.reptile_0.2.h1, folds.rnd4k_reptile.h1, maxnet)
```

```{r t.t.amphibian}
t.t.amphibian_0.2 <- list()
for (i in 1:length(data.amphibian)){t.t.amphibian_0.2[[i]] <- trainValTest(data.amphibian[[i]], test = 0.2, only_presence = TRUE, seed = 4839)}

rnd4k <- function(x){randomFolds(x[[1]], 
                                 k = 4,
                                 only_presence = TRUE,
                                 seed = 3668)}

folds.rnd4k_amphibian <- map(t.t.amphibian_0.2, rnd4k)
```

```{r}


h <- list(reg = seq(0.2, 1, 0.1))
exp_1 <- gridSearch(model, hypers = h, metric = "auc", test = val)
```
```{r it's modeling time dismo::kfold}

aves_na_TF <- map_lgl(extract_spatial_aves_furrr, na.omit)

fold5 <- function(x){kfold(x, k=5)}
fold4 <- function(x){kfold(x, k=4)}


fold5_amphibian <- map(list_spatial_amphibian, fold5)
fold5_aves <- map(list_spatial_aves, fold5)
fold5_mammal <- map(list_spatial_mammal_na, fold5)
fold5_reptile <- map(list_spatial_reptile, fold5)

test_fold5_amphibian <- list()
for (i in seq_along(1:length(list_spatial_amphibian))){ 
                      test_fold5_amphibian[[i]] <- list_spatial_amphibian[[i]][fold5_amphibian[[i]] == 1, ]}

test_fold5_aves <- list()
for (i in seq_along(1:length(list_spatial_aves))){ 
                      test_fold5_aves[[i]] <- list_spatial_aves[[i]][fold5_aves[[i]] == 1, ]}

test_fold5_mammal <- list()
for (i in seq_along(1:length(list_spatial_mammal))){ 
                      test_fold5_mammal[[i]] <- list_spatial_mammal_na[[i]][fold5_mammal[[i]] == 1, ]}

train_fold5_amphibian <- list()
for (i in seq_along(1:length(list_spatial_amphibian))){ 
                      train_fold5_amphibian[[i]] <- list_spatial_amphibian[[i]][fold5_amphibian[[i]] != 1, ]}

train_fold5_reptile <- list()
for (i in seq_along(1:length(list_spatial_reptile))){ 
                      train_fold5_reptile[[i]] <- list_spatial_reptile[[i]][fold5_reptile[[i]] != 1, ]}

train_fold5_mammal <- list()
for (i in seq_along(1:length(list_spatial_mammal_na))){ 
                      train_fold5_mammal[[i]] <- list_spatial_mammal_na[[i]][fold5_mammal[[i]] != 1, ]}

```

```{r save the model}
map(train_fold5_reptile, sp::as.)
writeOGR(train_fold5_mammal[[1]], dsn = getwd(), driver = "ESRI Shapefile")

savemodel <- function(x){save(x, file = model_mammal_names)}

map(model_mammal_maxent, savemodel)

model_mammal_names <- paste0("E:/model/mammal/model_",sci_MAMMAL,".rda")


for (i in 1:51){save(model_mammal_maxent[[i]], file =  model_mammal_names[[i]])}

save(model_mammal_maxent[[1]], file = model_mammal_names[1])

saveRDS(model_mammal_maxent, file = "E:/gmm.rda")

save(model_mammal_maxent, list = model_mammal_names, file = "E:/model")

```

```{r it's modeling time: dismo::maxent}

model_amphibian_maxent <-  map2(bios_amphibian ,train_fold5_amphibian, maxent)

model_aves_maxent <- map2(bios_aves, train_fold5_aves, maxent)



model_mammal_maxent <- future_map2(bios_mammal, train_fold5_mammal, maxent)
#Error in .local(x, p, ...) : only got:1random background point values; is there a layer with many NA values?


bios_mammal <- bios_mammal


model_reptile_maxent <- map2(bios_reptile, train_fold5_reptile, maxent)

```

```{r what was important varibles}
map(model_amphibian_maxent, plot)
map(model_aves_maxent, plot)
map(model_mammal_maxent, plot)
```

```{r AUC, ROC, }
rocplot <- function(x){plot(x, 'ROC')} 

```

```{r it's modeling time: dismo::predict}
```

```{r random points for background}
randompoints_amp1 <- randomPoints(bios_amphibian[[1]], 1000)
randompoints_ave1 <- randomPoints(aves_bios[[1]], 1000)

```

```{r }
# extract test point and make it data frame
pointdf_test_fold5_amphibian <- map2(bios_amphibian, test_fold5_amphibian, raster::extract) %>% map(data.frame)
pointdf_test_fold5_aves <- map2(aves_bios, test_fold5_aves, raster::extract) %>% map(data.frame)
pointdf_test_fold5_mammal <- map2(bios_mammal, test_fold5_mammal, raster::extract) %>% map(data.frame)

point_test_fold5_mammal <- map2(bios_mammal, test_fold5_mammal_sf, raster::extract)




#remove god damn NAs... 
extractNA_test_fold5_mammal <- map(test_fold5_mammal_sf,na.omit)



# predict = model + test data
predict <- dismo::predict()

predict_amphibian_maxent <- map2(model_amphibian_maxent, pointdf_test_fold5_amphibian, predict)
predict_aves_maxent <- map2(model_aves_maxent, pointdf_test_fold5_aves, predict) 
predict_mammal_maxent <- map2(model_mammal_maxent, pointdf_test_fold5_mammal, predict)


# as data frame
pred_df_amp <- map(predict_amphibian_maxent, as.data.frame)
pred_df_amp <- map(pred_df_amp) %>% mutate()
pred_df_ave <- map(predict_aves_maxent, as.data.frame)
pred_df_mam <- map(predict_mammal_maxent, as.data.frame)

#save it for future
predict_amphibian_names <- paste0("E:/pred/amphibian/predict_", list_origin_amphibian, ".csv")
predict_aves_names <- paste0("E:/pred/aves/predict_", list_origin_aves, ".csv")

map2(pred_df_amp, predict_amphibian_names, write_csv)
map2(pred_df_ave, predict_aves_names, write_csv)


hist(predict_mammal_maxent[[1]])
```
```{r}
map(predict_mammal_maxent, hist)
```

```{r predict don't have xy. prediction sp to sf, }
as(test_fold5_mammal[[1]], "sf")

test_fold5_mammal_sf <- map2(test_fold5_mammal, "sf", as)

test_fold5_mammal_sf <- test_fold5_mammal_sf %>% map2(point_test_fold5_mammal, mutate)

#convert df and give variable name "pred"
predict_mammal_maxent <- map(predict_mammal_maxent, as.data.frame)

rename_pred <- function(x){rename(x, "pred" = ".x[[i]]")}

predict_mammal_maxent <- map(predict_mammal_maxent, rename_pred)

sf_pred_fold5_mammal <- extractNA_test_fold5_mammal %>% map2(predict_mammal_maxent, mutate)

sf_pred_fold5_mammal <- sf_pred_fold5_mammal %>% map(mutate)

#bio, pred, resid. ALL WE NEED.

sf_resid_fold5_mammal <- list()
for (i in seq_along(1:length(sf_pred_fold5_mammal))){
  sf_resid_fold5_mammal[[i]] <- mutate(sf_pred_fold5_mammal[[i]], residual_1 = 1 - pred,
                                  residual_0.9 = 0.9 - pred,
                                  residual_0.8 = 0.8 - pred,
                                  residual_0.7 = 0.7 - pred,
                                  residual_0.6 = 0.6 - pred,
                                  residual_0.5 = 0.5 - pred)
}





```








add background 
```{r}
numb.back.mammal <- vector()
for(i in 1:length(data.mammal)){
  numb.back.mammal[i] <- sum(data.mammal[[i]]@pa==0)
}
```


```{r}
for(i in 1:length(folds.env_mammal)){
  folds.env_mammal[[i]]$folds[[1]][[1]][length(folds.env_mammal[[1]]$folds[[1]][[1]])+1:length(folds.env_mammal[[1]]$folds[[1]][[1]])+numb.back.mammal[1]] <- 3661:7463
  folds.env_mammal[[1]]$folds[[1]][[2]][3661:7463] <- 3661:7463
  
  folds.env_mammal[[1]]$folds[[2]][[1]][3661:7463] <- 3661:7463
  folds.env_mammal[[1]]$folds[[2]][[2]][3661:7463] <- 3661:7463
  
  folds.env_mammal[[1]]$folds[[3]][[1]][3661:7463] <- 3661:7463
  folds.env_mammal[[1]]$folds[[3]][[2]][3661:7463] <- 3661:7463
  
  folds.env_mammal[[1]]$folds[[4]][[1]][3661:7463] <- 3661:7463
  folds.env_mammal[[1]]$folds[[4]][[2]][3661:7463] <- 3661:7463


```



```{r}
my.env.block <- function (rasterLayer, speciesData, species = NULL, k = 5, standardization = "normal", 
          rasterBlock = TRUE, sampleNumber = 10000, biomod2Format = TRUE, 
          numLimit = 0, verbose = TRUE, ext) 
{
  if (methods::is(speciesData, "SpatialPoints")) {
    speciesData <- sf::st_as_sf(speciesData)
  }
  else if (!methods::is(speciesData, "sf")) {
    stop("speciesData should be a sf or SpatialPoints object")
  }
  if (!is.null(species)) {
    if (species %in% colnames(speciesData) == FALSE) {
      warning("There is no match between the columns name in 'speciesData' and 'species' argument (the response variable).\n")
      species <- NULL
    }
  }
  if (methods::is(rasterLayer, "Raster")) {
    if (raster::nlayers(rasterLayer) >= 1) {
      foldList <- list()
      foldNum <- rep(NA, nrow(speciesData))
      biomodTable <- data.frame(RUN1 = rep(TRUE, nrow(speciesData)))
      if (standardization == "standard") {
        rasterLayer <- standardize(rasterLayer)
      }
      else if (standardization == "normal") {
        rasterLayer <- normalize(rasterLayer)
      }
      else if (standardization == "none" || is.null(standardization)) {
        rasterLayer <- rasterLayer
      }
      if (rasterBlock == TRUE) {
        ext <- raster::extract(rasterLayer, speciesData)
        if (anyNA(ext)) {
          stop("The input raster layer does not cover all the species points.")
        }
        if (raster::ncell(rasterLayer) < 10 * sampleNumber) {
          rp <- length(which(!is.na(raster::values(rasterLayer[[1]]))))
          if (rp < sampleNumber) {
            sampleNumber <- rp
            message("The sampleNumber reduced to ", 
                    sampleNumber, "; the total number of available cells.\n")
          }
        }
        sampr <- raster::sampleRandom(rasterLayer, size = sampleNumber)
        sampr <- sampr[stats::complete.cases(sampr), 
        ]
        sampr <- rbind(ext, sampr)
        kms <- stats::kmeans(sampr, centers = k, iter.max = 500, 
                             nstart = 25)
        speciesData$fold <- kms$cluster[seq_len(nrow(speciesData))]
      }
      else {
        
        if (anyNA(ext)) {
          stop("The input raster layer does not cover all the species points.")
        }
        kms <- stats::kmeans(ext, centers = k, iter.max = 500, 
                             nstart = 25)
        speciesData$fold <- kms$cluster
      }
      if (is.null(species)) {
        trainTestTable <- data.frame(train = rep(0, 
                                                 k), test = 0)
      }
      else {
        cl <- sort(unique(speciesData[, species, drop = TRUE]))
        clen <- length(cl)
        trainTestTable <- as.data.frame(matrix(0, nrow = k, 
                                               ncol = clen * 2))
        names(trainTestTable) <- c(paste("train", cl, 
                                         sep = "_"), paste("test", cl, sep = "_"))
      }
      for (i in seq_len(k)) {
        testSet <- which(speciesData$fold == i)
        trainSet <- which(speciesData$fold != i)
        foldNum[testSet] <- i
        foldList[[i]] <- assign(paste0("fold", i), list(trainSet, 
                                                        testSet))
        if (is.null(species)) {
          trainTestTable$train[i] <- length(trainSet)
          trainTestTable$test[i] <- length(testSet)
        }
        else {
          countrain <- table(speciesData[trainSet, species, 
                                         drop = TRUE])
          countest <- table(speciesData[testSet, species, 
                                        drop = TRUE])
          trainTestTable[i, which(cl %in% names(countrain))] <- countrain
          trainTestTable[i, clen + which(cl %in% names(countest))] <- countest
        }
        if (biomod2Format == TRUE) {
          colm <- paste0("RUN", i)
          biomodTable[, colm] <- FALSE
          biomodTable[trainSet, colm] <- TRUE
        }
      }
      if (any(trainTestTable <= numLimit)) {
        zerofolds <- which(apply(trainTestTable, 1, 
                                 function(x) any(x <= numLimit)))
        if (length(zerofolds) > 1) {
          warning("The folds ", paste(zerofolds, collapse = ", "), 
                  " have class(es) with ", numLimit, " or less records")
        }
        else {
          warning("The fold ", zerofolds, " has class(es) with ", 
                  numLimit, " or less records")
        }
      }
      if (biomod2Format == TRUE) {
        biomodTable <- as.matrix(biomodTable)
        theList <- list(folds = foldList, foldID = foldNum, 
                        biomodTable = biomodTable, k = k, species = species, 
                        records = trainTestTable)
      }
      else {
        theList <- list(folds = foldList, foldID = foldNum, 
                        biomodTable = NULL, k = k, species = species, 
                        records = trainTestTable)
      }
    }
    else stop("'The raster layer is empty!'")
  }
  else stop("The input file is not a valid R raster file")
  if (verbose) 
    print(trainTestTable)
  class(theList) <- c("EnvironmentalBlock")
  return(theList)
}

```

case 1. 

3 climate variable from PC1, PC2, PC3, PC4


```{r}
library(FactoMineR)

PCA_mammal <- list()
for (i in 1:length(data.mammal)){
  PCA_mammal[[i]] <- PCA(data.mammal[[i]]@data)
} 

PCA_mammal.contrib3 <- vector()
for(i in 1:length(PCA_mammal)){
  PCA_mammal.contrib3[i] <- PCA_mammal[[i]]$eig[3,3]
}

PCA_mammal.contrib3
```

```{r}
PCA1234_mammal <- list()
for(i in 1:length(PCA_mammal)){
  PCA1234_mammal[[i]] <- c(names(tail(sort(PCA_mammal[[i]]$var$cos2[,1]), 1)),
                       names(tail(sort(PCA_mammal[[i]]$var$cos2[,2]), 1)),
                       names(tail(sort(PCA_mammal[[i]]$var$cos2[,3]), 1)),
                       names(tail(sort(PCA_mammal[[i]]$var$cos2[,4]), 1)))
}

factoextra::fviz_pca_var(PCA_mammal[[1]], repel = TRUE)


```


```{r}
library(vegan)
library(geosphere)
```


PCNM. Spatial filter

```{r}

geodistm <- function(x){as.dist(geosphere::distm(x@coords, fun = distGeo))}

distm_mammal <- list()
for(i in 1:3){
  distm_mammal[[i]] <- geodistm(data.mammal[[i]])
}


distm_mammal[[1]] <- geodistm(data.mammal[[1]])
distm_mammal[[2]] <- geodistm(data.mammal[[2]])
distm_mammal[[3]] <- geodistm(data.mammal[[3]])
distm_mammal[[4]] <- geodistm(data.mammal[[4]])
distm_mammal[[5]] <- geodistm(data.mammal[[5]])
distm_mammal[[6]] <- geodistm(data.mammal[[6]])
b <- as.dist(geosphere::distm(a, fun = distGeo))

b <- parDist(as.matrix(data.mammal[[3]]@coords), method = "euclidean")

parallelDist::parDist
geosphere::distGeo()
geosphere::distm()

# RcppArmadillo is used as dependency
library(RcppArmadillo)
# Use RcppXPtrUtils for simple usage of C++ external pointers
library(RcppXPtrUtils)
# compile user-defined function and return pointer (RcppArmadillo is used as dependency)
euclideanFuncPtr <- cppXPtr(
"double customDist(const arma::mat &A, const arma::mat &B) {
  return sqrt(arma::accu(arma::square(A - B)));
}", depends = c("RcppArmadillo"))
# distance matrix for user-defined euclidean distance function
# (note that method is set to "custom")
parDist(matrix(1:16, ncol=2), method="custom", func = euclideanFuncPtr)


distm_mammal <- future_map(data.mammal, geodistm)
distm_mammal <- as.dist()

```


```{r}
library(bigmemory)
library(bigdist)
library(disk.frame)
library(parallelDist)



a <- data.mammal[[3]]@coords 
 data.frame(label = 1:nrow(a),
                 latitude = a$Y,
                 longitude = a$X) -> a
 
write_tsv(a, "abc.txt")

a <- as.disk.frame(a, overwrite = T)

a[12,2]
```
```{r}
big.mammal.3 <- bigdist::bigdist(as.matrix(data.mammal[[3]]@coords), file = file.path("D:", "mammal.4"), method = "euclidean")
```


```{r}
library(parallel)
cl <- makePSOCKcluster(30)
setDefaultCluster(cl)
adder <- function(a, b) a + b
clusterExport(NULL, c('adder'))
parLapply(NULL, 1:8, function(z) adder(z, 100))

clusterEvalQ(NULL, library(MASS))
```







```{r}

```



###############################################
variable selection with PCNM

```{r}
SDMtune::varSel(model = ,metric = "auc",bg4cor = ,)
```

```{r}
maxent.train <- function(x, y){SDMtune::train("Maxent",
                                               data = x[[1]],
                                               folds = y)}

maxent.a1 <- maxent.train(data.amphibian.test, folds[[1]])

SDMtune::maxentVarImp()

```

# Spatial Dependency

```{r}
library(tidyverse)
library(spdep)
```
```{r}
library(furrr)
future::plan(multisession, workers = 30)
```


```{r}
train_rndcv4k_mammal <- readr::read_rds(file = "train_test/train_rndcv4k_mammal.rds")
test_rndcv4k_mammal <- readr::read_rds(file = "train_test/test_rndcv4k_mammal.rds")
train_spcv4k_mammal <- readr::read_rds(file = "train_test/train_spcv4k_mammal.rds")
test_spcv4k_mammal <- readr::read_rds(file = "train_test/test_spcv4k_mammal.rds")

t.t.mammal_0.2 <- readr::read_rds(file = "t.t/t.t.mammal_0.2.rds")


train_rndcv4k_reptile <- readr::read_rds(file = "train_test/train_rndcv4k_reptile.rds")
test_rndcv4k_reptile <- readr::read_rds(file = "train_test/test_rndcv4k_reptile.rds")
t.t.reptile_0.2 <- readr::read_rds(file = "t.t/t.t.reptile_0.2.rds")

train_rndcv4k_amphibian <- readr::read_rds(file = "train_test/train_rndcv4k_amphibian.rds")
test_rndcv4k_amphibian <- readr::read_rds(file = "train_test/test_rndcv4k_amphibian.rds")
t.t.amphibian_0.2 <- readr::read_rds(file = "t.t/t.t.amphibian_0.2.rds")

```

it's hell
```{r}
rndcv4k_mammal.df <- list()
for(i in 1:length(train_rndcv4k_mammal.df)){
rndcv4k_mammal.df[[i]] <- dplyr::bind_rows(train_rndcv4k_mammal.df[[i]], test_rndcv4k_mammal.df[[i]])
}

rndcv4k_reptile.df <- list()
for(i in 1:length(train_rndcv4k_reptile.df)){
rndcv4k_reptile.df[[i]] <- dplyr::bind_rows(train_rndcv4k_reptile.df[[i]], test_rndcv4k_reptile.df[[i]])
}

sf_rndcv4k_mammal <- map(rndcv4k_mammal.df, sf_xy)


sf_rndcv4k_reptile <- map(rndcv4k_reptile.df, sf_xy)

vario_rndcv4k_mammal <- future_map(sf_rndcv4k_mammal, vario_resid, 
                                .options = furrr_options(seed = TRUE),
                                .progress = T)

vario_rndcv4k_reptile <- future_map(sf_rndcv4k_reptile, vario_resid, 
                                .options = furrr_options(seed = TRUE),
                                .progress = T)

sf_rndcv4k_reptile.good <- list()
sf_rndcv4k_reptile.good <- sf_rndcv4k_reptile[c(2,4,5,7,12,14,17,20,22,23,
                                                25,26,27,28,29,30,32,33,36,37,
                                                39,40,41,43,44,47,48,49,52,57,
                                                61,63,64,66,73,74,75,80,81,86,
                                                87,89,91,93)]

range.vm.sph.4kR.good <- list()
range.vm.sph.4kR.good <- range.vm.sph.4kR[c(2,4,5,7,12,14,17,20,22,23,
                                                25,26,27,28,29,30,32,33,36,37,
                                                39,40,41,43,44,47,48,49,52,57,
                                                61,63,64,66,73,74,75,80,81,86,
                                                87,89,91,93)]






dnn.sph.4kR.good <- furrr::future_map2(sf_rndcv4k_reptile.good, 
                                       range.vm.sph.4kR.good, 
                                       dnn,
                                       .options = furrr_options(seed = TRUE),
                                       .progress = T)

listw_reptile.good <- furrr::future_map(dnn.sph.4kR.good, 
                                           nb2listw_zero, 
                                           .options = furrr_options(seed = TRUE),
                                           .progress = T)


moran_rndsph_reptile   <- future_map2(sf_rndcv4k_reptile.good, 
                         listw_reptile.good, 
                         my.moran.test, 
                         .options = furrr_options(seed = TRUE),
                         .progress = T)

```


```{r}
train_rndcv4k_mammal.df <- list()
for(i in 1:length(train_rndcv4k_mammal)){
train_rndcv4k_mammal.df[[i]] <- slice(data.frame(prediction = train_rndcv4k_mammal[[i]],
                                                long = t.t.mammal_0.2[[i]][[1]]@coords[,1],
                                                lat = t.t.mammal_0.2[[i]][[1]]@coords[,2],
                                                residual = 1 - train_rndcv4k_mammal[[i]])
                                                , 1:sum(t.t.mammal_0.2[[i]][[1]]@pa == 1))
}


test_rndcv4k_mammal.df <- list()
for(i in 1:length(test_rndcv4k_mammal)){
test_rndcv4k_mammal.df[[i]] <- slice(data.frame(prediction = test_rndcv4k_mammal[[i]],
                                   long = t.t.mammal_0.2[[i]][[2]]@coords[,1],
                                   lat = t.t.mammal_0.2[[i]][[2]]@coords[,2],
                                   residual = 1 - test_rndcv4k_mammal[[i]])
                                   , 1:sum(t.t.mammal_0.2[[i]][[2]]@pa == 1))
}



train_rndcv4k_reptile.df <- list()
for(i in 1:length(train_rndcv4k_reptile)){
train_rndcv4k_reptile.df[[i]] <- slice(data.frame(prediction = train_rndcv4k_reptile[[i]],
                                                long = t.t.reptile_0.2[[i]][[1]]@coords[,1],
                                                lat = t.t.reptile_0.2[[i]][[1]]@coords[,2],
                                                residual = 1 - train_rndcv4k_reptile[[i]])
                                                , 1:sum(t.t.reptile_0.2[[i]][[1]]@pa == 1))
}


test_rndcv4k_reptile.df <- list()
for(i in 1:length(test_rndcv4k_reptile)){
test_rndcv4k_reptile.df[[i]] <- slice(data.frame(prediction = test_rndcv4k_reptile[[i]],
                                   long = t.t.reptile_0.2[[i]][[2]]@coords[,1],
                                   lat = t.t.reptile_0.2[[i]][[2]]@coords[,2],
                                   residual = 1 - test_rndcv4k_reptile[[i]])
                                   , 1:sum(t.t.reptile_0.2[[i]][[2]]@pa == 1))
}


train_rndcv4k_amphibian.df <- list()
for(i in 1:length(train_rndcv4k_amphibian)){
train_rndcv4k_amphibian.df[[i]] <- slice(data.frame(prediction = train_rndcv4k_amphibian[[i]],
                                                long = t.t.amphibian_0.2[[i]][[1]]@coords[,1],
                                                lat = t.t.amphibian_0.2[[i]][[1]]@coords[,2],
                                                residual = 1 - train_rndcv4k_amphibian[[i]])
                                                , 1:sum(t.t.amphibian_0.2[[i]][[1]]@pa == 1))
}


test_rndcv4k_amphibian.df <- list()
for(i in 1:length(test_rndcv4k_amphibian)){
test_rndcv4k_amphibian.df[[i]] <- slice(data.frame(prediction = test_rndcv4k_amphibian[[i]],
                                   long = t.t.amphibian_0.2[[i]][[2]]@coords[,1],
                                   lat = t.t.amphibian_0.2[[i]][[2]]@coords[,2],
                                   residual = 1 - test_rndcv4k_amphibian[[i]])
                                   , 1:sum(t.t.amphibian_0.2[[i]][[2]]@pa == 1))
}





```




```{r semivariogram}
library(gstat)

vario_pred <- function(x){gstat::variogram(prediction~1, x)}
vario_resid <- function(x){gstat::variogram(residual~1, x)}

sf_xy <- function(x){sf::st_as_sf(x, coords = c("long", "lat"), crs = 4326)}
sf_train_rndcv4k_mammal <- map(train_rndcv4k_mammal.df, sf_xy)
sf_test_rndcv4k_mammal <- map(test_rndcv4k_mammal.df, sf_xy)

vario_rndcv4k_mammal <- future_map(sf_test_rndcv4k_mammal, vario_resid, 
                                .options = furrr_options(seed = TRUE),
                                .progress = T)

sf_train_rndcv4k_reptile <- map(train_rndcv4k_reptile.df, sf_xy)
sf_test_rndcv4k_reptile <- map(test_rndcv4k_reptile.df, sf_xy)

vario_rndcv4k_reptile <- future_map(sf_test_rndcv4k_reptile, vario_resid, 
                                .options = furrr_options(seed = TRUE),
                                .progress = T)

sf_train_rndcv4k_amphibian <- map(train_rndcv4k_amphibian.df, sf_xy)
sf_test_rndcv4k_amphibian <- map(test_rndcv4k_amphibian.df, sf_xy)

vario_rndcv4k_amphibian <- future_map(sf_test_rndcv4k_amphibian, vario_resid, 
                                .options = furrr_options(seed = TRUE),
                                .progress = T)



####
plot_variogram <- function(v, m) {
  preds = variogramLine(m, maxdist = max(v$dist))
  ggplot() + 
    geom_point(data = v, aes(x = dist, y = gamma, size=np)) +
    geom_line(data = preds, aes(x = dist, y = gamma)) +
    theme(legend.key.size = unit(0.00005, 'cm'))
}

v <- variogram(zinc ~ 1, meuse)
m <- fit.variogram(v, vgm(c("Exp", "Sph")))
plot_variogram(v, m) 
###

vario.plot.4km.sph <- map2(vario_rndcv4k_mammal, vmcv4k.sph_mammal, plot_variogram)
vario.plot.4km.gau <- map2(vario_mammal_cv4k, vmcv4k.gau_mammal, plot_variogram)
vario.plot.4km.exp <- map2(vario_mammal_cv4k, vmcv4k.exp_mammal, plot_variogram)
vario.plot.4km.mat <- map2(vario_mammal_cv4k, vmcv4k.mat_mammal, plot_variogram)
vario.plot.4km.exc <- map2(vario_mammal_cv4k, vmcv4k.exc_mammal, plot_variogram)
vario.plot.4km.cir <- map2(vario_mammal_cv4k, vmcv4k.cir_mammal, plot_variogram)
vario.plot.4km.lin <- map2(vario_mammal_cv4k, vmcv4k.lin_mammal, plot_variogram)
vario.plot.4km.bes <- map2(vario_mammal_cv4k, vmcv4k.bes_mammal, plot_variogram)
vario.plot.4km.pen <- map2(vario_mammal_cv4k, vmcv4k.pen_mammal, plot_variogram)
vario.plot.4km.per <- map2(vario_mammal_cv4k, vmcv4k.per_mammal, plot_variogram)
vario.plot.4km.wav <- map2(vario_mammal_cv4k, vmcv4k.wav_mammal, plot_variogram)
vario.plot.4km.hol <- map2(vario_mammal_cv4k, vmcv4k.hol_mammal, plot_variogram)
vario.plot.4km.spl <- map2(vario_mammal_cv4k, vmcv4k.spl_mammal, plot_variogram)
vario.plot.4km.leg <- map2(vario_mammal_cv4k, vmcv4k.leg_mammal, plot_variogram)
vario.plot.4km.err <- map2(vario_mammal_cv4k, vmcv4k.err_mammal, plot_variogram)



#ggplot variogram
gg.vario <- function(x){ggplot(x,aes(x=dist,y=gamma,size=np)) + geom_point()}

vario.plot.4km.sph <- map(vario_mammal_cv4k, gg.vario)


#Check variogram


vario_sph <- function(x){fit.variogram(x, vgm("Sph"))}
vario_exp <- function(x){fit.variogram(x, vgm("Exp"))}
vario_gau <- function(x){fit.variogram(x, vgm("Gau"))}
vario_mat <- function(x){fit.variogram(x, vgm("Mat"))}
vario_exc <- function(x){fit.variogram(x, vgm("Exc"))}
vario_stemat <- function(x){fit.variogram(x, vgm("Ste Mat"))}
vario_cir <- function(x){fit.variogram(x, vgm("Cir"))}
vario_lin <- function(x){fit.variogram(x, vgm("Lin"))}
vario_bes <- function(x){fit.variogram(x, vgm("Bes"))}
vario_pen <- function(x){fit.variogram(x, vgm("Pen"))}
vario_per <- function(x){fit.variogram(x, vgm("Per"))}
vario_wav <- function(x){fit.variogram(x, vgm("Wav"))}
vario_hol <- function(x){fit.variogram(x, vgm("Hol"))}
vario_log <- function(x){fit.variogram(x, vgm("Log"))}
vario_pow <- function(x){fit.variogram(x, vgm("Pow"))}
vario_spl <- function(x){fit.variogram(x, vgm("Spl"))}
vario_leg <- function(x){fit.variogram(x, vgm("Leg"))}
vario_err <- function(x){fit.variogram(x, vgm("Err"))}
vario_int <- function(x){fit.variogram(x, vgm("Int"))}


vmcv4k.sph_mammal <- map(vario_rndcv4k_mammal, vario_sph)
vmcv4k.exp_mammal <- map(vario_mammal_cv4k, vario_exp)
vmcv4k.gau_mammal <- map(vario_mammal_cv4k, vario_gau)
vmcv4k.mat_mammal <- map(vario_mammal_cv4k, vario_mat)
vmcv4k.exc_mammal <- map(vario_mammal_cv4k, vario_exc)
vmcv4k.stemat_mammal <- map(vario_mammal_cv4k, vario_stemat)
vmcv4k.cir_mammal <- map(vario_mammal_cv4k, vario_cir)
vmcv4k.lin_mammal <- map(vario_mammal_cv4k, vario_lin)
vmcv4k.bes_mammal <- map(vario_mammal_cv4k, vario_bes)
vmcv4k.pen_mammal <- map(vario_mammal_cv4k, vario_pen)
vmcv4k.per_mammal <- map(vario_mammal_cv4k, vario_per)
vmcv4k.wav_mammal <- map(vario_mammal_cv4k, vario_wav)
vmcv4k.hol_mammal <- map(vario_mammal_cv4k, vario_hol)
vmcv4k.log_mammal <- map(vario_mammal_cv4k, vario_log)
vmcv4k.pow_mammal <- map(vario_mammal_cv4k, vario_pow)
vmcv4k.spl_mammal <- map(vario_mammal_cv4k, vario_spl)
vmcv4k.leg_mammal <- map(vario_mammal_cv4k, vario_leg)
vmcv4k.err_mammal <- map(vario_mammal_cv4k, vario_err)
vmcv4k.int_mammal <- map(vario_mammal_cv4k, vario_int)

range.vm.sph.4kM <- map(vmcv4k.sph_mammal, c(3,2))

vmcv4k.sph_reptile <- map(vario_rndcv4k_reptile, vario_sph)
range.vm.sph.4kR <- map(vmcv4k.sph_reptile, c(3,2))

vmcv4k.sph_amphibian <- map(vario_rndcv4k_amphibian, vario_sph)
range.vm.sph.4kA <- map(vmcv4k.sph_amphibian, c(3,2))


range.vm.sph.4kM <- data.frame(range = unlist(map(vmcv4k.sph_mammal, c(3,2))))
range.vm.exp.4kM <- data.frame(range = unlist(map(vmcv4k.exp_mammal, c(3,2))))
range.vm.gau.4kM <- data.frame(range = unlist(map(vmcv4k.gau_mammal, c(3,2))))
range.vm.mat.4kM <- data.frame(range = unlist(map(vmcv4k.mat_mammal, c(3,2))))

plot.vario.sph <- function(x){plot(x, model=fit.variogram(x, vgm("Sph")))}
plot.vario.exp <- function(x){plot(x, model=fit.variogram(x, vgm("Exp")))}
plot.vario.gau <- function(x){plot(x, model=fit.variogram(x, vgm("Gau")))}
plot.vario.mat <- function(x){plot(x, model=fit.variogram(x, vgm("Mat")))}

vario.plot.4km.sph <- map(vario_mammal_cv4k, plot.vario.sph)
vario.plot.4km.gau <- map(vario_mammal_cv4k, plot.vario.gau)
vario.plot.4km.sph <- map(vario_mammal_cv4k, plot.vario)
vario.plot.4km.sph <- map(vario_mammal_cv4k, plot.vario)

vario.plot.4kR.sph <- map(vario_rndcv4k_reptile, plot.vario.sph)

library(gridExtra)

a<- grid.arrange(vario.plot.4km.sph[[1]], vario.plot.4km.sph[[2]], vario.plot.4km.sph[[3]], vario.plot.4km.sph[[4]],vario.plot.4km.sph[[5]], vario.plot.4km.sph[[6]],vario.plot.4km.sph[[7]], vario.plot.4km.sph[[8]],vario.plot.4km.sph[[9]], vario.plot.4km.sph[[10]],vario.plot.4km.sph[[11]], vario.plot.4km.sph[[12]],vario.plot.4km.sph[[13]], vario.plot.4km.sph[[14]],vario.plot.4km.sph[[15]], vario.plot.4km.sph[[16]],vario.plot.4km.sph[[17]], vario.plot.4km.sph[[18]],vario.plot.4km.sph[[19]], vario.plot.4km.sph[[20]],vario.plot.4km.sph[[21]], vario.plot.4km.sph[[22]],vario.plot.4km.sph[[23]], vario.plot.4km.sph[[24]],vario.plot.4km.sph[[25]], vario.plot.4km.sph[[26]],vario.plot.4km.sph[[27]], vario.plot.4km.sph[[28]],vario.plot.4km.sph[[29]], vario.plot.4km.sph[[30]],vario.plot.4km.sph[[31]], vario.plot.4km.sph[[32]],vario.plot.4km.sph[[33]], vario.plot.4km.sph[[34]],vario.plot.4km.sph[[35]])


cowplot::plot_grid(vario.plot.4kR.sph[[71]], vario.plot.4kR.sph[[72]], vario.plot.4kR.sph[[73]], vario.plot.4kR.sph[[74]],vario.plot.4kR.sph[[75]], vario.plot.4kR.sph[[76]],vario.plot.4kR.sph[[77]], vario.plot.4kR.sph[[78]],vario.plot.4kR.sph[[79]], vario.plot.4kR.sph[[80]],vario.plot.4kR.sph[[81]], vario.plot.4kR.sph[[82]],vario.plot.4kR.sph[[83]], vario.plot.4kR.sph[[84]],vario.plot.4kR.sph[[85]], vario.plot.4kR.sph[[86]],vario.plot.4kR.sph[[87]], vario.plot.4kR.sph[[88]],vario.plot.4kR.sph[[89]], vario.plot.4kR.sph[[90]],vario.plot.4kR.sph[[91]], vario.plot.4kR.sph[[92]],vario.plot.4kR.sph[[93]], vario.plot.4kR.sph[[94]], 
               ncol = 6, nrow = 6, label_size = 5)

pdf("test2.pdf")

a <- grid.arrange(vario.plot.4km.sph[[1]], vario.plot.4km.sph[[2]], vario.plot.4km.sph[[3]], vario.plot.4km.sph[[4]], ncol = 2, nrow = 2)



savePlot(vario.plot.4km.gau[[1]], filename = "test.png", type = "png")
ggsave(filename = "test.png", plot = vario.plot.4km.gau[[1]])

all_vario

library(ncf)

ncf::correlog(test_xy_mammal[[1]][,1], test_xy_mammal[[1]][,2], test_xy_mammal[[1]][,3],
              resamp = 10, increment = 1000)
```


```{r}
dnn.sph.4kM.test.good <- vector("list", length = 19)
dnn.sph.4kM.test.good <- dnn.sph.4kM.test[c(1,2,5,7,9,10,12,13,17,18,19,20,22,23,24,25,27,30,33,34)]




sf_test_rndcv4k_mammal.good <- list()
sf_test_rndcv4k_mammal.good <-  sf_test_rndcv4k_mammal[c(1,5,7,9,10,12,13,17,18,19,20,22,23,24,25,27,30,33,34)]

```




```{r}

library(spdep)

dnn.sph.4kM[[1]] <- spdep::dnearneigh(a, 0, 168.4539)

moran()

```



```{r}
library(spatstat)
library(geosphere)





# most far away
a <- vector()
for(i in 1:length(test_rndcv4k_mammal.df)){
a[i] <- which.max(spatstat.geom::nndist(X = test_rndcv4k_mammal.df[[i]]$long,
                                                              Y = test_rndcv4k_mammal.df[[i]]$lat,
                                                              k = 1))}


# most far away's neightbor

b <- vector()
for( i in 1:length(test_rndcv4k_mammal.df)){
b[i] <- spatstat.geom::nnwhich(X = test_rndcv4k_mammal.df[[i]]$long,
                       Y = test_rndcv4k_mammal.df[[i]]$lat,
                       k = 1)[a[i]]}


# Their distance 
c <- vector()
for(i in 1:length(test_rndcv4k_mammal.df)){
c[i] <- geosphere::distGeo(test_rndcv4k_mammal.df[[i]][a[i],2:3], test_rndcv4k_mammal.df[[i]][b[i],2:3])
}
c <- c/1000





dnn.min.4kM.test <- furrr::future_map2(sf_test_rndcv4k_mammal, 
                                       c, 
                                       dnn,
                                       .options = furrr_options(seed = TRUE),
                                       .progress = T)

listw.min_test_mammal <- furrr::future_map(dnn.min.4kM.test, 
                                           nb2listw_zero, 
                                           .options = furrr_options(seed = TRUE),
                                           .progress = T)

moran_rnd.min_mammal   <- future_map2(sf_test_rndcv4k_mammal, 
                         listw.min_test_mammal, 
                         my.moran.test, 
                         .options = furrr_options(seed = TRUE),
                         .progress = T)

moran_rnd.min_M <- vector()
for(i in 1:length(moran_rnd.min_mammal)){
moran_rnd.min_M[i] <- moran_rnd.min_mammal[[i]][3][[1]][[1]]
}


#

a <- vector()
for(i in 1:length(test_rndcv4k_reptile.df)){
a[i] <- which.max(spatstat.geom::nndist(X = test_rndcv4k_reptile.df[[i]]$long,
                                                              Y = test_rndcv4k_reptile.df[[i]]$lat,
                                                              k = 1))}


# most far away's neightbor

b <- vector()
for( i in 1:length(test_rndcv4k_reptile.df)){
b[i] <- spatstat.geom::nnwhich(X = test_rndcv4k_reptile.df[[i]]$long,
                       Y = test_rndcv4k_reptile.df[[i]]$lat,
                       k = 1)[a[i]]}


# Their distance 
c <- vector()
for(i in 1:length(test_rndcv4k_reptile.df)){
c[i] <- geosphere::distGeo(test_rndcv4k_reptile.df[[i]][a[i],2:3], test_rndcv4k_reptile.df[[i]][b[i],2:3])
}
c <- c/1000

dnn.min.4kR.test <- furrr::future_map2(sf_test_rndcv4k_reptile, 
                                       c, 
                                       dnn,
                                       .options = furrr_options(seed = TRUE),
                                       .progress = T)

listw.min_test_reptile <- furrr::future_map(dnn.min.4kR.test, 
                                           nb2listw_zero, 
                                           .options = furrr_options(seed = TRUE),
                                           .progress = T)

moran_rnd.min_reptile   <- future_map2(sf_test_rndcv4k_reptile, 
                         listw.min_test_reptile, 
                         my.moran.test, 
                         .options = furrr_options(seed = TRUE),
                         .progress = T)

moran_rnd.min_R <- vector()
for(i in 1:length(moran_rnd.min_reptile)){
moran_rnd.min_R[i] <- moran_rnd.min_reptile[[i]][3][[1]][[1]]
}

#


a <- vector()
for(i in 1:length(test_rndcv4k_amphibian.df)){
a[i] <- which.max(spatstat.geom::nndist(X = test_rndcv4k_amphibian.df[[i]]$long,
                                                              Y = test_rndcv4k_amphibian.df[[i]]$lat,
                                                              k = 1))}


# most far away's neightbor

b <- vector()
for( i in 1:length(test_rndcv4k_amphibian.df)){
b[i] <- spatstat.geom::nnwhich(X = test_rndcv4k_amphibian.df[[i]]$long,
                       Y = test_rndcv4k_amphibian.df[[i]]$lat,
                       k = 1)[a[i]]}


# Their distance 
c <- vector()
for(i in 1:length(test_rndcv4k_amphibian.df)){
c[i] <- geosphere::distGeo(test_rndcv4k_amphibian.df[[i]][a[i],2:3], test_rndcv4k_amphibian.df[[i]][b[i],2:3])
}
c <- c/1000

dnn.min.4kA.test <- furrr::future_map2(sf_test_rndcv4k_amphibian, 
                                       c, 
                                       dnn,
                                       .options = furrr_options(seed = TRUE),
                                       .progress = T)

listw.min_test_amphibian <- furrr::future_map(dnn.min.4kA.test, 
                                           nb2listw_zero, 
                                           .options = furrr_options(seed = TRUE),
                                           .progress = T)

moran_rnd.min_amphibian   <- future_map2(sf_test_rndcv4k_amphibian, 
                         listw.min_test_amphibian, 
                         my.moran.test, 
                         .options = furrr_options(seed = TRUE),
                         .progress = T)

moran_rnd.min_A <- vector()
for(i in 1:length(moran_rnd.min_amphibian)){
moran_rnd.min_A[i] <- moran_rnd.min_amphibian[[i]][3][[1]][[1]]
}




```



```{r get your Spatial Autocorrelation with gstat:: }
#make neightbour to check Moran's I 
library(spdep)

#1. Variogram range based neighborhood 

dnn <- function(x, y){spdep::dnearneigh(x, 0, y, longlat = TRUE)}

dnn.sph.4kM.test <- furrr::future_map2(sf_test_rndcv4k_mammal, 
                                       range.vm.sph.4kM, 
                                       dnn,
                                       .options = furrr_options(seed = TRUE),
                                       .progress = T)

dnn.sph.4kR.test <- furrr::future_map2(sf_test_rndcv4k_reptile, 
                                       range.vm.sph.4kR, 
                                       dnn,
                                       .options = furrr_options(seed = TRUE),
                                       .progress = T)

dnn.sph.4kA.test <- furrr::future_map2(sf_test_rndcv4k_amphibian,
                                       range.vm.sph.4kA, 
                                       dnn,
                                       .options = furrr_options(seed = TRUE),
                                       .progress = T)

nb2listw_zero <- function(x){nb2listw(x, zero.policy = T)}



listw_test_mammal <- furrr::future_map(dnn.sph.4kM.test, 
                                           nb2listw_zero, 
                                           .options = furrr_options(seed = TRUE),
                                           .progress = T)

listw_test_reptile <- furrr::future_map(dnn.sph.4kR.test, 
                                           nb2listw_zero, 
                                           .options = furrr_options(seed = TRUE),
                                           .progress = T)

listw_test_amphibian <- furrr::future_map(dnn.sph.4kA.test, 
                                           nb2listw_zero, 
                                           .options = furrr_options(seed = TRUE),
                                           .progress = T)


my.moran.test <- function(x,y){spdep::moran.test(x$residual, listw = y, zero.policy = T)}



moran_rndsph_mammal   <- future_map2(sf_test_rndcv4k_mammal, 
                         listw_test_mammal, 
                         my.moran.test, 
                         .options = furrr_options(seed = TRUE),
                         .progress = T)

moran_rndsph_reptile   <- future_map2(sf_test_rndcv4k_reptile, 
                         listw_test_reptile, 
                         my.moran.test, 
                         .options = furrr_options(seed = TRUE),
                         .progress = T)

moran_rndsph_amphibian   <- future_map2(sf_test_rndcv4k_amphibian, 
                         listw_test_amphibian, 
                         my.moran.test, 
                         .options = furrr_options(seed = TRUE),
                         .progress = T)

moran_rndsph_M <- vector()
for(i in 1:length(moran_rndsph_mammal)){
moran_rndsph_M[i] <- moran_rndsph_mammal[[i]][3][[1]][[1]]
}

moran_rndsph_R <- vector()
for(i in 1:length(moran_rndsph_reptile)){
moran_rndsph_R[i] <- moran_rndsph_reptile[[i]][3][[1]][[1]]
}

moran_rndsph_A <- vector()
for(i in 1:length(moran_rndsph_amphibian)){
moran_rndsph_A[i] <- moran_rndsph_amphibian[[i]][3][[1]][[1]]
}

result_mammal <- tibble(rsac_rndcv4k_sph = moran_rndsph_M)
result_reptile <- tibble(rsac_rndcv4k_sph = moran_rndsph_R)
result_amphibian <- tibble(rsac_rndcv4k_sph = moran_rndsph_A)

#set true for fucking stupid error and its old style function
set.ZeroPolicyOption(TRUE)




```

```{r}
result_mammal <- readr::read_csv("result_mammal.csv")

result_mammal %>% mutate(log_train_rndcv4k = map_dbl(map(map(train_rndcv4k_mammal.df,4), log),mean),
                         log_test_rndcv4k = map_dbl(map(map(test_rndcv4k_mammal.df,4), log),mean)) -> result_mammal

result_mammal %>% mutate(log_train_rndcv4k.median = map_dbl(map(map(train_rndcv4k_mammal.df,4), log),median),
                         log_test_rndcv4k.median = map_dbl(map(map(test_rndcv4k_mammal.df,4), log),median)) -> result_mammal


result_mammal %>% mutate(resid_train_rndcv4k = map_dbl(map(train_rndcv4k_mammal.df,4), mean),
                         resid_test_rndcv4k = map_dbl(map(test_rndcv4k_mammal.df,4), mean)) -> result_mammal


result_reptile %>% mutate(resid_train_rndcv4k = map_dbl(map(train_rndcv4k_reptile.df,4), mean),
                         resid_test_rndcv4k = map_dbl(map(test_rndcv4k_reptile.df,4), mean)) -> result_reptile

result_amphibian <- readr::read_csv("result_amphibian.csv")
result_amphibian %>% mutate(resid_train_rndcv4k = map_dbl(map(train_rndcv4k_amphibian.df,4), mean),
                         resid_test_rndcv4k = map_dbl(map(test_rndcv4k_amphibian.df,4), mean)) -> result_amphibian


readr::write_csv(result_mammal, file = "result_mammal.csv")
readr::write_csv(result_reptile, file = "result_reptile.csv")
readr::write_csv(result_amphibian, file = "result_amphibian.csv")

```

# raster DNN

```{r}
library(spdep)
library(raster)
library(furrr)
future::plan(multisession, workers = 30)

biopath <- paste0("bios/10m/", list.files(pattern="*.tif", path = "bios/10m/"))
stackbio <- raster::stack(biopath)

bbox_mammal <- readr::read_rds(file = "bbox_mammal.rds")
bbox_reptile <- readr::read_rds(file = "bbox_reptile.rds")
bbox_amphibian <- readr::read_rds(file = "bbox_amphibian.rds")
data.mammal <- readr::read_rds(file = "data/data.mammal.rds")
name.M <- list()
  for(i in 1:length(data.mammal)){
    name.M[[i]] <- paste0("bios/crop/10m/",data.mammal[[i]]@species,".tif")}

stackbio_M <- list()
for(i in 1:length(bbox_mammal)){stackbio_M[[i]] <- stackbio}
stackbio_R <- list()
for(i in 1:length(bbox_reptile)){stackbio_R[[i]] <- stackbio}
stackbio_A <- list()
for(i in 1:length(bbox_amphibian)){stackbio_A[[i]] <- stackbio}

crop <- raster::crop

cropbio_M <- furrr::future_map2(stackbio_M, bbox_mammal, crop)
wr <- function(x, y){raster::writeRaster(x, filename = y)}
furrr::future_map2(cropbio_M, name.M ,wr)

a <-raster::raster("test.tif")
b <- elsa::moran(a, 1, 90)


spdep::cell2nb(stackbio_M[[1]])
a <- spdep::dnearneigh(raster::as.matrix(cropbio_M[[1]]), 1, range.vm.sph.4kM[1,])
b <- spdep::nb2listwdist(a)

sf::st_as_sf(stackbio_M[[1]])




```

```{r}
library(glmnet)
library(maxnet)
biopath <- paste0("bios/crop/", list.files(pattern="*.tif", path = "bios/crop/"))

bio_mammal <- list()
for(i in 1:length(biopath)){
bio_mammal[[i]] <- raster::stack(biopath[i])
}
for(i in 1:length(bio_mammal)){
names(cropbio_M[[i]]) <- c("wc2.1_30s_bio_01",  "wc2.1_30s_bio_02",  "wc2.1_30s_bio_03",  "wc2.1_30s_bio_04", "wc2.1_30s_bio_05", "wc2.1_30s_bio_06", "wc2.1_30s_bio_07",  "wc2.1_30s_bio_08", "wc2.1_30s_bio_09", "wc2.1_30s_bio_10", "wc2.1_30s_bio_11", "wc2.1_30s_bio_12", "wc2.1_30s_bio_13", "wc2.1_30s_bio_14", "wc2.1_30s_bio_15", "wc2.1_30s_bio_16", "wc2.1_30s_bio_17", "wc2.1_30s_bio_18", "wc2.1_30s_bio_19")}

model_rndcv4k_mammal <- readr::read_rds("model/model_rndcv4k_mammal.rds")
sdm.predict <- function(x,y){SDMtune::predict(x, y, type = "cloglog")}

raster.rndcv4k.mammal <- map2(model_rndcv4k_mammal, cropbio_M, sdm.predict)

name.M <- list()
  for(i in 1:length(data.mammal)){
    name.M[[i]] <- paste0("bios/pred/10m/",data.mammal[[i]]@species,".tif")}


pred_mammal <- paste0("bios/pred/10m/",list.files(path = "bios/pred/10m", pattern = "*.tif"))

predict_mammal <- list()
for(i in 1:length(pred_mammal)){
predict_mammal[[i]] <- raster::raster(pred_mammal[i])}

my.moran <- function(x){Moran(x, w=matrix(c(1,1,1,1,0,1,1,1,1), 3,3))}

moran.mammal <- future_map(predict_mammal, my.moran)


pred_mammal <- list()
for(i in 1:length(predict_mammal)){
  pred_mammal[[i]] <- raster::rasterToPoints(predict_mammal[[i]])
}

pred_mammal <- map(pred_mammal, as.data.frame)

sf_df <- function(x){sf::st_as_sf(x, 
                                  coords = c("x", "y"), 
                                  crs = 4326,
                                  remove = T)
}

pred_mammal <- map(pred_mammal, sf_df)

for(i in 1:length(pred_mammal)){
names(pred_mammal[[i]]) <- c("prediction","geometry")}

dnn.pred.mammal <- furrr::future_map2(pred_mammal, range.vm.sph.4kM ,dnn)








raster::Moran()
ncf::correlog(test_xy_mammal[[1]][,1], test_xy_mammal[[1]][,2], test_xy_mammal[[1]][,3],
              resamp = 10, increment = 1000)

```


```{r Moran's Correlogram}

  
a <- sp.correlogram(knb5_mammal[[6]], sf_resid_fold5_mammal[[6]]$residual_1, order = 9, method = "I")
plot(a)


```

```{r tmap visualize}
#Some variogram is weird. Checking tmap

library(tmap)
tm_shape(sf_resid_fold5_mammal[[1]]) + tm_dots("pred")
tm_shape(sf_resid_fold5_mammal[[2]]) + tm_dots("pred")
tm_shape(sf_resid_fold5_mammal[[13]]) + tm_dots("pred")
#4 is fucked up 
tm_shape(sf_resid_fold5_mammal[[14]]) + tm_dots("pred")

```


```{r Y axis, Moran's I with different "K", different "Threshold"}

mammal_Y_moran <- tibble::tibble(moran_0.5k1 = unlist(map(moran_mammal_0.5k1, c(3,1))),
                                  moran_0.5k2 = unlist(map(moran_mammal_0.5k2, c(3,1))),
                                  moran_0.5k3 = unlist(map(moran_mammal_0.5k3, c(3,1))),
                                  moran_0.5k4 = unlist(map(moran_mammal_0.5k4, c(3,1))),
                                  moran_0.5k5 = unlist(map(moran_mammal_0.5k5, c(3,1))),
                                  moran_0.5k6 = unlist(map(moran_mammal_0.5k6, c(3,1))),
                                  moran_0.5k7 = unlist(map(moran_mammal_0.5k7, c(3,1))),
                                  moran_0.5k8 = unlist(map(moran_mammal_0.5k8, c(3,1))),
                                  moran_0.5k9 = unlist(map(moran_mammal_0.5k9, c(3,1))),
                                  moran_0.5k10 = unlist(map(moran_mammal_0.5k10, c(3,1))),
                                  moran_0.6k1 = unlist(map(moran_mammal_0.6k1, c(3,1))),
                                  moran_0.6k2 = unlist(map(moran_mammal_0.6k2, c(3,1))),
                                  moran_0.6k3 = unlist(map(moran_mammal_0.6k3, c(3,1))),
                                  moran_0.6k4 = unlist(map(moran_mammal_0.6k4, c(3,1))),
                                  moran_0.6k5 = unlist(map(moran_mammal_0.6k5, c(3,1))),
                                  moran_0.6k6 = unlist(map(moran_mammal_0.6k6, c(3,1))),
                                  moran_0.6k7 = unlist(map(moran_mammal_0.6k7, c(3,1))),
                                  moran_0.6k8 = unlist(map(moran_mammal_0.6k8, c(3,1))),
                                  moran_0.6k9 = unlist(map(moran_mammal_0.6k9, c(3,1))),
                                  moran_0.6k10 = unlist(map(moran_mammal_0.6k10, c(3,1))),
                                  moran_0.7k1 = unlist(map(moran_mammal_0.7k1, c(3,1))),
                                  moran_0.7k2 = unlist(map(moran_mammal_0.7k2, c(3,1))),
                                  moran_0.7k3 = unlist(map(moran_mammal_0.7k3, c(3,1))),
                                  moran_0.7k4 = unlist(map(moran_mammal_0.7k4, c(3,1))),
                                  moran_0.7k5 = unlist(map(moran_mammal_0.7k5, c(3,1))),
                                  moran_0.7k6 = unlist(map(moran_mammal_0.7k6, c(3,1))),
                                  moran_0.7k7 = unlist(map(moran_mammal_0.7k7, c(3,1))),
                                  moran_0.7k8 = unlist(map(moran_mammal_0.7k8, c(3,1))),
                                  moran_0.7k9 = unlist(map(moran_mammal_0.7k9, c(3,1))),
                                  moran_0.7k10 = unlist(map(moran_mammal_0.7k10, c(3,1))),
                                  moran_0.8k1 = unlist(map(moran_mammal_0.8k1, c(3,1))),
                                  moran_0.8k2 = unlist(map(moran_mammal_0.8k2, c(3,1))),
                                  moran_0.8k3 = unlist(map(moran_mammal_0.8k3, c(3,1))),
                                  moran_0.8k4 = unlist(map(moran_mammal_0.8k4, c(3,1))),
                                  moran_0.8k5 = unlist(map(moran_mammal_0.8k5, c(3,1))),
                                  moran_0.8k6 = unlist(map(moran_mammal_0.8k6, c(3,1))),
                                  moran_0.8k7 = unlist(map(moran_mammal_0.8k7, c(3,1))),
                                  moran_0.8k8 = unlist(map(moran_mammal_0.8k8, c(3,1))),
                                  moran_0.8k9 = unlist(map(moran_mammal_0.8k9, c(3,1))),
                                  moran_0.8k10 = unlist(map(moran_mammal_0.8k10, c(3,1))),
                                  moran_0.9k1 = unlist(map(moran_mammal_0.9k1, c(3,1))),
                                  moran_0.9k2 = unlist(map(moran_mammal_0.9k2, c(3,1))),
                                  moran_0.9k3 = unlist(map(moran_mammal_0.9k3, c(3,1))),
                                  moran_0.9k4 = unlist(map(moran_mammal_0.9k4, c(3,1))),
                                  moran_0.9k5 = unlist(map(moran_mammal_0.9k5, c(3,1))),
                                  moran_0.9k6 = unlist(map(moran_mammal_0.9k6, c(3,1))),
                                  moran_0.9k7 = unlist(map(moran_mammal_0.9k7, c(3,1))),
                                  moran_0.9k8 = unlist(map(moran_mammal_0.9k8, c(3,1))),
                                  moran_0.9k9 = unlist(map(moran_mammal_0.9k9, c(3,1))),
                                  moran_0.9k10 = unlist(map(moran_mammal_0.9k10, c(3,1))),
                                  moran_1k1 = unlist(map(moran_mammal_1k1, c(3,1))),
                                  moran_1k2 = unlist(map(moran_mammal_1k2, c(3,1))),
                                  moran_1k3 = unlist(map(moran_mammal_1k3, c(3,1))),
                                  moran_1k4 = unlist(map(moran_mammal_1k4, c(3,1))),
                                  moran_1k5 = unlist(map(moran_mammal_1k5, c(3,1))),
                                  moran_1k6 = unlist(map(moran_mammal_1k6, c(3,1))),
                                  moran_1k7 = unlist(map(moran_mammal_1k7, c(3,1))),
                                  moran_1k8 = unlist(map(moran_mammal_1k8, c(3,1))),
                                  moran_1k9 = unlist(map(moran_mammal_1k9, c(3,1))),
                                  moran_1k10 = unlist(map(moran_mammal_1k10, c(3,1))),
                                  nb_0.05 = nb_mammal,
                                  moran_1dnb = unlist(map(moran_mammal_1dnb, c(3,1))),
                                  moran_0.9dnb = unlist(map(moran_mammal_0.9dnb, c(3,1))),
                                  moran_0.8dnb = unlist(map(moran_mammal_0.8dnb, c(3,1))),
                                  moran_0.7dnb = unlist(map(moran_mammal_0.7dnb, c(3,1))),
                                  moran_0.6dnb = unlist(map(moran_mammal_0.6dnb, c(3,1))),
                                  moran_0.5dnb = unlist(map(moran_mammal_0.5dnb, c(3,1))))



```

```{r X axis, Niche breadth from different Quantile, different ordination}
#from 0.05~0.95 

nb_mammal <- nb_mammal[-31]
nb_mammal <- nb_mammal[-26]

mammal_X_nb <- data.frame(nb_mammal)


```

```{r X + Y...}

mammal_XY <- mutate(mammal_Y_moran, nb_0.05 = mammal_X_nb)
mammal_XY_df <- as.data.frame(mammal_XY)
```

```{r}
p <- ggplot(data = mammal_Y_moran) +
    geom_point(aes(x = nb_0.05, y = moran_1k1, color = 1)) +
    geom_smooth(aes(x = nb_0.05, y= moran_1k10), method = "lm") +
    geom_point(aes(x = nb_0.05, y = moran_1k2, color = 2)) +
    geom_point(aes(x = nb_0.05, y = moran_1k3, color = 3)) +
    geom_point(aes(x = nb_0.05, y = moran_1k4, color = 4)) +
    geom_point(aes(x = nb_0.05, y = moran_1k5, color = 5)) +
    geom_point(aes(x = nb_0.05, y = moran_1k6, color = 6)) +
    geom_point(aes(x = nb_0.05, y = moran_1k7, color = 7)) +
    geom_point(aes(x = nb_0.05, y = moran_1k8, color = 8)) +
    geom_point(aes(x = nb_0.05, y = moran_1k9, color = 9)) +
    geom_point(aes(x = nb_0.05, y = moran_1k10, color = 10)) +
    labs(title = "Residuals of SDM", 
    subtitle = "Can niche breadth predict ",
    x = "Climatic Niche Breadth", y = "Residual Moran's I") +
    theme_bw()



```

```{r}
q <- ggplot(data = mammal_Y_moran) +
    geom_point(aes(x = nb_0.05, y = moran_1k1, color = 1)) +
    geom_smooth(aes(x = nb_0.05, y= moran_1k10), method = "lm") +
    geom_point(aes(x = nb_0.05, y = moran_1k10, color = 10)) +
    labs(title = "Residuals of SDM", 
    subtitle = "Can niche breadth predict?",
    x = "Climatic Niche Breadth", y = "Residual Moran's I") +
    theme_bw()

scatter_morannb <- function(y){ggplot(data = mammal_Y_moran) +
                                  geom_point(aes(x = nb_0.05, y = y)) + 
                                  geom_smooth(aes(x = nb_0.05, y = y), method = "lm")}
  
all_scatter<- map(mammal_Y_moran[1:60], scatter_morannb)


map2(ggname_save, all_scatter, ggsave)

a <- list(1:60)

ggname <- read_csv("E:/residual_sdm/species_mammal.csv", col_names = "scientificName", skip = 1)
ggname<- ggname[-31,]
ggname <- ggname[-26,]
ggname <- as.list(ggname)
ggname_save <- paste0("E:/",1:60,".png")
```

```{r}
p <- ggplot(data = mammal_Y_moran) +
    geom_point(aes(x = nb_0.05, y = moran_1dnb, size = , color = "red")) +
    geom_point(aes(x = nb_0.05, y = moran_1k10, size = 0.002, color = "blue")) +
    geom_smooth(aes(x = nb_0.05, y= moran_1dnb), method = "lm") +
    geom_smooth(aes(x = nb_0.05, y= moran_1k10), method = "lm") +
    labs(title = "Residuals of SDM", 
    subtitle = "Can niche breadth predict ",
    x = "Climatic Niche Breadth", y = "Residual Moran's I", fill="wtf") +
    theme(legend.position = 'none') 
    

    





```

```{r}
p <- ggplot(data = mammal_Y_moran) +
    geom_point(aes(x = nb_0.05, y = moran_1k1, color = 1)) +
    geom_smooth(aes(x = nb_0.05, y= moran_1k10), method = "lm") +
    geom_point(aes(x = nb_0.05, y = moran_1k2, color = 2)) +
    geom_point(aes(x = nb_0.05, y = moran_1k3, color = 3)) +
    geom_point(aes(x = nb_0.05, y = moran_1k4, color = 4)) +
    geom_point(aes(x = nb_0.05, y = moran_1k5, color = 5)) +
    geom_point(aes(x = nb_0.05, y = moran_1k6, color = 6)) +
    geom_point(aes(x = nb_0.05, y = moran_1k7, color = 7)) +
    geom_point(aes(x = nb_0.05, y = moran_1k8, color = 8)) +
    geom_point(aes(x = nb_0.05, y = moran_1k9, color = 9)) +
    geom_point(aes(x = nb_0.05, y = moran_1k10, color = 10)) +
    labs(title = "Residuals of SDM", 
    subtitle = "Can niche breadth predict ",
    x = "Climatic Niche Breadth", y = "Residual Moran's I") +
    theme_bw()



```



```{r}
p <- ggplot(data = mammal_Y_moran) +
    geom_smooth(aes(x = nb_0.05, y= moran_0.9k10), method = "lm") +
    labs(title = "Residuals of SDM", 
    subtitle = "Can niche breadth predict ",
    x = "Climatic Niche Breadth", y = "Residual Moran's I") +
    theme_bw()
```

```{r histogram}
tibble4ggp1 <- tibble(rsac = mammal_Y_moran$moran_1dnb)
tibble4ggp2 <- tibble(rsac = mammal_Y_moran$moran_1k10)
tibble4ggp <- rbind(tibble4ggp1, tibble4ggp2)                     
tibble4ggp <- tibble4ggp %>% mutate(neighbor = length(1:100))
tibble4ggp$neighbor[1:50] <- "variogram distance"
tibble4ggp$neighbor[51:100] <- "10NN"


ggplot(tibble4ggp, aes(x=rsac, color=neighbor, )) +
  geom_histogram(aes(fill=neighbor), color="gray50", position="dodge", alpha=0.2, binwidth=0.09)+
  geom_density(alpha=0.5)+
  theme_gray()


```



```{r}

for (i in 1:length(sf_train_rndcv4k_amphibian)){
sf::write_sf(sf_train_rndcv4k_amphibian[[i]], paste0("train_test/t.t_rndcv4k_amphibian/train_",t.t.amphibian_0.2[[i]][[1]]@species[1],".shp"))
}

for (i in 1:length(sf_test_rndcv4k_amphibian)){
sf::write_sf(sf_test_rndcv4k_amphibian[[i]], paste0("train_test/t.t_rndcv4k_amphibian/test/test_",t.t.amphibian_0.2[[i]][[1]]@species[1],".shp"))
}

#

for (i in 1:length(sf_train_rndcv4k_mammal)){
sf::write_sf(sf_train_rndcv4k_mammal[[i]], paste0("train_test/t.t_rndcv4k_mammal/train/train_",t.t.mammal_0.2[[i]][[1]]@species[1],".shp"))
}

for (i in 1:length(sf_test_rndcv4k_mammal)){
sf::write_sf(sf_test_rndcv4k_mammal[[i]], paste0("train_test/t.t_rndcv4k_mammal/test/testn_",t.t.mammal_0.2[[i]][[1]]@species[1],".shp"))
}

#

for (i in 1:length(sf_train_rndcv4k_reptile)){
sf::write_sf(sf_train_rndcv4k_reptile[[i]], paste0("train_test/t.t_rndcv4k_reptile/train/train_",t.t.reptile_0.2[[i]][[1]]@species[1],".shp"))
}

for (i in 1:length(sf_test_rndcv4k_reptile)){
sf::write_sf(sf_test_rndcv4k_reptile[[i]], paste0("train_test/t.t_rndcv4k_reptile/test/testn_",t.t.reptile_0.2[[i]][[1]]@species[1],".shp"))
}

```

# Niche Breadth

```{r}
library(ggcorrplot)
library(FactoMineR)
library(factoextra)
library(vegan)
library(listviewer)
library(MicroNiche)
library(corrr)
library(mapr)
library(ggplot2)
```

```{r}
library(tidyverse)

```

```{r}
library(furrr)
future::plan(multisession, workers = 30)
```


# Aims. 
Capture the niche breadth of every species.
Methodology include 3 ways,
1. classical Levin's Niche Breadth with my own function(다 더하는 것은 어렵. samp intensity에 대한 비판 방어는?)
2. Levin's Niche breadth with ENMeval
3. DBSCAN - 자의적 판단기준?
4. Broennimann et al. 2012 ecospat... var, PCA, Sum of Variance
5. 0.05 ~ 0.95 boxplot
6. 전문가 데이터와 비교 
7. 순위로 더하기
8. 다 해보고 순위가 비슷한 애들만 뽑아보기?
9. 


# 1. Classical Levin's niche breadth
This represent relative frequency of individuals in the jth Category
which catch the Eveness along the gradients

0 < B < J (number of Jth category)
0 represent specialist, J reprensent generalist.

until bio11, it is temperature. each category can be 2
from 12 - 19, they are precipitation. each category can be 10 each.

```{r}
data.mammal <- readr::read_rds(file = "data/data.mammal.rds")
data.reptile <- readr::read_rds(file = "data/data.reptile.rds")
data.amphibian <- readr::read_rds(file = "data/data.amphibian.rds")
```


```{r}

reaarange <- function(x){dplyr::select(x@data, c(1,12,13,14,15,16,17,18,19,2,3,4,5,6,7,8,9,10,11))}

for (i in 1:length(data.mammal)){
data.mammal[[i]]@data <- reaarange(data.mammal[[i]])
}

for (i in 1:length(data.mammal)){
names(data.mammal[[i]]@data) <- c("wc2.1_30s_bio_01", "wc2.1_30s_bio_02", "wc2.1_30s_bio_03", "wc2.1_30s_bio_04",
                                  "wc2.1_30s_bio_05", "wc2.1_30s_bio_06", "wc2.1_30s_bio_07", "wc2.1_30s_bio_08",
                                  "wc2.1_30s_bio_09", "wc2.1_30s_bio_10", "wc2.1_30s_bio_11", "wc2.1_30s_bio_12",
                                  "wc2.1_30s_bio_13", "wc2.1_30s_bio_14", "wc2.1_30s_bio_15", "wc2.1_30s_bio_16",
                                  "wc2.1_30s_bio_17", "wc2.1_30s_bio_18", "wc2.1_30s_bio_19")
}

for (i in 1:length(data.reptile)){
data.reptile[[i]]@data <- reaarange(data.reptile[[i]])
}

for (i in 1:length(data.reptile)){
names(data.reptile[[i]]@data) <- c("wc2.1_30s_bio_01", "wc2.1_30s_bio_02", "wc2.1_30s_bio_03", "wc2.1_30s_bio_04",
                                  "wc2.1_30s_bio_05", "wc2.1_30s_bio_06", "wc2.1_30s_bio_07", "wc2.1_30s_bio_08",
                                  "wc2.1_30s_bio_09", "wc2.1_30s_bio_10", "wc2.1_30s_bio_11", "wc2.1_30s_bio_12",
                                  "wc2.1_30s_bio_13", "wc2.1_30s_bio_14", "wc2.1_30s_bio_15", "wc2.1_30s_bio_16",
                                  "wc2.1_30s_bio_17", "wc2.1_30s_bio_18", "wc2.1_30s_bio_19")
}

for (i in 1:length(data.amphibian)){
data.amphibian[[i]]@data <- reaarange(data.amphibian[[i]])
}

for (i in 1:length(data.amphibian)){
names(data.amphibian[[i]]@data) <- c("wc2.1_30s_bio_01", "wc2.1_30s_bio_02", "wc2.1_30s_bio_03", "wc2.1_30s_bio_04",
                                  "wc2.1_30s_bio_05", "wc2.1_30s_bio_06", "wc2.1_30s_bio_07", "wc2.1_30s_bio_08",
                                  "wc2.1_30s_bio_09", "wc2.1_30s_bio_10", "wc2.1_30s_bio_11", "wc2.1_30s_bio_12",
                                  "wc2.1_30s_bio_13", "wc2.1_30s_bio_14", "wc2.1_30s_bio_15", "wc2.1_30s_bio_16",
                                  "wc2.1_30s_bio_17", "wc2.1_30s_bio_18", "wc2.1_30s_bio_19")
}

```


```{r}
library(raster)

bios.name <- paste0("C:/Users/lophital/Documents/rsac_x_overfit/bios/2.5m/", list.files(pattern="*.tif", path = "C:/Users/lophital/Documents/rsac_x_overfit/bios/2.5m/"))

bios <- list()
for (i in 1:length(bios.name)){
  bios[[i]] <- raster::raster(bios.name[i])
}

bio.min <- vector()
for (i in 1:19){
bio.min[i] <- ceiling(bios[[i]]@data@min)
}

bio.max <- vector()
for (i in 1:19){
bio.max[i] <- ceiling(bios[[i]]@data@max)
}

biobreak <- list()
for(i in 1:11){
biobreak[[i]] <- bio.min[i]:bio.max[i]
}

for(i in 12:19){
biobreak[[i]] <- (bio.min[i]:bio.max[i]*10)  
}

bchist <- function(x, y){hist(x, breaks = y)}
biohist_reptile <- list()
for (i in 1:94){
biohist_reptile[[i]] <- map2(data.reptile[[i]]@data, biobreak, bchist)
}

levin.nb <- function(x){
  1/sum((x$counts/sum(x$counts))^2)
  }

levin.nb_reptile <- list()
for(i in 1:length(data.reptile)){
levin.nb_reptile[[i]] <- map(biohist_reptile[[i]], levin.nb)
}

nichebreadth.df <- data.frame(bio1 = map_dbl(levin.nb_reptile, 1),
                              bio2 = map_dbl(levin.nb_reptile, 2),
                              bio3 = map_dbl(levin.nb_reptile, 3),
                              bio4 = map_dbl(levin.nb_reptile, 4),
                              bio5 = map_dbl(levin.nb_reptile, 5),
                              bio6 = map_dbl(levin.nb_reptile, 6),
                              bio7 = map_dbl(levin.nb_reptile, 7),
                              bio8 = map_dbl(levin.nb_reptile, 8),
                              bio9 = map_dbl(levin.nb_reptile, 9),
                              bio10 = map_dbl(levin.nb_reptile, 10),
                              bio11 = map_dbl(levin.nb_reptile, 11),
                              bio12 = map_dbl(levin.nb_reptile, 12),
                              bio13 = map_dbl(levin.nb_reptile, 13),
                              bio14 = map_dbl(levin.nb_reptile, 14),
                              bio15 = map_dbl(levin.nb_reptile, 15),
                              bio16 = map_dbl(levin.nb_reptile, 16),
                              bio17 = map_dbl(levin.nb_reptile, 17),
                              bio18 = map_dbl(levin.nb_reptile, 18),
                              bio19 = map_dbl(levin.nb_reptile, 19))

```

# 2. Levin's niche breadth with ENMeval

```{r}
library(RInSp)

a <- RInSp::import.RInSp(data.reptile[[2]]@data, data.type = "double")
b <- RInSp::like.Wi(a)
```


# 3. Broennimann et al. 2012

plot in 2 PC axis, Z axis of SDM, Kernel density smoothing


```{r{}
# this will set up disk.frame with multiple workers
setup_disk.frame(workers = 60)

# this will allow unlimited amount of data to be passed from worker to worker
options(future.globals.maxSize = Inf)
```



```{r}
library(FactoMineR)
library(data.table)

stackbio <- raster::stack(bios)

memory.limit(9999999)

bio_df <- data.frame(na.omit(raster::values(stackbio)))
readr::write_csv(bio_df, "bios/bio_df.csv")

bio_df <- fread("bio_df.csv")



my.PCA <- function(x){FactoMineR::PCA(x@data, scale.unit = TRUE)}

memory.limit(999999999)
PCA_bio <- FactoMineR::PCA(bio_df, scale.unit = T, ncp = 2)

PCA_mammal <- future_map(data.mammal, 
                         my.PCA,
                         .options = furrr_options(seed = TRUE),
                         .progress = T)

PCA_reptile <- future_map(data.reptile, 
                         my.PCA,
                         .options = furrr_options(seed = TRUE),
                         .progress = T)

PCA_amphibian <- future_map(data.amphibian, 
                         my.PCA,
                         .options = furrr_options(seed = TRUE),
                         .progress = T)


```



```{r}
library(ecospat)
```


```{r}
mcp <- function (xy) {
  xy <- as.data.frame(coordinates(xy))
  coords.t <- chull(xy[, 1], xy[, 2])
  xy.bord <- xy[coords.t, ]
  xy.bord <- rbind(xy.bord[nrow(xy.bord), ], xy.bord)
  return(SpatialPolygons(list(Polygons(list(Polygon(as.matrix(xy.bord))), 1))))
  }
```



```{r}
my.ecospat.kd <- function (x, ext, R = 100, th = 0, env.mask = c(), method = "adehabitat") 
{
  if (method == "adehabitat") {
    if (ncol(x) == 2) {
      xr <- data.frame(cbind((x[, 1] - ext[1])/abs(ext[2] - 
        ext[1]), (x[, 2] - ext[3])/abs(ext[4] - ext[3])))
      mask <- adehabitatMA::ascgen(sp::SpatialPoints(cbind((0:(R))/R, 
        (0:(R)/R))), nrcol = R - 2, count = FALSE)
      x.dens <- adehabitatHR::kernelUD(sp::SpatialPoints(xr[, 
        1:2]), h = "href", grid = mask, kern = "bivnorm")
      x.dens <- raster::raster(xmn = ext[1], xmx = ext[2], 
        ymn = ext[3], ymx = ext[4], matrix(x.dens$ud, 
          nrow = R))
      if (!is.null(th)) {
        th.value <- quantile(raster::extract(x.dens, 
          x), th, na.rm = T)
        x.dens[x.dens < th.value] <- 0
      }
      if (!is.null(env.mask)) {
        x.dens <- x.dens * env.mask
      }
    }
    else if (ncol(x) == 1) {
      xr <- seq(from = min(ext), to = max(ext), length.out = R)
      x.dens <- density(x[, 1], kernel = "gaussian", from = min(xr), 
        to = max(xr), n = R, cut = 0)
      if (!is.null(env.mask)) {
        x.dens$y <- x.dens$y * env.mask
      }
      if (!is.null(th)) {
        xr <- sapply(x, findInterval, x.dens$x)
        th.value <- quantile(x.dens$y[xr], th, na.rm = T)
        sprm <- which(x.dens$y < th.value)
        x.dens$y[sprm] <- 0
      }
    }
  }
  if (method == "ks") {
    if (ncol(x) == 2) {
      x.dens <- ks::kde(x, xmin = ext[c(1, 3)], xmax = ext[c(2, 
        4)], gridsize = c(R, R))
      x.dens <- raster::flip(raster::t(raster::raster(x.dens$estimate)), 
        direction = "y")
      raster::extent(x.dens) <- c(xmn = ext[1], xmx = ext[2], 
        ymn = ext[3], ymx = ext[4])
      if (!is.null(th)) {
        th.value <- quantile(raster::extract(x.dens, 
          x), th, na.rm = T)
        x.dens[x.dens < th.value] <- 0
      }
      if (!is.null(env.mask)) {
        x.dens <- x.dens * env.mask
      }
    }
    else if (ncol(x) == 1) {
      x.dens <- ks::kde(x, xmin = min(ext), xmax = max(ext), 
        gridsize = c(R, R))
      x.dens$y <- x.dens$estimate
      x.dens$x <- x.dens$eval.points
      if (!is.null(env.mask)) {
        x.dens$y <- x.dens$y * env.mask
      }
      if (!is.null(th)) {
        xr <- sapply(x, findInterval, x.dens$x)
        th.value <- quantile(x.dens$y[xr], th, na.rm = T)
        sprm <- which(x.dens$y < th.value)
        x.dens$y[sprm] <- 0
      }
    }
  }
  return(x.dens)
}


my.ecospat.grid <- function (glob, glob1, sp, R = 100, th.sp = 0, th.env = 0, geomask = NULL, 
  kernel.method = "adehabitat", extend.extent = c(0, 0, 0, 
    0)) 
{
  if (is.null(kernel.method) | (kernel.method != "ks" & kernel.method != 
    "adehabitat")) {
    stop("supply a kernel method ('adehabitat' or 'ks')")
  }
  glob <- as.matrix(glob)
  glob1 <- as.matrix(glob1)
  sp <- as.matrix(sp)
  l <- list()
  if (ncol(glob) > 2) {
    stop("cannot calculate overlap with more than two axes")
  }
  if (ncol(glob) == 1) {
    xmin <- min(glob[, 1]) + extend.extent[1]
    xmax <- max(glob[, 1]) + extend.extent[2]
    glob1.dens <- my.ecospat.kd(x = glob1, ext = c(xmin, xmax), 
      method = kernel.method, th = 0)
    sp.dens <- my.ecospat.kd(x = sp, ext = c(xmin, xmax), method = kernel.method, 
      th = 0, env.mask = glob1.dens$y > 0)
    x <- sp.dens$x
    y <- sp.dens$y
    z <- sp.dens$y * nrow(sp)/sum(sp.dens$y)
    Z <- glob1.dens$y * nrow(glob)/sum(glob1.dens$y)
    z.uncor <- z/max(z)
    z.cor <- z/Z
    z.cor[is.na(z.cor)] <- 0
    z.cor[z.cor == "Inf"] <- 0
    z.cor <- z.cor/max(z.cor)
  }
  if (ncol(glob) == 2) {
    xmin <- apply(glob, 2, min, na.rm = T)
    xmax <- apply(glob, 2, max, na.rm = T)
    ext <- c(xmin[1], xmax[1], xmin[2], xmax[2]) + extend.extent
    glob1.dens <- my.ecospat.kd(x = glob1, ext = ext, method = kernel.method, 
      th = 0)
    if (!is.null(geomask)) {
      sp::proj4string(geomask) <- NA
      glob1.dens <- raster::mask(glob1.dens, geomask, 
        updatevalue = 0)
    }
    sp.dens <- my.ecospat.kd(x = sp, ext = ext, method = kernel.method, 
      th = 0, env.mask = glob1.dens > 0)
    x <- seq(from = ext[1], to = ext[2], length.out = 100)
    y <- seq(from = ext[3], to = ext[4], length.out = 100)
    l$y <- y
    Z <- glob1.dens * nrow(glob1)/raster::cellStats(glob1.dens, 
      "sum")
    z <- sp.dens * nrow(sp)/raster::cellStats(sp.dens, "sum")
    z.uncor <- z/raster::cellStats(z, "max")
    z.cor <- z/Z
    z.cor[is.na(z.cor)] <- 0
    z.cor <- z.cor/raster::cellStats(z.cor, "max")
  }
  w <- z.uncor
  w[w > 0] <- 1
  l$x <- x
  l$z <- z
  l$z.uncor <- z.uncor
  l$z.cor <- z.cor
  l$Z <- Z
  l$glob <- glob
  l$glob1 <- glob1
  l$sp <- sp
  l$w <- w
  return(l)
}
```

```{r}
my.ecospat.grid2 <- function(x){
                     my.ecospat.grid(glob = PCA_bio$ind$coord[,1:2],
                                    glob1 = PCA_bio$ind$coord[,1:2],
                                    sp = x$ind$coord[,1:2],
                                    R = 1000
                                    )}

nb_mammal <- map(PCA_mammal, my.ecospat.grid2)
nb_reptile <- future_map(PCA_reptile, my.ecospat.grid2)
nb_amphibian <- future_map(PCA_amphibian, my.ecospat.grid2)

nb.01 <- function(x){length(Which(x$z.uncor>0.1, cells=T))}
nb.03 <- function(x){length(Which(x$z.uncor>0.3, cells=T))}
nb.05 <- function(x){length(Which(x$z.uncor>0.5, cells=T))}
nb.09 <- function(x){length(Which(x$z.uncor>0.9, cells=T))}

nbb.01_mammal <- map_int(nb_mammal, nb.01) 
nbb.03_mammal <- map_int(nb_mammal, nb.03)
nbb.05_mammal <- map_int(nb_mammal, nb.05)
nbb.09_mammal <- map_int(nb_mammal, nb.09)

nbb.01_reptile <- map_int(nb_reptile, nb.01) 
nbb.03_reptile <- map_int(nb_reptile, nb.03)
nbb.05_reptile <- map_int(nb_reptile, nb.05)
nbb.09_reptile <- map_int(nb_reptile, nb.09)

nbb.01_amphibian <- map_int(nb_amphibian, nb.01) 
nbb.03_amphibian <- map_int(nb_amphibian, nb.03)
nbb.05_amphibian <- map_int(nb_amphibian, nb.05)
nbb.09_amphibian <- map_int(nb_amphibian, nb.09)

plot(a$z.uncor, main = "Sp1 with default kernel")
length(Which(x$z.uncor>0.5, cells=T))

```


```{r}
result_mammal <-readr:::read_csv(file = "result_mammal.csv")
result_mammal %>% mutate(nb_01 = nbb.01_mammal,
                         nb_03 = nbb.03_mammal,
                         nb_05 = nbb.05_mammal,
                         nb_09 = nbb.09_mammal) -> result_mammal
readr::write_csv(result_mammal, file =  "result_mammal.csv")

result_reptile <-readr:::read_csv(file = "result_reptile.csv")
result_reptile %>% mutate(nb_01 = nbb.01_reptile,
                         nb_03 = nbb.03_reptile,
                         nb_05 = nbb.05_reptile,
                         nb_09 = nbb.09_reptile) -> result_reptile
readr::write_csv(result_reptile, file =  "result_reptile.csv")

result_amphibian <-readr:::read_csv(file = "result_amphibian.csv")
result_amphibian %>% mutate(nb_01 = nbb.01_amphibian,
                         nb_03 = nbb.03_amphibian,
                         nb_05 = nbb.05_amphibian,
                         nb_09 = nbb.09_amphibian) -> result_amphibian
readr::write_csv(result_amphibian, file =  "result_amphibian.csv")


qq <- ggplot(data = result_mammal) +
    geom_point(aes(x = nb_01, y = rsac_rndcv4k_sph, color = 1)) +
    geom_smooth(aes(x = nb_01, y= rsac_rndcv4k_sph), method = "lm") +
    geom_point(aes(x = nb_03, y = rsac_rndcv4k_sph, color = 2)) +
    geom_smooth(aes(x = nb_03, y= rsac_rndcv4k_sph), method = "lm") +
    geom_point(aes(x = nb_05, y = rsac_rndcv4k_sph, color = 3)) +
    geom_smooth(aes(x = nb_05, y= rsac_rndcv4k_sph), method = "lm") +
    geom_point(aes(x = nb_09, y = rsac_rndcv4k_sph, color = 4)) +
    geom_smooth(aes(x = nb_09, y= rsac_rndcv4k_sph), method = "lm")

q <- ggplot(data = result_mammal) +
    geom_point(aes(x = nb_01, y = rsac_rndcv4k_sph, color = 1)) +
    geom_smooth(aes(x = nb_01, y= rsac_rndcv4k_sph), method = "lm") 

q <- ggplot(data = result_reptile) +
    geom_point(aes(x = nb_01, y = rsac_rndcv4k_sph, color = 1)) +
    geom_smooth(aes(x = nb_01, y= rsac_rndcv4k_sph), method = "lm") 

qq <- ggplot(data = result_reptile) +
    geom_point(aes(x = nb_01, y = rsac_rndcv4k_sph, color = 1)) +
    geom_smooth(aes(x = nb_01, y= rsac_rndcv4k_sph), method = "lm") 
```










```{r}
map(out_reptile$gbif$data, map_ggplot)
```
```{r mapping occurences with mapr::mapggplot}
map(out_aves$gbif$data, map_ggplot)
mapr::map_ggplot(out_reptile$gbif$data$Terrapene_carolina, map = "usa", size = 1)
```

```{r standardized extracted points values}
standard <- function(x){scale(x, center = T, scale = T)}

standard_amphibian <- extract_spatial_amphibian_lapply %>%  map(.f = scale(., center = T, scale = T))
standard_amphibian <- map(extract_spatial_amphibian_lapply, standard) 
standard_amphibian_df <- map(standard_amphibian, as.data.frame)


```



```{r PCA extracted points with FactoMineR::PCA }
#----------------------------
# PCA extracted points
#----------------------------
list_PCA_mammal <- lapply(
  extract_spatial_mammal_lapply,
  function(x){
    PCA(x)
  }
)

list_PCA_reptile <- lapply(
  extract_spatial_reptile_lapply,
  function(x){
    PCA(x)
  }
)

list_PCA_amphibian <- lapply(
  extract_spatial_amphibian_lapply,
  function(x){
    PCA(x)
  }
)

list_PCA_aves <- lapply(
  extract_spatial_aves_furrr,
  function(x){
    PCA(x)
  }
)

```

```{r PCA extracted points from saved}
#----------------------------
# PCA extracted points - saved
#----------------------------
list_PCA_mammal <- lapply(
  extract_mammal_saved,
  function(x){
    PCA(x)
  }
)

list_PCA_reptile <- lapply(
  extract_reptile_saved,
  function(x){
    PCA(x)
  }
)

list_PCA_amphibian <- lapply(
  extract_spatial_amphibian_lapply,
  function(x){
    PCA(x)
  }
)

list_PCA_aves <- lapply(
  extract_aves_saved,
  function(x){
    PCA(x)
  }
)

```


```{r PCA for the standardized extracted points value}
list_PCA_amphibian_standard <- lapply(
  standard_amphibian,
  function(x){
    PCA(x)
  }
)

```

```{r caculating niche breadth}
#----------------------------
# Niche breadth - 0.05 ~ 0.95
#----------------------------

cord_out_1 <- list()
cord_out_2 <- list()

for (i in seq_along(1:length(list_PCA_mammal))){
  cord_out_1[[i]] <- quantile(list_PCA_mammal[[i]]$ind$coord[,1], c(0.05, .95))
  cord_out_2[[i]] <- quantile(list_PCA_mammal[[i]]$ind$coord[,2], c(0.05, .95))
}

cord_mammal_df_pc1 <- do.call(rbind, cord_out_1)
cord_mammal_df_pc2 <- do.call(rbind, cord_out_2)
nb_mammal_pc1_df <- abs(cord_mammal_df_pc1[,1]) + cord_mammal_df_pc1[,2]
nb_mammal_pc2_df <- abs(cord_mammal_df_pc2[,2]) + cord_mammal_df_pc2[,2]
nb_mammal <- nb_mammal_pc1_df + nb_mammal_pc2_df 

##########################################################



cord_out_1 <- list()
cord_out_2 <- list()

for (i in seq_along(1:length(list_PCA_reptile))){
  cord_out_1[[i]] <- quantile(list_PCA_reptile[[i]]$ind$coord[,1], c(0.05, .95))
  cord_out_2[[i]] <- quantile(list_PCA_reptile[[i]]$ind$coord[,2], c(0.05, .95))
}

cord_reptile_df_pc1 <- do.call(rbind, cord_out_1)
cord_reptile_df_pc2 <- do.call(rbind, cord_out_2)
nb_reptile_pc1_df <- abs(cord_reptile_df_pc1[,1]) + cord_reptile_df_pc1[,2]
nb_reptile_pc2_df <- abs(cord_reptile_df_pc2[,2]) + cord_reptile_df_pc2[,2]
nb_reptile <- nb_reptile_pc1_df + nb_reptile_pc2_df

##########################################################

cord_out_1 <- list()
cord_out_2 <- list()
# A for loop to extract the quantiles and same
for (i in seq_along(1:length(list_PCA_amphibian))){
  cord_out_1[[i]] <- quantile(list_PCA_amphibian[[i]]$ind$coord[,1], c(0.05, .95))
  cord_out_2[[i]] <- quantile(list_PCA_amphibian[[i]]$ind$coord[,2], c(0.05, .95))
}

# Create two corresponding DF's
cord_amphibian_df_pc1 <- do.call(rbind, cord_out_1)
cord_amphibian_df_pc2 <- do.call(rbind, cord_out_2)
nb_amphibian_pc1_df <- abs(cord_amphibian_df_pc1[,1]) + cord_amphibian_df_pc1[,2]
nb_amphibian_pc2_df <- abs(cord_amphibian_df_pc2[,2]) + cord_amphibian_df_pc2[,2]
nb_amphibian <- nb_amphibian_pc1_df + nb_amphibian_pc2_df 

##########################################################

cord_out_1 <- list()
cord_out_2 <- list()
# A for loop to extract the quantiles and same
for (i in seq_along(1:length(list_PCA_aves))){
  cord_out_1[[i]] <- quantile(list_PCA_aves[[i]]$ind$coord[,1], c(0.05, .95))
  cord_out_2[[i]] <- quantile(list_PCA_aves[[i]]$ind$coord[,2], c(0.05, .95))
}

# Create two corresponding DF's
cord_aves_df_pc1 <- do.call(rbind, cord_out_1)
cord_aves_df_pc2 <- do.call(rbind, cord_out_2)
nb_aves_pc1_df <- abs(cord_aves_df_pc1[,1]) + cord_aves_df_pc1[,2]
nb_aves_pc2_df <- abs(cord_aves_df_pc2[,2]) + cord_aves_df_pc2[,2]
nb_aves <- nb_aves_pc1_df + nb_aves_pc2_df 

##########################################################
```

```{r niche breadth with standardzied}
#----------------------------
# Niche breadth with standardized 
#----------------------------

cord_out_1 <- list()
cord_out_2 <- list()

for (i in seq_along(1:length(list_PCA_amphibian_standard))){
  cord_out_1[[i]] <- quantile(list_PCA_amphibian_standard[[i]]$ind$coord[,1], c(0.05, .95))
  cord_out_2[[i]] <- quantile(list_PCA_amphibian_standard[[i]]$ind$coord[,2], c(0.05, .95))
}

cord_amphibian_df_pc1_sd <- do.call(rbind, cord_out_1)
cord_amphibian_df_pc2_sd <- do.call(rbind, cord_out_2)
nb_amphibian_pc1_df_sd <- abs(cord_amphibian_df_pc1_sd[,1]) + cord_amphibian_df_pc1_sd[,2]
nb_amphibian_pc2_df_sd <- abs(cord_amphibian_df_pc2_sd[,2]) + cord_amphibian_df_pc2_sd[,2]
nb_amphibian_sd <- nb_amphibian_pc1_df_sd + nb_amphibian_pc2_df_sd

```

Do really nb is different with taxons?

```{r save nb}
nb_aves_df <- data.frame(nb_aves)
nb_reptile_df <- data.frame(nb_reptile)
nb_mammal_df <- data.frame(nb_mammal)

write_csv(nb_aves_df, "E:/nichebreadth/nb_aves_df.csv")
write_csv(nb_reptile_df, "E:/nichebreadth/nb_reptile_df.csv")
write_csv(nb_mammal_df, "E:/nichebreadth/nb_mammal_df.csv")

```

```{r TOP 4 PCA Variables Visualize}
pca_var_g <- fviz_pca_var(pkmon_pca, select.var = list(cos2 = 0.5), repel = TRUE)

sweep(list_PCA_mammal$Peromyscus_maniculatus$var$coord,2,sqrt(list_PCA_mammal$Peromyscus_maniculatus$eig[1:ncol(list_PCA_mammal$Peromyscus_maniculatus$var$coord),1]),FUN="/")

pcm1 <- PCA(m1bio)
pca_var_contrib <- factoextra::fviz_pca_var(pcm1, select.var = list(contrib = 3), repel = TRUE)

```

```{r TOP 4 PCA Variables}
top4_pc1_mammal <- list()
top4_pc2_mammal <- list()
for (i in seq_along(1:length(list_PCA_mammal))){
 top4_pc1_mammal[[i]] <- names(tail(sort(list_PCA_mammal[[i]]$var$cos2[,1]), 4))
 top4_pc2_mammal[[i]] <- names(tail(sort(list_PCA_mammal[[i]]$var$cos2[,2]), 4))
}

top4_pc1_reptile <- list()
top4_pc2_reptile <- list()
for (i in seq_along(1:length(list_PCA_reptile))){
  top4_pc1_reptile[[i]] <- names(tail(sort(list_PCA_reptile[[i]]$var$cos2[,1]), 4))
  top4_pc2_reptile[[i]] <- names(tail(sort(list_PCA_reptile[[i]]$var$cos2[,2]), 4))
}

top4_pc1_amphibian <- list()
top4_pc2_amphibian <- list()
for (i in seq_along(1:length(list_PCA_amphibian))){
  top4_pc1_amphibian[[i]] <- names(tail(sort(list_PCA_amphibian[[i]]$var$cos2[,1]), 4))
  top4_pc2_amphibian[[i]] <- names(tail(sort(list_PCA_amphibian[[i]]$var$cos2[,2]), 4))
}

top4_pc1_aves <- list()
top4_pc2_aves <- list()
for (i in seq_along(1:length(list_PCA_aves))){
  top4_pc1_aves[[i]] <- names(tail(sort(list_PCA_aves[[i]]$var$cos2[,1]), 4))
  top4_pc2_aves[[i]] <- names(tail(sort(list_PCA_aves[[i]]$var$cos2[,2]), 4))
}

```

```{r TOP 4 PCA standardized variables}
##################### 
# TOP 4 PCA standardized 
######################
top4_pc1_amphibian_sd <- list()
top4_pc2_amphibian_sd <- list()
for (i in seq_along(1:length(list_PCA_amphibian_standard))){
  top4_pc1_amphibian_sd[[i]] <- names(tail(sort(list_PCA_amphibian_standard[[i]]$var$cos2[,1]), 4))
  top4_pc2_amphibian_sd[[i]] <- names(tail(sort(list_PCA_amphibian_standard[[i]]$var$cos2[,2]), 4))
}

```

```{r stacking rasters }

paste2 <- function(x){paste("E:/residual_sdm/" ,x, ".tif", sep = "")}



######################################################
top4_pc1_mammal.tif <- top4_pc1_mammal %>% map(paste2)
top4_pc2_mammal.tif <- top4_pc2_mammal %>% map(paste2)

top4_pc2_mammal.tif.stack <- top4_pc2_mammal.tif %>% map(stack)
top4_pc1_mammal.tif.stack <- top4_pc1_mammal.tif %>% map(stack)
top4_pc12_mammal.stack <- map2(top4_pc1_mammal.tif.stack, top4_pc2_mammal.tif.stack, stack)

##############################################################################
top4_pc1_reptile.tif <- top4_pc1_reptile %>% map(paste2)
top4_pc2_reptile.tif <- top4_pc2_reptile %>% map(paste2)

top4_pc2_reptile.tif.stack <- top4_pc2_reptile.tif %>% map(stack)
top4_pc1_reptile.tif.stack <- top4_pc1_reptile.tif %>% map(stack)
top4_pc12_reptile.stack <- map2(top4_pc1_reptile.tif.stack, top4_pc2_reptile.tif.stack, stack)

##############################################################################
top4_pc1_amphibian.tif <- top4_pc1_amphibian %>% map(paste2)
top4_pc2_amphibian.tif <- top4_pc2_amphibian %>% map(paste2)

top4_pc2_amphibian.tif.stack <- top4_pc2_amphibian.tif %>% map(stack)
top4_pc1_amphibian.tif.stack <- top4_pc1_amphibian.tif %>% map(stack)
top4_pc12_amphibian.stack <- map2(top4_pc1_amphibian.tif.stack, top4_pc2_amphibian.tif.stack, stack)

##############################################################################
top4_pc1_aves.tif <- top4_pc1_aves %>% map(paste2)
top4_pc2_aves.tif <- top4_pc2_aves %>% map(paste2)

top4_pc2_aves.tif.stack <- top4_pc2_aves.tif %>% map(stack)
top4_pc1_aves.tif.stack <- top4_pc1_aves.tif %>% map(stack)
top4_pc12_aves.stack <- map2(top4_pc1_aves.tif.stack, top4_pc2_aves.tif.stack, stack)

```

```{r get the extent}
#extent 
extent_mammal <- map(list_spatial_mammal, extent)
extent_reptile <- map(list_spatial_reptile, extent)
extent_amphibian <- map(list_spatial_amphibian, extent)
extent_aves <- map(list_spatial_aves, extent)
```

```{r}
#----------------------------
#raster crop to save times
#----------------------------

tic("mammal_bios") #mammal_bios: 5026.39 sec elapsed
mammal_bios <- furrr::future_map2(top4_pc12_mammal.stack, extent_mammal, crop)
toc()

tic("reptile_bios") #reptile_bios: 2834.84 sec elapsed
reptile_bios <- furrr::future_map2(top4_pc12_reptile.stack, extent_reptile, crop)
toc()

tic("amphibian_bios") #amphibian_bios: 762.35 sec elapsed
amphibian_bios <- furrr::future_map2(top4_pc12_amphibian.stack, extent_amphibian, crop)
toc()

tic("aves_bios") #aves_bios: 3765.14 sec elapsed
aves_bios <- furrr::future_map2(top4_pc12_aves.stack, extent_aves, crop)
toc()


```


```{r save raster}

reptile_bios %>% furrr::future_map2(paste0("J:/reptile_bios_", list_origin_reptile,".gri"), writeRaster)

amphibian_bios %>% furrr::future_map2(paste0("J:/amphibian_bios_", list_origin_amphibian,".gri"), writeRaster)

aves_bios %>% 
furrr::future_map2(paste0("J:/aves_bios_", list_origin_aves,".gri"), writeRaster)

```

```{r read saved rasters}

bios_mammal <- list.files(path = "J:/", pattern="*.gri")
bios_mammal <- paste0("J:/mammal_bios_", list_origin_mammal, ".gri")
bios_mammal <- map(bios_mammal, brick)

bios_amphibian <- list.files(path = "J:/", pattern="*.gri")
bios_amphibian <- paste0("J:/amphibian/amphibian_bios_", list_origin_amphibian, ".gri")
bios_amphibian <- map(bios_amphibian, brick)

bios_aves <- list.files(path = "J:/", pattern="*.gri")
bios_aves <- paste0("J:/aves_bios_", list_origin_aves, ".gri")
bios_aves <- map(bios_aves, brick)

bios_reptile <- list.files(path = "J:/", pattern="*.gri")
bios_reptile <- paste0("J:/reptile_bios_", list_origin_reptile, ".gri")
bios_reptile <- map(bios_reptile, brick)


```
Old face is name face. Classic PCA is nice as well.  


```{r}

```


t-SNE was fancy for last few years. Check it too.  

```{r}

```

But UMAP is even more fancier these days.

```{r}

```

Don't forget the environmental grid.
```{r}
dismo::gridSample()

```



```{r}

```

Before PCA, Let's check correlation matrix of variables
```{r}
extract_spatial_amphibian_lapply[[1]] %>% 
  mutate_if(is.numeric, scale) %>% 
  select_if(is.numeric) %>% 
  correlate() %>% # (2)
  shave(upper = TRUE) %>% # (3)
  stretch(na.rm = TRUE) %>% 
  arrange(-r) %>% 
  DT::datatable() %>% 
  DT::formatRound("r", digits = 2)

```


```{r}
dismo::threshold()
```

t-SNE, UMAP, PCA, Environment filter? 

## 추가 연구 Further study 
```{r}
library("sampbias")
```

# Boyce

```{r}
library(tidyverse)
library(SDMtune)
library(blockCV)
library(ENMeval)
library(raster)
library(sf)
library(sp)
library(zeallot)
library(rJava)
library(dismo)
library(ecospat)
```

load bioclimate models
```{r}
data.mammal <- readr::read_rds("data/newdata/data.mammal.rds")
data.reptile <- readr::read_rds("data/newdata/data.reptile.rds")
data.amphibian <- readr::read_rds("data/newdata/data.amphibian.rds")

#bios
model_rndcv4k_mammal <- readr::read_rds("model/newmodel/model_rndcv4k_mammal.rds")
model_spcv4k_mammal <- readr::read_rds("model/newmodel/model_spcv4k_mammal.rds")


model_rndcv4k_reptile <- readr::read_rds("model/newmodel/model_rndcv4k_reptile.rds")
model_spcv4k_reptile <- readr::read_rds("model/newmodel/model_spcv4k_reptile.rds")


model_rndcv4k.pcnm_reptile <- readr::read_rds("model/newmodel/model_pcnm/model_rndcv4k_reptile.rds")
model_spcv4k.pcnm_reptile <- readr::read_rds("model/newmodel/model_pcnm/model_spcv4k_reptile.rds")

model_rndcv4k_amphibian <- readr::read_rds("model/newmodel/model_rndcv4k_amphibian.rds")
model_spcv4k_amphibian <- readr::read_rds("model/newmodel/model_spcv4k_amphibian.rds")

#PCNMs
model_rndcv4k.pcnm_amphibian <- readr::read_rds("model/newmodel/model_pcnm/model_rndcv4k_amphibian.rds")
model_spcv4k.pcnm_amphibian <- readr::read_rds("model/newmodel/model_pcnm/model_spcv4k_amphibian.rds")

t.t.mammal_0.2 <- readr::read_rds("t.t/newt.t/t.t.mammal_0.2.rds")
t.t.reptile_0.2 <- readr::read_rds("t.t/newt.t/t.t.reptile_0.2.rds")
t.t.amphibian_0.2 <- readr::read_rds("t.t/newt.t/t.t.amphibian_0.2.rds")

t.t.pcnm.reptile_0.2 <- readr::read_rds("t.t/newt.t/t.t.pcnm.reptile_0.2.rds")
t.t.pcnm.amphibian_0.2 <- readr::read_rds("t.t/newt.t/t.t.pcnm.amphibian_0.2.rds")

#grid 
grid.rnd_reptile <- readr::read_rds("D:/grid.rnd_reptile.rds")
grid.rnd_amphibian <- readr::read_rds("D:/grid.rnd_amphibian.rds")
grid.sp_reptile <- readr::read_rds("D:/grid.sp_reptile.rds")
grid.sp_amphibian <- readr::read_rds("D:/grid.sp_amphibian.rds")




grid.rnd.pcnm_reptile <- readr::read_rds("D:/grid.rnd.pcnm_reptile.rds")
grid.rnd.pcnm_amphibian <- readr::read_rds("D:/grid.rnd.pcnm_amphibian.rds")
grid.sp.pcnm_reptile <- readr::read_rds("D:/grid.sp.pcnm_reptile.rds")
grid.sp.pcnm_amphibian <- readr::read_rds("D:/grid.sp.pcnm_amphibian.rds")

a <- vector()
for(i in 1:length(grid.rnd.pcnm_reptile)){a[i] <- nrow(grid.rnd.pcnm_reptile[[i]]@models[[1]]@data@data)}
b <- vector()
for(i in 1:length(grid.rnd.pcnm_amphibian)){b[i] <- nrow(grid.rnd.pcnm_amphibian[[i]]@models[[1]]@data@data)}

folds.sp4k_amphibian <- readr::read_rds("folds/folds.sp4k_amphibian.rds")
SARange_amphibian <- readr::read_rds("SARange/SARange_amphibian.rds")

```

because original plot is highly exagrated.

let's check reg 5. the middle one.

```{r}

######bio
model_rndcv4k_reptile <- list()
for(i in 1:length(grid.rnd_reptile)){
model_rndcv4k_reptile[[i]] <- grid.rnd_reptile[[i]]@models[[1]]  
}

model_rndcv4k_amphibian <- list()
for(i in 1:length(grid.rnd_amphibian)){
model_rndcv4k_amphibian[[i]] <- grid.rnd_amphibian[[i]]@models[[1]]  
}

model_spcv4k_reptile <- list()
for(i in 1:length(grid.sp_reptile)){
model_spcv4k_reptile[[i]] <- grid.sp_reptile[[i]]@models[[1]]  
}

model_spcv4k_amphibian <- list()
for(i in 1:length(grid.sp_amphibian)){
model_spcv4k_amphibian[[i]] <- grid.sp_amphibian[[i]]@models[[1]]  
}
## PCNM
model_rndcv4k.pcnm_reptile <- list()
for(i in 1:length(grid.rnd.pcnm_reptile)){
model_rndcv4k.pcnm_reptile[[i]] <- grid.rnd.pcnm_reptile[[i]]@models[[1]]  
}

model_rndcv4k.pcnm_amphibian <- list()
for(i in 1:length(grid.rnd.pcnm_amphibian)){
model_rndcv4k.pcnm_amphibian[[i]] <- grid.rnd.pcnm_amphibian[[i]]@models[[1]]  
}

model_spcv4k.pcnm_reptile <- list()
for(i in 1:length(grid.sp.pcnm_reptile)){
model_spcv4k.pcnm_reptile[[i]] <- grid.sp.pcnm_reptile[[i]]@models[[1]]  
}

model_spcv4k.pcnm_amphibian <- list()
for(i in 1:length(grid.sp.pcnm_amphibian)){
model_spcv4k.pcnm_amphibian[[i]] <- grid.sp.pcnm_amphibian[[i]]@models[[1]]  
}


```






```{r}
model_rndcv4k.pcnm_amphibian <- readr::read_rds("model/pcnmmodel/model_rndcv4k_amphibian.rds")
```

```{r 91 vs 93 reptile}
a <- vector()
for(i in 1:length(model_rndcv4k_reptile)){a[i] <- model_rndcv4k_reptile[[i]]@data@species }
a

a[c(47,77)]

b <- vector()
for(i in 1:length(t.t.reptile_0.2)){b[i] <- t.t.reptile_0.2[[i]][[1]]@species}
b

model_rndcv4k_reptile <- model_rndcv4k_reptile[-c(47,77)]
```


```{r}
#cut data.amphibian 
data.amphibian[c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] <- NULL
#and 9 for glm error 
data.amphibian[[9]] <- NULL
```



```{r}
source("plots.R")
```


```{r}
boyce_mammal <- readr::read_rds("boyce/boyce_mammal.rds")
```


```{r}
model_spcv4k.pcnm_amphibian <- readr::read_rds("model/pcnmmodel/fwd/model_spcv4k_amphibian.rds")
data.amphibian[c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] <- NULL
data.amphibian[c(11, 21, 25)] <- NULL
data.amphibian <- data.amphibian[-10] 
data.amphibian <- data.amphibian[-22] 
data.amphibian.pcnm <- data.amphibian
```

```{r}
t.t.amphibian_0.2.pcnm <- list()
for (i in 1:length(data.amphibian.pcnm)){
  t.t.amphibian_0.2.pcnm[[i]] <- trainValTest(data.amphibian.pcnm[[i]], 
                                         test = 0.2, 
                                         only_presence = TRUE, 
                                         seed = 1)}
```



test_rndcv 
```{r test_rndcv mean}
#MAMMAL
test_rndcv4k_mammal <- list()
for(i in 1:length(model_rndcv4k_mammal)){
test_rndcv4k_mammal[[i]] <- list(SDMtune::predict(model_rndcv4k_mammal[[i]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```

```{r test_rndcv mean}
#REPTILE RND
test_rndcv4k_reptile <- list()
for(i in 1:length(model_rndcv4k_reptile)){
test_rndcv4k_reptile[[i]] <- list(SDMtune::predict(model_rndcv4k_reptile[[i]], 
                                                  t.t.reptile_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_reptile[[i]],
                                 t.t.reptile_0.2[[i]][[2]]@data[t.t.reptile_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))
                                } #전부다는 [[1]]에, 출현은 [[2]]에
```

```{r test_rndcv mean}
#AMPHIBIAN RND
test_rndcv4k_amphibian <- list()
for(i in 1:length(model_rndcv4k_amphibian)){
test_rndcv4k_amphibian[[i]] <- list(SDMtune::predict(model_rndcv4k_amphibian[[i]], 
                                                  t.t.amphibian_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_amphibian[[i]],
                                 t.t.amphibian_0.2[[i]][[2]]@data[t.t.amphibian_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```


```{r test_spcv mean}
#REPTILE SP
test_spcv4k_reptile <- list()
for(i in 1:length(model_spcv4k_reptile)){
test_spcv4k_reptile[[i]] <- list(SDMtune::predict(model_spcv4k_reptile[[i]], 
                                                  t.t.reptile_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_reptile[[i]],
                                 t.t.reptile_0.2[[i]][[2]]@data[t.t.reptile_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```


```{r test_spcv mean}
#AMPHIBIAN SP
test_spcv4k_amphibian <- list()
for(i in 1:length(model_spcv4k_amphibian)){
test_spcv4k_amphibian[[i]] <- list(SDMtune::predict(model_spcv4k_amphibian[[i]], 
                                                  t.t.amphibian_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_amphibian[[i]],
                                 t.t.amphibian_0.2[[i]][[2]]@data[t.t.amphibian_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```




test_rnd but PCNM REPTILE
```{r test_rndcv mean}
test_rndcv4k.pcnm_reptile <- list()
for(i in 1:length(model_rndcv4k.pcnm_reptile)){
test_rndcv4k.pcnm_reptile[[i]] <- list(SDMtune::predict(model_rndcv4k.pcnm_reptile[[i]], 
                                                  t.t.pcnm.reptile_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k.pcnm_reptile[[i]],
                                 t.t.pcnm.reptile_0.2[[i]][[2]]@data[t.t.pcnm.reptile_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")
                                )} #전부다는 [[1]]에, 출현은 [[2]]에
```

test_rnd but PCNM AMPHIBIAN
```{r test_rndcv mean}
test_rndcv4k.pcnm_amphibian <- list()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
test_rndcv4k.pcnm_amphibian[[i]] <- list(SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]], 
                                                  t.t.pcnm.amphibian_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]],
                                 t.t.pcnm.amphibian_0.2[[i]][[2]]@data[t.t.pcnm.amphibian_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```

test_SP PCNM REPTILE

```{r test_rndcv mean}
test_spcv4k.pcnm_reptile <- list()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
test_spcv4k.pcnm_reptile[[i]] <- list(SDMtune::predict(model_spcv4k.pcnm_reptile[[i]], 
                                                  t.t.pcnm.reptile_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k.pcnm_reptile[[i]],
                                 t.t.pcnm.reptile_0.2[[i]][[2]]@data[t.t.pcnm.reptile_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```

test_SP PCNM AMPHIBIAN

```{r test_rndcv mean}
test_spcv4k.pcnm_amphibian <- list()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
test_spcv4k.pcnm_amphibian[[i]] <- list(SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]], 
                                                  t.t.pcnm.amphibian_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]],
                                 t.t.pcnm.amphibian_0.2[[i]][[2]]@data[t.t.pcnm.amphibian_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```


test_spcv 
```{r test_spcv mean}
test_spcv4k_mammal <- list()
for(i in 1:length(model_spcv4k_mammal)){
test_spcv4k_mammal[[i]] <- list(SDMtune::predict(model_spcv4k_mammal[[i]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```






test_rndcv not mean
```{r test_rndcv not mean}
test_rndcv4k.notmean_mammal <- list()
for(i in 1:length(model_rndcv4k_mammal)){
test_rndcv4k.notmean_mammal[[i]] <- list(list(SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[1]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[1]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                 list(SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[2]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[2]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                 list(SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[3]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[3]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                 list(SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[4]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[4]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")))} #전부다는 [[1]]에, 출현은 [[2]]에
```

test spcv not mean
```{r test_spcv not mean}
test_spcv4k.notmean_mammal <- list()
for(i in 1:length(model_spcv4k_mammal)){
test_spcv4k.notmean_mammal[[i]] <- list(list(SDMtune::predict(model_spcv4k_mammal[[i]]@models[[1]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]]@models[[1]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                 list(SDMtune::predict(model_spcv4k_mammal[[i]]@models[[2]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]]@models[[2]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                 list(SDMtune::predict(model_spcv4k_mammal[[i]]@models[[3]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]]@models[[3]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                 list(SDMtune::predict(model_spcv4k_mammal[[i]]@models[[4]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]]@models[[4]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")))} #전부다는 [[1]]에, 출현은 [[2]]에
```


```{r}
poc.df_rndcv4k_mammal <- list()
for(i in 1:length(model_rndcv4k_mammal)){
poc.df_rndcv4k_mammal[[i]] <- list(SDMtune::predict(model_rndcv4k_mammal[[i]], 
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 0,],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #배경은 [[1]]에, 출현은 [[2]]에






```

boyce caculator
```{r}
my.boyce <- function(x,y){ecospat.boyce(fit = x, 
                                        obs = y,
                                              nclass=0,
                                              window.w="default",
                                              res=100,
                                              PEplot = TRUE)}
```


```{r boyce.test mean}
boyce.test.rnd_mammal <- list()
for(i in 1:length(test_rndcv4k_mammal)){
boyce.test.rnd_mammal[[i]] <- my.boyce(test_rndcv4k_mammal[[i]][[1]], test_rndcv4k_mammal[[i]][[2]])  
}

```

```{r boyce.test rnd bioclimate mean reptile}
boyce.test.rnd_reptile <- list()
for(i in 1:length(test_rndcv4k_reptile)){
boyce.test.rnd_reptile[[i]] <- my.boyce(test_rndcv4k_reptile[[i]][[1]], test_rndcv4k_reptile[[i]][[2]])  
}

```




```{r boyce.test rnd bioclimate mean reptile}
boyce.test.rnd_amphibian <- list()
for(i in 1:length(test_rndcv4k_amphibian)){
boyce.test.rnd_amphibian[[i]] <- my.boyce(test_rndcv4k_amphibian[[i]][[1]], test_rndcv4k_amphibian[[i]][[2]])  
}

```



```{r boyce.test rnd PCNM mean reptile}
boyce.test.rnd.pcnm_reptile <- list()
for(i in 1:length(test_rndcv4k.pcnm_reptile)){
boyce.test.rnd.pcnm_reptile[[i]] <- my.boyce(test_rndcv4k.pcnm_reptile[[i]][[1]], test_rndcv4k.pcnm_reptile[[i]][[2]])  
}

```


```{r boyce.test rnd PCNM mean amphibian}
boyce.test.rnd.pcnm_amphibian <- list()
for(i in 1:length(test_rndcv4k.pcnm_amphibian)){
boyce.test.rnd.pcnm_amphibian[[i]] <- my.boyce(test_rndcv4k.pcnm_amphibian[[i]][[1]], test_rndcv4k.pcnm_amphibian[[i]][[2]])  
}

```


```{r boyce.test mean}
#REPTILE SP
boyce.test.sp_reptile <- list()
for(i in 1:length(test_spcv4k_reptile)){
boyce.test.sp_reptile[[i]] <- my.boyce(test_spcv4k_reptile[[i]][[1]], test_spcv4k_reptile[[i]][[2]])  
}

```

```{r boyce.test mean}
#AMPHIBIAN SP
boyce.test.sp_amphibian <- list()
for(i in 1:length(test_spcv4k_amphibian)){
boyce.test.sp_amphibian[[i]] <- my.boyce(test_spcv4k_amphibian[[i]][[1]], test_spcv4k_amphibian[[i]][[2]])  
}

```



```{r boyce.test sp PCNM mean REPTILE}
boyce.test.sp.pcnm_reptile <- list()
for(i in 1:length(test_spcv4k.pcnm_reptile)){
boyce.test.sp.pcnm_reptile[[i]] <- my.boyce(test_spcv4k.pcnm_reptile[[i]][[1]], test_spcv4k.pcnm_reptile[[i]][[2]])  
}

```


```{r boyce.test sp PCNM mean}
boyce.test.sp.pcnm_amphibian <- list()
for(i in 1:length(test_spcv4k.pcnm_amphibian)){
boyce.test.sp.pcnm_amphibian[[i]] <- my.boyce(test_spcv4k.pcnm_amphibian[[i]][[1]], test_spcv4k.pcnm_amphibian[[i]][[2]])  
}

```


```{r boyce.test rnd NOT mean}
boyce.test.rnd.notmean_mammal <- list()
for(i in 1:length(test_rndcv4k.notmean_mammal)){boyce.test.rnd.notmean_mammal[[i]] <- 
                    list(my.boyce(test_rndcv4k.notmean_mammal[[i]][[1]][[1]], test_rndcv4k.notmean_mammal[[i]][[1]][[2]]),
                        my.boyce(test_rndcv4k.notmean_mammal[[i]][[2]][[1]], test_rndcv4k.notmean_mammal[[i]][[2]][[2]]),
                        my.boyce(test_rndcv4k.notmean_mammal[[i]][[3]][[1]], test_rndcv4k.notmean_mammal[[i]][[3]][[2]]),
                        my.boyce(test_rndcv4k.notmean_mammal[[i]][[4]][[1]], test_rndcv4k.notmean_mammal[[i]][[4]][[2]]))
}
```


#jesus fucking macrotis lagotis
do not remove. just pass that fig
```{r boyce.test rnd NOT mean}
boyce.test.sp.notmean_mammal <- list()
for(i in 1:length(test_spcv4k.notmean_mammal)){boyce.test.sp.notmean_mammal[[i]] <- 
                    list(my.boyce(test_spcv4k.notmean_mammal[[i]][[1]][[1]], test_spcv4k.notmean_mammal[[i]][[1]][[2]]),
                        my.boyce(test_spcv4k.notmean_mammal[[i]][[2]][[1]], test_spcv4k.notmean_mammal[[i]][[2]][[2]]),
                        my.boyce(test_spcv4k.notmean_mammal[[i]][[3]][[1]], test_spcv4k.notmean_mammal[[i]][[3]][[2]]),
                        my.boyce(test_spcv4k.notmean_mammal[[i]][[4]][[1]], test_spcv4k.notmean_mammal[[i]][[4]][[2]]))
}# this will stop at 12 macrotis lagotis
```
```{r boyce.test rnd NOT mean}
boyce.test.sp.notmean_mammal <- list()
for(i in 13:length(test_spcv4k.notmean_mammal)){boyce.test.sp.notmean_mammal[[i]] <- 
                    list(my.boyce(test_spcv4k.notmean_mammal[[i]][[1]][[1]], test_spcv4k.notmean_mammal[[i]][[1]][[2]]),
                        my.boyce(test_spcv4k.notmean_mammal[[i]][[2]][[1]], test_spcv4k.notmean_mammal[[i]][[2]][[2]]),
                        my.boyce(test_spcv4k.notmean_mammal[[i]][[3]][[1]], test_spcv4k.notmean_mammal[[i]][[3]][[2]]),
                        my.boyce(test_spcv4k.notmean_mammal[[i]][[4]][[1]], test_spcv4k.notmean_mammal[[i]][[4]][[2]]))
}# so just fucking pass it
```

make df 
```{r}
df.boyce.test.rndsp.notmean_mammal <- list()
for(i in 1:35){df.boyce.test.rndsp.notmean_mammal[[i]] <- rbind(data.frame(Hs = boyce.test.rnd.notmean_mammal[[i]][[1]]$HS,
                                                                F.ratio = boyce.test.rnd.notmean_mammal[[i]][[1]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs = boyce.test.rnd.notmean_mammal[[i]][[2]]$HS,
                                                                F.ratio = boyce.test.rnd.notmean_mammal[[i]][[2]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs = boyce.test.rnd.notmean_mammal[[i]][[3]]$HS,
                                                                F.ratio = boyce.test.rnd.notmean_mammal[[i]][[3]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs = boyce.test.rnd.notmean_mammal[[i]][[4]]$HS,
                                                                F.ratio = boyce.test.rnd.notmean_mammal[[i]][[4]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs= boyce.test.sp.notmean_mammal[[i]][[1]]$HS,
                                                                F.ratio = boyce.test.sp.notmean_mammal[[i]][[1]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs= boyce.test.sp.notmean_mammal[[i]][[2]]$HS,
                                                                F.ratio = boyce.test.sp.notmean_mammal[[i]][[2]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs= boyce.test.sp.notmean_mammal[[i]][[3]]$HS,
                                                                F.ratio = boyce.test.sp.notmean_mammal[[i]][[3]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs= boyce.test.sp.notmean_mammal[[i]][[4]]$HS,
                                                                F.ratio = boyce.test.sp.notmean_mammal[[i]][[4]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species))
}# this will stop in 11

#pass 12 and move on to 13
for(i in 13:35){df.boyce.test.rndsp.notmean_mammal[[i]] <- rbind(data.frame(Hs = boyce.test.rnd.notmean_mammal[[i]][[1]]$HS,
                                                                F.ratio = boyce.test.rnd.notmean_mammal[[i]][[1]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs = boyce.test.rnd.notmean_mammal[[i]][[2]]$HS,
                                                                F.ratio = boyce.test.rnd.notmean_mammal[[i]][[2]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs = boyce.test.rnd.notmean_mammal[[i]][[3]]$HS,
                                                                F.ratio = boyce.test.rnd.notmean_mammal[[i]][[3]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs = boyce.test.rnd.notmean_mammal[[i]][[4]]$HS,
                                                                F.ratio = boyce.test.rnd.notmean_mammal[[i]][[4]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs= boyce.test.sp.notmean_mammal[[i]][[1]]$HS,
                                                                F.ratio = boyce.test.sp.notmean_mammal[[i]][[1]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs= boyce.test.sp.notmean_mammal[[i]][[2]]$HS,
                                                                F.ratio = boyce.test.sp.notmean_mammal[[i]][[2]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs= boyce.test.sp.notmean_mammal[[i]][[3]]$HS,
                                                                F.ratio = boyce.test.sp.notmean_mammal[[i]][[3]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs= boyce.test.sp.notmean_mammal[[i]][[4]]$HS,
                                                                F.ratio = boyce.test.sp.notmean_mammal[[i]][[4]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species))
}

df.boyce.test.rndsp.notmean_mammal[-12] -> df.boyce.test.rndsp.notmean_mammal
df.boyce.test.rndsp.notmean_mammal2 <- do.call(rbind, df.boyce.test.rndsp.notmean_mammal)    


```



to check boyce of spcv4k without PCNM
```{r}
test_spcv4k_amphibian <- list()
for(i in 1:length(model_spcv4k_amphibian)){
test_spcv4k_amphibian[[i]] <- list(SDMtune::predict(model_spcv4k_amphibian[[i]], 
                                                  t.t.amphibian_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_amphibian[[i]],
                                 t.t.amphibian_0.2[[i]][[2]]@data[t.t.amphibian_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```

```{r}
boyce_test.sp_amphibian <- list()
for(i in 1:length(test_spcv4k_amphibian)){
boyce_test.sp_amphibian[[i]] <- my.boyce(test_spcv4k_amphibian[[i]][[1]], test_spcv4k_amphibian[[i]][[2]])  
}
```



```{r}


boyce_test.sp.pcnm_amphibian <- list()
for(i in 1:length(test_spcv4k.pcnm_amphibian)){
boyce_test.sp.pcnm_amphibian[[i]] <- my.boyce(test_spcv4k.pcnm_amphibian[[i]][[1]], test_spcv4k.pcnm_amphibian[[i]][[2]])  
}
```


```{r}
df.boyce.test.sp.pcnm_amphibian <- list()
for(i in 1:30){df.boyce.test.sp.pcnm_amphibian[[i]] <- rbind(data.frame(Hs = boyce_test.sp.pcnm_amphibian[[i]][[1]]$HS,
                                                            F.ratio = boyce_test.sp.pcnm_amphibian[[i]][[1]]$F.ratio,
                                                            model = "m1",
                                                            species = data.amphibian.pcnm[[i]]@species),
                                                 data.frame(Hs = boyce_test.sp.pcnm_amphibian[[i]][[2]]$HS,
                                                            F.ratio = boyce_test.sp.pcnm_amphibian[[i]][[2]]$F.ratio,
                                                            model = "m2",
                                                            species = data.amphibian.pcnm[[i]]@species),
                                                 data.frame(Hs = boyce_test.sp.pcnm_amphibian[[i]][[3]]$HS,
                                                            F.ratio = boyce_test.sp.pcnm_amphibian[[i]][[3]]$F.ratio,
                                                            model = "m3",
                                                            species = data.amphibian.pcnm[[i]]@species),
                                                 data.frame(Hs = boyce_test.sp.pcnm_amphibian[[i]][[4]]$HS,
                                                            F.ratio = boyce_test.sp.pcnm_amphibian[[i]][[4]]$F.ratio,
                                                            model = "m4",
                                                            species = data.amphibian.pcnm[[i]]@species))}



df.boyce.test.sp.pcnm_amphibian2 <- do.call(rbind, df.boyce.test.sp.pcnm_amphibian)
```



```{r}

data.val.mammal <- list()
for(i in 1:35){data.val.mammal[[i]] <- list(model_rndcv4k_mammal[[i]]@data@data[model_rndcv4k_mammal[[i]]@folds$test[,1],][1:(sum(model_rndcv4k_mammal[[i]]@data@pa == 1) - sum(model_rndcv4k_mammal[[i]]@models[[1]]@data@pa == 1)),],
                    model_rndcv4k_mammal[[i]]@data@data[model_rndcv4k_mammal[[i]]@folds$test[,2],][1:(sum(model_rndcv4k_mammal[[i]]@data@pa == 1) - sum(model_rndcv4k_mammal[[i]]@models[[2]]@data@pa == 1)),],
                    model_rndcv4k_mammal[[i]]@data@data[model_rndcv4k_mammal[[i]]@folds$test[,3],][1:(sum(model_rndcv4k_mammal[[i]]@data@pa == 1) - sum(model_rndcv4k_mammal[[i]]@models[[3]]@data@pa == 1)),],
                    model_rndcv4k_mammal[[i]]@data@data[model_rndcv4k_mammal[[i]]@folds$test[,4],][1:(sum(model_rndcv4k_mammal[[i]]@data@pa == 1) - sum(model_rndcv4k_mammal[[i]]@models[[4]]@data@pa == 1)),])}

data.valnwbg.mammal <- list()
for(i in 1:35){
  data.valnwbg.mammal[[i]] <- list( model_rndcv4k_mammal[[i]]@data@data[model_rndcv4k_mammal[[i]]@folds$test[,1],],
model_rndcv4k_mammal[[i]]@data@data[model_rndcv4k_mammal[[i]]@folds$test[,2],],
model_rndcv4k_mammal[[i]]@data@data[model_rndcv4k_mammal[[i]]@folds$test[,3],],
model_rndcv4k_mammal[[i]]@data@data[model_rndcv4k_mammal[[i]]@folds$test[,4],])
}


# model_rndcv4k_mammal[[1]]@data@data[model_rndcv4k_mammal[[1]]@folds$test[,1],][1:(sum(model_rndcv4k_mammal#[[1]]@data@pa == 1) - sum(model_rndcv4k_mammal[[1]]@models[[1]]@data@pa == 1)),] # 1st val set

# CV 모형의 전체 학습 출현 개수
#sum(model_rndcv4k_mammal[[1]]@data@pa == 1)
# 1번 모형의 학습 출현 개수
#sum(model_rndcv4k_mammal[[1]]@models[[1]]@data@pa == 1)
  
  
#model_rndcv4k_mammal[[1]]@data@data[model_rndcv4k_mammal[[1]]@folds$test[,1],][model_rndcv4k_mammal[[1]]@models[[1]]@data@pa# 1st val set

#model_rndcv4k_mammal[[1]]@data@data[model_rndcv4k_mammal[[1]]@data@pa==1,][model_rndcv4k_mammal[[1]]@folds$test[,1],]                                                                               
                                                                               
                                                                               
                                                                               
#model_rndcv4k_mammal[[1]]@data@data[model_rndcv4k_mammal[[1]]@folds$test[,2],]# 2nd val set
#model_rndcv4k_mammal[[1]]@data@data[model_rndcv4k_mammal[[1]]@folds$test[,3],]# 3rd val set
#model_rndcv4k_mammal[[1]]@data@data[model_rndcv4k_mammal[[1]]@folds$test[,4],]# 4th val set

#1번 종의 CV 모형        #그중 1번째 모형 #에 포함된 데이터
#model_rndcv4k_mammal[[1]]@models[[1]]@data@data[model_rndcv4k_mammal[[1]]@folds$test[,1],]

#1번 종의 CV 모형        #그중 1번째 모형 #에 포함된 데이터(종, pa도 잇음)
#model_rndcv4k_mammal[[1]]@models[[1]]@data@data[model_rndcv4k_mammal[[1]]@models[[1]]@data@pa == 1,]

```


validation to pcnm model
```{r}

data.val.amphibian <- list()
for(i in 1:34){data.val.amphibian[[i]] <- list(model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@folds$test[,1],][1:(sum(model_rndcv4k.pcnm_amphibian[[i]]@data@pa == 1) - sum(model_rndcv4k.pcnm_amphibian[[i]]@models[[1]]@data@pa == 1)),],
                    model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@folds$test[,2],][1:(sum(model_rndcv4k.pcnm_amphibian[[i]]@data@pa == 1) - sum(model_rndcv4k.pcnm_amphibian[[i]]@models[[2]]@data@pa == 1)),],
                    model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@folds$test[,3],][1:(sum(model_rndcv4k.pcnm_amphibian[[i]]@data@pa == 1) - sum(model_rndcv4k.pcnm_amphibian[[i]]@models[[3]]@data@pa == 1)),],
                    model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@folds$test[,4],][1:(sum(model_rndcv4k.pcnm_amphibian[[i]]@data@pa == 1) - sum(model_rndcv4k.pcnm_amphibian[[i]]@models[[4]]@data@pa == 1)),])}

data.valnwbg.amphibian <- list()
for(i in 1:34){
  data.valnwbg.amphibian[[i]] <- list( model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@folds$test[,1],],
model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@folds$test[,2],],
model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@folds$test[,3],],
model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@folds$test[,4],])
}

```

validation to PCNM SPatial
```{r}


data.val.sp.amphibian <- list()
for(i in 1:30){data.val.sp.amphibian[[i]] <- list(model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@folds$test[,1],][1:(sum(model_spcv4k.pcnm_amphibian[[i]]@data@pa == 1) - sum(model_spcv4k.pcnm_amphibian[[i]]@models[[1]]@data@pa == 1)),],
                    model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@folds$test[,2],][1:(sum(model_spcv4k.pcnm_amphibian[[i]]@data@pa == 1) - sum(model_spcv4k.pcnm_amphibian[[i]]@models[[2]]@data@pa == 1)),],
                    model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@folds$test[,3],][1:(sum(model_spcv4k.pcnm_amphibian[[i]]@data@pa == 1) - sum(model_spcv4k.pcnm_amphibian[[i]]@models[[3]]@data@pa == 1)),],
                    model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@folds$test[,4],][1:(sum(model_spcv4k.pcnm_amphibian[[i]]@data@pa == 1) - sum(model_spcv4k.pcnm_amphibian[[i]]@models[[4]]@data@pa == 1)),])}

data.valnwbg.sp.amphibian <- list()
for(i in 1:30){
  data.valnwbg.sp.amphibian[[i]] <- list( model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@folds$test[,1],],
model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@folds$test[,2],],
model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@folds$test[,3],],
model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@folds$test[,4],])
}


```





DATA from validation model built with Spatial block cross validation
```{r spatial block}
data.val.sp.mammal <- list()
for(i in 1:35){data.val.sp.mammal[[i]] <- list(model_spcv4k_mammal[[i]]@data@data[model_spcv4k_mammal[[i]]@folds$test[,1],][1:(sum(model_spcv4k_mammal[[i]]@data@pa == 1) - sum(model_spcv4k_mammal[[i]]@models[[1]]@data@pa == 1)),],
                    model_spcv4k_mammal[[i]]@data@data[model_spcv4k_mammal[[i]]@folds$test[,2],][1:(sum(model_spcv4k_mammal[[i]]@data@pa == 1) - sum(model_spcv4k_mammal[[i]]@models[[2]]@data@pa == 1)),],
                    model_rndcv4k_mammal[[i]]@data@data[model_spcv4k_mammal[[i]]@folds$test[,3],][1:(sum(model_spcv4k_mammal[[i]]@data@pa == 1) - sum(model_spcv4k_mammal[[i]]@models[[3]]@data@pa == 1)),],
                    model_spcv4k_mammal[[i]]@data@data[model_spcv4k_mammal[[i]]@folds$test[,4],][1:(sum(model_spcv4k_mammal[[i]]@data@pa == 1) - sum(model_spcv4k_mammal[[i]]@models[[4]]@data@pa == 1)),])}

data.valnwbg.sp.mammal <- list()
for(i in 1:35){
  data.valnwbg.sp.mammal[[i]] <- list( model_spcv4k_mammal[[i]]@data@data[model_spcv4k_mammal[[i]]@folds$test[,1],],
model_spcv4k_mammal[[i]]@data@data[model_spcv4k_mammal[[i]]@folds$test[,2],],
model_spcv4k_mammal[[i]]@data@data[model_spcv4k_mammal[[i]]@folds$test[,3],],
model_spcv4k_mammal[[i]]@data@data[model_spcv4k_mammal[[i]]@folds$test[,4],])
}
```


```{r environmental block}
data.val.env.mammal <- list()
for(i in 1:35){data.val.env.mammal[[i]] <- list(model_envcv4k_mammal[[i]]@data@data[model_envcv4k_mammal[[i]]@folds$test[,1],][1:(sum(model_envcv4k_mammal[[i]]@data@pa == 1) - sum(model_envcv4k_mammal[[i]]@models[[1]]@data@pa == 1)),],
                    model_envcv4k_mammal[[i]]@data@data[model_envcv4k_mammal[[i]]@folds$test[,2],][1:(sum(model_envcv4k_mammal[[i]]@data@pa == 1) - sum(model_envcv4k_mammal[[i]]@models[[2]]@data@pa == 1)),],
                    model_rndcv4k_mammal[[i]]@data@data[model_envcv4k_mammal[[i]]@folds$test[,3],][1:(sum(model_envcv4k_mammal[[i]]@data@pa == 1) - sum(model_envcv4k_mammal[[i]]@models[[3]]@data@pa == 1)),],
                    model_envcv4k_mammal[[i]]@data@data[model_envcv4k_mammal[[i]]@folds$test[,4],][1:(sum(model_envcv4k_mammal[[i]]@data@pa == 1) - sum(model_envcv4k_mammal[[i]]@models[[4]]@data@pa == 1)),])}

data.valnwbg.env.mammal <- list()
for(i in 1:35){
  data.valnwbg.env.mammal[[i]] <- list( model_envcv4k_mammal[[i]]@data@data[model_envcv4k_mammal[[i]]@folds$test[,1],],
model_envcv4k_mammal[[i]]@data@data[model_envcv4k_mammal[[i]]@folds$test[,2],],
model_envcv4k_mammal[[i]]@data@data[model_envcv4k_mammal[[i]]@folds$test[,3],],
model_envcv4k_mammal[[i]]@data@data[model_envcv4k_mammal[[i]]@folds$test[,4],])
}
```



문제 있는듯? 2번은  왜 모형 다르누?
```{r}
val_rndcv4k_mammal <- list()
for(i in 1:length(model_rndcv4k_mammal)){
val_rndcv4k_mammal[[i]] <- list(list(SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[1]], 
                                                  data.val.mammal[[i]][[1]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]],
                                 data.valnwbg.mammal[[i]][[1]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[2]], 
                                                  data.val.mammal[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]],
                                 data.valnwbg.mammal[[i]][[2]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[3]], 
                                                  data.val.mammal[[i]][[3]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]],
                                 data.valnwbg.mammal[[i]][[3]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[4]], 
                                                  data.val.mammal[[i]][[4]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]],
                                 data.valnwbg.mammal[[i]][[4]],
                                                   fun = "mean",
                                                   type = "cloglog")))}
```

predict spatial validation set with spatial model (!)
```{r}
val_spcv4k_mammal <- list()
for(i in 1:length(model_spcv4k_mammal)){
val_spcv4k_mammal[[i]] <- list(list(SDMtune::predict(model_spcv4k_mammal[[i]]@models[[1]], 
                                                  data.val.sp.mammal[[i]][[1]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]],
                                 data.valnwbg.sp.mammal[[i]][[1]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_spcv4k_mammal[[i]]@models[[2]], 
                                                  data.val.sp.mammal[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]],
                                 data.valnwbg.sp.mammal[[i]][[2]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_spcv4k_mammal[[i]]@models[[3]], 
                                                  data.val.sp.mammal[[i]][[3]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]],
                                 data.valnwbg.sp.mammal[[i]][[3]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_spcv4k_mammal[[i]]@models[[4]], 
                                                  data.val.sp.mammal[[i]][[4]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]],
                                 data.valnwbg.sp.mammal[[i]][[4]],
                                                   fun = "mean",
                                                   type = "cloglog")))}
```

predict environmental validation set with environmental model
```{r}
val_envcv4k_mammal <- list()
for(i in 1:length(model_envcv4k_mammal)){
val_envcv4k_mammal[[i]] <- list(list(SDMtune::predict(model_envcv4k_mammal[[i]]@models[[1]], 
                                                  data.val.env.mammal[[i]][[1]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_envcv4k_mammal[[i]],
                                 data.valnwbg.env.mammal[[i]][[1]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_envcv4k_mammal[[i]]@models[[2]], 
                                                  data.val.env.mammal[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_envcv4k_mammal[[i]],
                                 data.valnwbg.env.mammal[[i]][[2]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_envcv4k_mammal[[i]]@models[[3]], 
                                                  data.val.env.mammal[[i]][[3]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_envcv4k_mammal[[i]],
                                 data.valnwbg.env.mammal[[i]][[3]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_envcv4k_mammal[[i]]@models[[4]], 
                                                  data.val.env.mammal[[i]][[4]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_envcv4k_mammal[[i]],
                                 data.valnwbg.env.mammal[[i]][[4]],
                                                   fun = "mean",
                                                   type = "cloglog")))}
```

validation to pcnm amphibian

```{r}
val_rndcv4k.pcnm_amphibian <- list()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
val_rndcv4k.pcnm_amphibian[[i]] <- list(list(SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]]@models[[1]], 
                                                  data.val.amphibian[[i]][[1]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]],
                                 data.valnwbg.amphibian[[i]][[1]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]]@models[[2]], 
                                                  data.val.amphibian[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]],
                                 data.valnwbg.amphibian[[i]][[2]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]]@models[[3]], 
                                                  data.val.amphibian[[i]][[3]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]],
                                 data.valnwbg.amphibian[[i]][[3]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]]@models[[4]], 
                                                  data.val.amphibian[[i]][[4]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]],
                                 data.valnwbg.amphibian[[i]][[4]],
                                                   fun = "mean",
                                                   type = "cloglog")))}
```

validation to spatial amphibian pcnm
```{r}
val_spcv4k.pcnm_amphibian <- list()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
val_spcv4k.pcnm_amphibian[[i]] <- list(list(SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]]@models[[1]], 
                                                  data.val.sp.amphibian[[i]][[1]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]],
                                 data.valnwbg.sp.amphibian[[i]][[1]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]]@models[[2]], 
                                                  data.val.sp.amphibian[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]],
                                 data.valnwbg.sp.amphibian[[i]][[2]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]]@models[[3]], 
                                                  data.val.sp.amphibian[[i]][[3]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]],
                                 data.valnwbg.sp.amphibian[[i]][[3]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]]@models[[4]], 
                                                  data.val.sp.amphibian[[i]][[4]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]],
                                 data.valnwbg.sp.amphibian[[i]][[4]],
                                                   fun = "mean",
                                                   type = "cloglog")))}
```


boyce result of rnd cv
```{r}
boyce.val.rnd_mammal <- list()
for(i in 1:length(val_rndcv4k_mammal)){boyce.val.rnd_mammal[[i]] <- 
                    list(my.boyce(val_rndcv4k_mammal[[i]][[1]][[2]], val_rndcv4k_mammal[[i]][[1]][[1]]),
                        my.boyce(val_rndcv4k_mammal[[i]][[2]][[2]], val_rndcv4k_mammal[[i]][[2]][[1]]),
                        my.boyce(val_rndcv4k_mammal[[i]][[3]][[2]], val_rndcv4k_mammal[[i]][[3]][[1]]),
                        my.boyce(val_rndcv4k_mammal[[i]][[4]][[2]], val_rndcv4k_mammal[[i]][[4]][[1]]))
}
```

boyce result of spatial block cv
```{r}
boyce.val.sp_mammal <- list()
for(i in 1:length(val_spcv4k_mammal)){boyce.val.sp_mammal[[i]] <- 
                    list(my.boyce(val_spcv4k_mammal[[i]][[1]][[2]], val_spcv4k_mammal[[i]][[1]][[1]]),
                        my.boyce(val_spcv4k_mammal[[i]][[2]][[2]], val_spcv4k_mammal[[i]][[2]][[1]]),
                        my.boyce(val_spcv4k_mammal[[i]][[3]][[2]], val_spcv4k_mammal[[i]][[3]][[1]]),
                        my.boyce(val_spcv4k_mammal[[i]][[4]][[2]], val_spcv4k_mammal[[i]][[4]][[1]]))
}
```

boyce result of environmental block cv
```{r}
boyce.val.env_mammal <- list()
for(i in 1:length(val_envcv4k_mammal)){boyce.val.env_mammal[[i]] <- 
                    list(my.boyce(val_envcv4k_mammal[[i]][[1]][[2]], val_envcv4k_mammal[[i]][[1]][[1]]),
                        my.boyce(val_envcv4k_mammal[[i]][[2]][[2]], val_envcv4k_mammal[[i]][[2]][[1]]),
                        my.boyce(val_envcv4k_mammal[[i]][[3]][[2]], val_envcv4k_mammal[[i]][[3]][[1]]),
                        my.boyce(val_envcv4k_mammal[[i]][[4]][[2]], val_envcv4k_mammal[[i]][[4]][[1]]))
}
```


```{r}
boyce.val.rnd.pcnm_amphibian <- list()
for(i in 1:length(val_rndcv4k.pcnm_amphibian)){boyce.val.rnd.pcnm_amphibian[[i]] <- 
                    list(my.boyce(val_rndcv4k.pcnm_amphibian[[i]][[1]][[2]], val_rndcv4k.pcnm_amphibian[[i]][[1]][[1]]),
                        my.boyce(val_rndcv4k.pcnm_amphibian[[i]][[2]][[2]], val_rndcv4k.pcnm_amphibian[[i]][[2]][[1]]),
                        my.boyce(val_rndcv4k.pcnm_amphibian[[i]][[3]][[2]], val_rndcv4k.pcnm_amphibian[[i]][[3]][[1]]),
                        my.boyce(val_rndcv4k.pcnm_amphibian[[i]][[4]][[2]], val_rndcv4k.pcnm_amphibian[[i]][[4]][[1]]))
}
```



```{r}
boyce.val.sp.pcnm_amphibian <- list()
for(i in 1:length(val_spcv4k.pcnm_amphibian)){boyce.val.sp.pcnm_amphibian[[i]] <- 
                    list(my.boyce(val_spcv4k.pcnm_amphibian[[i]][[1]][[2]], val_spcv4k.pcnm_amphibian[[i]][[1]][[1]]),
                        my.boyce(val_spcv4k.pcnm_amphibian[[i]][[2]][[2]], val_spcv4k.pcnm_amphibian[[i]][[2]][[1]]),
                        my.boyce(val_spcv4k.pcnm_amphibian[[i]][[3]][[2]], val_spcv4k.pcnm_amphibian[[i]][[3]][[1]]),
                        my.boyce(val_spcv4k.pcnm_amphibian[[i]][[4]][[2]], val_spcv4k.pcnm_amphibian[[i]][[4]][[1]]))
}
```

df for ggplot2 
```{r}
df.boyce.val.rnd_mammal <- list()
for(i in 1:35){df.boyce.val.rnd_mammal[[i]] <- rbind(data.frame(Hs = boyce.val.rnd_mammal[[i]][[1]]$HS,
                                                            F.ratio = boyce.val.rnd_mammal[[i]][[1]]$F.ratio,
                                                            model = "m1",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val.rnd_mammal[[i]][[2]]$HS,
                                                            F.ratio = boyce.val.rnd_mammal[[i]][[2]]$F.ratio,
                                                            model = "m2",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val.rnd_mammal[[i]][[3]]$HS,
                                                            F.ratio = boyce.val.rnd_mammal[[i]][[3]]$F.ratio,
                                                            model = "m3",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val.rnd_mammal[[i]][[4]]$HS,
                                                            F.ratio = boyce.val.rnd_mammal[[i]][[4]]$F.ratio,
                                                            model = "m4",
                                                            species = data.mammal[[i]]@species))}


df.boyce.val.rnd_mammal2 <- do.call(rbind, df.boyce.val.rnd_mammal)

```





```{r}
df.boyce.val.sp_mammal <- list()
for(i in 1:35){df.boyce.val.sp_mammal[[i]] <- rbind(data.frame(Hs = boyce.val.sp_mammal[[i]][[1]]$HS,
                                                            F.ratio = boyce.val.sp_mammal[[i]][[1]]$F.ratio,
                                                            model = "m1",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val.sp_mammal[[i]][[2]]$HS,
                                                            F.ratio = boyce.val.sp_mammal[[i]][[2]]$F.ratio,
                                                            model = "m2",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val.sp_mammal[[i]][[3]]$HS,
                                                            F.ratio = boyce.val.sp_mammal[[i]][[3]]$F.ratio,
                                                            model = "m3",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val.sp_mammal[[i]][[4]]$HS,
                                                            F.ratio = boyce.val.sp_mammal[[i]][[4]]$F.ratio,
                                                            model = "m4",
                                                            species = data.mammal[[i]]@species))}

for(i in 1:35){df.boyce.val.sp_mammal[[i]] <- rbind(data.frame(Hs = boyce.val.sp_mammal[[i]][[1]]$HS,
                                                            F.ratio = boyce.val.sp_mammal[[i]][[1]]$F.ratio,
                                                            model = "m1",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val.sp_mammal[[i]][[2]]$HS,
                                                            F.ratio = boyce.val.sp_mammal[[i]][[2]]$F.ratio,
                                                            model = "m2",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val.sp_mammal[[i]][[3]]$HS,
                                                            F.ratio = boyce.val.sp_mammal[[i]][[3]]$F.ratio,
                                                            model = "m3",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val_mammal[[i]][[4]]$HS,
                                                            F.ratio = boyce.val.sp_mammal[[i]][[4]]$F.ratio,
                                                            model = "m4",
                                                            species = data.mammal[[i]]@species))}

df.boyce.val.sp_mammal2 <- do.call(rbind, df.boyce.val.sp_mammal)

```



df for test
```{r}
df.boyce.test.rndsp_mammal <- list()
for(i in 1:35){df.boyce.test.rndsp_mammal[[i]] <- rbind(data.frame(Hs = boyce.test.rnd_mammal[[i]]$HS,
                                                                F.ratio = boyce.test.rnd_mammal[[i]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                      data.frame(Hs= boyce.test.sp_mammal[[i]]$HS,
                                                               F.ratio = boyce.test.sp_mammal[[i]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species))
}

df.boyce.test.rndsp_mammal2 <- do.call(rbind, df.boyce.test.rndsp_mammal)         df.boyce.test.rndsp_mammal2[df.boyce.test.rndsp_mammal2$species == "Macritos lagotis",] # stupid lagotis                          
```

df test bioclimate reptile n amphibian 

```{r}
df.boyce.test.rndsp_reptile <- list()
for(i in 1:91){df.boyce.test.rndsp_reptile[[i]] <- rbind(data.frame(Hs = boyce.test.rnd_reptile[[i]]$HS,
                                                                F.ratio = boyce.test.rnd_reptile[[i]]$F.ratio,
                                                                model = "random",
                                                                taxa = "reptile",
                                                                species = model_rndcv4k_reptile[[i]]@data@species),
                                                      data.frame(Hs= boyce.test.sp_reptile[[i]]$HS,
                                                               F.ratio = boyce.test.sp_reptile[[i]]$F.ratio,
                                                                model = "spatial",
                                                                taxa = "reptile",
                                                                species = model_spcv4k_reptile[[i]]@data@species))}

df.boyce.test.rndsp_reptile2 <- do.call(rbind, df.boyce.test.rndsp_reptile)    

df.boyce.test.rndsp_amphibian <- list()
for(i in 1:50){df.boyce.test.rndsp_amphibian[[i]] <- rbind(data.frame(Hs = boyce.test.rnd_amphibian[[i]]$HS,
                                                                F.ratio = boyce.test.rnd_amphibian[[i]]$F.ratio,
                                                                model = "random",
                                                                taxa = "amphibian",
                                                                species = model_rndcv4k_amphibian[[i]]@data@species),
                                                      data.frame(Hs= boyce.test.sp_amphibian[[i]]$HS,
                                                               F.ratio = boyce.test.sp_amphibian[[i]]$F.ratio,
                                                                model = "spatial",
                                                                taxa = "amphibian",
                                                                species = model_spcv4k_amphibian[[i]]@data@species))
}

df.boyce.test.rndsp_amphibian2 <- do.call(rbind, df.boyce.test.rndsp_amphibian)

```




df test PCNM reptile n amphibian

```{r}
df.boyce.test.rndsp.pcnm_reptile <- list()
for(i in 1:65){df.boyce.test.rndsp.pcnm_reptile[[i]] <- rbind(data.frame(Hs = boyce.test.rnd.pcnm_reptile[[i]]$HS,
                                                                F.ratio = boyce.test.rnd.pcnm_reptile[[i]]$F.ratio,
                                                                model = "random",
                                                                taxa = "reptile",
                                                                species = model_rndcv4k.pcnm_reptile[[i]]@data@species),
                                                      data.frame(Hs= boyce.test.sp.pcnm_reptile[[i]]$HS,
                                                               F.ratio = boyce.test.sp.pcnm_reptile[[i]]$F.ratio,
                                                                model = "spatial",
                                                                taxa = "reptile",
                                                                species = model_spcv4k.pcnm_reptile[[i]]@data@species))}

df.boyce.test.rndsp.pcnm_reptile2 <- do.call(rbind, df.boyce.test.rndsp.pcnm_reptile)    

df.boyce.test.rndsp.pcnm_amphibian <- list()
for(i in 1:32){df.boyce.test.rndsp.pcnm_amphibian[[i]] <- rbind(data.frame(Hs = boyce.test.rnd.pcnm_amphibian[[i]]$HS,
                                                                F.ratio = boyce.test.rnd.pcnm_amphibian[[i]]$F.ratio,
                                                                model = "random",
                                                                taxa = "amphibian",
                                                                species = model_rndcv4k.pcnm_amphibian[[i]]@data@species),
                                                      data.frame(Hs= boyce.test.sp.pcnm_amphibian[[i]]$HS,
                                                               F.ratio = boyce.test.sp.pcnm_amphibian[[i]]$F.ratio,
                                                                model = "spatial",
                                                                taxa = "amphibian",
                                                                species = model_spcv4k.pcnm_amphibian[[i]]@data@species))
}

df.boyce.test.rndsp.pcnm_amphibian2 <- do.call(rbind, df.boyce.test.rndsp.pcnm_amphibian)

```

GGPLOT 
RND : BIO vs PCNM :TEST

bio rep 91
bio amp 50
pcnm rep 65
pcnm amp 32



```{r}

unique(df.boyce.test.rndsp_reptile2$species)
unique(df.boyce.test.rndsp.pcnm_reptile2$species)

unique(df.boyce.test.rndsp_amphibian2$species)
unique(df.boyce.test.rndsp.pcnm_amphibian2$species)

a <- vector()
for(i in 1:length(unique(df.boyce.test.rndsp.pcnm_reptile2$species))){
  a[i] <- unique(df.boyce.test.rndsp.pcnm_reptile2$species)[i]
}

b <- list()
for(i in 1:length(a)){
df.boyce.test.rndsp_reptile2 %>% filter(species == a[i]) -> b[[i]]
}

b <- do.call(rbind, b)


c <- vector()
for(i in 1:length(unique(df.boyce.test.rndsp.pcnm_amphibian2$species))){
  c[i] <- unique(df.boyce.test.rndsp.pcnm_amphibian2$species)[i]
}

d <- list()
for(i in 1:length(c)){
df.boyce.test.rndsp_amphibian2 %>% filter(species == c[i]) -> d[[i]]
}

d <- do.call(rbind, d)


which(unique(b$species) != unique(df.boyce.test.rndsp.pcnm_reptile2$species))
which(unique(d$species) != unique(df.boyce.test.rndsp.pcnm_amphibian2$species))
```
b & d got good set 

now all 65, 32


Boyce comparison with SEVM and BIOclimate under RANDOM CV
```{r}
rbind(b %>% filter(model == "random") %>% mutate(variable = "bio"),
      d %>% filter(model == "random") %>% mutate(variable = "bio"),
      df.boyce.test.rndsp.pcnm_reptile2 %>% filter(model == "random") %>% mutate(variable = "PCNM"),
      df.boyce.test.rndsp.pcnm_amphibian2 %>% filter(model == "random") %>% mutate(variable = "PCNM")) %>%
  ggplot(data = .) +
      geom_line(aes(x = Hs, y = F.ratio, color = variable), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Random cv REPTILE and Amphibian)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> plot.boyce.rnd.test.BvP_repamp


```


Boyce comparison with SEVM and BIOclimate under Spatial CV
```{r}
rbind(b %>% filter(model == "spatial") %>% mutate(variable = "bio"),
      d %>% filter(model == "spatial") %>% mutate(variable = "bio"),
      df.boyce.test.rndsp.pcnm_reptile2 %>% filter(model == "spatial") %>% mutate(variable = "PCNM"),
      df.boyce.test.rndsp.pcnm_amphibian2 %>% filter(model == "spatial") %>% mutate(variable = "PCNM")) %>%
  ggplot(data = .) +
      geom_line(aes(x = Hs, y = F.ratio, color = variable), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Spatial cv REPTILE and Amphibian)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> plot.boyce.sp.test.BvP_repamp


```

ALL TOGETHER
```{r}
rbind(b %>% mutate(variable = "bio"),
      d %>% mutate(variable = "bio"),
      df.boyce.test.rndsp.pcnm_reptile2 %>% mutate(variable = "PCNM"),
      df.boyce.test.rndsp.pcnm_amphibian2 %>% mutate(variable = "PCNM")) %>%
  ggplot(data = .) +
      geom_line(aes(x = Hs, y = F.ratio, color = variable, linetype = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Random cv REPTILE and Amphibian)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> plot.boyce.rndsp.test.BvP_repamp


```

ALL TOGETHER - RETPILE
```{r}
rbind(b %>% mutate(variable = "bio"),
      df.boyce.test.rndsp.pcnm_reptile2 %>% mutate(variable = "PCNM")) %>%
  ggplot(data = .) +
      geom_line(aes(x = Hs, y = F.ratio, color = variable, linetype = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Reptile)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> plot.boyce.rndsp.test.BvP_reptile #8, 11,12,16,31,32, 47,51,53

nice.name <- vector()
for(i in c(8, 11,12,17,26,34,35 ,57,59)){
  nice.name[i] <- model_rndcv4k.pcnm_reptile[[i]]@data@species
}
nice.name <- na.omit(nice.name)

nice.df <- list()
for(i in 1:length(nice.name)){
 nice.df[[i]]  <- filter(rbind(b %>% mutate(variable = "bio"),
      df.boyce.test.rndsp.pcnm_reptile2 %>% mutate(variable = "PCNM")), species == nice.name[i])
}
nice.df <- do.call(rbind, nice.df)

ggplot(data = nice.df) +
      geom_line(aes(x = Hs, y = F.ratio, color = variable, linetype = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Reptile)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> plot.boyce.rndsp.test.BvP_reptile.nice


```

ALL TOGETHER - AMPHIBIAN
```{r}
rbind(d %>% mutate(variable = "bio"),
      df.boyce.test.rndsp.pcnm_amphibian2 %>% mutate(variable = "PCNM")) %>%
  ggplot(data = .) +
      geom_line(aes(x = Hs, y = F.ratio, color = variable, linetype = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Amphibian)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> plot.boyce.rndsp.test.BvP_amphibian #2, 3, 5, 7, 8, 12, 19, 21, 26 look nice

nice.name <- vector()
for(i in c(2, 3, 5, 7, 8, 12, 19, 21, 26)){
  nice.name[i] <- model_rndcv4k.pcnm_amphibian[[i]]@data@species
}
nice.name <- na.omit(nice.name)

nice.df <- list()
for(i in 1:length(nice.name)){
 nice.df[[i]]  <- filter(rbind(d %>% mutate(variable = "bio"),
      df.boyce.test.rndsp.pcnm_amphibian2 %>% mutate(variable = "PCNM")), species == nice.name[i])
}
nice.df <- do.call(rbind, nice.df)

ggplot(data = nice.df) +
      geom_line(aes(x = Hs, y = F.ratio, color = variable, linetype = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Amphibian)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> plot.boyce.rndsp.test.BvP_amphibian.nice





```


what if mix rnd and sp
```{r}
rbind(
  mutate(df.boyce.val.rnd_mammal2, cv = "random"), 
  mutate(df.boyce.val.sp_mammal2, cv = "spatial")) %>% 
 ggplot(data = .) +
      geom_smooth(aes(x = Hs, y = F.ratio, color = cv), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Random-Spatial cv mammal)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 11, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> plot.boyce.rndsp.val_mammal

plot.boyce.rndsp.val_mammal
```





```{r}
plot.boyce.rndsp.test.mean_mammal <- ggplot(data = df.boyce.test.rndsp_mammal2[df.boyce.test.rndsp_mammal2$species != "Macrotis lagotis",]) +
      geom_line(aes(x = Hs, y = F.ratio, color = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Random-Spatial cv mammal for Test data)",
           subtitle = "Mean of 4 model",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 11, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white"))

plot.boyce.rndsp.test.mean_mammal
```

PCNM rndsp reptile

```{r}
plot.boyce.rndsp.test.pcnm_reptile <- ggplot(data = df.boyce.test.rndsp.pcnm_reptile2) +
      geom_line(aes(x = Hs, y = F.ratio, color = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Random-Spatial cv REPTILE for Test data)",
           subtitle = "Mean of 4 model, 5 Bioclimate, 14 PCNM",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 11, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white"))

plot.boyce.rndsp.test.pcnm_reptile
```

plot PCNM amphibian

```{r}
plot.boyce.rndsp.test.pcnm_amphibian <- ggplot(data = df.boyce.test.rndsp.pcnm_amphibian2) +
      geom_line(aes(x = Hs, y = F.ratio, color = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Random-Spatial cv amphibian for Test data)",
           subtitle = "Mean of 4 model, 5 Bioclimate, 14 PCNM",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 11, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white"))

plot.boyce.rndsp.test.pcnm_amphibian 

```








```{r}
plot.boyce.rndsp.test.notmean_mammal <- ggplot(data = df.boyce.test.rndsp.notmean_mammal2) +
      geom_smooth(aes(x = Hs, y = F.ratio, color = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Random-Spatial cv mammal for Test data)",
           y = "출현/기대 비율",
           x = "서식처 적합도") +
      theme_light() +
      theme(strip.text.x = element_text(size = 11, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white"))

plot.boyce.rndsp.test.notmean_mammal
```



```{r} 
#df.boyce.val_mammal2[4692, ] <- NA
#some rows are inf 
```

df for pcnm val plot
```{r}
df.boyce.val.rnd.pcnm_amphibian <- list()
for(i in 1:34){df.boyce.val.rnd.pcnm_amphibian[[i]] <- rbind(data.frame(Hs = boyce.val.rnd.pcnm_amphibian[[i]][[1]]$HS,
                                                            F.ratio = boyce.val.rnd.pcnm_amphibian[[i]][[1]]$F.ratio,
                                                            model = "m1",
                                                            species = data.amphibian[[i]]@species),
                                                 data.frame(Hs = boyce.val.rnd.pcnm_amphibian[[i]][[2]]$HS,
                                                            F.ratio = boyce.val.rnd.pcnm_amphibian[[i]][[2]]$F.ratio,
                                                            model = "m2",
                                                            species = data.amphibian[[i]]@species),
                                                 data.frame(Hs = boyce.val.rnd.pcnm_amphibian[[i]][[3]]$HS,
                                                            F.ratio = boyce.val.rnd.pcnm_amphibian[[i]][[3]]$F.ratio,
                                                            model = "m3",
                                                            species = data.amphibian[[i]]@species),
                                                 data.frame(Hs = boyce.val.rnd.pcnm_amphibian[[i]][[4]]$HS,
                                                            F.ratio = boyce.val.rnd.pcnm_amphibian[[i]][[4]]$F.ratio,
                                                            model = "m4",
                                                            species = data.amphibian[[i]]@species))}



df.boyce.val.rnd.pcnm_amphibian2 <- do.call(rbind, df.boyce.val.rnd.pcnm_amphibian)

```


```{r}
df.boyce.val.sp.pcnm_amphibian <- list()
for(i in 1:30){df.boyce.val.sp.pcnm_amphibian[[i]] <- rbind(data.frame(Hs = boyce.val.sp.pcnm_amphibian[[i]][[1]]$HS,
                                                            F.ratio = boyce.val.sp.pcnm_amphibian[[i]][[1]]$F.ratio,
                                                            model = "m1",
                                                            species = data.amphibian.pcnm[[i]]@species),
                                                 data.frame(Hs = boyce.val.sp.pcnm_amphibian[[i]][[2]]$HS,
                                                            F.ratio = boyce.val.sp.pcnm_amphibian[[i]][[2]]$F.ratio,
                                                            model = "m2",
                                                            species = data.amphibian.pcnm[[i]]@species),
                                                 data.frame(Hs = boyce.val.sp.pcnm_amphibian[[i]][[3]]$HS,
                                                            F.ratio = boyce.val.sp.pcnm_amphibian[[i]][[3]]$F.ratio,
                                                            model = "m3",
                                                            species = data.amphibian.pcnm[[i]]@species),
                                                 data.frame(Hs = boyce.val.sp.pcnm_amphibian[[i]][[4]]$HS,
                                                            F.ratio = boyce.val.sp.pcnm_amphibian[[i]][[4]]$F.ratio,
                                                            model = "m4",
                                                            species = data.amphibian.pcnm[[i]]@species))}



df.boyce.val.sp.pcnm_amphibian2 <- do.call(rbind, df.boyce.val.sp.pcnm_amphibian)
```


```{r}
p1 <- ggplot(data = df.boyce.val_mammal2) +
      geom_line(aes(x = Hs, y = F.ratio, color = model)) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot",
           y = "출현/기대 비율",
           x = "서식처 적합도") +
      theme_light() +
      theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white"))

p1
```

```{r}
plot.boyce.rnd.val_mammal <- ggplot(data = df.boyce.val.rnd_mammal2) +
      
      geom_smooth(aes(x = Hs, y = F.ratio)) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Random cv mammal)",
           y = "출현/기대 비율",
           x = "서식처 적합도") +
      theme_light() +
      theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white"))

plot.boyce.rnd.val_mammal
```


```{r}
plot.boyce.sp.val_mammal <- ggplot(data = df.boyce.val.sp_mammal2) +
                            geom_line(aes(x = Hs, y = F.ratio, color = model)) +
                            geom_hline(yintercept=1, linetype="dashed") +
                            facet_wrap( ~ species, scale = "free") +
                            labs(title = "Boyce P/E plot with Spatial block cross validation",
                                 y = "출현/기대 비율",
                                 x = "서식처 적합도") +
                            theme_light() +
                            theme(strip.text.x = element_text(size = 8, colour = "black"),
                              strip.background = element_rect(colour="gray",
                                                              fill="white"))

plot.boyce.sp.val_mammal
```


```{r}
plot.boyce.rnd.val.pcnm_amphibian <- ggplot(data = df.boyce.val.rnd.pcnm_amphibian2) +
                            geom_line(aes(x = Hs, y = F.ratio, color = model)) +
                            geom_hline(yintercept=1, linetype="dashed") +
                            facet_wrap( ~ species, scale = "free") +
                            labs(title = "Boyce P/E plot with Spatial block cross validation",
                                 y = "출현/기대 비율",
                                 x = "서식처 적합도") +
                            theme_light() +
                            theme(strip.text.x = element_text(size = 8, colour = "black"),
                              strip.background = element_rect(colour="gray",
                                                              fill="white"))

plot.boyce.rnd.val.pcnm_amphibian
```


```{r}
plot.boyce.sp.val.pcnm_amphibian <- ggplot(data = df.boyce.val.sp.pcnm_amphibian2) +
                            geom_line(aes(x = Hs, y = F.ratio, color = model)) +
                            geom_hline(yintercept=1, linetype="dashed") +
                            facet_wrap( ~ species, scale = "free") +
                            labs(title = "Boyce P/E plot with Spatial block cross validation",
                                 y = "출현/기대 비율",
                                 x = "서식처 적합도") +
                            theme_light() +
                            theme(strip.text.x = element_text(size = 8, colour = "black"),
                              strip.background = element_rect(colour="gray",
                                                              fill="white"))

plot.boyce.sp.val.pcnm_amphibian
```

```{r}
test_spcv4k.pcnm_amphibian <- list()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
test_spcv4k.pcnm_amphibian[[i]] <- list(SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]], 
                                                  t.t.amphibian_0.2.test[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]],
                                 t.t.amphibian_0.2.test[[i]][[2]]@data[t.t.amphibian_0.2.test[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```

```{r}
t.t.amphibian_0.2.test <- t.t.amphibian_0.2.test[-10]
t.t.amphibian_0.2.test <- t.t.amphibian_0.2.test[-22]

```



```{r}
a <- pocplot(pred = poc.df_rndcv4k_mammal[[1]][[2]], 
             back = poc.df_rndcv4k_mammal[[1]][[1]], 
             title="(a) Model 2", filename="figs/forfun.png", linearize=FALSE)
```



```{r}
ggsave("mammal_boyce.png", p1, width = 50, height = 25, dpi = 200, limitsize = F)
ggsave("boyce.sp.val_mammal2.png", plot.boyce.sp.val_mammal, width = 50, height = 25, dpi = 200, limitsize = F)
ggsave("plot.boyce.rndsp.val_mammal.png", plot.boyce.rndsp.val_mammal, width = 50, height = 25, dpi = 200, limitsize = F)
ggsave("plot.boyce.rndsp.test.mean_mammal.png", plot.boyce.rndsp.test_mammal, width = 50, height = 25, dpi = 200, limitsize = F)
ggsave("plot.boyce.rndsp.test.notmean_mammal.png", plot.boyce.rndsp.test.notmean_mammal, width = 50, height = 25, dpi = 200, limitsize = F)
ggsave("plot.boyce.rnd.test.BvP_repamp.png", plot.boyce.rnd.test.BvP_repamp, width = 50, height = 25, dpi = 200, limitsize = F)
ggsave("plot.boyce.rndsp.test.BvP_repamp.png", plot.boyce.rndsp.test.BvP_repamp, width = 25, height = 12, dpi = 200, limitsize = F)
ggsave("plot.boyce.rndsp.test.BvP_reptile.png", plot.boyce.rndsp.test.BvP_reptile, width = 25, height = 12, dpi = 200, limitsize = F)
ggsave("plot.boyce.rndsp.test.BvP_amphibian.png", plot.boyce.rndsp.test.BvP_amphibian, width = 25, height = 12, dpi = 200, limitsize = F)

```

#AUC comparison 

```{r}
AUC_rnd.val.mammal <- vector()
for(i in 1:35){
AUC_rnd.val.mammal[i] <- SDMtune::auc(model = model_rndcv4k_mammal[[i]], test = TRUE)
}

AUC_sp.val.mammal <- vector()
for(i in 1:35){
AUC_sp.val.mammal[i] <- SDMtune::auc(model = model_spcv4k_mammal[[i]], test = TRUE)
}
```

AUC for test 
```{r}
AUC_rnd.test.reptile <- vector()
for(i in 1:length(model_rndcv4k_reptile)){
AUC_rnd.test.reptile[i] <- SDMtune::auc(model = model_rndcv4k_reptile[[i]], test = t.t.reptile_0.2[[i]][[2]])
}

AUC_rnd.test.amphibian <- vector()
for(i in 1:length(model_rndcv4k_amphibian)){
AUC_rnd.test.amphibian[i] <- SDMtune::auc(model = model_rndcv4k_amphibian[[i]], test = t.t.amphibian_0.2[[i]][[2]])
}

AUC_sp.test.reptile <- vector()
for(i in 1:length(model_spcv4k_reptile)){
AUC_sp.test.reptile[i] <- SDMtune::auc(model = model_spcv4k_reptile[[i]], test = t.t.reptile_0.2[[i]][[2]])
}
```
```{r}
AUC_sp.test.amphibian <- vector()
for(i in 1:length(model_spcv4k_amphibian)){
AUC_sp.test.amphibian[i] <- SDMtune::auc(model = model_spcv4k_amphibian[[i]], test = t.t.amphibian_0.2[[i]][[2]])
}

AUC_rnd.test.pcnm.reptile <- vector()
for(i in 1:length(model_rndcv4k.pcnm_reptile)){
AUC_rnd.test.pcnm.reptile[i] <- SDMtune::auc(model = model_rndcv4k.pcnm_reptile[[i]], test = t.t.pcnm.reptile_0.2[[i]][[2]])
}

AUC_rnd.test.pcnm.amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
AUC_rnd.test.pcnm.amphibian[i] <- SDMtune::auc(model = model_rndcv4k.pcnm_amphibian[[i]], test = t.t.pcnm.amphibian_0.2[[i]][[2]])
}

AUC_sp.test.pcnm.reptile <- vector()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
AUC_sp.test.pcnm.reptile[i] <- SDMtune::auc(model = model_spcv4k.pcnm_reptile[[i]], test = t.t.pcnm.reptile_0.2[[i]][[2]])
}

AUC_sp.test.pcnm.amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
AUC_sp.test.pcnm.amphibian[i] <- SDMtune::auc(model = model_spcv4k.pcnm_amphibian[[i]], test = t.t.pcnm.amphibian_0.2[[i]][[2]])
}


```

AUC for train(PCNM fix)

```{r}
AUC_rnd.train.bio_reptile <- vector()
for(i in 1:length(model_rndcv4k.bio_reptile)){
AUC_rnd.train.bio_reptile[i] <- SDMtune::auc(model = model_rndcv4k.bio_reptile[[i]])
}

AUC_rnd.test.amphibian <- vector()
for(i in 1:length(model_rndcv4k_amphibian)){
AUC_rnd.test.amphibian[i] <- SDMtune::auc(model = model_rndcv4k_amphibian[[i]], test = t.t.amphibian_0.2[[i]][[2]])
}

AUC_sp.test.reptile <- vector()
for(i in 1:length(model_spcv4k_reptile)){
AUC_sp.test.reptile[i] <- SDMtune::auc(model = model_spcv4k_reptile[[i]], test = t.t.reptile_0.2[[i]][[2]])
}
```
```{r}
AUC_sp.test.amphibian <- vector()
for(i in 1:length(model_spcv4k_amphibian)){
AUC_sp.test.amphibian[i] <- SDMtune::auc(model = model_spcv4k_amphibian[[i]], test = t.t.amphibian_0.2[[i]][[2]])
}

AUC_rnd.test.pcnm.reptile <- vector()
for(i in 1:length(model_rndcv4k.pcnm_reptile)){
AUC_rnd.test.pcnm.reptile[i] <- SDMtune::auc(model = model_rndcv4k.pcnm_reptile[[i]], test = t.t.pcnm.reptile_0.2[[i]][[2]])
}

AUC_rnd.test.pcnm.amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
AUC_rnd.test.pcnm.amphibian[i] <- SDMtune::auc(model = model_rndcv4k.pcnm_amphibian[[i]], test = t.t.pcnm.amphibian_0.2[[i]][[2]])
}

AUC_sp.test.pcnm.reptile <- vector()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
AUC_sp.test.pcnm.reptile[i] <- SDMtune::auc(model = model_spcv4k.pcnm_reptile[[i]], test = t.t.pcnm.reptile_0.2[[i]][[2]])
}

AUC_sp.test.pcnm.amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
AUC_sp.test.pcnm.amphibian[i] <- SDMtune::auc(model = model_spcv4k.pcnm_amphibian[[i]], test = t.t.pcnm.amphibian_0.2[[i]][[2]])
}


```



plot AUCs... 1. speceis col name
```{r}
name.model_rndcv4k_reptile <- vector()
for(i in 1:length(model_rndcv4k_reptile)){
  name.model_rndcv4k_reptile[i] <- model_rndcv4k_reptile[[i]]@data@species
}

name.model_rndcv4k_amphibian <- vector()
for(i in 1:length(model_rndcv4k_amphibian)){
  name.model_rndcv4k_amphibian[i] <- model_rndcv4k_amphibian[[i]]@data@species
}

name.model_spcv4k_reptile <- vector()
for(i in 1:length(model_spcv4k_reptile)){
  name.model_spcv4k_reptile[i] <- model_spcv4k_reptile[[i]]@data@species
}

name.model_spcv4k_amphibian <- vector()
for(i in 1:length(model_spcv4k_amphibian)){
  name.model_spcv4k_amphibian[i] <- model_spcv4k_amphibian[[i]]@data@species
}

name.model_rndcv4k.pcnm_reptile <- vector()
for(i in 1:length(model_rndcv4k.pcnm_reptile)){
  name.model_rndcv4k.pcnm_reptile[i] <- model_rndcv4k.pcnm_reptile[[i]]@data@species
}

name.model_rndcv4k.pcnm_amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
  name.model_rndcv4k.pcnm_amphibian[i] <- model_rndcv4k.pcnm_amphibian[[i]]@data@species
}

name.model_spcv4k.pcnm_reptile <- vector()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
  name.model_spcv4k.pcnm_reptile[i] <- model_spcv4k.pcnm_reptile[[i]]@data@species
}

name.model_spcv4k.pcnm_amphibian <- vector()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
  name.model_spcv4k.pcnm_amphibian[i] <- model_spcv4k.pcnm_amphibian[[i]]@data@species
}

```


plot AUCs
```{r}

rbind(data.frame(AUC_bio = AUC_rnd.test.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k_reptile,
           variable = "bio"),
      data.frame(AUC_bio = AUC_rnd.test.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k_amphibian,
           variable = "bio"),
      data.frame(AUC_bio = AUC_sp.test.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k_reptile,
           variable = "bio"),
      data.frame(AUC_bio = AUC_sp.test.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k_amphibian,
           variable = "bio")) -> a #nrow 282

rbind(data.frame(AUC_PCNM = AUC_rnd.test.pcnm.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(AUC_PCNM = AUC_rnd.test.pcnm.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k.pcnm_amphibian,
           variable = "PCNM"),
      data.frame(AUC_PCNM = AUC_sp.test.pcnm.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(AUC_PCNM = AUC_sp.test.pcnm.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k.pcnm_amphibian,
           variable = "PCNM")) -> b #nrow 194


d <- vector()
for(i in 1:length(unique(b$species))){
  d[i] <- unique(b$species)[i] #필요한 학명들
}

e <- list()
for(i in 1:length(d)){
  e[[i]] <- a %>% dplyr::filter(species == d[i]) #a중 b학명과 겹치는 것들 하나씩 e에 넣음 
}

e <- do.call(rbind, e) #e 것들을 전부 결합. a중 b와 이름이 같은 애들을 뭉침
e <- e[order(e$cv),] #b와 같은 정렬



df.AUC <- data.frame(AUC_bio = e$AUC_bio,
                     AUC_PCNM = b$AUC_PCNM,
                     cv = e$cv,
                     taxa = e$taxa,
                     species = e$species)

  ggplot(data = df.AUC) +
      geom_point(aes(x = AUC_bio, y = AUC_PCNM, color = cv, shape = taxa, size = 2)) +
      geom_hline(yintercept=0.5, linetype="dashed") +
      geom_vline(xintercept=0.5, linetype="dashed") +
       geom_abline(intercept = 0, slope = 1, size = 0.5) +
      labs(title = "AUC comparison",
           subtitle = "regularization = 5",
           y = "AUC with PCNM variables",
           x = "AUC with bioclimate variables") +
      coord_cartesian(xlim=c(0.6, 1.0), ylim=c(0.8, 1.0)) +
      theme_light() +
      theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> test



```





```{r without PCNM}

AUC_sp.amphibian <- vector()
for(i in 1:length(model_spcv4k_amphibian)){
AUC_sp.amphibian[i] <- SDMtune::auc(model = model_spcv4k_amphibian[[i]], t.t.amphibian_0.2[[i]][[2]])  
}

```



```{r with PCNM}
AUC_sp.pcnm.amphibian <- vector()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
  AUC_sp.pcnm.amphibian[i] <- SDMtune::auc(model = model_spcv4k.pcnm_amphibian[[i]], t.t.amphibian_0.2.test[[i]][[2]])
}

```

```{r cut to direct comparison} 
AUC_sp.amphibian[-c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] -> AUC_sp.amphibian
AUC_sp.amphibian[-c(11, 21, 25)] -> AUC_sp.amphibian
AUC_sp.amphibian <- AUC_sp.amphibian[-10] 
AUC_sp.amphibian <- AUC_sp.amphibian[-22] 
```

```{r}
AUC_sp.amphibian
AUC_sp.pcnm.amphibian
```

TSS?

TSS for test 
```{r}
TSS_rnd.test.reptile <- vector()
for(i in 1:length(model_rndcv4k_reptile)){
TSS_rnd.test.reptile[i] <- SDMtune::tss(model = model_rndcv4k_reptile[[i]], test = t.t.reptile_0.2[[i]][[2]])
}

TSS_rnd.test.amphibian <- vector()
for(i in 1:length(model_rndcv4k_amphibian)){
TSS_rnd.test.amphibian[i] <- SDMtune::tss(model = model_rndcv4k_amphibian[[i]], test = t.t.amphibian_0.2[[i]][[2]])
}

TSS_sp.test.reptile <- vector()
for(i in 1:length(model_spcv4k_reptile)){
TSS_sp.test.reptile[i] <- SDMtune::tss(model = model_spcv4k_reptile[[i]], test = t.t.reptile_0.2[[i]][[2]])
}

TSS_sp.test.amphibian <- vector()
for(i in 1:length(model_spcv4k_amphibian)){
TSS_sp.test.amphibian[i] <- SDMtune::tss(model = model_spcv4k_amphibian[[i]], test = t.t.amphibian_0.2[[i]][[2]])
}

TSS_rnd.test.pcnm.reptile <- vector()
for(i in 1:length(model_rndcv4k.pcnm_reptile)){
TSS_rnd.test.pcnm.reptile[i] <- SDMtune::tss(model = model_rndcv4k.pcnm_reptile[[i]], test = t.t.pcnm.reptile_0.2[[i]][[2]])
}

TSS_rnd.test.pcnm.amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
TSS_rnd.test.pcnm.amphibian[i] <- SDMtune::tss(model = model_rndcv4k.pcnm_amphibian[[i]], test = t.t.pcnm.amphibian_0.2[[i]][[2]])
}

TSS_sp.test.pcnm.reptile <- vector()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
TSS_sp.test.pcnm.reptile[i] <- SDMtune::tss(model = model_spcv4k.pcnm_reptile[[i]], test = t.t.pcnm.reptile_0.2[[i]][[2]])
}

TSS_sp.test.pcnm.amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
TSS_sp.test.pcnm.amphibian[i] <- SDMtune::tss(model = model_spcv4k.pcnm_amphibian[[i]], test = t.t.pcnm.amphibian_0.2[[i]][[2]])
}


```



plot TSSs... 1. speceis col name
```{r}
name.model_rndcv4k_reptile <- vector()
for(i in 1:length(model_rndcv4k_reptile)){
  name.model_rndcv4k_reptile[i] <- model_rndcv4k_reptile[[i]]@data@species
}

name.model_rndcv4k_amphibian <- vector()
for(i in 1:length(model_rndcv4k_amphibian)){
  name.model_rndcv4k_amphibian[i] <- model_rndcv4k_amphibian[[i]]@data@species
}

name.model_spcv4k_reptile <- vector()
for(i in 1:length(model_spcv4k_reptile)){
  name.model_spcv4k_reptile[i] <- model_spcv4k_reptile[[i]]@data@species
}

name.model_spcv4k_amphibian <- vector()
for(i in 1:length(model_spcv4k_amphibian)){
  name.model_spcv4k_amphibian[i] <- model_spcv4k_amphibian[[i]]@data@species
}

name.model_rndcv4k.pcnm_reptile <- vector()
for(i in 1:length(model_rndcv4k.pcnm_reptile)){
  name.model_rndcv4k.pcnm_reptile[i] <- model_rndcv4k.pcnm_reptile[[i]]@data@species
}

name.model_rndcv4k.pcnm_amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
  name.model_rndcv4k.pcnm_amphibian[i] <- model_rndcv4k.pcnm_amphibian[[i]]@data@species
}

name.model_spcv4k.pcnm_reptile <- vector()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
  name.model_spcv4k.pcnm_reptile[i] <- model_spcv4k.pcnm_reptile[[i]]@data@species
}

name.model_spcv4k.pcnm_amphibian <- vector()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
  name.model_spcv4k.pcnm_amphibian[i] <- model_spcv4k.pcnm_amphibian[[i]]@data@species
}

```


plot TSSs
```{r}

rbind(data.frame(TSS_bio = TSS_rnd.test.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k_reptile,
           variable = "bio"),
      data.frame(TSS_bio = TSS_rnd.test.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k_amphibian,
           variable = "bio"),
      data.frame(TSS_bio = TSS_sp.test.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k_reptile,
           variable = "bio"),
      data.frame(TSS_bio = TSS_sp.test.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k_amphibian,
           variable = "bio")) -> a #nrow 282

rbind(data.frame(TSS_PCNM = TSS_rnd.test.pcnm.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(TSS_PCNM = TSS_rnd.test.pcnm.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k.pcnm_amphibian,
           variable = "PCNM"),
      data.frame(TSS_PCNM = TSS_sp.test.pcnm.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(TSS_PCNM = TSS_sp.test.pcnm.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k.pcnm_amphibian,
           variable = "PCNM")) -> b #nrow 194


d <- vector()
for(i in 1:length(unique(b$species))){
  d[i] <- unique(b$species)[i] #필요한 학명들
}

e <- list()
for(i in 1:length(d)){
  e[[i]] <- a %>% dplyr::filter(species == d[i]) #a중 b학명과 겹치는 것들 하나씩 e에 넣음 
}

e <- do.call(rbind, e) #e 것들을 전부 결합. a중 b와 이름이 같은 애들을 뭉침
e <- e[order(e$cv),] #b와 같은 정렬



df.TSS <- data.frame(TSS_bio = e$TSS_bio,
                     TSS_PCNM = b$TSS_PCNM,
                     cv = e$cv,
                     taxa = e$taxa,
                     species = e$species)

  ggplot(data = df.TSS) +
      geom_point(aes(x = TSS_bio, y = TSS_PCNM, color = cv, shape = taxa, size = 2)) +
      geom_hline(yintercept=0.5, linetype="dashed") +
      geom_vline(xintercept=0.5, linetype="dashed") +
       geom_abline(intercept = 0, slope = 1, size = 0.5) +
      labs(title = "TSS comparison",
           subtitle = "regularization = 5",
           y = "TSS with PCNM variables",
           x = "TSS with bioclimate variables") +
      theme_light() +
      theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> test



```





```{r without PCNM}

TSS_sp.amphibian <- vector()
for(i in 1:length(model_spcv4k_amphibian)){
TSS_sp.amphibian[i] <- SDMtune::tss(model = model_spcv4k_amphibian[[i]], t.t.amphibian_0.2[[i]][[2]])  
}

```



```{r with PCNM}
TSS_sp.pcnm.amphibian <- vector()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
  TSS_sp.pcnm.amphibian[i] <- SDMtune::tss(model = model_spcv4k.pcnm_amphibian[[i]], t.t.amphibian_0.2.test[[i]][[2]])
}

```

```{r cut to direct comparison} 
TSS_sp.amphibian[-c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] -> TSS_sp.amphibian
TSS_sp.amphibian[-c(11, 21, 25)] -> TSS_sp.amphibian
TSS_sp.amphibian <- TSS_sp.amphibian[-10] 
TSS_sp.amphibian <- TSS_sp.amphibian[-22] 
```

```{r}
TSS_sp.amphibian
TSS_sp.pcnm.amphibian
```






DRAW Boyce index

```{r}


BOYCE_rnd.test.reptile <- vector()
for(i in 1:length(boyce.test.rnd_reptile)){
 BOYCE_rnd.test.reptile[i] <- boyce.test.rnd_reptile[[i]]$Spearman.cor  
}

BOYCE_rnd.test.amphibian <- vector()
for(i in 1:length(boyce.test.rnd_amphibian)){
 BOYCE_rnd.test.amphibian[i] <- boyce.test.rnd_amphibian[[i]]$Spearman.cor  
}

BOYCE_sp.test.reptile <- vector()
for(i in 1:length(boyce.test.sp_reptile)){
 BOYCE_sp.test.reptile[i] <- boyce.test.sp_reptile[[i]]$Spearman.cor  
}

BOYCE_sp.test.amphibian <- vector()
for(i in 1:length(boyce.test.sp_amphibian)){
 BOYCE_sp.test.amphibian[i] <- boyce.test.sp_amphibian[[i]]$Spearman.cor  
}

BOYCE_rnd.test.pcnm.reptile <- vector()
for(i in 1:length(boyce.test.rnd.pcnm_reptile)){
 BOYCE_rnd.test.pcnm.reptile[i] <- boyce.test.rnd.pcnm_reptile[[i]]$Spearman.cor  
}

BOYCE_rnd.test.pcnm.amphibian <- vector()
for(i in 1:length(boyce.test.rnd.pcnm_amphibian)){
 BOYCE_rnd.test.pcnm.amphibian[i] <- boyce.test.rnd.pcnm_amphibian[[i]]$Spearman.cor  
}

BOYCE_sp.test.pcnm.reptile <- vector()
for(i in 1:length(boyce.test.sp.pcnm_reptile)){
 BOYCE_sp.test.pcnm.reptile[i] <- boyce.test.sp.pcnm_reptile[[i]]$Spearman.cor  
}

BOYCE_sp.test.pcnm.amphibian <- vector()
for(i in 1:length(boyce.test.sp.pcnm_amphibian)){
 BOYCE_sp.test.pcnm.amphibian[i] <- boyce.test.sp.pcnm_amphibian[[i]]$Spearman.cor  
}


```


plot BOYCEs
```{r}

rbind(data.frame(BOYCE = BOYCE_rnd.test.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k_reptile,
           variable = "bio"),
      data.frame(BOYCE = BOYCE_rnd.test.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k_amphibian,
           variable = "bio"),
      data.frame(BOYCE = BOYCE_sp.test.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k_reptile,
           variable = "bio"),
      data.frame(BOYCE = BOYCE_sp.test.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k_amphibian,
           variable = "bio")) -> a #nrow 282

rbind(data.frame(BOYCE = BOYCE_rnd.test.pcnm.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(BOYCE = BOYCE_rnd.test.pcnm.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k.pcnm_amphibian,
           variable = "PCNM"),
      data.frame(BOYCE = BOYCE_sp.test.pcnm.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(BOYCE = BOYCE_sp.test.pcnm.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k.pcnm_amphibian,
           variable = "PCNM")) -> b #nrow 194


d <- vector()
for(i in 1:length(unique(b$species))){
  d[i] <- unique(b$species)[i] #필요한 학명들
}

e <- list()
for(i in 1:length(d)){
  e[[i]] <- a %>% dplyr::filter(species == d[i]) #a중 b학명과 겹치는 것들 하나씩 e에 넣음 
}

e <- do.call(rbind, e) #e 것들을 전부 결합. a중 b와 이름이 같은 애들을 뭉침
e <- e[order(e$cv),] #b와 같은 정렬

eb <- rbind(e,b)

df.BOYCE <- data.frame(BOYCE = eb$BOYCE, #for point plot
                     cv = eb$cv,
                     taxa = eb$taxa,
                     variable = eb$variable,
                     species = eb$species)

df.BOYCE <- data.frame(BOYCE_bio = e$BOYCE_bio,
                     BOYCE_PCNM = b$BOYCE_PCNM,
                     cv = e$cv,
                     taxa = e$taxa,
                     species = e$species)

 ggplot(data = filter(df.BOYCE, taxa == "reptile")) +
      geom_point(aes(x = cv, y = BOYCE, color = variable), size = 1) +
      geom_path(aes(x = cv, y = BOYCE, colour = variable, group = variable)) +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Model transferability of reptile species",
           subtitle = "More parallel slope, More transferable",
           y = "Boyce index",
           x = "Cross-validation",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> transfer.BOYCE #for point plot

  ggplot(data = filter(df.BOYCE, taxa == "amphibian")) +
      geom_point(aes(x = cv, y = BOYCE, color = variable), size = 1) +
      geom_path(aes(x = cv, y = BOYCE, colour = variable, group = variable)) +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Model transferability of amphibian species",
           subtitle = "More parallel slope, More transferable",
           y = "Boyce index",
           x = "Cross-validation",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> transfer.BOYCE #for point plot


df.BOYCE.bio.sp <- filter(df.BOYCE, variable == "bio", cv == "spatial")
df.BOYCE.bio.rnd <- filter(df.BOYCE, variable == "bio", cv == "random")
df.BOYCE.pcnm.sp <- filter(df.BOYCE, variable == "PCNM", cv == "spatial")
df.BOYCE.pcnm.rnd <- filter(df.BOYCE, variable == "PCNM", cv == "random")

length(which((df.BOYCE.bio.rnd$BOYCE - df.BOYCE.bio.sp$BOYCE) > (df.BOYCE.pcnm.rnd$BOYCE - df.BOYCE.pcnm.sp$BOYCE))) #46
length(which((df.BOYCE.bio.rnd$BOYCE - df.BOYCE.bio.sp$BOYCE) < (df.BOYCE.pcnm.rnd$BOYCE - df.BOYCE.pcnm.sp$BOYCE))) #49

  ggplot(data = df.BOYCE) +
      geom_point(aes(x = BOYCE_bio, y = BOYCE_PCNM, color = cv, shape = taxa, size = 2)) +
      geom_hline(yintercept=0.5, linetype="dashed") +
      geom_vline(xintercept=0.5, linetype="dashed") +
       geom_abline(intercept = 0, slope = 1, size = 0.5) +
      labs(title = "BOYCE comparison",
           y = "BOYCE with PCNM variables",
           x = "BOYCE with bioclimate variables") +
      coord_cartesian(xlim=c(0.6, 1.0), ylim=c(0.8, 1.0)) +
      theme_light() +
      theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> test



```





```{r}
BOYCE_sp.amphibian <- vector()
for(i in 1:length(boyce_test.sp_amphibian)){
  BOYCE_sp.amphibian[i] <- boyce_test.sp_amphibian[[i]]$Spearman.cor
}

  
  
  BOYCE_sp.pcnm.amphibian <- vector()
for(i in 1:length(boyce_test.sp.pcnm_amphibian)){
  BOYCE_sp.pcnm.amphibian[i] <- boyce_test.sp.pcnm_amphibian[[i]]$Spearman.cor}
```

```{r cut for direct comparison}
BOYCE_sp.amphibian[-c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] -> BOYCE_sp.amphibian
BOYCE_sp.amphibian[-c(11, 21, 25)] -> BOYCE_sp.amphibian
BOYCE_sp.amphibian <- BOYCE_sp.amphibian[-10] 
BOYCE_sp.amphibian <- BOYCE_sp.amphibian[-22] 
```

```{r}
BOYCE_sp.amphibian
BOYCE_sp.pcnm.amphibian
```







```{r}
source("pocplots.R")
pocplot <- function(pred, back, linearize=TRUE, ...) {
  ispresence <- c(rep(1,length(pred)), rep(0, length(back)))
  predd <- smoothdist(c(pred,back), ispresence)
  c <- mean(back)*length(back)/length(pred)
  if (linearize) {
    fun <- function(x,y) c*y / (1-y)
    predd$y <- mapply(fun, predd$x, predd$y)
    predd$se <- mapply(fun, predd$x, predd$se)
    ideal <- function(x) x
    ylab <- "Relative probability of presence" 
  } 
  else {
    ideal <- function(x) x / (x + c)
    ylab <- "Probability of presence"
  }
  calibplot(predd, negrug=back, posrug=pred, ideal=ideal, ylab=ylab,
    capuci = FALSE, ...)
  predd
}

```

DRAW POC plot
```{r}

poc.test.rnd_reptile <- list()
for(i in 1:length(test_rndcv4k_reptile)){
poc.test.rnd_reptile[[i]] <- pocplot(test_rndcv4k_reptile[[i]][[2]], test_rndcv4k_reptile[[i]][[3]])}

poc.test.rnd.pcnm_reptile <- list()
for(i in 1:length(test_rndcv4k.pcnm_reptile)){
poc.test.rnd.pcnm_reptile[[i]] <- pocplot(test_rndcv4k.pcnm_reptile[[i]][[2]], test_rndcv4k.pcnm_reptile[[i]][[3]])}
```


```{r}
SDMtune::plotResponse(model_rndcv4k_reptile[[1]], var = "wc2.1_30s_bio_01", type = "logistic")

# Acquire environmental variables
files <- list.files(path = file.path(system.file(package = "dismo"), "ex"),
                    pattern = "grd", full.names = TRUE)
predictors <- raster::stack(files)

# Prepare presence and background locations
p_coords <- virtualSp$presence
bg_coords <- virtualSp$background

# Create SWD object
data <- prepareSWD(species = "Virtual species", p = p_coords, a = bg_coords,
                   env = predictors, categorical = "biome")

# Train a model
model <- train(method = "Maxnet", data = data, fc = "lq")

# Plot cloglog response curve for a continuous environmental variable (bio1)
plotResponse(model, var = "bio2", type = "cloglog")

# Plot marginal cloglog response curve for a continuous environmental
# variable (bio1)
plotResponse(model, var = "bio1", type = "cloglog", marginal = TRUE)

# Plot logistic response curve for a continuous environmental variable
# (bio12) adding the rugs and giving a custom color
plotResponse(model, var = "bio12", type = "logistic", rug = TRUE,
             color = "blue")

# Plot response curve for a categorical environmental variable (biome) giving
# a custom color
plotResponse(model, var = "biome", type = "logistic", color = "green")

# Train a model with cross validation
folds <- randomFolds(data, k = 4, only_presence = TRUE)
model <- train(method = "Maxnet", data = data, fc = "lq", folds = folds)

# Plot cloglog response curve for a continuous environmental variable (bio17)
plotResponse(model, var = "bio1", type = "cloglog")

# Plot logistic response curve for a categorical environmental variable
# (biome) giving a custom color
plotResponse(model, var = "biome", type = "logistic", color = "green")


```



transferability
Draw AUCs


```{r}
rbind(data.frame(AUC = AUC_rnd.test.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k_reptile,
           variable = "bio"),
      data.frame(AUC = AUC_rnd.test.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k_amphibian,
           variable = "bio"),
      data.frame(AUC = AUC_sp.test.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k_reptile,
           variable = "bio"),
      data.frame(AUC = AUC_sp.test.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k_amphibian,
           variable = "bio")) -> a #nrow 282

rbind(data.frame(AUC = AUC_rnd.test.pcnm.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(AUC = AUC_rnd.test.pcnm.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k.pcnm_amphibian,
           variable = "PCNM"),
      data.frame(AUC = AUC_sp.test.pcnm.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(AUC = AUC_sp.test.pcnm.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k.pcnm_amphibian,
           variable = "PCNM")) -> b #nrow 194

rbind(data.frame(AUC = AUC_rnd.train.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k_reptile,
           variable = "bio"),
      data.frame(AUC = AUC_rnd.train.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k_amphibian,
           variable = "bio"),
      data.frame(AUC = AUC_sp.train.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k_reptile,
           variable = "bio"),
      data.frame(AUC = AUC_sp.train.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k_amphibian,
           variable = "bio")) -> x #nrow 282

rbind(data.frame(AUC = AUC_rnd.train.pcnm.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(AUC = AUC_rnd.train.pcnm.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k.pcnm_amphibian,
           variable = "PCNM"),
      data.frame(AUC = AUC_sp.train.pcnm.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(AUC = AUC_sp.train.pcnm.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k.pcnm_amphibian,
           variable = "PCNM")) -> y #nrow 194

#a282 b194 x282 y194

d <- vector()
for(i in 1:length(unique(b$species))){
  d[i] <- unique(b$species)[i] #필요한 학명들
}

e <- list()
for(i in 1:length(d)){
  e[[i]] <- a %>% dplyr::filter(species == d[i]) #a중 b학명과 겹치는 것들 하나씩 e에 넣음 
}

e <- do.call(rbind, e) #e 것들을 전부 결합. a중 b와 이름이 같은 애들을 뭉침
e <- e[order(e$cv),] #b와 같은 정렬



eb <- rbind(e,b) 



df.AUC <- data.frame(AUC = eb$AUC,
                     cv = eb$cv,
                     taxa = eb$taxa,
                     variable = eb$variable,
                     species = eb$species)

 ggplot(data = filter(df.AUC, taxa == "reptile")) +
      geom_point(aes(x = cv, y = AUC, color = variable), size = 1) +
      geom_path(aes(x = cv, y = AUC, colour = variable, group = variable)) +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Model transferability of reptile species",
           subtitle = "More parallel slope, More transferable",
           y = "AUC",
           x = "Cross-validation",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> transfer.AUC
 
  ggplot(data = filter(df.AUC, taxa == "amphibian")) +
      geom_point(aes(x = cv, y = AUC, color = variable), size = 1) +
      geom_path(aes(x = cv, y = AUC, colour = variable, group = variable)) +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Model transferability of amphibian species",
           subtitle = "More parallel slope, More transferable",
           y = "AUC",
           x = "Cross-validation",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> transfer.AUC
 
 
df.AUC.bio.sp <- filter(df.AUC, variable == "bio", cv == "spatial")
df.AUC.bio.rnd <- filter(df.AUC, variable == "bio", cv == "random")
df.AUC.pcnm.sp <- filter(df.AUC, variable == "PCNM", cv == "spatial")
df.AUC.pcnm.rnd <- filter(df.AUC, variable == "PCNM", cv == "random")

length(which((df.AUC.bio.rnd$AUC - df.AUC.bio.sp$AUC) > (df.AUC.pcnm.rnd$AUC - df.AUC.pcnm.sp$AUC))) #44
length(which((df.AUC.bio.rnd$AUC - df.AUC.bio.sp$AUC) < (df.AUC.pcnm.rnd$AUC - df.AUC.pcnm.sp$AUC))) #53
```










```{r}
# where to use???????
rbind(
data.frame(AUC = AUC_rnd.test.reptile,
           cv = "random",
           tt = "test",
           taxa = "reptile",
           variable = "bioclimate",
           id = "AUC_rnd.test.bioclimate.reptile"),
data.frame(AUC = AUC_rnd.test.amphibian,
           cv = "random",
           tt = "test",
           taxa = "amphibian",
           variable = "bioclimate",
           id = "AUC_rnd.test.bioclimate.amphibian"),
data.frame(AUC = AUC_rnd.test.pcnm.reptile,
           cv = "random",
           tt = "test",
           taxa = "reptile",
           variable = "pcnm",
           id = "AUC_rnd.test.pcnm.reptile"),
data.frame(AUC = AUC_rnd.test.pcnm.amphibian,
           cv = "random",
           tt = "test",
           taxa = "amphibian",
           variable = "pcnm",
           id = "AUC_rnd.test.pcnm.amphibian"),
data.frame(AUC = AUC_sp.test.reptile,
           cv = "spatial",
           tt = "test",
           taxa = "reptile",
           variable = "bioclimate",
           id = "AUC_sp.test.bioclimate.reptile"),
data.frame(AUC = AUC_sp.test.amphibian,
           cv = "spatial",
           tt = "test",
           taxa = "amphibian",
           variable = "bioclimate",
           id = "AUC_sp.test.bioclimate.amphibian"),
data.frame(AUC = AUC_sp.test.pcnm.reptile,
           cv = "spatial",
           tt = "test",
           taxa = "reptile",
           variable = "pcnm",
           id = "AUC_sp.test.pcnm.reptile"),
data.frame(AUC = AUC_sp.test.pcnm.amphibian,
           cv = "spatial",
           tt = "test",
           taxa = "amphibian",
           variable = "pcnm", 
           id = "AUC_sp.test.pcnm.amphibian"),
data.frame(AUC = AUC_rnd.train.reptile,
           cv = "random",
           tt = "train",
           taxa = "reptile",
           variable = "bioclimate",
           id = "AUC_rnd.train.bioclimate.reptile"),
data.frame(AUC = AUC_rnd.train.amphibian,
           cv = "random",
           tt = "train",
           taxa = "amphibian",
           variable = "bioclimate",
           id = "AUC_rnd.train.bioclimate.amphibian"),
data.frame(AUC = AUC_rnd.train.pcnm.reptile,
           cv = "random",
           tt = "train",
           taxa = "reptile",
           variable = "pcnm",
           id = "AUC_rnd.train.pcnm.reptile"),
data.frame(AUC = AUC_rnd.train.pcnm.amphibian,
           cv = "random",
           tt = "train",
           taxa = "amphibian",
           variable = "pcnm",
           id = "AUC_rnd.train.pcnm.amphibian"),
data.frame(AUC = AUC_sp.train.pcnm.reptile,
           cv = "spatial",
           tt = "train",
           taxa = "reptile",
           variable = "pcnm",
           id = "AUC_sp.train.pcnm.reptile"),
data.frame(AUC = AUC_sp.train.pcnm.amphibian,
           cv = "spatial",
           tt = "train",
           taxa = "amphibian",
           variable = "pcnm",
           id = "AUC_sp.train.pcnm.amphibian"),
data.frame(AUC = AUC_sp.train.reptile,
           cv = "spatial",
           tt = "train",
           taxa = "reptile",
           variable = "bioclimate",
           id = "AUC_sp.train.bioclimate.reptile"),
data.frame(AUC = AUC_sp.train.amphibian,
           cv = "spatial",
           tt = "train",
           taxa = "amphibian",
           variable = "bioclimate",
           id = "AUC_sp.train.bioclimate.amphibian")) -> df.AUC 


 ggplot(data = df.AUC) +
      geom_point(data = filter(df.AUC, tt == "train"),  aes(x = tt, y = AUC, color = variable), size = 1) +
      geom_point(data = filter(df.AUC, tt == "test", cv =="random"), aes(x = cv, y = AUC, color = variable), size = 1) +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Random cv REPTILE and Amphibian)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white"))



```




Boyce box plot

```{r}
ggplot(df.BOYCE) + 
  geom_boxplot(aes(x = cv, y = BOYCE_bio)) + 
  theme(axis.text.x = element_text(angle=65, vjust=0.6)) + 
  labs(title="Box plot", 
       subtitle="City Mileage grouped by Class of vehicle",
       x="A",
       y="B")
```













AUC for train

```{r}
AUC_rnd.train.reptile <- vector()
for(i in 1:length(model_rndcv4k_reptile)){
AUC_rnd.train.reptile[i] <- SDMtune::auc(model = model_rndcv4k_reptile[[i]])
}

AUC_rnd.train.amphibian <- vector()
for(i in 1:length(model_rndcv4k_amphibian)){
AUC_rnd.train.amphibian[i] <- SDMtune::auc(model = model_rndcv4k_amphibian[[i]])
}

AUC_sp.train.reptile <- vector()
for(i in 1:length(model_spcv4k_reptile)){
AUC_sp.train.reptile[i] <- SDMtune::auc(model = model_spcv4k_reptile[[i]])
}

AUC_sp.train.amphibian <- vector()
for(i in 1:length(model_spcv4k_amphibian)){
AUC_sp.train.amphibian[i] <- SDMtune::auc(model = model_spcv4k_amphibian[[i]])
}

AUC_rnd.train.pcnm.reptile <- vector()
for(i in 1:length(model_rndcv4k.pcnm_reptile)){
AUC_rnd.train.pcnm.reptile[i] <- SDMtune::auc(model = model_rndcv4k.pcnm_reptile[[i]])
}

AUC_rnd.train.pcnm.amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
AUC_rnd.train.pcnm.amphibian[i] <- SDMtune::auc(model = model_rndcv4k.pcnm_amphibian[[i]])
}

AUC_sp.train.pcnm.reptile <- vector()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
AUC_sp.train.pcnm.reptile[i] <- SDMtune::auc(model = model_spcv4k.pcnm_reptile[[i]])
}

AUC_sp.train.pcnm.amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
AUC_sp.train.pcnm.amphibian[i] <- SDMtune::auc(model = model_spcv4k.pcnm_amphibian[[i]])
}


```

# xAI

```{r}
library(DALEX)
devtools::install_github("ModelOriented/localModel")





predict.test <- function(x,y){
  SDMtune::predict(x,
                   data = y,
                   fun = "mean",
                   type = "cloglog")
}

train_rndcv4k.pcnm_reptile <- list()
for(i in 29:length(model_rndcv4k.pcnm_reptile)){#28 got error idk whatever. make new fake model.
train_rndcv4k.pcnm_reptile[[i]] <- list(SDMtune::predict(model_rndcv4k.pcnm_reptile[[i]], 
                                                        t.t.pcnm.reptile_0.2[[i]][[1]],
                                                        fun = "mean",
                                                        type = "cloglog"))}

model_rndcv4k.pcnm_reptile.retard28 <- model_rndcv4k.pcnm_reptile[-28]
t.t.pcnm.reptile_0.2.retard28 <- t.t.pcnm.reptile_0.2[-28]
train_rndcv4k.pcnm_reptile <- train_rndcv4k.pcnm_reptile[-28]

explain.rndcv4k.pcnm_reptile <- list()
for(i in 1:length(model_rndcv4k.pcnm_reptile.retard28)){
explain.rndcv4k.pcnm_reptile[[i]]  <- DALEX::explain(model = model_rndcv4k.pcnm_reptile.retard28[[i]],  
                                                      data = t.t.pcnm.reptile_0.2.retard28[[i]][[1]]@data, #dataset used for training
                                                         y = train_rndcv4k.pcnm_reptile[[i]], # response from data
                                          predict_function =  predict.test,
                                                     label = "Maxnet")
}



localModel.rndcv4k.pcnm_reptile <- list()
for(i in 1:length(explain.rndcv4k.pcnm_reptile)){
localModel.rndcv4k.pcnm_reptile[[i]] <- predict_surrogate(explainer = explain.rndcv4k.pcnm_reptile[[i]], 
                                                    new_observation = t.t.pcnm.reptile_0.2.retard28[[i]][[2]]@data[1:10,],
                                                    n_features = 8, 
                                                    n_permutations = 10,
                                                    type = "localModel")}









library("DALEXtra")
library("lime")
library("localModel")
model_type.dalex_explainer <- DALEXtra::model_type.dalex_explainer
predict_model.dalex_explainer <- DALEXtra::predict_model.dalex_explainer

a1_ex <- predict_surrogate(explainer = a1, 
                  new_observation = t.t.pcnm.reptile_0.2[[1]][[2]]@data[,],
                  n_features = 8, 
                  n_permutations = 1000,
                  type = "lime")

plot_interpretable_feature(a2_ex, "wc2.1_30s_bio_02 ")


plot(a1_ex[1:100,])


filter(a1_ex, case ==c(1329:15453)) -> a1_ex.back
filter(a1_ex.back, feature_weight > 0.1) -> a1_ex.back


DALEX::sha





a2_ex <- predict_surrogate(explainer = a1, 
                  new_observation = t.t.pcnm.reptile_0.2[[1]][[2]]@data,
                  n_features = 5, 
                  n_permutations = 10000,
                  type = "localModel")

b1 <- as_regressor(model_rndcv4k.pcnm_reptile[[1]])



localModel::

plot_interpretable_feature(a2_ex, "wc2.1_30s_bio_15")

lime::text_explanations_output(a2_ex, "wc2.1_30s_bio_15")

```

```{r}
DALEX::variable_effect()
  pdp_glm  <- variable_response(explainer_glm, variable =  "Age", type = "pdp")
```



```{r}

```



```{r}
devtools::install_github("boyanangelov/sdmexplain")
devtools::install_github("boyanangelov/sdmbench")

```

라임에서 다른 모형을 가져오려면 prediction을 가져와야 한다.
그리고 그게 회귄지 분륜지도 알려줘야한다.
분류는 predict_model() 제네릭을 콜링하고
후자는 model_type 제네릭에 모형이 응답해야한다.


```{r}
occ_data_raw <- sdmbench::get_benchmarking_data("Lynx lynx")
occ_data <- occ_data_raw$df_data
occ_data$label <- as.factor(occ_data$label)

coordinates.df <- rbind(occ_data_raw$raster_data$coords_presence,
                        occ_data_raw$raster_data$background)
occ_data <- cbind(occ_data, coordinates.df)

train_test_split <- rsample::initial_split(occ_data, prop = 0.7)
data.train <- rsample::training(train_test_split)
data.test  <- rsample::testing(train_test_split)

train.coords <- dplyr::select(data.train, c("x", "y"))
data.train$x <- NULL
data.train$y <- NULL

test.coords <- dplyr::select(data.test, c("x", "y"))
data.test$x <- NULL
data.test$y <- NULL

task <- makeClassifTask(id = "model", data = data.train, target = "label")
lrn <- makeLearner("classif.lda", predict.type = "prob")
mod <- train(lrn, task)

explainable_data <- prepare_explainable_data(data.test, mod, test.coords)

processed_plots <- process_lime_plots(explainable_data$explanation)

plot_explainable_sdm(explainable_data$processed_data,
                     explainable_data$processed_plots)
```












```{r}
library(iml)
library(lime)
library(breakDown)
```
# lime

to bring maxent to lime, need to predict first.

```{r}
lime::predict_model(x = lime::as_regressor(model_rndcv4k_mammal[[1]]),
                    newdata = t.t.mammal_0.2[[1]][[2]],
                    type = 'raw')

```
```{r}
# Example of adding support for lda models (already available in lime)
predict_model.lda <- function(x, newdata, type, ...) {
  res <- predict(x, newdata = newdata, ...)
  switch(
    type,
    raw = data.frame(Response = res$class, stringsAsFactors = FALSE),
    prob = as.data.frame(res$posterior, check.names = FALSE)
  )
}

model_type.maxnet <- function(x, y){SDMtune::train("Maxnet",
                                               data = x[[1]],
                                               folds = y)} 'regression'
```



```{r}
save.me <- vector()

```

```{r}
train.mammal.1 <- t.t.mammal_0.2[[1]][[1]]@data
train.mammal.1 %>% mutate(prediction = 1) -> train.mammal.1


```


```{r}
maxnet_exp <- DALEX::explain(model = model_rndcv4k_mammal[[1]],  
                        data = t.t.mammal_0.2[[1]][[2]]@data,
                           y = train.mammal.1$prediction, 
                       label = "Maxnet")

lime_   <- DALEX::predict_parts(explainer = maxnet_exp, 
                  new_observation = t.t.mammal_0.2[[1]][[2]]@data, 
                  B = 19,
                  type = "shap")

predict <- SDMtune::predict

pdp_rf <- model_profile(explainer = maxnet_exp, variables = "wc2.1_30s_bio_01")

test <- vector()
for(i in 1:19){
vector[i] <- loss_root_mean_square(observed = train.mammal.1$wc2.1_30s_bio_02, 
                   predicted = predict(model_rndcv4k_mammal[[1]], t.t.mammal_0.2[[1]][[2]]@data))}

```



and let lime know it is regression model.

```{r}

# Example of adding support for lda models (already available in lime)
predict_model.maxnet <- function (method, data, folds = NULL, verbose = TRUE, ...) 
{
  l <- length(method)
  output <- vector("list", length = l)
  for (i in 1:l) {
    m <- match.arg(method[i], c("Maxent", "Maxnet", "ANN", 
      "RF", "BRT"))
    func <- paste0("train", m)
    ea <- list(...)
    if (is.null(folds)) {
      argus <- c(data = data, ea[names(ea) %in% .args_name(func)])
      output[[i]] <- do.call(func, args = argus)
    }
    else {
      folds <- .convert_folds(folds, data)
      k <- ncol(folds[[1]])
      if (verbose) {
        pb <- progress::progress_bar$new(format = "Cross Validation [:bar] :percent in :elapsedfull", 
          total = k, clear = FALSE, width = 60, show_after = 0)
        pb$tick(0)
      }
      models <- vector("list", length = k)
      for (j in 1:k) {
        train <- .subset_swd(data, folds$train[, j])
        argus <- c(data = train, ea[names(ea) %in% .args_name(func)])
        models[[j]] <- do.call(func, args = argus)
        if (verbose) 
          pb$tick(1)
      }
      output[[i]] <- SDMmodelCV(models = models, data = data, 
        folds = folds)
    }
  }
  if (l == 1) {
    return(output[[1]])
  }
  else {
    names(output) <- method
    return(output)
  }
}


model_type.maxnet <- function(x, ...) 'regression'


lime::model_type('regression')

```

```{r}
explainer <- lime(t.t.mammal_0.2[[1]][[1]]@data, 
                  model_rndcv4k_mammal[[1]],
                  bin_continuous = TRUE, quantile_bins = FALSE)

explanation <- explain(t.t.mammal_0.2[[1]][[2]], explainer, n_features = 19)

```

# PCNM

```{r}
library(tidyverse)
library(SDMtune)
library(blockCV)
library(ENMeval)
library(raster)
library(sf)
library(sp)
library(zeallot)
library(rJava)
library(dismo)
library(vegan)
```

```{r}
library(furrr)
future::plan(multisession, workers = 32)

```


데이터 가져오기
```{r 데이터 가져오기}
data.mammal <- readr::read_rds("data/newdata/data.mammal.rds")
data.reptile <- readr::read_rds(file = "data/newdata/data.reptile.rds")
data.amphibian <- readr::read_rds(file = "data/newdata/data.amphibian.rds")

```


거리 매트릭스 가져오기
```{r}
p.distm.3 <- readr::read_rds("D:/p.distm/p.distm.mammal.3.rds") 
p.distm.21 <- readr::read_rds("D:/p.distm/p.distm.mammal.21.rds")

a.distm.mammal <- readr::read_rds("distm/a.distm.mammal.rds")

p.distm.reptile <- readr::read_rds("distm/p.distm.reptile.rds")
p.distm.amphibian <- readr::read_rds("distm/p.distm.amphibian.rds")
a.distm.amphibian <- readr::read_rds("distm/a.distm.amphibian.rds")
```


```{r}

pcnm.p.reptile <- readr::read_rds("pcnm/pcnm.p.reptile.rds")
pcnm.a.reptile <- readr::read_rds("pcnm/pcnm.a.reptile.rds")

pcnm.p.amphibian <- readr::read_rds("pcnm/pcnm.p.amphibian.rds")
pcnm.a.amphibian <- readr::read_rds("pcnm/pcnm.a.amphibian.rds")
data.amphibian.copy <- data.amphibian
data.amphibian.copy <- data.amphibian.copy[-c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)]

```


tooo big removeeee

```{r}
p.distm.21[c(5,8,11,12,14,17,19,21)] <- NULL
p.distm.21[c(3,5)] <- NULL
```



12turtle 48gecko 78
```{r}
p.distm.reptile[c(12,48,78)] <- NULL

```

?
```{r}
k <- vector()
for(i in 1:91){
  k[i] <- sum(data.reptile[[i]]@pa == 1)
}
which(k > 10000)
```

```{r}
p.distm.reptile[which(k > 10000)] <- NULL
data.reptile[which(k > 10000)] <- NULL
```


fuck above.

```{r}
data.reptile[which(num < 11000)] -> data.reptile
data.reptile <- map(data.reptile, addSamplesToBg)
```

```{r}
data.amphibian.copy <- map(data.amphibian.copy, addSamplesToBg)
#no don't... a matrix is original one.. no time to make new one
```



```{r}
p.reptile <- vector()
for(i in 1:length(data.reptile)){
p.reptile[i] <- sum(data.reptile[[i]]@pa == 1)} 

p.reptile
```
```{r}
p.amphibian <- vector()
for(i in 1:length(data.amphibian)){
p.amphibian[i] <- sum(data.amphibian[[i]]@pa == 1)} 

p.amphibian
```


```{r}
p.reptile.pcnm <- vector()
for(i in 1:length(pcnm.p.reptile)){
p.reptile.pcnm[i] <- nrow(pcnm.p.reptile[[i]]$vectors)}

p.reptile.pcnm
```

```{r}
p.amphibian.pcnm <- vector()
for(i in 1:length(pcnm.p.amphibian)){
p.amphibian.pcnm[i] <- nrow(pcnm.p.amphibian[[i]]$vectors)}

p.amphibian.pcnm
```


```{r}
for(i in 1:70){
  print(isTRUE(p.reptile.pcnm[i] == p.reptile[i]))
}
```

```{r}
for(i in 1:35){
  print(isTRUE(p.amphibian.pcnm[i] == p.amphibian[i]))
}
```


```{r}
a.reptile <- vector()
for(i in 1:length(data.reptile)){
a.reptile[i] <- sum(data.reptile[[i]]@pa == 0)} 

a.reptile
```
```{r}
a.reptile.pcnm <- vector()
for(i in 1:length(pcnm.p.reptile)){
a.reptile.pcnm[i] <- nrow(pcnm.a.reptile[[i]]$vectors)}

a.reptile.pcnm
```
```{r}
for(i in 1:70){
  print(isTRUE(a.reptile.pcnm[i] == a.reptile[i]))
}
```

```{r}
a.amphibian <- vector()
for(i in 1:length(data.amphibian.copy)){
a.amphibian[i] <- sum(data.amphibian.copy[[i]]@pa == 0)} 

a.amphibian
```
```{r}
a.amphibian.pcnm <- vector()
for(i in 1:length(pcnm.p.amphibian)){
a.amphibian.pcnm[i] <- nrow(pcnm.a.amphibian[[i]]$vectors)}

a.amphibian.pcnm
```
```{r}
for(i in 1:35){
  print(isTRUE(a.amphibian.pcnm[i] == a.amphibian[i]))
}
```



data.reptile and pcnm p a reptile is equal.

```{r}
library(FactoMineR)

PCA_reptile <- list()
for (i in 1:length(data.reptile)){
  PCA_reptile[[i]] <- PCA(data.reptile[[i]]@data, ncp = 19)
}

PCA_amphibian <- list()
for (i in 1:length(data.amphibian.copy)){
  PCA_amphibian[[i]] <- PCA(data.amphibian.copy[[i]]@data)
} 
```


```{r}

PCA12345_reptile <- list()
for(i in 1:length(PCA_reptile)){
  PCA12345_reptile[[i]] <- c(names(tail(sort(PCA_reptile[[i]]$var$cos2[,1]), 1)),
                            names(tail(sort(PCA_reptile[[i]]$var$cos2[,2]), 1)),
                            names(tail(sort(PCA_reptile[[i]]$var$cos2[,3]), 1)),
                            names(tail(sort(PCA_reptile[[i]]$var$cos2[,4]), 1)),
                            names(tail(sort(PCA_reptile[[i]]$var$cos2[,5]), 1))
                            )}



PCA12345_amphibian <- list()
for(i in 1:length(PCA_amphibian)){
  PCA12345_amphibian[[i]] <- c(names(tail(sort(PCA_amphibian[[i]]$var$cos2[,1]), 1)),
                             names(tail(sort(PCA_amphibian[[i]]$var$cos2[,2]), 1)),
                             names(tail(sort(PCA_amphibian[[i]]$var$cos2[,3]), 1)),
                             names(tail(sort(PCA_amphibian[[i]]$var$cos2[,4]), 1)),
                             names(tail(sort(PCA_amphibian[[i]]$var$cos2[,5]), 1)))}
```



```{r}
ncol.pcnm.p.reptile <- vector()
for(i in 1:length(pcnm.p.reptile)){
ncol.pcnm.p.reptile[i] <- ncol(pcnm.p.reptile[[i]]$vectors)
}

ncol.pcnm.a.reptile <- vector()
for(i in 1:length(pcnm.a.reptile)){
ncol.pcnm.a.reptile[i] <- ncol(pcnm.a.reptile[[i]]$vectors)
}

which(ncol.pcnm.p.reptile < 14)
which(ncol.pcnm.a.reptile < 14)
```
these shits will be thrown

```{r}
ncol.pcnm.p.amphibian <- vector()
for(i in 1:length(pcnm.p.amphibian)){
ncol.pcnm.p.amphibian[i] <- ncol(pcnm.p.amphibian[[i]]$vectors)
}

ncol.pcnm.a.amphibian <- vector()
for(i in 1:length(pcnm.a.amphibian)){
ncol.pcnm.a.amphibian[i] <- ncol(pcnm.a.amphibian[[i]]$vectors)
}

which(ncol.pcnm.p.amphibian < 14) #11 25 
which(ncol.pcnm.a.amphibian < 14) #21
```


```{r}
pcnm.a.reptile.copy <- pcnm.a.reptile
pcnm.p.reptile.copy <- pcnm.p.reptile

pcnm.p.reptile.copy <- pcnm.p.reptile.copy[-c(22, 27, 58, 60, 61)]
pcnm.a.reptile.copy <- pcnm.a.reptile.copy[-c(22, 27, 58, 60, 61)]
```


```{r}
pcnm.a.amphibian.copy <- pcnm.a.amphibian
pcnm.p.amphibian.copy <- pcnm.p.amphibian

pcnm.p.amphibian.copy <- pcnm.p.amphibian.copy[-c(11, 21, 25)]
pcnm.a.amphibian.copy <- pcnm.a.amphibian.copy[-c(11, 21, 25)]
```


cut pcnm vectors
```{r}
df.pcnm.reptile <- list()
for(i in 1:65){
as.data.frame(rbind(pcnm.p.reptile.copy[[i]]$vectors[,1:14],
                    pcnm.a.reptile.copy[[i]]$vectors[,1:14])) -> df.pcnm.reptile[[i]]}

```

```{r}
df.pcnm.amphibian <- list()
for(i in 1:32){
as.data.frame(rbind(pcnm.p.amphibian.copy[[i]]$vectors[,1:14],
                    pcnm.a.amphibian.copy[[i]]$vectors[,1:14])) -> df.pcnm.amphibian[[i]]}

```


```{r}
which(map_dbl(df.pcnm.reptile, ncol) != 14)

data.reptile.copy <- data.reptile
PCA12345_reptile.copy <- PCA12345_reptile
PCA_reptile.copy <- PCA_reptile

data.reptile.copy[-c(22, 27, 58, 60, 61)] -> data.reptile.copy
PCA12345_reptile.copy[-c(22, 27, 58, 60, 61)] -> PCA12345_reptile.copy
PCA_reptile.copy[-c(22, 27, 58, 60, 61)] -> PCA_reptile.copy

test <- list()
for(i in 1:65){
data.reptile.copy[[i]]@data %>% dplyr:::select(PCA12345_reptile.copy[[i]]) %>% cbind(df.pcnm.reptile[[i]]) -> test[[i]]}

which(map_dbl(test, ncol) != 19)
```
```{r}
which(map_dbl(df.pcnm.amphibian, ncol) != 14)

data.amphibian.copy2 <- data.amphibian.copy #주의 앰피는 렙타랑 조금 과정이 달랏음.
PCA12345_amphibian.copy <- PCA12345_amphibian
PCA_amphibian.copy <- PCA_amphibian

data.amphibian.copy2[-c(11, 21, 25)] -> data.amphibian.copy2 
PCA12345_amphibian.copy[-c(11, 21, 25)] -> PCA12345_amphibian.copy
PCA_amphibian.copy[-c(11, 21, 25)] -> PCA_amphibian.copy


test <- list()
for(i in 1:32){
data.amphibian.copy2[[i]]@data %>% dplyr:::select(PCA12345_amphibian.copy[[i]]) %>% cbind(df.pcnm.amphibian[[i]]) -> test[[i]]}

which(map_dbl(test, ncol) != 19) 
```



```{r}
#c( 4  8 13 16 18 20 21 34 35 37 41 42 47 48 52 53 59) overlapped.. 

PCA12345_reptile.copy[[4]]
names(tail(sort(PCA_reptile.copy[[4]]$var$cos2[,5])))
PCA12345_reptile.copy[[4]][5] <- "wc2.1_30s_bio_07"

PCA12345_reptile.copy[[8]]
names(tail(sort(PCA_reptile.copy[[8]]$var$cos2[,5])))
PCA12345_reptile.copy[[8]][5] <- "wc2.1_30s_bio_19"

PCA12345_reptile.copy[[13]]
names(tail(sort(PCA_reptile.copy[[13]]$var$cos2[,5])))
PCA12345_reptile.copy[[13]][5] <- "wc2.1_30s_bio_09"

PCA12345_reptile.copy[[16]]
names(tail(sort(PCA_reptile.copy[[16]]$var$cos2[,5])))
PCA12345_reptile.copy[[16]][5] <- "wc2.1_30s_bio_17"

PCA12345_reptile.copy[[18]]
names(tail(sort(PCA_reptile.copy[[18]]$var$cos2[,5])))
PCA12345_reptile.copy[[18]][5] <- "wc2.1_30s_bio_08"

PCA12345_reptile.copy[[20]]
names(tail(sort(PCA_reptile.copy[[20]]$var$cos2[,5])))
PCA12345_reptile.copy[[20]][5] <- "wc2.1_30s_bio_19"

PCA12345_reptile.copy[[21]]
names(tail(sort(PCA_reptile.copy[[21]]$var$cos2[,3])))
PCA12345_reptile.copy[[21]][3] <- "wc2.1_30s_bio_12"

PCA12345_reptile.copy[[34]]
names(tail(sort(PCA_reptile.copy[[34]]$var$cos2[,5])))
PCA12345_reptile.copy[[34]][5] <- "wc2.1_30s_bio_14"

PCA12345_reptile.copy[[35]]
names(tail(sort(PCA_reptile.copy[[35]]$var$cos2[,5])))
PCA12345_reptile.copy[[35]][5] <- "wc2.1_30s_bio_08"

PCA12345_reptile.copy[[37]]
names(tail(sort(PCA_reptile.copy[[37]]$var$cos2[,5])))
PCA12345_reptile.copy[[37]][5] <- "wc2.1_30s_bio_03"

PCA12345_reptile.copy[[41]]
names(tail(sort(PCA_reptile.copy[[41]]$var$cos2[,5])))
PCA12345_reptile.copy[[41]][5] <- "wc2.1_30s_bio_02"

PCA12345_reptile.copy[[42]]
names(tail(sort(PCA_reptile.copy[[42]]$var$cos2[,5])))
PCA12345_reptile.copy[[42]][5] <- "wc2.1_30s_bio_19"

PCA12345_reptile.copy[[47]]
names(tail(sort(PCA_reptile.copy[[47]]$var$cos2[,5])))
PCA12345_reptile.copy[[47]][5] <- "wc2.1_30s_bio_02"

PCA12345_reptile.copy[[48]]
names(tail(sort(PCA_reptile.copy[[48]]$var$cos2[,3])))
PCA12345_reptile.copy[[48]][3] <- "wc2.1_30s_bio_16"
names(tail(sort(PCA_reptile.copy[[48]]$var$cos2[,5])))
PCA12345_reptile.copy[[48]][5] <- "wc2.1_30s_bio_08"

PCA12345_reptile.copy[[52]]
names(tail(sort(PCA_reptile.copy[[52]]$var$cos2[,5])))
PCA12345_reptile.copy[[52]][5] <- "wc2.1_30s_bio_07"

PCA12345_reptile.copy[[53]]
names(tail(sort(PCA_reptile.copy[[53]]$var$cos2[,4])))
PCA12345_reptile.copy[[53]][4] <- "wc2.1_30s_bio_07"

PCA12345_reptile.copy[[59]]
names(tail(sort(PCA_reptile.copy[[59]]$var$cos2[,5])))
PCA12345_reptile.copy[[59]][5] <- "wc2.1_30s_bio_09"


for(i in 1:21){
data.reptile[[i]]@data %>% dplyr:::select(PCA12345_reptile[[i]]) %>% cbind(df.pcnm.reptile[[i]]) -> test[[i]]}

which(map_dbl(test, ncol) != 19)


```
```{r}
# c(1  2  5  8 13 22 23 24 25 28 31)


PCA12345_amphibian.copy[[1]]
names(tail(sort(PCA_amphibian.copy[[1]]$var$cos2[,5])))
PCA12345_amphibian.copy[[1]][5] <- "wc2.1_30s_bio_09"

PCA12345_amphibian.copy[[2]]
names(tail(sort(PCA_amphibian.copy[[2]]$var$cos2[,4])))
PCA12345_amphibian.copy[[2]][4] <- "wc2.1_30s_bio_18"

PCA12345_amphibian.copy[[5]]
names(tail(sort(PCA_amphibian.copy[[5]]$var$cos2[,4])))
PCA12345_amphibian.copy[[5]][4] <- "wc2.1_30s_bio_13"

PCA12345_amphibian.copy[[8]]
names(tail(sort(PCA_amphibian.copy[[8]]$var$cos2[,4])))
PCA12345_amphibian.copy[[8]][4] <- "wc2.1_30s_bio_18"

PCA12345_amphibian.copy[[13]]
names(tail(sort(PCA_amphibian.copy[[13]]$var$cos2[,5])))
PCA12345_amphibian.copy[[13]][5] <- "wc2.1_30s_bio_10"

PCA12345_amphibian.copy[[22]]
names(tail(sort(PCA_amphibian.copy[[22]]$var$cos2[,4])))
PCA12345_amphibian.copy[[22]][4] <- "wc2.1_30s_bio_03"

PCA12345_amphibian.copy[[23]]
names(tail(sort(PCA_amphibian.copy[[23]]$var$cos2[,5])))
PCA12345_amphibian.copy[[23]][5] <- "wc2.1_30s_bio_04"

PCA12345_amphibian.copy[[24]]
names(tail(sort(PCA_amphibian.copy[[24]]$var$cos2[,5])))
PCA12345_amphibian.copy[[24]][5] <- "wc2.1_30s_bio_04"

PCA12345_amphibian.copy[[25]]
names(tail(sort(PCA_amphibian.copy[[25]]$var$cos2[,5])))
PCA12345_amphibian.copy[[25]][5] <- "wc2.1_30s_bio_15"

PCA12345_amphibian.copy[[28]]
names(tail(sort(PCA_amphibian.copy[[28]]$var$cos2[,4])))
PCA12345_amphibian.copy[[28]][4] <- "wc2.1_30s_bio_08"

PCA12345_amphibian.copy[[31]]
names(tail(sort(PCA_amphibian.copy[[31]]$var$cos2[,5])))
PCA12345_amphibian.copy[[31]][5] <- "wc2.1_30s_bio_03"


test <- list()
for(i in 1:32){
data.amphibian.copy2[[i]]@data %>% dplyr:::select(PCA12345_amphibian.copy[[i]]) %>% cbind(df.pcnm.amphibian[[i]]) -> test[[i]]}

which(map_dbl(test, ncol) != 19) 

```







```{r}
for(i in 1:65){
print(isTRUE(nrow(test[[i]]) == nrow(data.reptile.copy[[i]]@data)))}

for(i in 1:65){
print(isTRUE(ncol(test[[i]]) == ncol(data.reptile.copy[[i]]@data)))}


```
```{r}
for(i in 1:32){
print(isTRUE(nrow(test[[i]]) == nrow(data.amphibian.copy2[[i]]@data)))}

for(i in 1:32){
print(isTRUE(ncol(test[[i]]) == ncol(data.amphibian.copy2[[i]]@data)))}


```


```{r CONFIRM}
for(i in 1:65){
data.reptile.copy[[i]]@data <- test[[i]]}

for(i in 1:65){
  print(dim(data.reptile.copy[[i]]@data))
}


```
```{r CONFIRM}
for(i in 1:32){
data.amphibian.copy[[i]]@data <- test[[i]]}

for(i in 1:32){
  print(dim(data.yyyy.copy[[i]]@data))
}


```{r}
write_rds(data.reptile.copy, "data/newdata/data.pcnm.reptile.rds")
```




















```{r}
#21 got less pcnm col, p got 2010col, a got 8col
for(i in 22:35){
as.data.frame(rbind(pcnm.p.amphibian[[i]]$vectors,
pcnm.a.amphibian[[i]]$vectors[,1:ncol(pcnm.p.amphibian[[i]]$vectors)])) -> k[[i]]}
```





amphibian. higher than 10k is

```{r}
k <- vector()
for(i in 1:50){
  k[i] <- sum(data.amphibian[[i]]@pa == 1)
}
which(k > 10000)
```




```{r}
p.distm.amphibian[c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] <- NULL
a.distm.amphibian[c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] <- NULL
```

```{r}
memory.limit(999999999)
```

```{r}
pcnm.p.reptile <- furrr::future_map(p.distm.reptile, 
                                      pcnm, 
                                      .options = furrr_options(seed = TRUE), 
                                      .progress = T)
#됬다 ㅠㅠ
pcnm.a.reptile <- furrr::future_map(a.distm.reptile,
                                      pcnm,
                                      .options = furrr_options(seed = TRUE), 
                                      .progress = T)

```


```{r}
pcnm.p.amphibian <- furrr::future_map(p.distm.amphibian, 
                                      pcnm, 
                                      .options = furrr_options(seed = TRUE), 
                                      .progress = T)
#됬다 ㅠㅠ
pcnm.a.amphibian <- furrr::future_map(a.distm.amphibian,
                                      pcnm,
                                      .options = furrr_options(seed = TRUE), 
                                      .progress = T)

```
PCNM 6, data.mammal 10 Macaca fascicularis just got 9 vecotr



```{r}
pcnm.p.mammal <- list()
for(i in 1:length(p.distm.3)){
pcnm.p.mammal[[i]] <- vegan::pcnm(p.distm.3[[i]])  
}

pcnm.p.mammal <- list()
for(i in 5:length(p.distm.21)){
pcnm.p.mammal[[i]] <- vegan::pcnm(p.distm.21[[i]])  
}

```
```{r}
pcnm.a.mammal <- list()
for(i in 1:length(p.distm.3)){
pcnm.a.mammal[[i]] <- vegan::pcnm(a.distm.mammal[[i]])  
}
```




```{r}

pcnm.p.reptile <- list()
for(i in 1:length(p.distm.reptile)){
pcnm.p.reptile[[i]] <- vegan::pcnm(p.distm.reptile[[i]])  
}

pcnm.p.reptile <- furrr::future_map(p.distm.reptile, pcnm, 
                                    .options = furrr_options(seed = TRUE), .progress = T)
```

```{r}
p.distm.amphibian <- readr::read_rds("distm/p.distm.amphibian.rds")
pcnm.p.amphibian <- list()
for(i in 1:length(p.distm.amphibian)){
pcnm.p.amphibian[[i]] <- vegan::pcnm(p.distm.amphibian[[i]])  
}
```






```{r}
model_rndcv4k_amphibian <- read_rds("model/newmodel/model_rndcv4k_amphibian.rds")
model_rndcv4k_amphibian[c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] <- NULL

data.amphibian <- read_rds("data/newdata/data.amphibian.rds")
data.amphibian[c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] <- NULL

```


만들어진 PCNM 가져오기 reptile
```{r} 
pcnm.a.reptile <- readr::read_rds("pcnm/pcnm.a.reptile.rds")
pcnm.p.reptile <- readr::read_rds("pcnm/pcnm.p.reptile.rds")
```




```{r}
my.ncol <- function(x){ncol(x$vectors)}
my.nrow <- function(x){nrow(x$vectors)}

map_int(pcnm.a.reptile, my.ncol) -> ncol.a.reptile
map_int(pcnm.p.reptile, my.ncol) -> ncol.p.reptile

map_int(pcnm.a.reptile, my.nrow) -> nrow.a.reptile
map_int(pcnm.p.reptile, my.nrow) -> nrow.p.reptile

which(ncol.a.reptile < 19) #58
which(ncol.p.reptile < 19) #8, 25, 53, 56, 58, 59

pcnm.a.amphibian[c(11, 21, 25)] <- NULL
pcnm.p.amphibian[c(11, 21, 25)] <- NULL
data.amphibian[c(11, 21, 25)] <- NULL
```

```{r}
nrow.ap.reptile
```

```{r}
nrow.data.reptile
```
```{r}
nrow.p.reptile

```
```{r}
my.nrow3 <- function(x){nrow(x@data[x@pa == 1,])}
my.nrow4 <- function(x){nrow(x@data[x@pa == 0,])}

nrow.p.data.reptile <- map_int(data.reptile, my.nrow3)
nrow.a.data.reptile <- map_int(data.reptile, my.nrow4)
```

```{r}
df.data.p <- data.frame(id = 1:length(nrow.p.data.reptile),
                        nrow = nrow.p.data.reptile)
df.pcnm.p <- data.frame(id = 1:length(nrow.p.reptile),
                        nrow = nrow.p.reptile)
df.pcnm.a <- data.frame(id = 1:length(nrow.a.reptile),
                        nrow = nrow.a.reptile)
df.data.a <- data.frame(id = 1:length(nrow.a.data.reptile),
                        nrow = nrow.a.data.reptile)
inner_join(df.pcnm.p, df.data.p, by = "nrow")
```

```{r}
inner_join(df.pcnm.a, df.data.p, by = "nrow")
```




```{r}
nrow.a.reptile + nrow.p.reptile -> nrow.ap.reptile
df.pcnm <- data.frame(id.pcnm = 1:67,
                      nrow = nrow.ap.reptile)
df.data <- data.frame(id.data = 1:91,
                      nrow = nrow.data.reptile)

dplyr::inner_join(df.data, df.pcnm, by = "nrow")

```

```{r}
my.nrow2 <- function(x){nrow(x@data)}
map_int(data.reptile, my.nrow2) -> nrow.data.reptile


```

```{r}
for(i in 1:67){which(nrow.ap.reptile[i] == nrow.data.reptile[i])}
```





```{r}
k <- list()
for(i in 1:20){
as.data.frame(rbind(pcnm.p.amphibian[[i]]$vectors,
pcnm.a.amphibian[[i]]$vectors[,1:ncol(pcnm.p.amphibian[[i]]$vectors)])) -> k[[i]]}
#21 got less pcnm col, p got 2010col, a got 8col
for(i in 22:35){
as.data.frame(rbind(pcnm.p.amphibian[[i]]$vectors,
pcnm.a.amphibian[[i]]$vectors[,1:ncol(pcnm.p.amphibian[[i]]$vectors)])) -> k[[i]]}


```





```{r}
k <- list()
for(i in 1:20){
as.data.frame(rbind(pcnm.p.amphibian[[i]]$vectors,
pcnm.a.amphibian[[i]]$vectors[,1:ncol(pcnm.p.amphibian[[i]]$vectors)])) -> k[[i]]}
#21 got less pcnm col, p got 2010col, a got 8col
for(i in 22:35){
as.data.frame(rbind(pcnm.p.amphibian[[i]]$vectors,
pcnm.a.amphibian[[i]]$vectors[,1:ncol(pcnm.p.amphibian[[i]]$vectors)])) -> k[[i]]}


```
too much vectors... 

# choose 16 in ratio
```{r}
k <- list()
for(i in 1:35){
as.data.frame(rbind(pcnm.p.amphibian[[i]]$vectors[,round(seq.int(1, ncol(pcnm.p.amphibian[[i]]$vectors), length.out =16))], 
pcnm.a.amphibian[[i]]$vectors[,round(seq.int(1, ncol(pcnm.a.amphibian[[i]]$vectors), length.out =16))])) -> k[[i]]}

```


PCNM p 11 got just 4 column. remove it.(among 35)
and again, pcnm a 20 got 8 column
```{r}

pcnm.p.ncol <- vector()
for(i in 1:35){
  ncol(pcnm.p.amphibian[[i]]$vectors) -> pcnm.p.ncol[i]
}

pcnm.a.ncol <- vector()
for(i in 1:35){
  ncol(pcnm.a.amphibian[[i]]$vectors) -> pcnm.a.ncol[i]
}

which(pcnm.a.ncol < 19) #21
which(pcnm.p.ncol < 19) #11, 25

pcnm.a.amphibian[c(11, 21, 25)] <- NULL
pcnm.p.amphibian[c(11, 21, 25)] <- NULL
data.amphibian[c(11, 21, 25)] <- NULL
```

```{r to show pcnm var imp}
pcnm.p.ncol <- vector()
for(i in 1:32){
  ncol(pcnm.p.amphibian[[i]]$vectors) -> pcnm.p.ncol[i]
}

pcnm.a.ncol <- vector()
for(i in 1:32){
  ncol(pcnm.a.amphibian[[i]]$vectors) -> pcnm.a.ncol[i]
}

which(pcnm.a.ncol < 50) #0
which(pcnm.p.ncol < 50) #28

pcnm.a.amphibian[28] <- NULL
pcnm.p.amphibian[28] <- NULL

```


# choose 16 in varsel
```{r}
k <- list()
for(i in 1:31){
as.data.frame(rbind(pcnm.p.amphibian[[i]]$vectors[,1:50], 
pcnm.a.amphibian[[i]]$vectors[,1:50])) -> k[[i]]}

```





```{r}
library(FactoMineR)

PCA_amphibian <- list()
for (i in 1:length(data.amphibian)){
  PCA_amphibian[[i]] <- PCA(data.amphibian[[i]]@data)
} 
```

```{r}
PCA123_amphibian <- list()
for(i in 1:length(PCA_amphibian)){
  PCA123_amphibian[[i]] <- c(names(tail(sort(PCA_amphibian[[i]]$var$cos2[,1]), 1)),
                       names(tail(sort(PCA_amphibian[[i]]$var$cos2[,2]), 1)),
                       names(tail(sort(PCA_amphibian[[i]]$var$cos2[,3]), 1)))}

PCA123_amphibian[c(11, 21, 25)] <- NULL
PCA123_amphibian[c(28)] <- NULL

for(i in 1:10){
data.amphibian[[i]]@data %>% dplyr:::select(PCA123_amphibian[[i]]) %>% cbind(k[[i]]) -> k[[i]]}




data.amphibian.test <- data.amphibian


for(i in 1:10){
data.amphibian.test[[i]]@data <- k[[i]]}

t.t.amphibian_0.2.test <- list()
for (i in 1:10){
  t.t.amphibian_0.2.test[[i]] <- trainValTest(data.amphibian.test[[i]], 
                                         test = 0.2, 
                                         only_presence = TRUE, 
                                         seed = 1)}
```


```{r}
rnd4k <- function(x){randomFolds(x[[1]], 
                                 k = 4,
                                 only_presence = TRUE,
                                 seed = 1)}

folds.rnd4k_amphibian.test <- map(t.t.amphibian_0.2.test, rnd4k)
```

t.t.amp 10 got glm error

```{r}
t.t.amphibian_0.2.test <- t.t.amphibian_0.2.test[-10] 
folds.rnd4k_amphibian.test <- folds.rnd4k_amphibian.test[-10] 
```

after remove 10, still error
```{r}
t.t.amphibian_0.2.test <- t.t.amphibian_0.2.test[-22] 
folds.rnd4k_amphibian.test <- folds.rnd4k_amphibian.test[-22] 
```

```{r}
model_rndcv4k_amphibian <- future_map2(t.t.amphibian_0.2.test, 
                                    folds.rnd4k_amphibian.test, 
                                    maxnet.train, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)
```

```{r}
folds.sp4k_amphibian <- readr::read_rds("folds/folds.sp4k_amphibian.rds")
folds.sp4k_amphibian[c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] <- NULL
folds.sp4k_amphibian[c(11, 21, 25)] <- NULL
folds.sp4k_amphibian <- folds.sp4k_amphibian[-10] 
folds.sp4k_amphibian <- folds.sp4k_amphibian[-22] 
```


```{r}
model_spcv4k_amphibian <- future_map2(t.t.amphibian_0.2.test, 
                                    folds.sp4k_amphibian, 
                                    maxnet.train, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)
```


```{r}
b <- SDMtune::varSel(maxent.a1@models[[1]], metric = "auc",test = maxent.a1@models[[1]]@data, bg4cor = data.amphibian.test[[1]])
c <- SDMtune:::varImp(maxent.a1)

SDMtune::
```


```{r}
# Acquire environmental variables
files <- list.files(path = file.path(system.file(package = "dismo"), "ex"),
                    pattern = "grd", full.names = TRUE)
predictors <- raster::stack(files)

# Prepare presence and background locations
p_coords <- virtualSp$presence
bg_coords <- virtualSp$background

# Create SWD object
data <- prepareSWD(species = "Virtual species", p = p_coords, a = bg_coords,
                   env = predictors, categorical = "biome")

# Split presence locations in training (80%) and testing (20%) datasets
datasets <- trainValTest(data, test = 0.2, only_presence = TRUE)
train <- datasets[[1]]
test <- datasets[[2]]

# Train a model
model <- train(method = "Maxnet", data = train, fc = "l")

# Prepare background locations to test autocorrelation, this usually gives a
# warning message given that less than 10000 points can be randomly sampled
bg_coords <- dismo::randomPoints(predictors, 10000)
bg <- prepareSWD(species = "Virtual species", a = bg_coords,
                 env = predictors, categorical = "biome")

## Not run: 
# Remove variables with correlation higher than 0.7 accounting for the AUC,
# in the following example the variable importance is computed as permutation
# importance
vs <- varSel(model, metric = "auc", bg4cor = bg, test = test, cor_th = 0.7,
             permut = 1)
vs

# Remove variables with correlation higher than 0.7 accounting for the TSS,
# in the following example the variable importance is the MaxEnt percent
# contribution
# Train a model
# The next line checks if Maxent is correctly configured but you don't need
# to run it in your script
if (dismo::maxent(silent = TRUE)) {
model <- train(method = "Maxent", data = train, fc = "l")
vs <- varSel(model, metric = "tss", bg4cor = bg, test = test, cor_th = 0.7,
             use_pc = TRUE)
vs

# Remove variables with correlation higher than 0.7 accounting for the aicc,
# in the following example the variable importance is the MaxEnt percent
# contribution
vs <- varSel(model, metric = "aicc", bg4cor = bg, cor_th = 0.7,
             use_pc = TRUE, env = predictors)
vs
}

## End(Not run)
```

# Data Viz

make table and histogram
```{r}
library(tidyverse)
library(hrbrthemes)
library(viridis)
library(forcats)
library(ggridges)
```
RANGE-BACKGROUND COMPARISON 
```{r}
data.mammal <- readr::read_rds("data/data.mammal.rds")
biovalue_mammal.13 <- readr::read_rds("biovalue_mammal.13.rds")
bg10k_mammal.bio <- readr::read_rds("bg10k_mammal.bio.rds")

#species by species
readr::write_csv(as.data.frame(biovalue_mammal.13[[1]]), "D:/biovalue_mammal.1.csv")

#names
biocolnames <- colnames(bg10k_mammal.bio[[1]][,1:19])

#
biovalue_mammal.13 <- list()
biovalue_mammal.13[[1]] <- readr::read_csv("D:/biovalue_mammal.1.csv", col_names = biocolnames, skip = 1)

#range data


r.data.mammal <- list()  
for(i in 1){
  r.data.mammal[[i]] <- data.frame(wc2.1_30s_bio_01 = biovalue_mammal.13[[i]][,1],
                                   wc2.1_30s_bio_02 = biovalue_mammal.13[[i]][,2],
                                   wc2.1_30s_bio_03 = biovalue_mammal.13[[i]][,3],
                                   wc2.1_30s_bio_04 = biovalue_mammal.13[[i]][,4],
                                   wc2.1_30s_bio_05 = biovalue_mammal.13[[i]][,5],
                                   wc2.1_30s_bio_06 = biovalue_mammal.13[[i]][,6],
                                   wc2.1_30s_bio_07 = biovalue_mammal.13[[i]][,7],
                                   wc2.1_30s_bio_08 = biovalue_mammal.13[[i]][,8],
                                   wc2.1_30s_bio_09 = biovalue_mammal.13[[i]][,9],
                                   wc2.1_30s_bio_10 = biovalue_mammal.13[[i]][,10],
                                   wc2.1_30s_bio_11 = biovalue_mammal.13[[i]][,11],
                                   wc2.1_30s_bio_12 = biovalue_mammal.13[[i]][,12],
                                   wc2.1_30s_bio_13 = biovalue_mammal.13[[i]][,13],
                                   wc2.1_30s_bio_14 = biovalue_mammal.13[[i]][,14],
                                   wc2.1_30s_bio_15 = biovalue_mammal.13[[i]][,15],
                                   wc2.1_30s_bio_16 = biovalue_mammal.13[[i]][,16],
                                   wc2.1_30s_bio_17 = biovalue_mammal.13[[i]][,17],
                                   wc2.1_30s_bio_18 = biovalue_mammal.13[[i]][,18],
                                   wc2.1_30s_bio_19 = biovalue_mammal.13[[i]][,19],
                                   species = data.mammal[[i]]@species,
                                   type = "range")
}


b.data.mammal <- list()
for(i in 1:length(bg10k_mammal.bio)){
  b.data.mammal[[i]] <- data.frame(wc2.1_30s_bio_01 = bg10k_mammal.bio[[i]][,1],
                                   wc2.1_30s_bio_02 = bg10k_mammal.bio[[i]][,2],
                                   wc2.1_30s_bio_03 = bg10k_mammal.bio[[i]][,3],
                                   wc2.1_30s_bio_04 = bg10k_mammal.bio[[i]][,4],
                                   wc2.1_30s_bio_05 = bg10k_mammal.bio[[i]][,5],
                                   wc2.1_30s_bio_06 = bg10k_mammal.bio[[i]][,6],
                                   wc2.1_30s_bio_07 = bg10k_mammal.bio[[i]][,7],
                                   wc2.1_30s_bio_08 = bg10k_mammal.bio[[i]][,8],
                                   wc2.1_30s_bio_09 = bg10k_mammal.bio[[i]][,9],
                                   wc2.1_30s_bio_10 = bg10k_mammal.bio[[i]][,10],
                                   wc2.1_30s_bio_11 = bg10k_mammal.bio[[i]][,11],
                                   wc2.1_30s_bio_12 = bg10k_mammal.bio[[i]][,12],
                                   wc2.1_30s_bio_13 = bg10k_mammal.bio[[i]][,13],
                                   wc2.1_30s_bio_14 = bg10k_mammal.bio[[i]][,14],
                                   wc2.1_30s_bio_15 = bg10k_mammal.bio[[i]][,15],
                                   wc2.1_30s_bio_16 = bg10k_mammal.bio[[i]][,16],
                                   wc2.1_30s_bio_17 = bg10k_mammal.bio[[i]][,17],
                                   wc2.1_30s_bio_18 = bg10k_mammal.bio[[i]][,18],
                                   wc2.1_30s_bio_19 = bg10k_mammal.bio[[i]][,19],
                                   species = data.mammal[[i]]@species,
                                   type = "background")}

r.comp_mammal <- list()
r.comp_mammal[[1]] <- tidyr::pivot_longer(r.data.mammal[[1]], 
                                            cols = 1:19, 
                                            names_to = "bio", 
                                            values_to = "covari")


b.comp_mammal <- list()
b.comp_mammal[[1]] <- tidyr::pivot_longer(b.data.mammal[[1]], 
                                            cols = 1:19, 
                                            names_to = "bio", 
                                            values_to = "covari")

br.comp_mammal <- list()
br.comp_mammal[[1]] <- dplyr::bind_rows(r.comp_mammal ,b.comp_mammal)


br.comp_mammal <- list()                    
br.comp_mammal[[1]] <- data.table::fread("D:/viz_rb/mammal/Artibeus jamaicensis.csv")  
br.comp_mammal[[2]] <- data.table::fread("D:/viz_rb/mammal/Blarina brevicauda.csv")  

p4 <- 
  br.comp_mammal[[2]] %>% ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0(br.comp_mammal[[2]]$species[2],"_Range/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    )

ggsave(paste0(br.comp_mammal[[2]]$species[2],"_br.comp.png"), p4, width=20, height= 12, dpi = 100, limitsize = F)
```

```{r}

data.table::fread("D:/viz_rb/mammal/Capreolus capreolus.csv") %>%
 
                ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Capreolus capreolus_Range/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Capreolus capreolus_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


```

```{r}

data.table::fread("D:/viz_rb/mammal/Loxodonta africana.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Loxodonta africana/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Loxodonta africana_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


```

```{r roll and print}

data.table::fread("D:/viz_rb/mammal/Macaca fascicularis.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Macaca fascicularis/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Macaca fascicularis_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


data.table::fread("D:/viz_rb/mammal/Macropus giganteus.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Macropus giganteus/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Macropus giganteus_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


data.table::fread("D:/viz_rb/mammal/Macrotis lagotis.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Macrotis lagotis/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Macrotis lagotis_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


data.table::fread("D:/viz_rb/mammal/Microtus pennsylvanicus.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Microtus pennsylvanicus/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Microtus pennsylvanicus_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)
```



```{r}
data.table::fread("D:/viz_rb/mammal/Myodes glareolus.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Myodes glareolus/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Myodes glareolus_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


data.table::fread("D:/viz_rb/mammal/Myotis brandtii.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Myotis brandtii/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Myotis brandtii_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


data.table::fread("D:/viz_rb/mammal/Nyctalus noctula.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Nyctalus noctula/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Nyctalus noctula_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)
```

```{r}
data.table::fread("D:/viz_rb/mammal/Ochotona princeps.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Ochotona princeps/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Ochotona princeps_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


data.table::fread("D:/viz_rb/mammal/Odocoileus virginianus.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Odocoileus virginianus/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Odocoileus virginianus_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)
```

```{r}
data.table::fread("D:/viz_rb/mammal/Ornithorhynchus anatinus.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Ornithorhynchus anatinus/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Ornithorhynchus anatinus_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


data.table::fread("D:/viz_rb/mammal/Peromyscus maniculatus.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Peromyscus maniculatus/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Peromyscus maniculatus_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)
```
```{r}

data.table::fread("D:/viz_rb/mammal/Pipistrellus pipistrellus.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Pipistrellus pipistrellus/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Pipistrellus pipistrellus_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


data.table::fread("D:/viz_rb/mammal/Pseudocheirus peregrinus.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Pseudocheirus peregrinus/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Pseudocheirus peregrinus_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


data.table::fread("D:/viz_rb/mammal/Pteropus poliocephalus.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Pteropus poliocephalus/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Pteropus poliocephalus_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


data.table::fread("D:/viz_rb/mammal/Rattus fuscipes.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Rattus fuscipes/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Rattus fuscipes_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


data.table::fread("D:/viz_rb/mammal/Rhinolophus hipposideros.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Rhinolophus hipposideros/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Rhinolophus hipposideros_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


data.table::fread("D:/viz_rb/mammal/Rupicapra rupicapra.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Rupicapra rupicapra/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Rupicapra rupicapra_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


data.table::fread("D:/viz_rb/mammal/Sorex araneus.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Sorex araneus/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Sorex araneus_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)
```
```{r}

data.table::fread("D:/viz_rb/mammal/Sorex minutus.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Sorex minutus/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Sorex minutus_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


data.table::fread("D:/viz_rb/mammal/Tachyglossus aculeatus.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Tachyglossus aculeatus/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Tachyglossus aculeatus_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


data.table::fread("D:/viz_rb/mammal/Talpa europaea.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Talpa europaea/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Talpa europaea_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


data.table::fread("D:/viz_rb/mammal/Trichosurus vulpecula.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Trichosurus vulpecula/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Trichosurus vulpecula_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)


data.table::fread("D:/viz_rb/mammal/Urocyon cinereoargenteus.csv") %>%
 
ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity") +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density", fill = "Data type") +
  ggtitle(paste0("Urocyon cinereoargenteus/Background values density")) +
  theme_light() +
  theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")
    ) -> p4

ggsave("Urocyon cinereoargenteus_br.comp.png", p4, width=20, height= 12, dpi = 100, limitsize = F)

```



```{r raw data}
data.mammal <- readr::read_rds("data/data.mammal.rds")

my.pseperate <- function(x){dplyr::bind_cols(dplyr::slice(x@coords, 1:which(x@pa==0)[1]-1),
                                             dplyr::slice(x@data, 1:which(x@pa==0)[1]-1))}

my.aseperate <- function(x){dplyr::bind_cols(dplyr::slice(x@coords, which(x@pa==0)[1]:nrow(x@coords)),
                                             dplyr::slice(x@data, which(x@pa==0)[1]:nrow(x@data)))}

p.data.mammal <- map(data.mammal, my.pseperate)
a.data.mammal <- map(data.mammal, my.aseperate)


for(i in 1:length(p.data.mammal)){
p.data.mammal[[i]] %>% mutate(species = data.mammal[[i]]@species,
                              type = "presence") -> p.data.mammal[[i]]
}

for(i in 1:length(a.data.mammal)){
a.data.mammal[[i]] %>% mutate(species = data.mammal[[i]]@species,
                              type = "background") -> a.data.mammal[[i]]
}

data4viz_mammal <- bind_rows(p.data.mammal, a.data.mammal)

```





```{r}
p1 <- ggplot(data4viz_mammal) +
    geom_density_ridges(aes(x = wc2.1_30s_bio_1, y = species,
                            fill = type), alpha = 0.6) +
    ggtitle("Bio1 with presence/background") +
    xlab("연 평균 기온") + ylab("Species") + theme_light() +
    theme(plot.title=element_text(size=20, color="black"))
p1
```

```{r}
p2 <- ggplot() +
    geom_density_ridges(data = b.comp_mammal[[1]], aes(x = covari, y = bio), alpha = 0.6) +
    geom_density_ridges(data = r.comp_mammal[[1]], aes(x = covari, y = bio), alpha = 0.6) +
    xlim(c(-10, 400)) +
    ggtitle("Bio1 with range/background") +
    xlab("frequency") + ylab("bioclimate") + theme_light() +
    theme(plot.title=element_text(size=20, color="black"))
p2
```



```{r}
p <- ggplot(data4viz_mammal) +
  geom_density_ridges_gradient(aes(x = wc2.1_30s_bio_1, y = species, fill = ..x..), scale = 3, rel_min_height = 0.01) +
  scale_fill_viridis(name = "Temp. [F]", option = "H") +
  labs(title = 'Temperatures in Lincoln NE in 2016') +
  theme_ipsum() +
    theme_light(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )
p
```




```{r}
dfs <-
  data.frame(
    "estimate" = rnorm(300),
    "loading" = factor(rep(1:5, 60)),
    "set" = factor(rep(1:3, 100),),
    "pop" = rep(c(0.1, 0.15, 0.20, 0.05, 0.7), 60)
  )


loadsummary2 <- crossing("type" =  data4viz_mammal$type, "loading" = dfs$species)
loadsummary2$pop <- rep(c(0.1, 0.15, 0.20, 0.05, 0.7), 3)

p <- ggplot(data4viz_mammal) +
  geom_density_ridges(aes(x = wc2.1_30s_bio_1, y = species,
                            fill = type)
    jittered_points = TRUE,
    point_shape = "|", point_size = 2, size = 0.25,
    position = position_points_jitter(height = 0), alpha = 0.6, scale = 1.2) + 
    geom_text(data = loadsummary2, 
              aes(y = species, x = wc2.1_30s_bio_1, label = pop),
              position=position_nudge(y= .25), 
              colour="black", 
              size=3.5)

p + geom_segment(aes(
  x = pop,
  y = as.numeric(loading) - .05,
  xend = pop,
  yend = as.numeric(loading) + .15))
#> Picking joint bandwidth of 0.437
####

# Plot



ggplot(data4viz_mammal) +
    geom_density_ridges(aes(x = yield, y = site,
                            group = interaction(year, site),
                            fill = year), alpha = 0.8)



for(i in 1:length(biovalue_mammal)){
biovalue_mammal[[i]] %>% mutate(species = data.mammal[[i]]@species,
                                type = "range") -> biovalue_mammal[[i]]
}


for(i in 1:length(bg10k_mammal.bio)){   
bg10k_mammal.bio[[i]] %>% mutate(species = ,
                                 type = "background") -> bg10k_mammal.bio[[i]]
}

# Load dataset from github
data <- data.frame(species = ,
                   type = c("range", "background"),
                   bio1 = ,
                   bio2 = ,
                   bio3 = ,
                   bio4 = ,
                   bio5 = ,
                   bio6 = ,
                   bio7 = ,
                   bio8 = ,
                   bio9 = , 
                   bio10 = ,
                   bio11 = ,
                   bio12 = ,
                   bio13 = ,
                   bio14 = ,
                   bio15 = ,
                   bio16 = ,
                   bio17 = ,
                   bio18 = ,
                   bio19 = )

# plot
p <- ggplot() +
    geom_histogram(data = r.comp_mammal[[1]], aes(x = covari, y = bio), alpha=0.6) +
    geom_histogram(data = b.comp_mammal[[1]], aes(x = covari, y = bio), alpha=0.6) +
    theme_ipsum() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8),
      strip.background = element_rect(colour="black",
                                        fill="white")
    ) +
    xlab("") +
    ylab("Assigned Probability (%)") +
    facet_wrap(~bio, scales = "free")



```

```{r}
p3 <- ggplot() +
      geom_density_ridges(data = br.comp_mammal[[1]], aes(x = covari, y = bio, fill = type), alpha = 0.6) +
      facet_wrap(~bio, scales = "free") +
      ggtitle("Bio1 with range/background") +
    xlab("frequency") + ylab("bioclimate") + theme_light() +
    theme(plot.title=element_text(size=20, color="black"))


```

```{r}
iris.tidy %>% 
  mutate(round.measurement = 
           round(measurement, digits = 0)%%2) %>% 
  dplyr::filter(round.measurement == 1) %>% 
  nrow()

iris.tidy %>% 
  ggplot2::ggplot(aes(x = measurement,
                      y = ..density..,
                      fill = Species)
  ) +
  geom_density(alpha = 0.5, 
               colour = "black", 
               position = "identity"
  )

p4 <- 
  br.comp_mammal[[1]] %>% ggplot2::ggplot(aes(x = covari,
                                    y = ..density..,
                                    fill = fct_rev(type))) +
  geom_density(alpha = 0.2, colour = "black", position = "identity"
  ) +
  facet_wrap( ~ bio, scale = "free") +
  labs(x = "Bioclimate", y = "Density") +
  ggtitle("Range/Background values density") +
  theme_light() +
  theme(
      legend.position="none",
      strip.text.x = element_text(size = 8, colour = "black"),
      strip.background = element_rect(colour="gray",
                                        fill="white")
    )

```



```{r save option}
ggsave("test.pdf", p4, width=20, height= 12, dpi = 100, limitsize = F)
```



# PCNM VarIMP


# is pcnm varaible importance high as sequence?

```{r}
library(tidyverse)
library(SDMtune)
library(blockCV)
library(ENMeval)
library(raster)
library(sf)
library(sp)
library(zeallot)
library(rJava)
library(dismo)
```
```{r}
library(furrr)
future::plan(multisession, workers = 31)
stopCluster(cl)
```


load models
```{r}
model_rndcv4k_reptile <- readr::read_rds("model/newmodel/model_rndcv4k_reptile.rds")
model_spcv4k_reptile <- readr::read_rds("model/newmodel/model_spcv4k_reptile.rds")


model_rndcv4k.pcnm_reptile <- readr::read_rds("model/newmodel/model_pcnm/model_rndcv4k_reptile.rds")
model_spcv4k.pcnm_reptile <- readr::read_rds("model/newmodel/model_pcnm/model_spcv4k_reptile.rds")

model_rndcv4k_amphibian <- readr::read_rds("model/newmodel/model_rndcv4k_amphibian.rds")
model_spcv4k_amphibian <- readr::read_rds("model/newmodel/model_spcv4k_amphibian.rds")

#PCNMs
model_rndcv4k.pcnm_amphibian <- readr::read_rds("model/newmodel/model_pcnm/model_rndcv4k_amphibian.rds")
model_spcv4k.pcnm_amphibian <- readr::read_rds("model/newmodel/model_pcnm/model_spcv4k_amphibian.rds")

t.t.mammal_0.2 <- readr::read_rds("t.t/newt.t/t.t.mammal_0.2.rds")
t.t.reptile_0.2 <- readr::read_rds("t.t/newt.t/t.t.reptile_0.2.rds")
t.t.amphibian_0.2 <- readr::read_rds("t.t/newt.t/t.t.amphibian_0.2.rds")

t.t.pcnm.reptile_0.2 <- readr::read_rds("t.t/newt.t/t.t.pcnm.reptile_0.2.rds")
t.t.pcnm.amphibian_0.2 <- readr::read_rds("t.t/newt.t/t.t.pcnm.amphibian_0.2.rds")
```


varimp

```{r}

varimp_rndcv4k_reptile <- map(model_rndcv4k_reptile, varImp)
varimp_rndcv4k_amphibian <- map(model_rndcv4k_amphibian, varImp)

varimp_rndcv4k.pcnm_amphibian <- map(model_rndcv4k.pcnm_amphibian, varImp)
varimp_rndcv4k.pcnm_reptile <- map(model_rndcv4k.pcnm_reptile, varImp)


# maxent varimp
maxentvarimp_rndcv4k.pcnm_reptile <- future_map(model_rndcv4k.pcnm_reptile, maxentVarImp, 
                                                .options = furrr_options(seed = TRUE), .progress = T)
write_rds(maxentvarimp_rndcv4k.pcnm_reptile, "maxentvarimp_rndcv4k.pcnm_reptile.rds")
maxentvarimp_rndcv4k.pcnm_amphibian <- future_map(model_rndcv4k.pcnm_amphibian, maxentVarImp, 
                                                .options = furrr_options(seed = TRUE), .progress = T)
write_rds(maxentvarimp_rndcv4k.pcnm_amphibian, "maxentvarimp_rndcv4k.pcnm_amphibian.rds")
maxentvarimp_spcv4k.pcnm_reptile <- future_map(model_spcv4k.pcnm_reptile, maxentVarImp,
                                               .options = furrr_options(seed = TRUE), .progress =  T)
write_rds(maxentvarimp_spcv4k.pcnm_reptile, "maxentvarimp_spcv4k.pcnm_reptile.rds")
maxentvarimp_spcv4k.pcnm_amphibian <- future_map(model_spcv4k.pcnm_amphibian, maxentVarImp,
                                               .options = furrr_options(seed = TRUE), .progress =  T)
write_rds(maxentvarimp_spcv4k.pcnm_amphibian, "maxentvarimp_spcv4k.pcnm_amphibian.rds")
# maxent varimp



varimp_spcv4k_reptile <- map(model_spcv4k_reptile, varImp)
varimp_spcv4k_amphibian <- map(model_spcv4k_amphibian, varImp)

varimp_spcv4k.pcnm_amphibian <- map(model_spcv4k.pcnm_amphibian, varImp)
varimp_spcv4k.pcnm_reptile <- map(model_spcv4k.pcnm_reptile, varImp)

df.maxentvarimp_rndcv4k.pcnm_reptile <- list()
for(i in 1:length(maxentvarimp_rndcv4k.pcnm_reptile)){
df.maxentvarimp_rndcv4k.pcnm_reptile[[i]] <- mutate(maxentvarimp_rndcv4k.pcnm_reptile[[i]], 
                                      taxa = "reptile", 
                                      species = model_rndcv4k.pcnm_reptile[[i]]@data@species,
                                      cv = "random")
}

df.maxentvarimp_rndcv4k.pcnm_amphibian <- list()
for(i in 1:length(maxentvarimp_rndcv4k.pcnm_amphibian)){
df.maxentvarimp_rndcv4k.pcnm_amphibian[[i]] <- mutate(maxentvarimp_rndcv4k.pcnm_amphibian[[i]],
                                        taxa = "amphibian",
                                        species = model_rndcv4k.pcnm_amphibian[[i]]@data@species,
                                        cv = "random")
}
df.maxentvarimp_spcv4k.pcnm_reptile <- list()
for(i in 1:length(maxentvarimp_spcv4k.pcnm_reptile)){
df.maxentvarimp_spcv4k.pcnm_reptile[[i]] <- mutate(maxentvarimp_spcv4k.pcnm_reptile[[i]],
                                        taxa = "reptile",
                                        species = model_spcv4k.pcnm_reptile[[i]]@data@species,
                                        cv = "spatial")
}
df.maxentvarimp_spcv4k.pcnm_amphibian <- list()
for(i in 1:length(maxentvarimp_spcv4k.pcnm_amphibian)){
df.maxentvarimp_spcv4k.pcnm_amphibian[[i]] <- mutate(maxentvarimp_spcv4k.pcnm_amphibian[[i]],
                                        taxa = "amphibian",
                                        species = model_spcv4k.pcnm_amphibian[[i]]@data@species,
                                        cv = "spatial")
}

# not use below
for(i in 1:length(varimp_spcv4k.pcnm_reptile)){
varimp_spcv4k.pcnm_reptile[[i]] <- mutate(varimp_spcv4k.pcnm_reptile[[i]],
                                           taxa = "reptile",
                                           species = model_spcv4k.pcnm_reptile[[i]]@data@species,
                                           cv = "random")
}
for(i in 1:length(varimp_spcv4k.pcnm_amphibian)){
varimp_spcv4k.pcnm_amphibian[[i]] <- mutate(varimp_rndcv4k.pcnm_amphibian[[i]],
                                        taxa = "amphibian",
                                        species = model_rndcv4k.pcnm_amphibian[[i]]@data@species,
                                        cv = "random")
}
for(i in 1:length(varimp_rndcv4k.pcnm_reptile)){
varimp_rndcv4k.pcnm_reptile[[i]] <- mutate(varimp_rndcv4k.pcnm_reptile[[i]],
                                           taxa = "reptile",
                                           species = model_rndcv4k.pcnm_reptile[[i]]@data@species,
                                           cv = "random")
}
for(i in 1:length(varimp_rndcv4k.pcnm_amphibian)){
varimp_rndcv4k.pcnm_amphibian[[i]] <- mutate(varimp_rndcv4k.pcnm_amphibian[[i]],
                                        taxa = "amphibian",
                                        species = model_rndcv4k.pcnm_amphibian[[i]]@data@species,
                                        cv = "random")
}
for(i in 1:length(varimp_spcv4k.pcnm_reptile)){
varimp_spcv4k.pcnm_reptile[[i]] <- mutate(varimp_spcv4k.pcnm_reptile[[i]],
                                           taxa = "reptile",
                                           species = model_spcv4k.pcnm_reptile[[i]]@data@species,
                                           cv = "spatial")
}
for(i in 1:length(varimp_spcv4k.pcnm_amphibian)){
varimp_spcv4k.pcnm_amphibian[[i]] <- mutate(varimp_spcv4k.pcnm_amphibian[[i]],
                                        taxa = "amphibian",
                                        species = model_spcv4k.pcnm_amphibian[[i]]@data@species,
                                        cv = "spatial")
}
for(i in 1:length(varimp_spcv4k.pcnm_reptile)){
varimp_spcv4k.pcnm_reptile[[i]] <- mutate(varimp_spcv4k.pcnm_reptile[[i]],
                                           taxa = "reptile",
                                           species = model_spcv4k.pcnm_reptile[[i]]@data@species,
                                           cv = "spatial")
}
for(i in 1:length(varimp_spcv4k.pcnm_amphibian)){
varimp_spcv4k.pcnm_amphibian[[i]] <- mutate(varimp_spcv4k.pcnm_amphibian[[i]],
                                        taxa = "amphibian",
                                        species = model_spcv4k.pcnm_amphibian[[i]]@data@species,
                                        cv = "spatial")
}

df.maxentvarimp_rndcv4k.pcnm_reptile <- do.call(rbind, df.maxentvarimp_rndcv4k.pcnm_reptile) 
df.maxentvarimp_rndcv4k.pcnm_amphibian <- do.call(rbind, df.maxentvarimp_rndcv4k.pcnm_amphibian) 
df.maxentvarimp_spcv4k.pcnm_reptile <- do.call(rbind, df.maxentvarimp_spcv4k.pcnm_reptile) 
df.maxentvarimp_spcv4k.pcnm_amphibian <- do.call(rbind, df.maxentvarimp_spcv4k.pcnm_amphibian) 

rbind(df.maxentvarimp_rndcv4k.pcnm_reptile,
      df.maxentvarimp_rndcv4k.pcnm_amphibian,
      df.maxentvarimp_spcv4k.pcnm_reptile,
      df.maxentvarimp_spcv4k.pcnm_amphibian) -> df.VARIMP

#this fucked up var name in bioclimates
gsub("PCNM1","PCNM01",  df.VARIMP$Variable) -> df.VARIMP$Variable
gsub("PCNM2","PCNM02",  df.VARIMP$Variable) -> df.VARIMP$Variable
gsub("PCNM3","PCNM03",  df.VARIMP$Variable) -> df.VARIMP$Variable
gsub("PCNM4","PCNM04",  df.VARIMP$Variable) -> df.VARIMP$Variable
gsub("PCNM5","PCNM05",  df.VARIMP$Variable) -> df.VARIMP$Variable
gsub("PCNM6","PCNM06",  df.VARIMP$Variable) -> df.VARIMP$Variable
gsub("PCNM7","PCNM07",  df.VARIMP$Variable) -> df.VARIMP$Variable
gsub("PCNM8","PCNM08",  df.VARIMP$Variable) -> df.VARIMP$Variable
gsub("PCNM9","PCNM09",  df.VARIMP$Variable) -> df.VARIMP$Variable
gsub("PCNM010","PCNM10",  df.VARIMP$Variable) -> df.VARIMP$Variable
gsub("PCNM011","PCNM11",  df.VARIMP$Variable) -> df.VARIMP$Variable
gsub("PCNM012","PCNM12",  df.VARIMP$Variable) -> df.VARIMP$Variable
gsub("PCNM013","PCNM13",  df.VARIMP$Variable) -> df.VARIMP$Variable
gsub("PCNM014","PCNM14",  df.VARIMP$Variable) -> df.VARIMP$Variable





ggplot(df.VARIMP) + 
  geom_boxplot(aes(x = Variable, y = Permutation_importance)) + 
  theme_light() +
  theme(strip.text.x = element_text(size = 9, colour = "black"),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        strip.background = element_rect(colour="gray",
                                        fill="white")) + 
  labs(title="Permutation variable importance", 
       subtitle="averaged decrease in training AUC",
       x="Variable",
       y="Variable Importance(normalized %)") -> plot.VARIMP_pt

ggplot(df.VARIMP) + 
  geom_boxplot(aes(x = Variable, y = Percent_contribution)) + 
  theme_light() +
  theme(strip.text.x = element_text(size = 9, colour = "black"),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        strip.background = element_rect(colour="gray",
                                        fill="white")) + 
  labs(title="Percent contribution for variable importance", 
       subtitle="Based on regularized gain from each coefficient modifying iteration",
       x="Variable",
       y="Variable Importance") -> plot.VARIMP_pc

```


35 each

```{r}
pcnm.p.ncol <- vector()
for(i in 1:35){
  ncol(pcnm.p[[i]]$vectors) -> pcnm.p.ncol[i]
}

pcnm.a.ncol <- vector()
for(i in 1:35){
  ncol(pcnm.a[[i]]$vectors) -> pcnm.a.ncol[i]
}

which(pcnm.a.ncol < 50) #21
which(pcnm.p.ncol < 50) #11, 25, 31

pcnm.a[c(11, 21, 25, 31)] <- NULL
pcnm.p[c(11, 21, 25, 31)] <- NULL
#total 31pcs
```


makes them together
```{r}
pcnm.df <- list()
for(i in 1:31){
as.data.frame(rbind(pcnm.p[[i]]$vectors[,1:50],
                    pcnm.a[[i]]$vectors[,1:50])) -> pcnm.df[[i]]}
```

put them as variable
load data

```{r}
data <- readr::read_rds("data/newdata/data.amphibian.rds")
data[c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] <- NULL # make 35 same as pcnm
data[c(11, 21, 25, 31)] <- NULL
```


conduct PCA to cut climate variable into 3

```{r}
library(FactoMineR)

PCA_amphibian <- list()
for (i in 1:length(data)){
  PCA_amphibian[[i]] <- PCA(data[[i]]@data)
} 
```




make PCA123 to find best 3
```{r}
PCA123_amphibian <- list()
for(i in 1:length(PCA_amphibian)){
  PCA123_amphibian[[i]] <- c(names(tail(sort(PCA_amphibian[[i]]$var$cos2[,1]), 1)),
                       names(tail(sort(PCA_amphibian[[i]]$var$cos2[,2]), 1)),
                       names(tail(sort(PCA_amphibian[[i]]$var$cos2[,3]), 1)))}
```


put them inside of data
```{r}
for(i in 1:31){
data[[i]]@data %>% dplyr:::select(PCA123_amphibian[[i]]) %>% cbind(pcnm.df[[i]]) -> data[[i]]@data}
```


cut test
```{r}
t.t <- list()
for (i in 1:31){
  t.t[[i]] <- trainValTest(data[[i]], 
                                         test = 0.2, 
                                         only_presence = TRUE, 
                                         seed = 1)}
```


make rnd fold
```{r}
rnd4k <- function(x){randomFolds(x[[1]], 
                                 k = 4,
                                 only_presence = TRUE,
                                 seed = 1)}

folds.rnd4k_amphibian.test <- map(t.t, rnd4k)
```


do model
```{r}
maxnet.train <- function(x, y){SDMtune::train("Maxnet",
                                               data = x[[1]],
                                               folds = y)}

model_rndcv4k_amphibian <- future_map2(t.t, 
                                    folds.rnd4k_amphibian.test, 
                                    maxnet.train, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)
```

fix glm error
```{r}
maxnet.train(t.t[[10]], folds.rnd4k_amphibian.test[[10]]) #error
```
```{r}
SDMtune::addSamplesToBg(t.t[[10]][[1]])

SDMtune::train("Maxnet",
               data = SDMtune::addSamplesToBg(t.t[[10]][[1]]),
              folds = folds.rnd4k_amphibian.test[[10]]) #still error
```
```{r}
SDMtune::addSamplesToBg(data[[10]]) %>% trainValTest(., 
                                         test = 0.2, 
                                         only_presence = TRUE, 
                                         seed = 1) -> t.t.2


rnd4k(t.t.2) -> fold2

maxnet.train(t.t.2, fold2) # works!!!
```
DO MODEL AGAIN
```{r}
data2 <- map(data, addSamplesToBg)
t.t2 <- list()
for (i in 1:31){
  t.t2[[i]] <- trainValTest(data2[[i]], 
                                         test = 0.2, 
                                         only_presence = TRUE, 
                                         seed = 1)}
fold2 <- map(t.t2, rnd4k)


```

```{r}
model_rndcv4k_amphibian <- future_map2(t.t2, 
                                    fold2, 
                                    maxnet.train, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)
```




check variable importance
```{r}
varimp <- future_map(model_rndcv4k_amphibian, varImp)

varimp.df <- data.frame(matrix(ncol = 62, nrow = 19))
cbind(varimp[[1]][1:19,1:2],
      varimp[[2]][1:19,1:2],
      varimp[[3]][1:19,1:2],
      varimp[[4]][1:19,1:2],
      varimp[[5]][1:19,1:2],
      varimp[[6]][1:19,1:2],
      varimp[[7]][1:19,1:2],
      varimp[[8]][1:19,1:2],
      varimp[[9]][1:19,1:2],
      varimp[[10]][1:19,1:2],
      varimp[[11]][1:19,1:2],
      varimp[[12]][1:19,1:2],
      varimp[[13]][1:19,1:2],
      varimp[[14]][1:19,1:2],
      varimp[[15]][1:19,1:2],
      varimp[[16]][1:19,1:2],
      varimp[[17]][1:19,1:2],
      varimp[[18]][1:19,1:2],
      varimp[[19]][1:19,1:2],
      varimp[[20]][1:19,1:2],
      varimp[[21]][1:19,1:2],
      varimp[[22]][1:19,1:2],
      varimp[[23]][1:19,1:2],
      varimp[[24]][1:19,1:2],
      varimp[[25]][1:19,1:2],
      varimp[[26]][1:19,1:2],
      varimp[[27]][1:19,1:2],
      varimp[[28]][1:19,1:2],
      varimp[[29]][1:19,1:2],
      varimp[[30]][1:19,1:2],
      varimp[[31]][1:19,1:2]) -> varimp.df

View(varimp.df)
varimp.df
```
even there is more than 50 PCNM variables, they do not actively contribute Model performance
Most of important PCNM variables were from 1:10. 
and among 1:10, PCNM 1,2,3 effect alot.
maybe because of clustering?

Try with all climate variables.
load old climate 19 datas
```{r}
climatedata <- readr::read_rds("data/newdata/data.amphibian.rds")
climatedata[c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] <- NULL # make 35 same as pcnm
climatedata[c(11, 21, 25, 31)] <- NULL

for(i in 1:31){
climatedata[[i]]@data %>% dplyr:::select(., 1:19) %>% cbind(pcnm.df[[i]]) -> climatedata[[i]]@data}
                                        #all variables with 50 PCNM

```


add to sample bg for glm error
```{r}
data3 <- map(climatedata, addSamplesToBg)
t.t3 <- list()
for (i in 1:31){
  t.t3[[i]] <- trainValTest(data3[[i]], 
                           test = 0.2, 
                           only_presence = TRUE, 
                           seed = 1)}
fold3 <- map(t.t3, rnd4k)


```

```{r}
model_rndcv4k_amphibian <- future_map2(t.t3, 
                                    fold3, 
                                    maxnet.train, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)
```

go for 2nd varimp
```{r}
varimp2 <- future_map(model_rndcv4k_amphibian, varImp)

varimp.df2 <- data.frame(matrix(ncol = 62, nrow = 19))
cbind(varimp2[[1]][1:19,1:2],
      varimp2[[2]][1:19,1:2],
      varimp2[[3]][1:19,1:2],
      varimp2[[4]][1:19,1:2],
      varimp2[[5]][1:19,1:2],
      varimp2[[6]][1:19,1:2],
      varimp2[[7]][1:19,1:2],
      varimp2[[8]][1:19,1:2],
      varimp2[[9]][1:19,1:2],
      varimp2[[10]][1:19,1:2],
      varimp2[[11]][1:19,1:2],
      varimp2[[12]][1:19,1:2],
      varimp2[[13]][1:19,1:2],
      varimp2[[14]][1:19,1:2],
      varimp2[[15]][1:19,1:2],
      varimp2[[16]][1:19,1:2],
      varimp2[[17]][1:19,1:2],
      varimp2[[18]][1:19,1:2],
      varimp2[[19]][1:19,1:2],
      varimp2[[20]][1:19,1:2],
      varimp2[[21]][1:19,1:2],
      varimp2[[22]][1:19,1:2],
      varimp2[[23]][1:19,1:2],
      varimp2[[24]][1:19,1:2],
      varimp2[[25]][1:19,1:2],
      varimp2[[26]][1:19,1:2],
      varimp2[[27]][1:19,1:2],
      varimp2[[28]][1:19,1:2],
      varimp2[[29]][1:19,1:2],
      varimp2[[30]][1:19,1:2],
      varimp2[[31]][1:19,1:2]) -> varimp.df2

View(varimp.df2)
varimp.df2
```

mostly PCNM 1 take everything... 

what will happen if PCNM 1 is excluded?

```{r}

t.t3wo1 <- t.t3
for(i in 1:length(t.t3)){
  t.t3wo1[[i]][[1]]@data <- t.t3[[i]][[1]]@data[,-20] 
}

model_wo1 <- future_map2(t.t3wo1, 
                                    fold3, 
                                    maxnet.train, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)
```

go for 3rd varimp
```{r}
varimp3 <- future_map(model_wo1, varImp)

varimp.df3 <- data.frame(matrix(ncol = 62, nrow = 19))
cbind(varimp3[[1]][1:19,1:2],
      varimp3[[2]][1:19,1:2],
      varimp3[[3]][1:19,1:2],
      varimp3[[4]][1:19,1:2],
      varimp3[[5]][1:19,1:2],
      varimp3[[6]][1:19,1:2],
      varimp3[[7]][1:19,1:2],
      varimp3[[8]][1:19,1:2],
      varimp3[[9]][1:19,1:2],
      varimp3[[10]][1:19,1:2],
      varimp3[[11]][1:19,1:2],
      varimp3[[12]][1:19,1:2],
      varimp3[[13]][1:19,1:2],
      varimp3[[14]][1:19,1:2],
      varimp3[[15]][1:19,1:2],
      varimp3[[16]][1:19,1:2],
      varimp3[[17]][1:19,1:2],
      varimp3[[18]][1:19,1:2],
      varimp3[[19]][1:19,1:2],
      varimp3[[20]][1:19,1:2],
      varimp3[[21]][1:19,1:2],
      varimp3[[22]][1:19,1:2],
      varimp3[[23]][1:19,1:2],
      varimp3[[24]][1:19,1:2],
      varimp3[[25]][1:19,1:2],
      varimp3[[26]][1:19,1:2],
      varimp3[[27]][1:19,1:2],
      varimp3[[28]][1:19,1:2],
      varimp3[[29]][1:19,1:2],
      varimp3[[30]][1:19,1:2],
      varimp3[[31]][1:19,1:2]) -> varimp.df3

View(varimp.df3)
varimp.df3
```

# Boyce_bgpcnmfix

```{r}
library(tidyverse)
library(SDMtune)
library(blockCV)
library(ENMeval)
library(raster)
library(sf)
library(sp)
library(zeallot)
library(rJava)
library(dismo)
library(ecospat)
```

load bioclimate models
```{r}
data.mammal <- readr::read_rds("data/newdata/data.mammal.rds")
data.reptile <- readr::read_rds("data/newdata/data.reptile.rds")
data.amphibian <- readr::read_rds("data/newdata/data.amphibian.rds")

#bios
model_rndcv4k_mammal <- readr::read_rds("model/newmodel/model_rndcv4k_mammal.rds")
model_spcv4k_mammal <- readr::read_rds("model/newmodel/model_spcv4k_mammal.rds")


model_rndcv4k_reptile <- readr::read_rds("model/newmodel/model_rndcv4k_reptile.rds")
model_spcv4k_reptile <- readr::read_rds("model/newmodel/model_spcv4k_reptile.rds")


model_rndcv4k.pcnm_reptile <- readr::read_rds("model/newmodel/model_pcnm/model_rndcv4k_reptile.rds")
model_spcv4k.pcnm_reptile <- readr::read_rds("model/newmodel/model_pcnm/model_spcv4k_reptile.rds")

model_rndcv4k_amphibian <- readr::read_rds("model/newmodel/model_rndcv4k_amphibian.rds")
model_spcv4k_amphibian <- readr::read_rds("model/newmodel/model_spcv4k_amphibian.rds")

#PCNMs
model_rndcv4k.pcnm_amphibian <- readr::read_rds("model/newmodel/model_pcnm/model_rndcv4k_amphibian.rds")
model_spcv4k.pcnm_amphibian <- readr::read_rds("model/newmodel/model_pcnm/model_spcv4k_amphibian.rds")
model_rndcv4k.pcnm_reptile <- readr::read_rds("model/newmodel/model_pcnm/model_rndcv4k_reptile.rds")
model_spcv4k.pcnm_reptile <- readr::read_rds("model/newmodel/model_pcnm/model_spcv4k_reptile.rds")

t.t.mammal_0.2 <- readr::read_rds("t.t/newt.t/t.t.mammal_0.2.rds")
t.t.reptile_0.2 <- readr::read_rds("t.t/newt.t/t.t.reptile_0.2.rds")
t.t.amphibian_0.2 <- readr::read_rds("t.t/newt.t/t.t.amphibian_0.2.rds")

t.t.pcnm.reptile_0.2 <- readr::read_rds("t.t/newt.t/t.t.pcnm.reptile_0.2.rds")
t.t.pcnm.amphibian_0.2 <- readr::read_rds("t.t/newt.t/t.t.pcnm.amphibian_0.2.rds")

#grid 
grid.rnd_reptile <- readr::read_rds("D:/grid.rnd_reptile.rds")
grid.rnd_amphibian <- readr::read_rds("D:/grid.rnd_amphibian.rds")
grid.sp_reptile <- readr::read_rds("D:/grid.sp_reptile.rds")
grid.sp_amphibian <- readr::read_rds("D:/grid.sp_amphibian.rds")




grid.rnd.pcnm_reptile <- readr::read_rds("D:/grid.rnd.pcnm_reptile.rds")
grid.rnd.pcnm_amphibian <- readr::read_rds("D:/grid.rnd.pcnm_amphibian.rds")
grid.sp.pcnm_reptile <- readr::read_rds("D:/grid.sp.pcnm_reptile.rds")
grid.sp.pcnm_amphibian <- readr::read_rds("D:/grid.sp.pcnm_amphibian.rds")

a <- vector()
for(i in 1:length(grid.rnd.pcnm_reptile)){a[i] <- nrow(grid.rnd.pcnm_reptile[[i]]@models[[1]]@data@data)}
b <- vector()
for(i in 1:length(grid.rnd.pcnm_amphibian)){b[i] <- nrow(grid.rnd.pcnm_amphibian[[i]]@models[[1]]@data@data)}

folds.sp4k_amphibian <- readr::read_rds("folds/folds.sp4k_amphibian.rds")
SARange_amphibian <- readr::read_rds("SARange/SARange_amphibian.rds")

```

because original plot is highly exagrated.

let's check reg 5. the middle one.

```{r}

######bio
model_rndcv4k_reptile <- list()
for(i in 1:length(grid.rnd_reptile)){
model_rndcv4k_reptile[[i]] <- grid.rnd_reptile[[i]]@models[[1]]  
}

model_rndcv4k_amphibian <- list()
for(i in 1:length(grid.rnd_amphibian)){
model_rndcv4k_amphibian[[i]] <- grid.rnd_amphibian[[i]]@models[[1]]  
}

model_spcv4k_reptile <- list()
for(i in 1:length(grid.sp_reptile)){
model_spcv4k_reptile[[i]] <- grid.sp_reptile[[i]]@models[[1]]  
}

model_spcv4k_amphibian <- list()
for(i in 1:length(grid.sp_amphibian)){
model_spcv4k_amphibian[[i]] <- grid.sp_amphibian[[i]]@models[[1]]  
}
## PCNM
model_rndcv4k.pcnm_reptile <- list()
for(i in 1:length(grid.rnd.pcnm_reptile)){
model_rndcv4k.pcnm_reptile[[i]] <- grid.rnd.pcnm_reptile[[i]]@models[[1]]  
}

model_rndcv4k.pcnm_amphibian <- list()
for(i in 1:length(grid.rnd.pcnm_amphibian)){
model_rndcv4k.pcnm_amphibian[[i]] <- grid.rnd.pcnm_amphibian[[i]]@models[[1]]  
}

model_spcv4k.pcnm_reptile <- list()
for(i in 1:length(grid.sp.pcnm_reptile)){
model_spcv4k.pcnm_reptile[[i]] <- grid.sp.pcnm_reptile[[i]]@models[[1]]  
}

model_spcv4k.pcnm_amphibian <- list()
for(i in 1:length(grid.sp.pcnm_amphibian)){
model_spcv4k.pcnm_amphibian[[i]] <- grid.sp.pcnm_amphibian[[i]]@models[[1]]  
}


```






```{r}
model_rndcv4k.pcnm_amphibian <- readr::read_rds("model/pcnmmodel/model_rndcv4k_amphibian.rds")
```

```{r 91 vs 93 reptile}
a <- vector()
for(i in 1:length(model_rndcv4k_reptile)){a[i] <- model_rndcv4k_reptile[[i]]@data@species }
a

a[c(47,77)]

b <- vector()
for(i in 1:length(t.t.reptile_0.2)){b[i] <- t.t.reptile_0.2[[i]][[1]]@species}
b

model_rndcv4k_reptile <- model_rndcv4k_reptile[-c(47,77)]
```


```{r}
#cut data.amphibian 
data.amphibian[c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] <- NULL
#and 9 for glm error 
data.amphibian[[9]] <- NULL
```



```{r}
source("plots.R")
```


```{r}
boyce_mammal <- readr::read_rds("boyce/boyce_mammal.rds")
```


```{r}
model_spcv4k.pcnm_amphibian <- readr::read_rds("model/pcnmmodel/fwd/model_spcv4k_amphibian.rds")
data.amphibian[c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] <- NULL
data.amphibian[c(11, 21, 25)] <- NULL
data.amphibian <- data.amphibian[-10] 
data.amphibian <- data.amphibian[-22] 
data.amphibian.pcnm <- data.amphibian
```

```{r}
t.t.amphibian_0.2.pcnm <- list()
for (i in 1:length(data.amphibian.pcnm)){
  t.t.amphibian_0.2.pcnm[[i]] <- trainValTest(data.amphibian.pcnm[[i]], 
                                         test = 0.2, 
                                         only_presence = TRUE, 
                                         seed = 1)}
```



test_rndcv 
```{r test_rndcv mean}
#MAMMAL
test_rndcv4k_mammal <- list()
for(i in 1:length(model_rndcv4k_mammal)){
test_rndcv4k_mammal[[i]] <- list(SDMtune::predict(model_rndcv4k_mammal[[i]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```

```{r test_rndcv mean}
#REPTILE RND
test_rndcv4k_reptile <- list()
for(i in 1:length(model_rndcv4k_reptile)){
test_rndcv4k_reptile[[i]] <- list(SDMtune::predict(model_rndcv4k_reptile[[i]], 
                                                  t.t.reptile_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_reptile[[i]],
                                 t.t.reptile_0.2[[i]][[2]]@data[t.t.reptile_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))
                                } #전부다는 [[1]]에, 출현은 [[2]]에
```

```{r test_rndcv mean}
#AMPHIBIAN RND
test_rndcv4k_amphibian <- list()
for(i in 1:length(model_rndcv4k_amphibian)){
test_rndcv4k_amphibian[[i]] <- list(SDMtune::predict(model_rndcv4k_amphibian[[i]], 
                                                  t.t.amphibian_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_amphibian[[i]],
                                 t.t.amphibian_0.2[[i]][[2]]@data[t.t.amphibian_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```


```{r test_spcv mean}
#REPTILE SP
test_spcv4k_reptile <- list()
for(i in 1:length(model_spcv4k_reptile)){
test_spcv4k_reptile[[i]] <- list(SDMtune::predict(model_spcv4k_reptile[[i]], 
                                                  t.t.reptile_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_reptile[[i]],
                                 t.t.reptile_0.2[[i]][[2]]@data[t.t.reptile_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```


```{r test_spcv mean}
#AMPHIBIAN SP
test_spcv4k_amphibian <- list()
for(i in 1:length(model_spcv4k_amphibian)){
test_spcv4k_amphibian[[i]] <- list(SDMtune::predict(model_spcv4k_amphibian[[i]], 
                                                  t.t.amphibian_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_amphibian[[i]],
                                 t.t.amphibian_0.2[[i]][[2]]@data[t.t.amphibian_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```




test_rnd but PCNM REPTILE
```{r test_rndcv mean}
test_rndcv4k.pcnm_reptile <- list()
for(i in 29:length(model_rndcv4k.pcnm_reptile)){
test_rndcv4k.pcnm_reptile[[i]] <- list(SDMtune::predict(model_rndcv4k.pcnm_reptile[[i]], 
                                                  t.t.pcnm.reptile_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k.pcnm_reptile[[i]],
                                 t.t.pcnm.reptile_0.2[[i]][[2]]@data[t.t.pcnm.reptile_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")
                                )} #전부다는 [[1]]에, 출현은 [[2]]에
```








test_rnd but PCNM AMPHIBIAN
```{r test_rndcv mean}
test_rndcv4k.pcnm_amphibian <- list()
for(i in 14:length(model_rndcv4k.pcnm_amphibian)){
test_rndcv4k.pcnm_amphibian[[i]] <- list(SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]], 
                                                  t.t.pcnm.amphibian_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]],
                                 t.t.pcnm.amphibian_0.2[[i]][[2]]@data[t.t.pcnm.amphibian_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```

test_SP PCNM REPTILE

```{r test_rndcv mean}
test_spcv4k.pcnm_reptile <- list()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
test_spcv4k.pcnm_reptile[[i]] <- list(SDMtune::predict(model_spcv4k.pcnm_reptile[[i]], 
                                                  t.t.pcnm.reptile_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k.pcnm_reptile[[i]],
                                 t.t.pcnm.reptile_0.2[[i]][[2]]@data[t.t.pcnm.reptile_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```

test_SP PCNM AMPHIBIAN

```{r test_rndcv mean}
test_spcv4k.pcnm_amphibian <- list()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
test_spcv4k.pcnm_amphibian[[i]] <- list(SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]], 
                                                  t.t.pcnm.amphibian_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]],
                                 t.t.pcnm.amphibian_0.2[[i]][[2]]@data[t.t.pcnm.amphibian_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```


test_spcv 
```{r test_spcv mean}
test_spcv4k_mammal <- list()
for(i in 1:length(model_spcv4k_mammal)){
test_spcv4k_mammal[[i]] <- list(SDMtune::predict(model_spcv4k_mammal[[i]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```






test_rndcv not mean
```{r test_rndcv not mean}
test_rndcv4k.notmean_mammal <- list()
for(i in 1:length(model_rndcv4k_mammal)){
test_rndcv4k.notmean_mammal[[i]] <- list(list(SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[1]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[1]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                 list(SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[2]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[2]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                 list(SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[3]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[3]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                 list(SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[4]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[4]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")))} #전부다는 [[1]]에, 출현은 [[2]]에
```

test spcv not mean
```{r test_spcv not mean}
test_spcv4k.notmean_mammal <- list()
for(i in 1:length(model_spcv4k_mammal)){
test_spcv4k.notmean_mammal[[i]] <- list(list(SDMtune::predict(model_spcv4k_mammal[[i]]@models[[1]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]]@models[[1]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                 list(SDMtune::predict(model_spcv4k_mammal[[i]]@models[[2]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]]@models[[2]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                 list(SDMtune::predict(model_spcv4k_mammal[[i]]@models[[3]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]]@models[[3]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                 list(SDMtune::predict(model_spcv4k_mammal[[i]]@models[[4]], 
                                                  t.t.mammal_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]]@models[[4]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")))} #전부다는 [[1]]에, 출현은 [[2]]에
```


```{r}
poc.df_rndcv4k_mammal <- list()
for(i in 1:length(model_rndcv4k_mammal)){
poc.df_rndcv4k_mammal[[i]] <- list(SDMtune::predict(model_rndcv4k_mammal[[i]], 
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 0,],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]],
                                 t.t.mammal_0.2[[i]][[2]]@data[t.t.mammal_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #배경은 [[1]]에, 출현은 [[2]]에






```

boyce caculator
```{r}
my.boyce <- function(x,y){ecospat.boyce(fit = x, 
                                        obs = y,
                                              nclass=0,
                                              window.w="default",
                                              res=100,
                                              PEplot = TRUE)}
```


```{r boyce.test mean}
boyce.test.rnd_mammal <- list()
for(i in 1:length(test_rndcv4k_mammal)){
boyce.test.rnd_mammal[[i]] <- my.boyce(test_rndcv4k_mammal[[i]][[1]], test_rndcv4k_mammal[[i]][[2]])  
}

```

```{r boyce.test rnd bioclimate mean reptile}
boyce.test.rnd_reptile <- list()
for(i in 1:length(test_rndcv4k_reptile)){
boyce.test.rnd_reptile[[i]] <- my.boyce(test_rndcv4k_reptile[[i]][[1]], test_rndcv4k_reptile[[i]][[2]])  
}

```




```{r boyce.test rnd bioclimate mean reptile}
boyce.test.rnd_amphibian <- list()
for(i in 1:length(test_rndcv4k_amphibian)){
boyce.test.rnd_amphibian[[i]] <- my.boyce(test_rndcv4k_amphibian[[i]][[1]], test_rndcv4k_amphibian[[i]][[2]])  
}

```



```{r boyce.test rnd PCNM mean reptile}
boyce.test.rnd.pcnm_reptile <- list()
for(i in 29:length(test_rndcv4k.pcnm_reptile)){
boyce.test.rnd.pcnm_reptile[[i]] <- my.boyce(test_rndcv4k.pcnm_reptile[[i]][[1]], test_rndcv4k.pcnm_reptile[[i]][[2]])  
}

```


```{r boyce.test rnd PCNM mean amphibian}
boyce.test.rnd.pcnm_amphibian <- list()
for(i in 14:length(test_rndcv4k.pcnm_amphibian)){
boyce.test.rnd.pcnm_amphibian[[i]] <- my.boyce(test_rndcv4k.pcnm_amphibian[[i]][[1]], test_rndcv4k.pcnm_amphibian[[i]][[2]])  
}

```


```{r boyce.test mean}
#REPTILE SP
boyce.test.sp_reptile <- list()
for(i in 1:length(test_spcv4k_reptile)){
boyce.test.sp_reptile[[i]] <- my.boyce(test_spcv4k_reptile[[i]][[1]], test_spcv4k_reptile[[i]][[2]])  
}

```

```{r boyce.test mean}
#AMPHIBIAN SP
boyce.test.sp_amphibian <- list()
for(i in 1:length(test_spcv4k_amphibian)){
boyce.test.sp_amphibian[[i]] <- my.boyce(test_spcv4k_amphibian[[i]][[1]], test_spcv4k_amphibian[[i]][[2]])  
}

```



```{r boyce.test sp PCNM mean REPTILE}
boyce.test.sp.pcnm_reptile <- list()
for(i in 1:length(test_spcv4k.pcnm_reptile)){
boyce.test.sp.pcnm_reptile[[i]] <- my.boyce(test_spcv4k.pcnm_reptile[[i]][[1]], test_spcv4k.pcnm_reptile[[i]][[2]])  
}

```


```{r boyce.test sp PCNM mean}
boyce.test.sp.pcnm_amphibian <- list()
for(i in 5:length(test_spcv4k.pcnm_amphibian)){
boyce.test.sp.pcnm_amphibian[[i]] <- my.boyce(test_spcv4k.pcnm_amphibian[[i]][[1]], test_spcv4k.pcnm_amphibian[[i]][[2]])  
}

```


```{r boyce.test rnd NOT mean}
boyce.test.rnd.notmean_mammal <- list()
for(i in 1:length(test_rndcv4k.notmean_mammal)){boyce.test.rnd.notmean_mammal[[i]] <- 
                    list(my.boyce(test_rndcv4k.notmean_mammal[[i]][[1]][[1]], test_rndcv4k.notmean_mammal[[i]][[1]][[2]]),
                        my.boyce(test_rndcv4k.notmean_mammal[[i]][[2]][[1]], test_rndcv4k.notmean_mammal[[i]][[2]][[2]]),
                        my.boyce(test_rndcv4k.notmean_mammal[[i]][[3]][[1]], test_rndcv4k.notmean_mammal[[i]][[3]][[2]]),
                        my.boyce(test_rndcv4k.notmean_mammal[[i]][[4]][[1]], test_rndcv4k.notmean_mammal[[i]][[4]][[2]]))
}
```


#jesus fucking macrotis lagotis
do not remove. just pass that fig
```{r boyce.test rnd NOT mean}
boyce.test.sp.notmean_mammal <- list()
for(i in 1:length(test_spcv4k.notmean_mammal)){boyce.test.sp.notmean_mammal[[i]] <- 
                    list(my.boyce(test_spcv4k.notmean_mammal[[i]][[1]][[1]], test_spcv4k.notmean_mammal[[i]][[1]][[2]]),
                        my.boyce(test_spcv4k.notmean_mammal[[i]][[2]][[1]], test_spcv4k.notmean_mammal[[i]][[2]][[2]]),
                        my.boyce(test_spcv4k.notmean_mammal[[i]][[3]][[1]], test_spcv4k.notmean_mammal[[i]][[3]][[2]]),
                        my.boyce(test_spcv4k.notmean_mammal[[i]][[4]][[1]], test_spcv4k.notmean_mammal[[i]][[4]][[2]]))
}# this will stop at 12 macrotis lagotis
```
```{r boyce.test rnd NOT mean}
boyce.test.sp.notmean_mammal <- list()
for(i in 13:length(test_spcv4k.notmean_mammal)){boyce.test.sp.notmean_mammal[[i]] <- 
                    list(my.boyce(test_spcv4k.notmean_mammal[[i]][[1]][[1]], test_spcv4k.notmean_mammal[[i]][[1]][[2]]),
                        my.boyce(test_spcv4k.notmean_mammal[[i]][[2]][[1]], test_spcv4k.notmean_mammal[[i]][[2]][[2]]),
                        my.boyce(test_spcv4k.notmean_mammal[[i]][[3]][[1]], test_spcv4k.notmean_mammal[[i]][[3]][[2]]),
                        my.boyce(test_spcv4k.notmean_mammal[[i]][[4]][[1]], test_spcv4k.notmean_mammal[[i]][[4]][[2]]))
}# so just fucking pass it
```

make df 
```{r}
df.boyce.test.rndsp.notmean_mammal <- list()
for(i in 1:35){df.boyce.test.rndsp.notmean_mammal[[i]] <- rbind(data.frame(Hs = boyce.test.rnd.notmean_mammal[[i]][[1]]$HS,
                                                                F.ratio = boyce.test.rnd.notmean_mammal[[i]][[1]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs = boyce.test.rnd.notmean_mammal[[i]][[2]]$HS,
                                                                F.ratio = boyce.test.rnd.notmean_mammal[[i]][[2]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs = boyce.test.rnd.notmean_mammal[[i]][[3]]$HS,
                                                                F.ratio = boyce.test.rnd.notmean_mammal[[i]][[3]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs = boyce.test.rnd.notmean_mammal[[i]][[4]]$HS,
                                                                F.ratio = boyce.test.rnd.notmean_mammal[[i]][[4]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs= boyce.test.sp.notmean_mammal[[i]][[1]]$HS,
                                                                F.ratio = boyce.test.sp.notmean_mammal[[i]][[1]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs= boyce.test.sp.notmean_mammal[[i]][[2]]$HS,
                                                                F.ratio = boyce.test.sp.notmean_mammal[[i]][[2]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs= boyce.test.sp.notmean_mammal[[i]][[3]]$HS,
                                                                F.ratio = boyce.test.sp.notmean_mammal[[i]][[3]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs= boyce.test.sp.notmean_mammal[[i]][[4]]$HS,
                                                                F.ratio = boyce.test.sp.notmean_mammal[[i]][[4]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species))
}# this will stop in 11

#pass 12 and move on to 13
for(i in 13:35){df.boyce.test.rndsp.notmean_mammal[[i]] <- rbind(data.frame(Hs = boyce.test.rnd.notmean_mammal[[i]][[1]]$HS,
                                                                F.ratio = boyce.test.rnd.notmean_mammal[[i]][[1]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs = boyce.test.rnd.notmean_mammal[[i]][[2]]$HS,
                                                                F.ratio = boyce.test.rnd.notmean_mammal[[i]][[2]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs = boyce.test.rnd.notmean_mammal[[i]][[3]]$HS,
                                                                F.ratio = boyce.test.rnd.notmean_mammal[[i]][[3]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs = boyce.test.rnd.notmean_mammal[[i]][[4]]$HS,
                                                                F.ratio = boyce.test.rnd.notmean_mammal[[i]][[4]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs= boyce.test.sp.notmean_mammal[[i]][[1]]$HS,
                                                                F.ratio = boyce.test.sp.notmean_mammal[[i]][[1]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs= boyce.test.sp.notmean_mammal[[i]][[2]]$HS,
                                                                F.ratio = boyce.test.sp.notmean_mammal[[i]][[2]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs= boyce.test.sp.notmean_mammal[[i]][[3]]$HS,
                                                                F.ratio = boyce.test.sp.notmean_mammal[[i]][[3]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species),
                                                                data.frame(Hs= boyce.test.sp.notmean_mammal[[i]][[4]]$HS,
                                                                F.ratio = boyce.test.sp.notmean_mammal[[i]][[4]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species))
}

df.boyce.test.rndsp.notmean_mammal[-12] -> df.boyce.test.rndsp.notmean_mammal
df.boyce.test.rndsp.notmean_mammal2 <- do.call(rbind, df.boyce.test.rndsp.notmean_mammal)    


```



to check boyce of spcv4k without PCNM
```{r}
test_spcv4k_amphibian <- list()
for(i in 1:length(model_spcv4k_amphibian)){
test_spcv4k_amphibian[[i]] <- list(SDMtune::predict(model_spcv4k_amphibian[[i]], 
                                                  t.t.amphibian_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_amphibian[[i]],
                                 t.t.amphibian_0.2[[i]][[2]]@data[t.t.amphibian_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```

```{r}
boyce_test.sp_amphibian <- list()
for(i in 1:length(test_spcv4k_amphibian)){
boyce_test.sp_amphibian[[i]] <- my.boyce(test_spcv4k_amphibian[[i]][[1]], test_spcv4k_amphibian[[i]][[2]])  
}
```



```{r}


boyce_test.sp.pcnm_amphibian <- list()
for(i in 1:length(test_spcv4k.pcnm_amphibian)){
boyce_test.sp.pcnm_amphibian[[i]] <- my.boyce(test_spcv4k.pcnm_amphibian[[i]][[1]], test_spcv4k.pcnm_amphibian[[i]][[2]])  
}
```


```{r}
df.boyce.test.sp.pcnm_amphibian <- list()
for(i in 1:30){df.boyce.test.sp.pcnm_amphibian[[i]] <- rbind(data.frame(Hs = boyce_test.sp.pcnm_amphibian[[i]][[1]]$HS,
                                                            F.ratio = boyce_test.sp.pcnm_amphibian[[i]][[1]]$F.ratio,
                                                            model = "m1",
                                                            species = data.amphibian.pcnm[[i]]@species),
                                                 data.frame(Hs = boyce_test.sp.pcnm_amphibian[[i]][[2]]$HS,
                                                            F.ratio = boyce_test.sp.pcnm_amphibian[[i]][[2]]$F.ratio,
                                                            model = "m2",
                                                            species = data.amphibian.pcnm[[i]]@species),
                                                 data.frame(Hs = boyce_test.sp.pcnm_amphibian[[i]][[3]]$HS,
                                                            F.ratio = boyce_test.sp.pcnm_amphibian[[i]][[3]]$F.ratio,
                                                            model = "m3",
                                                            species = data.amphibian.pcnm[[i]]@species),
                                                 data.frame(Hs = boyce_test.sp.pcnm_amphibian[[i]][[4]]$HS,
                                                            F.ratio = boyce_test.sp.pcnm_amphibian[[i]][[4]]$F.ratio,
                                                            model = "m4",
                                                            species = data.amphibian.pcnm[[i]]@species))}



df.boyce.test.sp.pcnm_amphibian2 <- do.call(rbind, df.boyce.test.sp.pcnm_amphibian)
```



```{r}

data.val.mammal <- list()
for(i in 1:35){data.val.mammal[[i]] <- list(model_rndcv4k_mammal[[i]]@data@data[model_rndcv4k_mammal[[i]]@folds$test[,1],][1:(sum(model_rndcv4k_mammal[[i]]@data@pa == 1) - sum(model_rndcv4k_mammal[[i]]@models[[1]]@data@pa == 1)),],
                    model_rndcv4k_mammal[[i]]@data@data[model_rndcv4k_mammal[[i]]@folds$test[,2],][1:(sum(model_rndcv4k_mammal[[i]]@data@pa == 1) - sum(model_rndcv4k_mammal[[i]]@models[[2]]@data@pa == 1)),],
                    model_rndcv4k_mammal[[i]]@data@data[model_rndcv4k_mammal[[i]]@folds$test[,3],][1:(sum(model_rndcv4k_mammal[[i]]@data@pa == 1) - sum(model_rndcv4k_mammal[[i]]@models[[3]]@data@pa == 1)),],
                    model_rndcv4k_mammal[[i]]@data@data[model_rndcv4k_mammal[[i]]@folds$test[,4],][1:(sum(model_rndcv4k_mammal[[i]]@data@pa == 1) - sum(model_rndcv4k_mammal[[i]]@models[[4]]@data@pa == 1)),])}

data.valnwbg.mammal <- list()
for(i in 1:35){
  data.valnwbg.mammal[[i]] <- list( model_rndcv4k_mammal[[i]]@data@data[model_rndcv4k_mammal[[i]]@folds$test[,1],],
model_rndcv4k_mammal[[i]]@data@data[model_rndcv4k_mammal[[i]]@folds$test[,2],],
model_rndcv4k_mammal[[i]]@data@data[model_rndcv4k_mammal[[i]]@folds$test[,3],],
model_rndcv4k_mammal[[i]]@data@data[model_rndcv4k_mammal[[i]]@folds$test[,4],])
}


# model_rndcv4k_mammal[[1]]@data@data[model_rndcv4k_mammal[[1]]@folds$test[,1],][1:(sum(model_rndcv4k_mammal#[[1]]@data@pa == 1) - sum(model_rndcv4k_mammal[[1]]@models[[1]]@data@pa == 1)),] # 1st val set

# CV 모형의 전체 학습 출현 개수
#sum(model_rndcv4k_mammal[[1]]@data@pa == 1)
# 1번 모형의 학습 출현 개수
#sum(model_rndcv4k_mammal[[1]]@models[[1]]@data@pa == 1)
  
  
#model_rndcv4k_mammal[[1]]@data@data[model_rndcv4k_mammal[[1]]@folds$test[,1],][model_rndcv4k_mammal[[1]]@models[[1]]@data@pa# 1st val set

#model_rndcv4k_mammal[[1]]@data@data[model_rndcv4k_mammal[[1]]@data@pa==1,][model_rndcv4k_mammal[[1]]@folds$test[,1],]                                                                               
                                                                               
                                                                               
                                                                               
#model_rndcv4k_mammal[[1]]@data@data[model_rndcv4k_mammal[[1]]@folds$test[,2],]# 2nd val set
#model_rndcv4k_mammal[[1]]@data@data[model_rndcv4k_mammal[[1]]@folds$test[,3],]# 3rd val set
#model_rndcv4k_mammal[[1]]@data@data[model_rndcv4k_mammal[[1]]@folds$test[,4],]# 4th val set

#1번 종의 CV 모형        #그중 1번째 모형 #에 포함된 데이터
#model_rndcv4k_mammal[[1]]@models[[1]]@data@data[model_rndcv4k_mammal[[1]]@folds$test[,1],]

#1번 종의 CV 모형        #그중 1번째 모형 #에 포함된 데이터(종, pa도 잇음)
#model_rndcv4k_mammal[[1]]@models[[1]]@data@data[model_rndcv4k_mammal[[1]]@models[[1]]@data@pa == 1,]

```


validation to pcnm model
```{r}

data.val.amphibian <- list()
for(i in 1:34){data.val.amphibian[[i]] <- list(model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@folds$test[,1],][1:(sum(model_rndcv4k.pcnm_amphibian[[i]]@data@pa == 1) - sum(model_rndcv4k.pcnm_amphibian[[i]]@models[[1]]@data@pa == 1)),],
                    model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@folds$test[,2],][1:(sum(model_rndcv4k.pcnm_amphibian[[i]]@data@pa == 1) - sum(model_rndcv4k.pcnm_amphibian[[i]]@models[[2]]@data@pa == 1)),],
                    model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@folds$test[,3],][1:(sum(model_rndcv4k.pcnm_amphibian[[i]]@data@pa == 1) - sum(model_rndcv4k.pcnm_amphibian[[i]]@models[[3]]@data@pa == 1)),],
                    model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@folds$test[,4],][1:(sum(model_rndcv4k.pcnm_amphibian[[i]]@data@pa == 1) - sum(model_rndcv4k.pcnm_amphibian[[i]]@models[[4]]@data@pa == 1)),])}

data.valnwbg.amphibian <- list()
for(i in 1:34){
  data.valnwbg.amphibian[[i]] <- list( model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@folds$test[,1],],
model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@folds$test[,2],],
model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@folds$test[,3],],
model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@folds$test[,4],])
}

```

validation to PCNM SPatial
```{r}


data.val.sp.amphibian <- list()
for(i in 1:30){data.val.sp.amphibian[[i]] <- list(model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@folds$test[,1],][1:(sum(model_spcv4k.pcnm_amphibian[[i]]@data@pa == 1) - sum(model_spcv4k.pcnm_amphibian[[i]]@models[[1]]@data@pa == 1)),],
                    model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@folds$test[,2],][1:(sum(model_spcv4k.pcnm_amphibian[[i]]@data@pa == 1) - sum(model_spcv4k.pcnm_amphibian[[i]]@models[[2]]@data@pa == 1)),],
                    model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@folds$test[,3],][1:(sum(model_spcv4k.pcnm_amphibian[[i]]@data@pa == 1) - sum(model_spcv4k.pcnm_amphibian[[i]]@models[[3]]@data@pa == 1)),],
                    model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@folds$test[,4],][1:(sum(model_spcv4k.pcnm_amphibian[[i]]@data@pa == 1) - sum(model_spcv4k.pcnm_amphibian[[i]]@models[[4]]@data@pa == 1)),])}

data.valnwbg.sp.amphibian <- list()
for(i in 1:30){
  data.valnwbg.sp.amphibian[[i]] <- list( model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@folds$test[,1],],
model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@folds$test[,2],],
model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@folds$test[,3],],
model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@folds$test[,4],])
}


```





DATA from validation model built with Spatial block cross validation
```{r spatial block}
data.val.sp.mammal <- list()
for(i in 1:35){data.val.sp.mammal[[i]] <- list(model_spcv4k_mammal[[i]]@data@data[model_spcv4k_mammal[[i]]@folds$test[,1],][1:(sum(model_spcv4k_mammal[[i]]@data@pa == 1) - sum(model_spcv4k_mammal[[i]]@models[[1]]@data@pa == 1)),],
                    model_spcv4k_mammal[[i]]@data@data[model_spcv4k_mammal[[i]]@folds$test[,2],][1:(sum(model_spcv4k_mammal[[i]]@data@pa == 1) - sum(model_spcv4k_mammal[[i]]@models[[2]]@data@pa == 1)),],
                    model_rndcv4k_mammal[[i]]@data@data[model_spcv4k_mammal[[i]]@folds$test[,3],][1:(sum(model_spcv4k_mammal[[i]]@data@pa == 1) - sum(model_spcv4k_mammal[[i]]@models[[3]]@data@pa == 1)),],
                    model_spcv4k_mammal[[i]]@data@data[model_spcv4k_mammal[[i]]@folds$test[,4],][1:(sum(model_spcv4k_mammal[[i]]@data@pa == 1) - sum(model_spcv4k_mammal[[i]]@models[[4]]@data@pa == 1)),])}

data.valnwbg.sp.mammal <- list()
for(i in 1:35){
  data.valnwbg.sp.mammal[[i]] <- list( model_spcv4k_mammal[[i]]@data@data[model_spcv4k_mammal[[i]]@folds$test[,1],],
model_spcv4k_mammal[[i]]@data@data[model_spcv4k_mammal[[i]]@folds$test[,2],],
model_spcv4k_mammal[[i]]@data@data[model_spcv4k_mammal[[i]]@folds$test[,3],],
model_spcv4k_mammal[[i]]@data@data[model_spcv4k_mammal[[i]]@folds$test[,4],])
}
```


```{r environmental block}
data.val.env.mammal <- list()
for(i in 1:35){data.val.env.mammal[[i]] <- list(model_envcv4k_mammal[[i]]@data@data[model_envcv4k_mammal[[i]]@folds$test[,1],][1:(sum(model_envcv4k_mammal[[i]]@data@pa == 1) - sum(model_envcv4k_mammal[[i]]@models[[1]]@data@pa == 1)),],
                    model_envcv4k_mammal[[i]]@data@data[model_envcv4k_mammal[[i]]@folds$test[,2],][1:(sum(model_envcv4k_mammal[[i]]@data@pa == 1) - sum(model_envcv4k_mammal[[i]]@models[[2]]@data@pa == 1)),],
                    model_rndcv4k_mammal[[i]]@data@data[model_envcv4k_mammal[[i]]@folds$test[,3],][1:(sum(model_envcv4k_mammal[[i]]@data@pa == 1) - sum(model_envcv4k_mammal[[i]]@models[[3]]@data@pa == 1)),],
                    model_envcv4k_mammal[[i]]@data@data[model_envcv4k_mammal[[i]]@folds$test[,4],][1:(sum(model_envcv4k_mammal[[i]]@data@pa == 1) - sum(model_envcv4k_mammal[[i]]@models[[4]]@data@pa == 1)),])}

data.valnwbg.env.mammal <- list()
for(i in 1:35){
  data.valnwbg.env.mammal[[i]] <- list( model_envcv4k_mammal[[i]]@data@data[model_envcv4k_mammal[[i]]@folds$test[,1],],
model_envcv4k_mammal[[i]]@data@data[model_envcv4k_mammal[[i]]@folds$test[,2],],
model_envcv4k_mammal[[i]]@data@data[model_envcv4k_mammal[[i]]@folds$test[,3],],
model_envcv4k_mammal[[i]]@data@data[model_envcv4k_mammal[[i]]@folds$test[,4],])
}
```



문제 있는듯? 2번은  왜 모형 다르누?
```{r}
val_rndcv4k_mammal <- list()
for(i in 1:length(model_rndcv4k_mammal)){
val_rndcv4k_mammal[[i]] <- list(list(SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[1]], 
                                                  data.val.mammal[[i]][[1]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]],
                                 data.valnwbg.mammal[[i]][[1]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[2]], 
                                                  data.val.mammal[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]],
                                 data.valnwbg.mammal[[i]][[2]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[3]], 
                                                  data.val.mammal[[i]][[3]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]],
                                 data.valnwbg.mammal[[i]][[3]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_rndcv4k_mammal[[i]]@models[[4]], 
                                                  data.val.mammal[[i]][[4]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k_mammal[[i]],
                                 data.valnwbg.mammal[[i]][[4]],
                                                   fun = "mean",
                                                   type = "cloglog")))}
```

predict spatial validation set with spatial model (!)
```{r}
val_spcv4k_mammal <- list()
for(i in 1:length(model_spcv4k_mammal)){
val_spcv4k_mammal[[i]] <- list(list(SDMtune::predict(model_spcv4k_mammal[[i]]@models[[1]], 
                                                  data.val.sp.mammal[[i]][[1]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]],
                                 data.valnwbg.sp.mammal[[i]][[1]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_spcv4k_mammal[[i]]@models[[2]], 
                                                  data.val.sp.mammal[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]],
                                 data.valnwbg.sp.mammal[[i]][[2]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_spcv4k_mammal[[i]]@models[[3]], 
                                                  data.val.sp.mammal[[i]][[3]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]],
                                 data.valnwbg.sp.mammal[[i]][[3]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_spcv4k_mammal[[i]]@models[[4]], 
                                                  data.val.sp.mammal[[i]][[4]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k_mammal[[i]],
                                 data.valnwbg.sp.mammal[[i]][[4]],
                                                   fun = "mean",
                                                   type = "cloglog")))}
```

predict environmental validation set with environmental model
```{r}
val_envcv4k_mammal <- list()
for(i in 1:length(model_envcv4k_mammal)){
val_envcv4k_mammal[[i]] <- list(list(SDMtune::predict(model_envcv4k_mammal[[i]]@models[[1]], 
                                                  data.val.env.mammal[[i]][[1]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_envcv4k_mammal[[i]],
                                 data.valnwbg.env.mammal[[i]][[1]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_envcv4k_mammal[[i]]@models[[2]], 
                                                  data.val.env.mammal[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_envcv4k_mammal[[i]],
                                 data.valnwbg.env.mammal[[i]][[2]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_envcv4k_mammal[[i]]@models[[3]], 
                                                  data.val.env.mammal[[i]][[3]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_envcv4k_mammal[[i]],
                                 data.valnwbg.env.mammal[[i]][[3]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_envcv4k_mammal[[i]]@models[[4]], 
                                                  data.val.env.mammal[[i]][[4]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_envcv4k_mammal[[i]],
                                 data.valnwbg.env.mammal[[i]][[4]],
                                                   fun = "mean",
                                                   type = "cloglog")))}
```

validation to pcnm amphibian

```{r}
val_rndcv4k.pcnm_amphibian <- list()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
val_rndcv4k.pcnm_amphibian[[i]] <- list(list(SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]]@models[[1]], 
                                                  data.val.amphibian[[i]][[1]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]],
                                 data.valnwbg.amphibian[[i]][[1]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]]@models[[2]], 
                                                  data.val.amphibian[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]],
                                 data.valnwbg.amphibian[[i]][[2]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]]@models[[3]], 
                                                  data.val.amphibian[[i]][[3]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]],
                                 data.valnwbg.amphibian[[i]][[3]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]]@models[[4]], 
                                                  data.val.amphibian[[i]][[4]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]],
                                 data.valnwbg.amphibian[[i]][[4]],
                                                   fun = "mean",
                                                   type = "cloglog")))}
```

validation to spatial amphibian pcnm
```{r}
val_spcv4k.pcnm_amphibian <- list()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
val_spcv4k.pcnm_amphibian[[i]] <- list(list(SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]]@models[[1]], 
                                                  data.val.sp.amphibian[[i]][[1]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]],
                                 data.valnwbg.sp.amphibian[[i]][[1]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]]@models[[2]], 
                                                  data.val.sp.amphibian[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]],
                                 data.valnwbg.sp.amphibian[[i]][[2]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]]@models[[3]], 
                                                  data.val.sp.amphibian[[i]][[3]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]],
                                 data.valnwbg.sp.amphibian[[i]][[3]],
                                                   fun = "mean",
                                                   type = "cloglog")),
                                list(SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]]@models[[4]], 
                                                  data.val.sp.amphibian[[i]][[4]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]],
                                 data.valnwbg.sp.amphibian[[i]][[4]],
                                                   fun = "mean",
                                                   type = "cloglog")))}
```


boyce result of rnd cv
```{r}
boyce.val.rnd_mammal <- list()
for(i in 1:length(val_rndcv4k_mammal)){boyce.val.rnd_mammal[[i]] <- 
                    list(my.boyce(val_rndcv4k_mammal[[i]][[1]][[2]], val_rndcv4k_mammal[[i]][[1]][[1]]),
                        my.boyce(val_rndcv4k_mammal[[i]][[2]][[2]], val_rndcv4k_mammal[[i]][[2]][[1]]),
                        my.boyce(val_rndcv4k_mammal[[i]][[3]][[2]], val_rndcv4k_mammal[[i]][[3]][[1]]),
                        my.boyce(val_rndcv4k_mammal[[i]][[4]][[2]], val_rndcv4k_mammal[[i]][[4]][[1]]))
}
```

boyce result of spatial block cv
```{r}
boyce.val.sp_mammal <- list()
for(i in 1:length(val_spcv4k_mammal)){boyce.val.sp_mammal[[i]] <- 
                    list(my.boyce(val_spcv4k_mammal[[i]][[1]][[2]], val_spcv4k_mammal[[i]][[1]][[1]]),
                        my.boyce(val_spcv4k_mammal[[i]][[2]][[2]], val_spcv4k_mammal[[i]][[2]][[1]]),
                        my.boyce(val_spcv4k_mammal[[i]][[3]][[2]], val_spcv4k_mammal[[i]][[3]][[1]]),
                        my.boyce(val_spcv4k_mammal[[i]][[4]][[2]], val_spcv4k_mammal[[i]][[4]][[1]]))
}
```

boyce result of environmental block cv
```{r}
boyce.val.env_mammal <- list()
for(i in 1:length(val_envcv4k_mammal)){boyce.val.env_mammal[[i]] <- 
                    list(my.boyce(val_envcv4k_mammal[[i]][[1]][[2]], val_envcv4k_mammal[[i]][[1]][[1]]),
                        my.boyce(val_envcv4k_mammal[[i]][[2]][[2]], val_envcv4k_mammal[[i]][[2]][[1]]),
                        my.boyce(val_envcv4k_mammal[[i]][[3]][[2]], val_envcv4k_mammal[[i]][[3]][[1]]),
                        my.boyce(val_envcv4k_mammal[[i]][[4]][[2]], val_envcv4k_mammal[[i]][[4]][[1]]))
}
```


```{r}
boyce.val.rnd.pcnm_amphibian <- list()
for(i in 1:length(val_rndcv4k.pcnm_amphibian)){boyce.val.rnd.pcnm_amphibian[[i]] <- 
                    list(my.boyce(val_rndcv4k.pcnm_amphibian[[i]][[1]][[2]], val_rndcv4k.pcnm_amphibian[[i]][[1]][[1]]),
                        my.boyce(val_rndcv4k.pcnm_amphibian[[i]][[2]][[2]], val_rndcv4k.pcnm_amphibian[[i]][[2]][[1]]),
                        my.boyce(val_rndcv4k.pcnm_amphibian[[i]][[3]][[2]], val_rndcv4k.pcnm_amphibian[[i]][[3]][[1]]),
                        my.boyce(val_rndcv4k.pcnm_amphibian[[i]][[4]][[2]], val_rndcv4k.pcnm_amphibian[[i]][[4]][[1]]))
}
```



```{r}
boyce.val.sp.pcnm_amphibian <- list()
for(i in 1:length(val_spcv4k.pcnm_amphibian)){boyce.val.sp.pcnm_amphibian[[i]] <- 
                    list(my.boyce(val_spcv4k.pcnm_amphibian[[i]][[1]][[2]], val_spcv4k.pcnm_amphibian[[i]][[1]][[1]]),
                        my.boyce(val_spcv4k.pcnm_amphibian[[i]][[2]][[2]], val_spcv4k.pcnm_amphibian[[i]][[2]][[1]]),
                        my.boyce(val_spcv4k.pcnm_amphibian[[i]][[3]][[2]], val_spcv4k.pcnm_amphibian[[i]][[3]][[1]]),
                        my.boyce(val_spcv4k.pcnm_amphibian[[i]][[4]][[2]], val_spcv4k.pcnm_amphibian[[i]][[4]][[1]]))
}
```

df for ggplot2 
```{r}
df.boyce.val.rnd_mammal <- list()
for(i in 1:35){df.boyce.val.rnd_mammal[[i]] <- rbind(data.frame(Hs = boyce.val.rnd_mammal[[i]][[1]]$HS,
                                                            F.ratio = boyce.val.rnd_mammal[[i]][[1]]$F.ratio,
                                                            model = "m1",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val.rnd_mammal[[i]][[2]]$HS,
                                                            F.ratio = boyce.val.rnd_mammal[[i]][[2]]$F.ratio,
                                                            model = "m2",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val.rnd_mammal[[i]][[3]]$HS,
                                                            F.ratio = boyce.val.rnd_mammal[[i]][[3]]$F.ratio,
                                                            model = "m3",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val.rnd_mammal[[i]][[4]]$HS,
                                                            F.ratio = boyce.val.rnd_mammal[[i]][[4]]$F.ratio,
                                                            model = "m4",
                                                            species = data.mammal[[i]]@species))}


df.boyce.val.rnd_mammal2 <- do.call(rbind, df.boyce.val.rnd_mammal)

```





```{r}
df.boyce.val.sp_mammal <- list()
for(i in 1:35){df.boyce.val.sp_mammal[[i]] <- rbind(data.frame(Hs = boyce.val.sp_mammal[[i]][[1]]$HS,
                                                            F.ratio = boyce.val.sp_mammal[[i]][[1]]$F.ratio,
                                                            model = "m1",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val.sp_mammal[[i]][[2]]$HS,
                                                            F.ratio = boyce.val.sp_mammal[[i]][[2]]$F.ratio,
                                                            model = "m2",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val.sp_mammal[[i]][[3]]$HS,
                                                            F.ratio = boyce.val.sp_mammal[[i]][[3]]$F.ratio,
                                                            model = "m3",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val.sp_mammal[[i]][[4]]$HS,
                                                            F.ratio = boyce.val.sp_mammal[[i]][[4]]$F.ratio,
                                                            model = "m4",
                                                            species = data.mammal[[i]]@species))}

for(i in 1:35){df.boyce.val.sp_mammal[[i]] <- rbind(data.frame(Hs = boyce.val.sp_mammal[[i]][[1]]$HS,
                                                            F.ratio = boyce.val.sp_mammal[[i]][[1]]$F.ratio,
                                                            model = "m1",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val.sp_mammal[[i]][[2]]$HS,
                                                            F.ratio = boyce.val.sp_mammal[[i]][[2]]$F.ratio,
                                                            model = "m2",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val.sp_mammal[[i]][[3]]$HS,
                                                            F.ratio = boyce.val.sp_mammal[[i]][[3]]$F.ratio,
                                                            model = "m3",
                                                            species = data.mammal[[i]]@species),
                                                 data.frame(Hs = boyce.val_mammal[[i]][[4]]$HS,
                                                            F.ratio = boyce.val.sp_mammal[[i]][[4]]$F.ratio,
                                                            model = "m4",
                                                            species = data.mammal[[i]]@species))}

df.boyce.val.sp_mammal2 <- do.call(rbind, df.boyce.val.sp_mammal)

```



df for test
```{r}
df.boyce.test.rndsp_mammal <- list()
for(i in 1:35){df.boyce.test.rndsp_mammal[[i]] <- rbind(data.frame(Hs = boyce.test.rnd_mammal[[i]]$HS,
                                                                F.ratio = boyce.test.rnd_mammal[[i]]$F.ratio,
                                                                model = "random",
                                                                species = data.mammal[[i]]@species),
                                                      data.frame(Hs= boyce.test.sp_mammal[[i]]$HS,
                                                               F.ratio = boyce.test.sp_mammal[[i]]$F.ratio,
                                                                model = "spatial",
                                                                species = data.mammal[[i]]@species))
}

df.boyce.test.rndsp_mammal2 <- do.call(rbind, df.boyce.test.rndsp_mammal)         df.boyce.test.rndsp_mammal2[df.boyce.test.rndsp_mammal2$species == "Macritos lagotis",] # stupid lagotis                          
```

df test bioclimate reptile n amphibian 

```{r}
df.boyce.test.rndsp_reptile <- list()
for(i in 1:91){df.boyce.test.rndsp_reptile[[i]] <- rbind(data.frame(Hs = boyce.test.rnd_reptile[[i]]$HS,
                                                                F.ratio = boyce.test.rnd_reptile[[i]]$F.ratio,
                                                                model = "random",
                                                                taxa = "reptile",
                                                                species = model_rndcv4k_reptile[[i]]@data@species),
                                                      data.frame(Hs= boyce.test.sp_reptile[[i]]$HS,
                                                               F.ratio = boyce.test.sp_reptile[[i]]$F.ratio,
                                                                model = "spatial",
                                                                taxa = "reptile",
                                                                species = model_spcv4k_reptile[[i]]@data@species))}

df.boyce.test.rndsp_reptile2 <- do.call(rbind, df.boyce.test.rndsp_reptile)    

df.boyce.test.rndsp_amphibian <- list()
for(i in 1:50){df.boyce.test.rndsp_amphibian[[i]] <- rbind(data.frame(Hs = boyce.test.rnd_amphibian[[i]]$HS,
                                                                F.ratio = boyce.test.rnd_amphibian[[i]]$F.ratio,
                                                                model = "random",
                                                                taxa = "amphibian",
                                                                species = model_rndcv4k_amphibian[[i]]@data@species),
                                                      data.frame(Hs= boyce.test.sp_amphibian[[i]]$HS,
                                                               F.ratio = boyce.test.sp_amphibian[[i]]$F.ratio,
                                                                model = "spatial",
                                                                taxa = "amphibian",
                                                                species = model_spcv4k_amphibian[[i]]@data@species))
}

df.boyce.test.rndsp_amphibian2 <- do.call(rbind, df.boyce.test.rndsp_amphibian)

```




df test PCNM reptile n amphibian

```{r}
df.boyce.test.rndsp.pcnm_reptile <- list()
for(i in 29:65){df.boyce.test.rndsp.pcnm_reptile[[i]] <- rbind(data.frame(Hs = boyce.test.rnd.pcnm_reptile[[i]]$HS,
                                                                F.ratio = boyce.test.rnd.pcnm_reptile[[i]]$F.ratio,
                                                                model = "random",
                                                                taxa = "reptile",
                                                                species = model_rndcv4k.pcnm_reptile[[i]]@data@species),
                                                      data.frame(Hs= boyce.test.sp.pcnm_reptile[[i]]$HS,
                                                               F.ratio = boyce.test.sp.pcnm_reptile[[i]]$F.ratio,
                                                                model = "spatial",
                                                                taxa = "reptile",
                                                                species = model_spcv4k.pcnm_reptile[[i]]@data@species))}

df.boyce.test.rndsp.pcnm_reptile2 <- do.call(rbind, df.boyce.test.rndsp.pcnm_reptile)    

df.boyce.test.rndsp.pcnm_amphibian <- list()
for(i in 14:32){df.boyce.test.rndsp.pcnm_amphibian[[i]] <- rbind(data.frame(Hs = boyce.test.rnd.pcnm_amphibian[[i]]$HS,
                                                                F.ratio = boyce.test.rnd.pcnm_amphibian[[i]]$F.ratio,
                                                                model = "random",
                                                                taxa = "amphibian",
                                                                species = model_rndcv4k.pcnm_amphibian[[i]]@data@species),
                                                      data.frame(Hs= boyce.test.sp.pcnm_amphibian[[i]]$HS,
                                                               F.ratio = boyce.test.sp.pcnm_amphibian[[i]]$F.ratio,
                                                                model = "spatial",
                                                                taxa = "amphibian",
                                                                species = model_spcv4k.pcnm_amphibian[[i]]@data@species))
}

df.boyce.test.rndsp.pcnm_amphibian2 <- do.call(rbind, df.boyce.test.rndsp.pcnm_amphibian)

```

GGPLOT 
RND : BIO vs PCNM :TEST

bio rep 91
bio amp 50
pcnm rep 65
pcnm amp 32



```{r}

unique(df.boyce.test.rndsp_reptile2$species)
unique(df.boyce.test.rndsp.pcnm_reptile2$species)

unique(df.boyce.test.rndsp_amphibian2$species)
unique(df.boyce.test.rndsp.pcnm_amphibian2$species)

a <- vector()
for(i in 1:length(unique(df.boyce.test.rndsp.pcnm_reptile2$species))){
  a[i] <- unique(df.boyce.test.rndsp.pcnm_reptile2$species)[i]
}

b <- list()
for(i in 1:length(a)){
df.boyce.test.rndsp_reptile2 %>% filter(species == a[i]) -> b[[i]]
}

b <- do.call(rbind, b)


c <- vector()
for(i in 1:length(unique(df.boyce.test.rndsp.pcnm_amphibian2$species))){
  c[i] <- unique(df.boyce.test.rndsp.pcnm_amphibian2$species)[i]
}

d <- list()
for(i in 1:length(c)){
df.boyce.test.rndsp_amphibian2 %>% filter(species == c[i]) -> d[[i]]
}

d <- do.call(rbind, d)


which(unique(b$species) != unique(df.boyce.test.rndsp.pcnm_reptile2$species))
which(unique(d$species) != unique(df.boyce.test.rndsp.pcnm_amphibian2$species))
```
b & d got good set 

now all 65, 32


Boyce comparison with SEVM and BIOclimate under RANDOM CV
```{r}
rbind(b %>% filter(model == "random") %>% mutate(variable = "bio"),
      d %>% filter(model == "random") %>% mutate(variable = "bio"),
      df.boyce.test.rndsp.pcnm_reptile2 %>% filter(model == "random") %>% mutate(variable = "PCNM"),
      df.boyce.test.rndsp.pcnm_amphibian2 %>% filter(model == "random") %>% mutate(variable = "PCNM")) %>%
  ggplot(data = .) +
      geom_line(aes(x = Hs, y = F.ratio, color = variable), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Random cv REPTILE and Amphibian)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> plot.boyce.rnd.test.BvP_repamp


```


Boyce comparison with SEVM and BIOclimate under Spatial CV
```{r}
rbind(b %>% filter(model == "spatial") %>% mutate(variable = "bio"),
      d %>% filter(model == "spatial") %>% mutate(variable = "bio"),
      df.boyce.test.rndsp.pcnm_reptile2 %>% filter(model == "spatial") %>% mutate(variable = "PCNM"),
      df.boyce.test.rndsp.pcnm_amphibian2 %>% filter(model == "spatial") %>% mutate(variable = "PCNM")) %>%
  ggplot(data = .) +
      geom_line(aes(x = Hs, y = F.ratio, color = variable), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Spatial cv REPTILE and Amphibian)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> plot.boyce.sp.test.BvP_repamp


```

ALL TOGETHER
```{r}
rbind(b %>% mutate(variable = "bio"),
      d %>% mutate(variable = "bio"),
      df.boyce.test.rndsp.pcnm_reptile2 %>% mutate(variable = "PCNM"),
      df.boyce.test.rndsp.pcnm_amphibian2 %>% mutate(variable = "PCNM")) %>%
  ggplot(data = .) +
      geom_line(aes(x = Hs, y = F.ratio, color = variable, linetype = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(REPTILE and Amphibian)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> plot.boyce.rndsp.test.BvP_repamp


```

ALL TOGETHER - RETPILE
```{r}
rbind(b %>% mutate(variable = "bio"),
      df.boyce.test.rndsp.pcnm_reptile2 %>% mutate(variable = "PCNM")) %>%
  ggplot(data = .) +
      geom_line(aes(x = Hs, y = F.ratio, color = variable, linetype = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Reptile)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> plot.boyce.rndsp.test.BvP_reptile #8, 11,12,16,31,32, 47,51,53

nice.name <- vector()
for(i in c(8, 11,12,17,26,34,35 ,57,59)){
  nice.name[i] <- model_rndcv4k.pcnm_reptile[[i]]@data@species
}
nice.name <- na.omit(nice.name)

nice.df <- list()
for(i in 1:length(nice.name)){
 nice.df[[i]]  <- filter(rbind(b %>% mutate(variable = "bio"),
      df.boyce.test.rndsp.pcnm_reptile2 %>% mutate(variable = "PCNM")), species == nice.name[i])
}
nice.df <- do.call(rbind, nice.df)

ggplot(data = nice.df) +
      geom_line(aes(x = Hs, y = F.ratio, color = variable, linetype = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Reptile)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> plot.boyce.rndsp.test.BvP_reptile.nice


```

ALL TOGETHER - AMPHIBIAN
```{r}
rbind(d %>% mutate(variable = "bio"),
      df.boyce.test.rndsp.pcnm_amphibian2 %>% mutate(variable = "PCNM")) %>%
  ggplot(data = .) +
      geom_line(aes(x = Hs, y = F.ratio, color = variable, linetype = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Amphibian)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> plot.boyce.rndsp.test.BvP_amphibian #2, 3, 5, 7, 8, 12, 19, 21, 26 look nice

nice.name <- vector()
for(i in c(2, 3, 5, 7, 8, 12, 19, 21, 26)){
  nice.name[i] <- model_rndcv4k.pcnm_amphibian[[i]]@data@species
}
nice.name <- na.omit(nice.name)

nice.df <- list()
for(i in 1:length(nice.name)){
 nice.df[[i]]  <- filter(rbind(d %>% mutate(variable = "bio"),
      df.boyce.test.rndsp.pcnm_amphibian2 %>% mutate(variable = "PCNM")), species == nice.name[i])
}
nice.df <- do.call(rbind, nice.df)

ggplot(data = nice.df) +
      geom_line(aes(x = Hs, y = F.ratio, color = variable, linetype = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Amphibian)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> plot.boyce.rndsp.test.BvP_amphibian.nice





```


what if mix rnd and sp
```{r}
rbind(
  mutate(df.boyce.val.rnd_mammal2, cv = "random"), 
  mutate(df.boyce.val.sp_mammal2, cv = "spatial")) %>% 
 ggplot(data = .) +
      geom_smooth(aes(x = Hs, y = F.ratio, color = cv), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Random-Spatial cv mammal)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 11, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> plot.boyce.rndsp.val_mammal

plot.boyce.rndsp.val_mammal
```





```{r}
plot.boyce.rndsp.test.mean_mammal <- ggplot(data = df.boyce.test.rndsp_mammal2[df.boyce.test.rndsp_mammal2$species != "Macrotis lagotis",]) +
      geom_line(aes(x = Hs, y = F.ratio, color = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Random-Spatial cv mammal for Test data)",
           subtitle = "Mean of 4 model",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 11, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white"))

plot.boyce.rndsp.test.mean_mammal
```

PCNM rndsp reptile

```{r}
plot.boyce.rndsp.test.pcnm_reptile <- ggplot(data = df.boyce.test.rndsp.pcnm_reptile2) +
      geom_line(aes(x = Hs, y = F.ratio, color = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Random-Spatial cv REPTILE for Test data)",
           subtitle = "Mean of 4 model, 5 Bioclimate, 14 PCNM",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 11, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white"))

plot.boyce.rndsp.test.pcnm_reptile
```

plot PCNM amphibian

```{r}
plot.boyce.rndsp.test.pcnm_amphibian <- ggplot(data = df.boyce.test.rndsp.pcnm_amphibian2) +
      geom_line(aes(x = Hs, y = F.ratio, color = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Random-Spatial cv amphibian for Test data)",
           subtitle = "Mean of 4 model, 5 Bioclimate, 14 PCNM",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 11, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white"))

plot.boyce.rndsp.test.pcnm_amphibian 

```








```{r}
plot.boyce.rndsp.test.notmean_mammal <- ggplot(data = df.boyce.test.rndsp.notmean_mammal2) +
      geom_smooth(aes(x = Hs, y = F.ratio, color = model), size = 1) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Random-Spatial cv mammal for Test data)",
           y = "출현/기대 비율",
           x = "서식처 적합도") +
      theme_light() +
      theme(strip.text.x = element_text(size = 11, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white"))

plot.boyce.rndsp.test.notmean_mammal
```



```{r} 
#df.boyce.val_mammal2[4692, ] <- NA
#some rows are inf 
```

df for pcnm val plot
```{r}
df.boyce.val.rnd.pcnm_amphibian <- list()
for(i in 1:34){df.boyce.val.rnd.pcnm_amphibian[[i]] <- rbind(data.frame(Hs = boyce.val.rnd.pcnm_amphibian[[i]][[1]]$HS,
                                                            F.ratio = boyce.val.rnd.pcnm_amphibian[[i]][[1]]$F.ratio,
                                                            model = "m1",
                                                            species = data.amphibian[[i]]@species),
                                                 data.frame(Hs = boyce.val.rnd.pcnm_amphibian[[i]][[2]]$HS,
                                                            F.ratio = boyce.val.rnd.pcnm_amphibian[[i]][[2]]$F.ratio,
                                                            model = "m2",
                                                            species = data.amphibian[[i]]@species),
                                                 data.frame(Hs = boyce.val.rnd.pcnm_amphibian[[i]][[3]]$HS,
                                                            F.ratio = boyce.val.rnd.pcnm_amphibian[[i]][[3]]$F.ratio,
                                                            model = "m3",
                                                            species = data.amphibian[[i]]@species),
                                                 data.frame(Hs = boyce.val.rnd.pcnm_amphibian[[i]][[4]]$HS,
                                                            F.ratio = boyce.val.rnd.pcnm_amphibian[[i]][[4]]$F.ratio,
                                                            model = "m4",
                                                            species = data.amphibian[[i]]@species))}



df.boyce.val.rnd.pcnm_amphibian2 <- do.call(rbind, df.boyce.val.rnd.pcnm_amphibian)

```


```{r}
df.boyce.val.sp.pcnm_amphibian <- list()
for(i in 1:30){df.boyce.val.sp.pcnm_amphibian[[i]] <- rbind(data.frame(Hs = boyce.val.sp.pcnm_amphibian[[i]][[1]]$HS,
                                                            F.ratio = boyce.val.sp.pcnm_amphibian[[i]][[1]]$F.ratio,
                                                            model = "m1",
                                                            species = data.amphibian.pcnm[[i]]@species),
                                                 data.frame(Hs = boyce.val.sp.pcnm_amphibian[[i]][[2]]$HS,
                                                            F.ratio = boyce.val.sp.pcnm_amphibian[[i]][[2]]$F.ratio,
                                                            model = "m2",
                                                            species = data.amphibian.pcnm[[i]]@species),
                                                 data.frame(Hs = boyce.val.sp.pcnm_amphibian[[i]][[3]]$HS,
                                                            F.ratio = boyce.val.sp.pcnm_amphibian[[i]][[3]]$F.ratio,
                                                            model = "m3",
                                                            species = data.amphibian.pcnm[[i]]@species),
                                                 data.frame(Hs = boyce.val.sp.pcnm_amphibian[[i]][[4]]$HS,
                                                            F.ratio = boyce.val.sp.pcnm_amphibian[[i]][[4]]$F.ratio,
                                                            model = "m4",
                                                            species = data.amphibian.pcnm[[i]]@species))}



df.boyce.val.sp.pcnm_amphibian2 <- do.call(rbind, df.boyce.val.sp.pcnm_amphibian)
```


```{r}
p1 <- ggplot(data = df.boyce.val_mammal2) +
      geom_line(aes(x = Hs, y = F.ratio, color = model)) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot",
           y = "출현/기대 비율",
           x = "서식처 적합도") +
      theme_light() +
      theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white"))

p1
```

```{r}
plot.boyce.rnd.val_mammal <- ggplot(data = df.boyce.val.rnd_mammal2) +
      
      geom_smooth(aes(x = Hs, y = F.ratio)) +
      geom_hline(yintercept=1, linetype="dashed") +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Random cv mammal)",
           y = "출현/기대 비율",
           x = "서식처 적합도") +
      theme_light() +
      theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white"))

plot.boyce.rnd.val_mammal
```


```{r}
plot.boyce.sp.val_mammal <- ggplot(data = df.boyce.val.sp_mammal2) +
                            geom_line(aes(x = Hs, y = F.ratio, color = model)) +
                            geom_hline(yintercept=1, linetype="dashed") +
                            facet_wrap( ~ species, scale = "free") +
                            labs(title = "Boyce P/E plot with Spatial block cross validation",
                                 y = "출현/기대 비율",
                                 x = "서식처 적합도") +
                            theme_light() +
                            theme(strip.text.x = element_text(size = 8, colour = "black"),
                              strip.background = element_rect(colour="gray",
                                                              fill="white"))

plot.boyce.sp.val_mammal
```


```{r}
plot.boyce.rnd.val.pcnm_amphibian <- ggplot(data = df.boyce.val.rnd.pcnm_amphibian2) +
                            geom_line(aes(x = Hs, y = F.ratio, color = model)) +
                            geom_hline(yintercept=1, linetype="dashed") +
                            facet_wrap( ~ species, scale = "free") +
                            labs(title = "Boyce P/E plot with Spatial block cross validation",
                                 y = "출현/기대 비율",
                                 x = "서식처 적합도") +
                            theme_light() +
                            theme(strip.text.x = element_text(size = 8, colour = "black"),
                              strip.background = element_rect(colour="gray",
                                                              fill="white"))

plot.boyce.rnd.val.pcnm_amphibian
```


```{r}
plot.boyce.sp.val.pcnm_amphibian <- ggplot(data = df.boyce.val.sp.pcnm_amphibian2) +
                            geom_line(aes(x = Hs, y = F.ratio, color = model)) +
                            geom_hline(yintercept=1, linetype="dashed") +
                            facet_wrap( ~ species, scale = "free") +
                            labs(title = "Boyce P/E plot with Spatial block cross validation",
                                 y = "출현/기대 비율",
                                 x = "서식처 적합도") +
                            theme_light() +
                            theme(strip.text.x = element_text(size = 8, colour = "black"),
                              strip.background = element_rect(colour="gray",
                                                              fill="white"))

plot.boyce.sp.val.pcnm_amphibian
```
```{r}
test_spcv4k.pcnm_amphibian <- list()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
test_spcv4k.pcnm_amphibian[[i]] <- list(SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]], 
                                                  t.t.amphibian_0.2.test[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]],
                                 t.t.amphibian_0.2.test[[i]][[2]]@data[t.t.amphibian_0.2.test[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))} #전부다는 [[1]]에, 출현은 [[2]]에
```

```{r}
t.t.amphibian_0.2.test <- t.t.amphibian_0.2.test[-10]
t.t.amphibian_0.2.test <- t.t.amphibian_0.2.test[-22]

```



```{r}
a <- pocplot(pred = poc.df_rndcv4k_mammal[[1]][[2]], 
             back = poc.df_rndcv4k_mammal[[1]][[1]], 
             title="(a) Model 2", filename="figs/forfun.png", linearize=FALSE)
```



```{r}
ggsave("mammal_boyce.png", p1, width = 50, height = 25, dpi = 200, limitsize = F)
ggsave("boyce.sp.val_mammal2.png", plot.boyce.sp.val_mammal, width = 50, height = 25, dpi = 200, limitsize = F)
ggsave("plot.boyce.rndsp.val_mammal.png", plot.boyce.rndsp.val_mammal, width = 50, height = 25, dpi = 200, limitsize = F)
ggsave("plot.boyce.rndsp.test.mean_mammal.png", plot.boyce.rndsp.test_mammal, width = 50, height = 25, dpi = 200, limitsize = F)
ggsave("plot.boyce.rndsp.test.notmean_mammal.png", plot.boyce.rndsp.test.notmean_mammal, width = 50, height = 25, dpi = 200, limitsize = F)
ggsave("plot.boyce.rnd.test.BvP_repamp.png", plot.boyce.rnd.test.BvP_repamp, width = 50, height = 25, dpi = 200, limitsize = F)
ggsave("plot.boyce.rndsp.test.BvP_repamp.png", plot.boyce.rndsp.test.BvP_repamp, width = 25, height = 12, dpi = 200, limitsize = F)
ggsave("plot.boyce.rndsp.test.BvP_reptile.png", plot.boyce.rndsp.test.BvP_reptile, width = 25, height = 12, dpi = 200, limitsize = F)
ggsave("plot.boyce.rndsp.test.BvP_amphibian.png", plot.boyce.rndsp.test.BvP_amphibian, width = 25, height = 12, dpi = 200, limitsize = F)

```

#AUC comparison 

```{r}
AUC_rnd.val.mammal <- vector()
for(i in 1:35){
AUC_rnd.val.mammal[i] <- SDMtune::auc(model = model_rndcv4k_mammal[[i]], test = TRUE)
}

AUC_sp.val.mammal <- vector()
for(i in 1:35){
AUC_sp.val.mammal[i] <- SDMtune::auc(model = model_spcv4k_mammal[[i]], test = TRUE)
}
```

AUC for test 
```{r}
AUC_rnd.test.reptile <- vector()
for(i in 1:length(model_rndcv4k_reptile)){
AUC_rnd.test.reptile[i] <- SDMtune::auc(model = model_rndcv4k_reptile[[i]], test = t.t.reptile_0.2[[i]][[2]])
}

AUC_rnd.test.amphibian <- vector()
for(i in 1:length(model_rndcv4k_amphibian)){
AUC_rnd.test.amphibian[i] <- SDMtune::auc(model = model_rndcv4k_amphibian[[i]], test = t.t.amphibian_0.2[[i]][[2]])
}

AUC_sp.test.reptile <- vector()
for(i in 1:length(model_spcv4k_reptile)){
AUC_sp.test.reptile[i] <- SDMtune::auc(model = model_spcv4k_reptile[[i]], test = t.t.reptile_0.2[[i]][[2]])
}
```
```{r}
AUC_sp.test.amphibian <- vector()
for(i in 1:length(model_spcv4k_amphibian)){
AUC_sp.test.amphibian[i] <- SDMtune::auc(model = model_spcv4k_amphibian[[i]], test = t.t.amphibian_0.2[[i]][[2]])
}

AUC_rnd.test.pcnm.reptile <- vector()
for(i in 1:length(model_rndcv4k.pcnm_reptile)){
AUC_rnd.test.pcnm.reptile[i] <- SDMtune::auc(model = model_rndcv4k.pcnm_reptile[[i]], test = t.t.pcnm.reptile_0.2[[i]][[2]])
}

AUC_rnd.test.pcnm.amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
AUC_rnd.test.pcnm.amphibian[i] <- SDMtune::auc(model = model_rndcv4k.pcnm_amphibian[[i]], test = t.t.pcnm.amphibian_0.2[[i]][[2]])
}

AUC_sp.test.pcnm.reptile <- vector()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
AUC_sp.test.pcnm.reptile[i] <- SDMtune::auc(model = model_spcv4k.pcnm_reptile[[i]], test = t.t.pcnm.reptile_0.2[[i]][[2]])
}

AUC_sp.test.pcnm.amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
AUC_sp.test.pcnm.amphibian[i] <- SDMtune::auc(model = model_spcv4k.pcnm_amphibian[[i]], test = t.t.pcnm.amphibian_0.2[[i]][[2]])
}


```



plot AUCs... 1. speceis col name
```{r}
name.model_rndcv4k_reptile <- vector()
for(i in 1:length(model_rndcv4k_reptile)){
  name.model_rndcv4k_reptile[i] <- model_rndcv4k_reptile[[i]]@data@species
}

name.model_rndcv4k_amphibian <- vector()
for(i in 1:length(model_rndcv4k_amphibian)){
  name.model_rndcv4k_amphibian[i] <- model_rndcv4k_amphibian[[i]]@data@species
}

name.model_spcv4k_reptile <- vector()
for(i in 1:length(model_spcv4k_reptile)){
  name.model_spcv4k_reptile[i] <- model_spcv4k_reptile[[i]]@data@species
}

name.model_spcv4k_amphibian <- vector()
for(i in 1:length(model_spcv4k_amphibian)){
  name.model_spcv4k_amphibian[i] <- model_spcv4k_amphibian[[i]]@data@species
}

name.model_rndcv4k.pcnm_reptile <- vector()
for(i in 1:length(model_rndcv4k.pcnm_reptile)){
  name.model_rndcv4k.pcnm_reptile[i] <- model_rndcv4k.pcnm_reptile[[i]]@data@species
}

name.model_rndcv4k.pcnm_amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
  name.model_rndcv4k.pcnm_amphibian[i] <- model_rndcv4k.pcnm_amphibian[[i]]@data@species
}

name.model_spcv4k.pcnm_reptile <- vector()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
  name.model_spcv4k.pcnm_reptile[i] <- model_spcv4k.pcnm_reptile[[i]]@data@species
}

name.model_spcv4k.pcnm_amphibian <- vector()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
  name.model_spcv4k.pcnm_amphibian[i] <- model_spcv4k.pcnm_amphibian[[i]]@data@species
}

```

bio name
```{r}
name.model_rndcv4k_reptile <- vector()
for(i in 1:length(model_rndcv4k_reptile)){
  name.model_rndcv4k_reptile[i] <- model_rndcv4k.bio_reptile[[i]]@data@species
}

name.model_rndcv4k_amphibian <- vector()
for(i in 1:length(model_rndcv4k_amphibian)){
  name.model_rndcv4k_amphibian[i] <- model_rndcv4k.bio_amphibian[[i]]@data@species
}

name.model_spcv4k_reptile <- vector()
for(i in 1:length(model_spcv4k_reptile)){
  name.model_spcv4k_reptile[i] <- model_spcv4k.bio_reptile[[i]]@data@species
}

name.model_spcv4k_amphibian <- vector()
for(i in 1:length(model_spcv4k_amphibian)){
  name.model_spcv4k_amphibian[i] <- model_spcv4k.bio_amphibian[[i]]@data@species
}
```


plot trained AUCs
```{r}

rbind(data.frame(AUC_bio = AUC_rnd.train.bio.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k_reptile,
           variable = "bio"),
      data.frame(AUC_bio = AUC_rnd.train.bio.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k_amphibian,
           variable = "bio"),
      data.frame(AUC_bio = AUC_sp.train.bio.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k_reptile,
           variable = "bio"),
      data.frame(AUC_bio = AUC_sp.train.bio.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k_amphibian,
           variable = "bio")) -> a #nrow 282

rbind(data.frame(AUC_PCNM = AUC_rnd.train.pcnm.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(AUC_PCNM = AUC_rnd.train.pcnm.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k.pcnm_amphibian,
           variable = "PCNM"),
      data.frame(AUC_PCNM = AUC_sp.train.pcnm.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(AUC_PCNM = AUC_sp.train.pcnm.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k.pcnm_amphibian,
           variable = "PCNM")) -> b #nrow 194


d <- vector()
for(i in 1:length(unique(b$species))){
  d[i] <- unique(b$species)[i] #필요한 학명들
}

e <- list()
for(i in 1:length(d)){
  e[[i]] <- a %>% dplyr::filter(species == d[i]) #a중 b학명과 겹치는 것들 하나씩 e에 넣음 
}

e <- do.call(rbind, e) #e 것들을 전부 결합. a중 b와 이름이 같은 애들을 뭉침
e <- e[order(e$cv),] #b와 같은 정렬



df.AUC <- data.frame(AUC_bio = e$AUC_bio,
                     AUC_PCNM = b$AUC_PCNM,
                     cv = e$cv,
                     taxa = e$taxa,
                     species = e$species)

  ggplot(data = df.AUC) +
      geom_point(aes(x = AUC_bio, y = AUC_PCNM, color = cv, shape = taxa, size = 2)) +
      geom_hline(yintercept=0.5, linetype="dashed") +
      geom_vline(xintercept=0.5, linetype="dashed") +
       geom_abline(intercept = 0, slope = 1, size = 0.5) +
      labs(title = "AUC comparison",
           subtitle = "regularization = 1",
           y = "AUC with PCNM variables",
           x = "AUC with bioclimate PCNM variables") +
      theme_light() +
      theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> test



```

```{r}

rbind(data.frame(AUC_bio = AUC_rnd.test.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k_reptile,
           variable = "bio"),
      data.frame(AUC_bio = AUC_rnd.test.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k_amphibian,
           variable = "bio"),
      data.frame(AUC_bio = AUC_sp.test.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k_reptile,
           variable = "bio"),
      data.frame(AUC_bio = AUC_sp.test.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k_amphibian,
           variable = "bio")) -> a #nrow 282

rbind(data.frame(AUC_PCNM = AUC_rnd.test.pcnm.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(AUC_PCNM = AUC_rnd.test.pcnm.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k.pcnm_amphibian,
           variable = "PCNM"),
      data.frame(AUC_PCNM = AUC_sp.test.pcnm.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(AUC_PCNM = AUC_sp.test.pcnm.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k.pcnm_amphibian,
           variable = "PCNM")) -> b #nrow 194


d <- vector()
for(i in 1:length(unique(b$species))){
  d[i] <- unique(b$species)[i] #필요한 학명들
}

e <- list()
for(i in 1:length(d)){
  e[[i]] <- a %>% dplyr::filter(species == d[i]) #a중 b학명과 겹치는 것들 하나씩 e에 넣음 
}

e <- do.call(rbind, e) #e 것들을 전부 결합. a중 b와 이름이 같은 애들을 뭉침
e <- e[order(e$cv),] #b와 같은 정렬



df.AUC <- data.frame(AUC_bio = e$AUC_bio,
                     AUC_PCNM = b$AUC_PCNM,
                     cv = e$cv,
                     taxa = e$taxa,
                     species = e$species)

  ggplot(data = df.AUC) +
      geom_point(aes(x = AUC_bio, y = AUC_PCNM, color = cv, shape = taxa, size = 2)) +
      geom_hline(yintercept=0.5, linetype="dashed") +
      geom_vline(xintercept=0.5, linetype="dashed") +
       geom_abline(intercept = 0, slope = 1, size = 0.5) +
      labs(title = "AUC comparison",
           subtitle = "regularization = 1",
           y = "AUC with PCNM variables",
           x = "AUC with bioclimate variables") +
      theme_light() +
      theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> test



```



```{r without PCNM}

AUC_sp.amphibian <- vector()
for(i in 1:length(model_spcv4k_amphibian)){
AUC_sp.amphibian[i] <- SDMtune::auc(model = model_spcv4k_amphibian[[i]], t.t.amphibian_0.2[[i]][[2]])  
}

```



```{r with PCNM}
AUC_sp.pcnm.amphibian <- vector()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
  AUC_sp.pcnm.amphibian[i] <- SDMtune::auc(model = model_spcv4k.pcnm_amphibian[[i]], t.t.amphibian_0.2.test[[i]][[2]])
}

```

```{r cut to direct comparison} 
AUC_sp.amphibian[-c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] -> AUC_sp.amphibian
AUC_sp.amphibian[-c(11, 21, 25)] -> AUC_sp.amphibian
AUC_sp.amphibian <- AUC_sp.amphibian[-10] 
AUC_sp.amphibian <- AUC_sp.amphibian[-22] 
```

```{r}
AUC_sp.amphibian
AUC_sp.pcnm.amphibian
```

TSS?

TSS for test 
```{r}
TSS_rnd.test.reptile <- vector()
for(i in 1:length(model_rndcv4k_reptile)){
TSS_rnd.test.reptile[i] <- SDMtune::tss(model = model_rndcv4k_reptile[[i]], test = t.t.reptile_0.2[[i]][[2]])
}

TSS_rnd.test.amphibian <- vector()
for(i in 1:length(model_rndcv4k_amphibian)){
TSS_rnd.test.amphibian[i] <- SDMtune::tss(model = model_rndcv4k_amphibian[[i]], test = t.t.amphibian_0.2[[i]][[2]])
}

TSS_sp.test.reptile <- vector()
for(i in 1:length(model_spcv4k_reptile)){
TSS_sp.test.reptile[i] <- SDMtune::tss(model = model_spcv4k_reptile[[i]], test = t.t.reptile_0.2[[i]][[2]])
}

TSS_sp.test.amphibian <- vector()
for(i in 1:length(model_spcv4k_amphibian)){
TSS_sp.test.amphibian[i] <- SDMtune::tss(model = model_spcv4k_amphibian[[i]], test = t.t.amphibian_0.2[[i]][[2]])
}

```

```{r}

TSS_rnd.test.pcnm.reptile <- vector()
for(i in 1:length(model_rndcv4k.pcnm_reptile)){
TSS_rnd.test.pcnm.reptile[i] <- SDMtune::tss(model = model_rndcv4k.pcnm_reptile[[i]], test = t.t.pcnm.reptile_0.2[[i]][[2]])
}

TSS_rnd.test.pcnm.amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
TSS_rnd.test.pcnm.amphibian[i] <- SDMtune::tss(model = model_rndcv4k.pcnm_amphibian[[i]], test = t.t.pcnm.amphibian_0.2[[i]][[2]])
}

TSS_sp.test.pcnm.reptile <- vector()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
TSS_sp.test.pcnm.reptile[i] <- SDMtune::tss(model = model_spcv4k.pcnm_reptile[[i]], test = t.t.pcnm.reptile_0.2[[i]][[2]])
}

TSS_sp.test.pcnm.amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
TSS_sp.test.pcnm.amphibian[i] <- SDMtune::tss(model = model_spcv4k.pcnm_amphibian[[i]], test = t.t.pcnm.amphibian_0.2[[i]][[2]])
}


```



plot TSSs... 1. speceis col name
```{r}
name.model_rndcv4k_reptile <- vector()
for(i in 1:length(model_rndcv4k_reptile)){
  name.model_rndcv4k_reptile[i] <- model_rndcv4k_reptile[[i]]@data@species
}

name.model_rndcv4k_amphibian <- vector()
for(i in 1:length(model_rndcv4k_amphibian)){
  name.model_rndcv4k_amphibian[i] <- model_rndcv4k_amphibian[[i]]@data@species
}

name.model_spcv4k_reptile <- vector()
for(i in 1:length(model_spcv4k_reptile)){
  name.model_spcv4k_reptile[i] <- model_spcv4k_reptile[[i]]@data@species
}

name.model_spcv4k_amphibian <- vector()
for(i in 1:length(model_spcv4k_amphibian)){
  name.model_spcv4k_amphibian[i] <- model_spcv4k_amphibian[[i]]@data@species
}

name.model_rndcv4k.pcnm_reptile <- vector()
for(i in 1:length(model_rndcv4k.pcnm_reptile)){
  name.model_rndcv4k.pcnm_reptile[i] <- model_rndcv4k.pcnm_reptile[[i]]@data@species
}

name.model_rndcv4k.pcnm_amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
  name.model_rndcv4k.pcnm_amphibian[i] <- model_rndcv4k.pcnm_amphibian[[i]]@data@species
}

name.model_spcv4k.pcnm_reptile <- vector()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
  name.model_spcv4k.pcnm_reptile[i] <- model_spcv4k.pcnm_reptile[[i]]@data@species
}

name.model_spcv4k.pcnm_amphibian <- vector()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
  name.model_spcv4k.pcnm_amphibian[i] <- model_spcv4k.pcnm_amphibian[[i]]@data@species
}

```


plot TSSs
```{r}

rbind(data.frame(TSS_bio = TSS_rnd.test.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k_reptile,
           variable = "bio"),
      data.frame(TSS_bio = TSS_rnd.test.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k_amphibian,
           variable = "bio"),
      data.frame(TSS_bio = TSS_sp.test.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k_reptile,
           variable = "bio"),
      data.frame(TSS_bio = TSS_sp.test.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k_amphibian,
           variable = "bio")) -> a #nrow 282

rbind(data.frame(TSS_PCNM = TSS_rnd.test.pcnm.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(TSS_PCNM = TSS_rnd.test.pcnm.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k.pcnm_amphibian,
           variable = "PCNM"),
      data.frame(TSS_PCNM = TSS_sp.test.pcnm.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(TSS_PCNM = TSS_sp.test.pcnm.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k.pcnm_amphibian,
           variable = "PCNM")) -> b #nrow 194


d <- vector()
for(i in 1:length(unique(b$species))){
  d[i] <- unique(b$species)[i] #필요한 학명들
}

e <- list()
for(i in 1:length(d)){
  e[[i]] <- a %>% dplyr::filter(species == d[i]) #a중 b학명과 겹치는 것들 하나씩 e에 넣음 
}

e <- do.call(rbind, e) #e 것들을 전부 결합. a중 b와 이름이 같은 애들을 뭉침
e <- e[order(e$cv),] #b와 같은 정렬



df.TSS <- data.frame(TSS_bio = e$TSS_bio,
                     TSS_PCNM = b$TSS_PCNM,
                     cv = e$cv,
                     taxa = e$taxa,
                     species = e$species)

  ggplot(data = df.TSS) +
      geom_point(aes(x = TSS_bio, y = TSS_PCNM, color = cv, shape = taxa, size = 2)) +
      geom_hline(yintercept=0.5, linetype="dashed") +
      geom_vline(xintercept=0.5, linetype="dashed") +
       geom_abline(intercept = 0, slope = 1, size = 0.5) +
      labs(title = "TSS comparison",
           subtitle = "regularization = 1",
           y = "TSS with PCNM variables",
           x = "TSS with bioclimate variables") +
      theme_light() +
      theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> test



```





```{r without PCNM}

TSS_sp.amphibian <- vector()
for(i in 1:length(model_spcv4k_amphibian)){
TSS_sp.amphibian[i] <- SDMtune::tss(model = model_spcv4k_amphibian[[i]], t.t.amphibian_0.2[[i]][[2]])  
}

```



```{r with PCNM}
TSS_sp.pcnm.amphibian <- vector()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
  TSS_sp.pcnm.amphibian[i] <- SDMtune::tss(model = model_spcv4k.pcnm_amphibian[[i]], t.t.amphibian_0.2.test[[i]][[2]])
}

```

```{r cut to direct comparison} 
TSS_sp.amphibian[-c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] -> TSS_sp.amphibian
TSS_sp.amphibian[-c(11, 21, 25)] -> TSS_sp.amphibian
TSS_sp.amphibian <- TSS_sp.amphibian[-10] 
TSS_sp.amphibian <- TSS_sp.amphibian[-22] 
```

```{r}
TSS_sp.amphibian
TSS_sp.pcnm.amphibian
```






DRAW Boyce index

```{r}


BOYCE_rnd.test.reptile <- vector()
for(i in 1:length(boyce.test.rnd_reptile)){
 BOYCE_rnd.test.reptile[i] <- boyce.test.rnd_reptile[[i]]$Spearman.cor  
}

BOYCE_rnd.test.amphibian <- vector()
for(i in 1:length(boyce.test.rnd_amphibian)){
 BOYCE_rnd.test.amphibian[i] <- boyce.test.rnd_amphibian[[i]]$Spearman.cor  
}

BOYCE_sp.test.reptile <- vector()
for(i in 1:length(boyce.test.sp_reptile)){
 BOYCE_sp.test.reptile[i] <- boyce.test.sp_reptile[[i]]$Spearman.cor  
}

BOYCE_sp.test.amphibian <- vector()
for(i in 1:length(boyce.test.sp_amphibian)){
 BOYCE_sp.test.amphibian[i] <- boyce.test.sp_amphibian[[i]]$Spearman.cor  
}

BOYCE_rnd.test.pcnm.reptile <- vector()
for(i in 29:length(boyce.test.rnd.pcnm_reptile)){
 BOYCE_rnd.test.pcnm.reptile[i] <- boyce.test.rnd.pcnm_reptile[[i]]$Spearman.cor  
}

BOYCE_rnd.test.pcnm.amphibian <- vector()
for(i in 14:length(boyce.test.rnd.pcnm_amphibian)){
 BOYCE_rnd.test.pcnm.amphibian[i] <- boyce.test.rnd.pcnm_amphibian[[i]]$Spearman.cor  
}

BOYCE_sp.test.pcnm.reptile <- vector()
for(i in 1:length(boyce.test.sp.pcnm_reptile)){
 BOYCE_sp.test.pcnm.reptile[i] <- boyce.test.sp.pcnm_reptile[[i]]$Spearman.cor  
}

BOYCE_sp.test.pcnm.amphibian <- vector()
for(i in 1:length(boyce.test.sp.pcnm_amphibian)){
 BOYCE_sp.test.pcnm.amphibian[i] <- boyce.test.sp.pcnm_amphibian[[i]]$Spearman.cor  
}


```


plot BOYCEs
```{r}

rbind(data.frame(BOYCE_bio = BOYCE_rnd.test.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k_reptile,
           variable = "bio"),
      data.frame(BOYCE_bio = BOYCE_rnd.test.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k_amphibian,
           variable = "bio"),
      data.frame(BOYCE_bio = BOYCE_sp.test.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k_reptile,
           variable = "bio"),
      data.frame(BOYCE_bio = BOYCE_sp.test.amphibian[-4],
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k_amphibian[-4],
           variable = "bio")) -> a #nrow 282

rbind(data.frame(BOYCE_PCNM = BOYCE_rnd.test.pcnm.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(BOYCE_PCNM = BOYCE_rnd.test.pcnm.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k.pcnm_amphibian,
           variable = "PCNM"),
      data.frame(BOYCE_PCNM = BOYCE_sp.test.pcnm.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(BOYCE_PCNM = BOYCE_sp.test.pcnm.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k.pcnm_amphibian,
           variable = "PCNM")) -> b #nrow 194


d <- vector()
for(i in 1:length(unique(b$species))){
  d[i] <- unique(b$species)[i] #필요한 학명들
}

e <- list()
for(i in 1:length(d)){
  e[[i]] <- a %>% dplyr::filter(species == d[i]) #a중 b학명과 겹치는 것들 하나씩 e에 넣음 
}

e <- do.call(rbind, e) #e 것들을 전부 결합. a중 b와 이름이 같은 애들을 뭉침
e <- e[order(e$cv),] #b와 같은 정렬

eb <- rbind(e,b)

df.BOYCE <- data.frame(BOYCE = eb$BOYCE, #for point plot
                     cv = eb$cv,
                     taxa = eb$taxa,
                     variable = eb$variable,
                     species = eb$species)

df.BOYCE <- data.frame(BOYCE_bio = e$BOYCE_bio,
                     BOYCE_PCNM = b$BOYCE_PCNM,
                     cv = e$cv,
                     taxa = e$taxa,
                     species = e$species)

 ggplot(data = filter(df.BOYCE, taxa == "reptile")) +
      geom_point(aes(x = cv, y = BOYCE, color = variable), size = 1) +
      geom_path(aes(x = cv, y = BOYCE, colour = variable, group = variable)) +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Model transferability of reptile species",
           subtitle = "More parallel slope, More transferable",
           y = "Boyce index",
           x = "Cross-validation",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> transfer.BOYCE #for point plot

  ggplot(data = filter(df.BOYCE, taxa == "amphibian")) +
      geom_point(aes(x = cv, y = BOYCE, color = variable), size = 1) +
      geom_path(aes(x = cv, y = BOYCE, colour = variable, group = variable)) +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Model transferability of amphibian species",
           subtitle = "More parallel slope, More transferable",
           y = "Boyce index",
           x = "Cross-validation",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> transfer.BOYCE #for point plot


df.BOYCE.bio.sp <- filter(df.BOYCE, variable == "bio", cv == "spatial")
df.BOYCE.bio.rnd <- filter(df.BOYCE, variable == "bio", cv == "random")
df.BOYCE.pcnm.sp <- filter(df.BOYCE, variable == "PCNM", cv == "spatial")
df.BOYCE.pcnm.rnd <- filter(df.BOYCE, variable == "PCNM", cv == "random")

length(which((df.BOYCE.bio.rnd$BOYCE - df.BOYCE.bio.sp$BOYCE) > (df.BOYCE.pcnm.rnd$BOYCE - df.BOYCE.pcnm.sp$BOYCE))) #46
length(which((df.BOYCE.bio.rnd$BOYCE - df.BOYCE.bio.sp$BOYCE) < (df.BOYCE.pcnm.rnd$BOYCE - df.BOYCE.pcnm.sp$BOYCE))) #49

  ggplot(data = df.BOYCE) +
      geom_point(aes(x = BOYCE_bio, y = BOYCE_PCNM, color = cv, shape = taxa, size = 2)) +
      geom_hline(yintercept=0.5, linetype="dashed") +
      geom_vline(xintercept=0.5, linetype="dashed") +
       geom_abline(intercept = 0, slope = 1, size = 0.5) +
      labs(title = "BOYCE comparison",
           y = "BOYCE with PCNM variables",
           x = "BOYCE with bioclimate variables") +
      theme_light() +
      theme(strip.text.x = element_text(size = 8, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> test



```





```{r}
BOYCE_sp.amphibian <- vector()
for(i in 1:length(boyce_test.sp_amphibian)){
  BOYCE_sp.amphibian[i] <- boyce_test.sp_amphibian[[i]]$Spearman.cor
}

  
  
  BOYCE_sp.pcnm.amphibian <- vector()
for(i in 1:length(boyce_test.sp.pcnm_amphibian)){
  BOYCE_sp.pcnm.amphibian[i] <- boyce_test.sp.pcnm_amphibian[[i]]$Spearman.cor}
```

```{r cut for direct comparison}
BOYCE_sp.amphibian[-c(5,9,10,23,25,26,27,29,31,33,34,42,44,45,49)] -> BOYCE_sp.amphibian
BOYCE_sp.amphibian[-c(11, 21, 25)] -> BOYCE_sp.amphibian
BOYCE_sp.amphibian <- BOYCE_sp.amphibian[-10] 
BOYCE_sp.amphibian <- BOYCE_sp.amphibian[-22] 
```

```{r}
BOYCE_sp.amphibian
BOYCE_sp.pcnm.amphibian
```







```{r}
source("pocplots.R")
pocplot <- function(pred, back, linearize=TRUE, ...) {
  ispresence <- c(rep(1,length(pred)), rep(0, length(back)))
  predd <- smoothdist(c(pred,back), ispresence)
  c <- mean(back)*length(back)/length(pred)
  if (linearize) {
    fun <- function(x,y) c*y / (1-y)
    predd$y <- mapply(fun, predd$x, predd$y)
    predd$se <- mapply(fun, predd$x, predd$se)
    ideal <- function(x) x
    ylab <- "Relative probability of presence" 
  } 
  else {
    ideal <- function(x) x / (x + c)
    ylab <- "Probability of presence"
  }
  calibplot(predd, negrug=back, posrug=pred, ideal=ideal, ylab=ylab,
    capuci = FALSE, ...)
  predd
}

```

DRAW POC plot
```{r}

poc.test.rnd_reptile <- list()
for(i in 1:length(test_rndcv4k_reptile)){
poc.test.rnd_reptile[[i]] <- pocplot(test_rndcv4k_reptile[[i]][[2]], test_rndcv4k_reptile[[i]][[3]])}

poc.test.rnd.pcnm_reptile <- list()
for(i in 1:length(test_rndcv4k.pcnm_reptile)){
poc.test.rnd.pcnm_reptile[[i]] <- pocplot(test_rndcv4k.pcnm_reptile[[i]][[2]], test_rndcv4k.pcnm_reptile[[i]][[3]])}
```


```{r}
SDMtune::plotResponse(model_rndcv4k_reptile[[1]], var = "wc2.1_30s_bio_01", type = "logistic")

# Acquire environmental variables
files <- list.files(path = file.path(system.file(package = "dismo"), "ex"),
                    pattern = "grd", full.names = TRUE)
predictors <- raster::stack(files)

# Prepare presence and background locations
p_coords <- virtualSp$presence
bg_coords <- virtualSp$background

# Create SWD object
data <- prepareSWD(species = "Virtual species", p = p_coords, a = bg_coords,
                   env = predictors, categorical = "biome")

# Train a model
model <- train(method = "Maxnet", data = data, fc = "lq")

# Plot cloglog response curve for a continuous environmental variable (bio1)
plotResponse(model, var = "bio2", type = "cloglog")

# Plot marginal cloglog response curve for a continuous environmental
# variable (bio1)
plotResponse(model, var = "bio1", type = "cloglog", marginal = TRUE)

# Plot logistic response curve for a continuous environmental variable
# (bio12) adding the rugs and giving a custom color
plotResponse(model, var = "bio12", type = "logistic", rug = TRUE,
             color = "blue")

# Plot response curve for a categorical environmental variable (biome) giving
# a custom color
plotResponse(model, var = "biome", type = "logistic", color = "green")

# Train a model with cross validation
folds <- randomFolds(data, k = 4, only_presence = TRUE)
model <- train(method = "Maxnet", data = data, fc = "lq", folds = folds)

# Plot cloglog response curve for a continuous environmental variable (bio17)
plotResponse(model, var = "bio1", type = "cloglog")

# Plot logistic response curve for a categorical environmental variable
# (biome) giving a custom color
plotResponse(model, var = "biome", type = "logistic", color = "green")


```



transferability
Draw AUCs


```{r}
rbind(data.frame(AUC = AUC_rnd.test.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k_reptile,
           variable = "bio"),
      data.frame(AUC = AUC_rnd.test.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k_amphibian,
           variable = "bio"),
      data.frame(AUC = AUC_sp.test.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k_reptile,
           variable = "bio"),
      data.frame(AUC = AUC_sp.test.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k_amphibian,
           variable = "bio")) -> a #nrow 282

rbind(data.frame(AUC = AUC_rnd.test.pcnm.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(AUC = AUC_rnd.test.pcnm.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k.pcnm_amphibian,
           variable = "PCNM"),
      data.frame(AUC = AUC_sp.test.pcnm.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(AUC = AUC_sp.test.pcnm.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k.pcnm_amphibian,
           variable = "PCNM")) -> b #nrow 194

rbind(data.frame(AUC = AUC_rnd.train.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k_reptile,
           variable = "bio"),
      data.frame(AUC = AUC_rnd.train.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k_amphibian,
           variable = "bio"),
      data.frame(AUC = AUC_sp.train.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k_reptile,
           variable = "bio"),
      data.frame(AUC = AUC_sp.train.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k_amphibian,
           variable = "bio")) -> x #nrow 282

rbind(data.frame(AUC = AUC_rnd.train.pcnm.reptile,
           cv = "random",
           taxa = "reptile",
           species = name.model_rndcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(AUC = AUC_rnd.train.pcnm.amphibian,
           cv = "random",
           taxa = "amphibian",
           species = name.model_rndcv4k.pcnm_amphibian,
           variable = "PCNM"),
      data.frame(AUC = AUC_sp.train.pcnm.reptile,
           cv = "spatial",
           taxa = "reptile",
           species = name.model_spcv4k.pcnm_reptile,
           variable = "PCNM"),
      data.frame(AUC = AUC_sp.train.pcnm.amphibian,
           cv = "spatial",
           taxa = "amphibian",
           species = name.model_spcv4k.pcnm_amphibian,
           variable = "PCNM")) -> y #nrow 194

#a282 b194 x282 y194

d <- vector()
for(i in 1:length(unique(b$species))){
  d[i] <- unique(b$species)[i] #필요한 학명들
}

e <- list()
for(i in 1:length(d)){
  e[[i]] <- a %>% dplyr::filter(species == d[i]) #a중 b학명과 겹치는 것들 하나씩 e에 넣음 
}

e <- do.call(rbind, e) #e 것들을 전부 결합. a중 b와 이름이 같은 애들을 뭉침
e <- e[order(e$cv),] #b와 같은 정렬



eb <- rbind(e,b) 



df.AUC <- data.frame(AUC = eb$AUC,
                     cv = eb$cv,
                     taxa = eb$taxa,
                     variable = eb$variable,
                     species = eb$species)

 ggplot(data = filter(df.AUC, taxa == "reptile")) +
      geom_point(aes(x = cv, y = AUC, color = variable), size = 1) +
      geom_path(aes(x = cv, y = AUC, colour = variable, group = variable)) +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Model transferability of reptile species",
           subtitle = "More parallel slope, More transferable",
           y = "AUC",
           x = "Cross-validation",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> transfer.AUC
 
  ggplot(data = filter(df.AUC, taxa == "amphibian")) +
      geom_point(aes(x = cv, y = AUC, color = variable), size = 1) +
      geom_path(aes(x = cv, y = AUC, colour = variable, group = variable)) +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Model transferability of amphibian species",
           subtitle = "More parallel slope, More transferable",
           y = "AUC",
           x = "Cross-validation",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> transfer.AUC
 
 
df.AUC.bio.sp <- filter(df.AUC, variable == "bio", cv == "spatial")
df.AUC.bio.rnd <- filter(df.AUC, variable == "bio", cv == "random")
df.AUC.pcnm.sp <- filter(df.AUC, variable == "PCNM", cv == "spatial")
df.AUC.pcnm.rnd <- filter(df.AUC, variable == "PCNM", cv == "random")

length(which((df.AUC.bio.rnd$AUC - df.AUC.bio.sp$AUC) > (df.AUC.pcnm.rnd$AUC - df.AUC.pcnm.sp$AUC))) #44
length(which((df.AUC.bio.rnd$AUC - df.AUC.bio.sp$AUC) < (df.AUC.pcnm.rnd$AUC - df.AUC.pcnm.sp$AUC))) #53
```










```{r}
# where to use???????
rbind(
data.frame(AUC = AUC_rnd.test.reptile,
           cv = "random",
           tt = "test",
           taxa = "reptile",
           variable = "bioclimate",
           id = "AUC_rnd.test.bioclimate.reptile"),
data.frame(AUC = AUC_rnd.test.amphibian,
           cv = "random",
           tt = "test",
           taxa = "amphibian",
           variable = "bioclimate",
           id = "AUC_rnd.test.bioclimate.amphibian"),
data.frame(AUC = AUC_rnd.test.pcnm.reptile,
           cv = "random",
           tt = "test",
           taxa = "reptile",
           variable = "pcnm",
           id = "AUC_rnd.test.pcnm.reptile"),
data.frame(AUC = AUC_rnd.test.pcnm.amphibian,
           cv = "random",
           tt = "test",
           taxa = "amphibian",
           variable = "pcnm",
           id = "AUC_rnd.test.pcnm.amphibian"),
data.frame(AUC = AUC_sp.test.reptile,
           cv = "spatial",
           tt = "test",
           taxa = "reptile",
           variable = "bioclimate",
           id = "AUC_sp.test.bioclimate.reptile"),
data.frame(AUC = AUC_sp.test.amphibian,
           cv = "spatial",
           tt = "test",
           taxa = "amphibian",
           variable = "bioclimate",
           id = "AUC_sp.test.bioclimate.amphibian"),
data.frame(AUC = AUC_sp.test.pcnm.reptile,
           cv = "spatial",
           tt = "test",
           taxa = "reptile",
           variable = "pcnm",
           id = "AUC_sp.test.pcnm.reptile"),
data.frame(AUC = AUC_sp.test.pcnm.amphibian,
           cv = "spatial",
           tt = "test",
           taxa = "amphibian",
           variable = "pcnm", 
           id = "AUC_sp.test.pcnm.amphibian"),
data.frame(AUC = AUC_rnd.train.reptile,
           cv = "random",
           tt = "train",
           taxa = "reptile",
           variable = "bioclimate",
           id = "AUC_rnd.train.bioclimate.reptile"),
data.frame(AUC = AUC_rnd.train.amphibian,
           cv = "random",
           tt = "train",
           taxa = "amphibian",
           variable = "bioclimate",
           id = "AUC_rnd.train.bioclimate.amphibian"),
data.frame(AUC = AUC_rnd.train.pcnm.reptile,
           cv = "random",
           tt = "train",
           taxa = "reptile",
           variable = "pcnm",
           id = "AUC_rnd.train.pcnm.reptile"),
data.frame(AUC = AUC_rnd.train.pcnm.amphibian,
           cv = "random",
           tt = "train",
           taxa = "amphibian",
           variable = "pcnm",
           id = "AUC_rnd.train.pcnm.amphibian"),
data.frame(AUC = AUC_sp.train.pcnm.reptile,
           cv = "spatial",
           tt = "train",
           taxa = "reptile",
           variable = "pcnm",
           id = "AUC_sp.train.pcnm.reptile"),
data.frame(AUC = AUC_sp.train.pcnm.amphibian,
           cv = "spatial",
           tt = "train",
           taxa = "amphibian",
           variable = "pcnm",
           id = "AUC_sp.train.pcnm.amphibian"),
data.frame(AUC = AUC_sp.train.reptile,
           cv = "spatial",
           tt = "train",
           taxa = "reptile",
           variable = "bioclimate",
           id = "AUC_sp.train.bioclimate.reptile"),
data.frame(AUC = AUC_sp.train.amphibian,
           cv = "spatial",
           tt = "train",
           taxa = "amphibian",
           variable = "bioclimate",
           id = "AUC_sp.train.bioclimate.amphibian")) -> df.AUC 


 ggplot(data = df.AUC) +
      geom_point(data = filter(df.AUC, tt == "train"),  aes(x = tt, y = AUC, color = variable), size = 1) +
      geom_point(data = filter(df.AUC, tt == "test", cv =="random"), aes(x = cv, y = AUC, color = variable), size = 1) +
      facet_wrap( ~ species, scale = "free") +
      labs(title = "Boyce P/E plot(Random cv REPTILE and Amphibian)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white"))



```




Boyce box plot

```{r}
ggplot(df.BOYCE) + 
  geom_boxplot(aes(x = cv, y = BOYCE_bio)) + 
  theme(axis.text.x = element_text(angle=65, vjust=0.6)) + 
  labs(title="Box plot", 
       subtitle="City Mileage grouped by Class of vehicle",
       x="A",
       y="B")
```













AUC for train

```{r}
AUC_rnd.train.reptile <- vector()
for(i in 1:length(model_rndcv4k_reptile)){
AUC_rnd.train.reptile[i] <- SDMtune::auc(model = model_rndcv4k_reptile[[i]])
}

AUC_rnd.train.amphibian <- vector()
for(i in 1:length(model_rndcv4k_amphibian)){
AUC_rnd.train.amphibian[i] <- SDMtune::auc(model = model_rndcv4k_amphibian[[i]])
}

AUC_sp.train.reptile <- vector()
for(i in 1:length(model_spcv4k_reptile)){
AUC_sp.train.reptile[i] <- SDMtune::auc(model = model_spcv4k_reptile[[i]])
}

AUC_sp.train.amphibian <- vector()
for(i in 1:length(model_spcv4k_amphibian)){
AUC_sp.train.amphibian[i] <- SDMtune::auc(model = model_spcv4k_amphibian[[i]])
}

AUC_rnd.train.pcnm.reptile <- vector()
for(i in 1:length(model_rndcv4k.pcnm_reptile)){
AUC_rnd.train.pcnm.reptile[i] <- SDMtune::auc(model = model_rndcv4k.pcnm_reptile[[i]])
}

AUC_rnd.train.pcnm.amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
AUC_rnd.train.pcnm.amphibian[i] <- SDMtune::auc(model = model_rndcv4k.pcnm_amphibian[[i]])
}

AUC_sp.train.pcnm.reptile <- vector()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
AUC_sp.train.pcnm.reptile[i] <- SDMtune::auc(model = model_spcv4k.pcnm_reptile[[i]])
}

AUC_sp.train.pcnm.amphibian <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
AUC_sp.train.pcnm.amphibian[i] <- SDMtune::auc(model = model_spcv4k.pcnm_amphibian[[i]])
}


```

# PLOT.MEORW

load model n go

```{r}
model_rndcv4k_reptile
model_rndcv4k.bio_reptile
model_rndcv4k.pcnm_reptile

bio.species <- vector()
for(i in 1:length(model_rndcv4k.bio_reptile)){
bio.species[i] <- model_rndcv4k.bio_reptile[[i]]@data@species}

pcnm.species <- vector()
for(i in 1:length(model_rndcv4k.pcnm_reptile)){
pcnm.species[i] <- model_rndcv4k.pcnm_reptile[[i]]@data@species
}

which(bio.species %in% pcnm.species)

model_rndcv4k.bio_reptile[which(bio.species %in% pcnm.species)] -> model_rndcv4k.bio_reptile


#amph

bio.species <- vector()
for(i in 1:length(model_rndcv4k.bio_amphibian)){
bio.species[i] <- model_rndcv4k.bio_amphibian[[i]]@data@species}

pcnm.species <- vector()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
pcnm.species[i] <- model_rndcv4k.pcnm_amphibian[[i]]@data@species
}

which(bio.species %in% pcnm.species)

model_rndcv4k.bio_amphibian[which(bio.species %in% pcnm.species)] -> model_rndcv4k.bio_amphibian

#reptile SPATIAL

bio.species <- vector()
for(i in 1:length(model_spcv4k.bio_reptile)){
bio.species[i] <- model_spcv4k.bio_reptile[[i]]@data@species}

pcnm.species <- vector()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
pcnm.species[i] <- model_spcv4k.pcnm_reptile[[i]]@data@species
}

which(bio.species %in% pcnm.species)

model_spcv4k.bio_reptile[which(bio.species %in% pcnm.species)] -> model_spcv4k.bio_reptile


#amph SPATIAL

bio.species <- vector()
for(i in 1:length(model_spcv4k.bio_amphibian)){
bio.species[i] <- model_spcv4k.bio_amphibian[[i]]@data@species}

pcnm.species <- vector()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
pcnm.species[i] <- model_spcv4k.pcnm_amphibian[[i]]@data@species
}

which(bio.species %in% pcnm.species)

model_spcv4k.bio_amphibian[which(bio.species %in% pcnm.species)] -> model_spcv4k.bio_amphibian



```





raw output

## RAW. RND. BIO
```{r raw_train_rndcv mean, BIO}
raw_rndcv4k.bio_reptile <- list()
for(i in 1:length(model_rndcv4k.bio_reptile)){
raw_rndcv4k.bio_reptile[[i]] <- list(SDMtune::predict(model_rndcv4k.bio_reptile[[i]], 
                                                  model_rndcv4k.bio_reptile[[i]]@data@data[model_rndcv4k.bio_reptile[[i]]@data@pa==0,],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                     SDMtune::predict(model_rndcv4k.bio_reptile[[i]],
                                     model_rndcv4k.bio_reptile[[i]]@data@data[model_rndcv4k.bio_reptile[[i]]@data@pa==1,],
                                                       fun = "mean",
                                                       type = "cloglog")
                                )} #배경은 [[1]]에, 출현은 [[2]]에 

raw_rndcv4k_bio.amphibian <- list()
for(i in 1:length(model_rndcv4k.bio_amphibian)){
raw_rndcv4k_bio.amphibian[[i]] <- list(SDMtune::predict(model_rndcv4k.bio_amphibian[[i]], 
                                                  model_rndcv4k.bio_amphibian[[i]]@data@data[model_rndcv4k.bio_amphibian[[i]]@data@pa==0,],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                     SDMtune::predict(model_rndcv4k.bio_amphibian[[i]],
                                     model_rndcv4k.bio_amphibian[[i]]@data@data[model_rndcv4k.bio_amphibian[[i]]@data@pa==1,],
                                                       fun = "mean",
                                                       type = "cloglog")
                                )} #배경은 [[1]]에, 출현은 [[2]]에

```
## RAW. SPATIAL. BIO
```{r raw_train_spcv mean, BIO}
raw_spcv4k.bio_reptile <- list()
for(i in 1:length(model_spcv4k.bio_reptile)){
raw_spcv4k.bio_reptile[[i]] <- list(SDMtune::predict(model_spcv4k.bio_reptile[[i]], 
                                                  model_spcv4k.bio_reptile[[i]]@data@data[model_spcv4k.bio_reptile[[i]]@data@pa==0,],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                     SDMtune::predict(model_spcv4k.bio_reptile[[i]],
                                     model_spcv4k.bio_reptile[[i]]@data@data[model_spcv4k.bio_reptile[[i]]@data@pa==1,],
                                                       fun = "mean",
                                                       type = "cloglog")
                                )} #배경은 [[1]]에, 출현은 [[2]]에 

raw_spcv4k_bio.amphibian <- list()
for(i in 1:length(model_spcv4k.bio_amphibian)){
raw_spcv4k_bio.amphibian[[i]] <- list(SDMtune::predict(model_spcv4k.bio_amphibian[[i]], 
                                                  model_spcv4k.bio_amphibian[[i]]@data@data[model_spcv4k.bio_amphibian[[i]]@data@pa==0,],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                     SDMtune::predict(model_spcv4k.bio_amphibian[[i]],
                                     model_spcv4k.bio_amphibian[[i]]@data@data[model_spcv4k.bio_amphibian[[i]]@data@pa==1,],
                                                       fun = "mean",
                                                       type = "cloglog")
                                )} #배경은 [[1]]에, 출현은 [[2]]에

```

# RAW. RND. PCNM
```{r test_rndcv mean, PCNM}
raw_rndcv4k.pcnm_reptile <- list()
for(i in 1:length(model_rndcv4k.pcnm_reptile)){
raw_rndcv4k.pcnm_reptile[[i]] <- list(SDMtune::predict(model_rndcv4k.pcnm_reptile[[i]], 
                                                  model_rndcv4k.pcnm_reptile[[i]]@data@data[model_rndcv4k.pcnm_reptile[[i]]@data@pa==0,],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                     SDMtune::predict(model_rndcv4k.pcnm_reptile[[i]],
                                     model_rndcv4k.pcnm_reptile[[i]]@data@data[model_rndcv4k.pcnm_reptile[[i]]@data@pa==1,],
                                                       fun = "mean",
                                                       type = "cloglog")
                                )} #배경은 [[1]]에, 출현은 [[2]]에 28번째 모형에서 에러발생!

raw_rndcv4k.pcnm_amphibian <- list()
for(i in 14:length(model_rndcv4k.pcnm_amphibian)){
raw_rndcv4k.pcnm_amphibian[[i]] <- list(SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]], 
                                                  model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@data@pa==0,],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                     SDMtune::predict(model_rndcv4k.pcnm_amphibian[[i]],
                                     model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@data@pa==1,],
                                                       fun = "mean",
                                                       type = "cloglog")
                                )} #배경은 [[1]]에, 출현은 [[2]]에
```
# RAW. SPATIAL. PCNM
```{r test_rndcv mean, PCNM}
raw_spcv4k.pcnm_reptile <- list()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
raw_spcv4k.pcnm_reptile[[i]] <- list(SDMtune::predict(model_spcv4k.pcnm_reptile[[i]], 
                                                  model_spcv4k.pcnm_reptile[[i]]@data@data[model_spcv4k.pcnm_reptile[[i]]@data@pa==0,],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                     SDMtune::predict(model_spcv4k.pcnm_reptile[[i]],
                                     model_spcv4k.pcnm_reptile[[i]]@data@data[model_spcv4k.pcnm_reptile[[i]]@data@pa==1,],
                                                       fun = "mean",
                                                       type = "cloglog")
                                )} #배경은 [[1]]에, 출현은 [[2]]에 28번째 모형에서 에러발생!

raw_spcv4k.pcnm_amphibian <- list()
for(i in 5:length(model_spcv4k.pcnm_amphibian)){
raw_spcv4k.pcnm_amphibian[[i]] <- list(SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]], 
                                                  model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@data@pa==0,],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                     SDMtune::predict(model_spcv4k.pcnm_amphibian[[i]],
                                     model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@data@pa==1,],
                                                       fun = "mean",
                                                       type = "cloglog")
                                )} #배경은 [[1]]에, 출현은 [[2]]에
```

# RAW. RND. PCNM no fix
```{r test_rndcv mean, PCNM}
raw_rndcv4k.pcnm.nofix_reptile <- list()
for(i in 1:length(model_rndcv4k_reptile)){
raw_rndcv4k.pcnm.nofix_reptile[[i]] <- list(SDMtune::predict(model_rndcv4k_reptile[[i]], 
                                                  model_rndcv4k_reptile[[i]]@data@data[model_rndcv4k_reptile[[i]]@data@pa==0,],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                     SDMtune::predict(model_rndcv4k_reptile[[i]],
                                     model_rndcv4k_reptile[[i]]@data@data[model_rndcv4k_reptile[[i]]@data@pa==1,],
                                                       fun = "mean",
                                                       type = "cloglog")
                                )} #배경은 [[1]]에, 출현은 [[2]]에

raw_rndcv4k.pcnm.nofix_amphibian <- list()
for(i in 1:length(model_rndcv4k_amphibian)){
raw_rndcv4k.pcnm.nofix_amphibian[[i]] <- list(SDMtune::predict(model_rndcv4k_amphibian[[i]], 
                                                  model_rndcv4k_amphibian[[i]]@data@data[model_rndcv4k_amphibian[[i]]@data@pa==0,],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                     SDMtune::predict(model_rndcv4k_amphibian[[i]],
                                     model_rndcv4k_amphibian[[i]]@data@data[model_rndcv4k_amphibian[[i]]@data@pa==1,],
                                                       fun = "mean",
                                                       type = "cloglog")
                                )} #배경은 [[1]]에, 출현은 [[2]]에
```

# RAW. SPATIAL. PCNM
```{r test_rndcv mean, PCNM}
raw_spcv4k.pcnm.nofix_reptile <- list()
for(i in 1:length(model_spcv4k_reptile)){
raw_spcv4k.pcnm.nofix_reptile[[i]] <- list(SDMtune::predict(model_spcv4k_reptile[[i]], 
                                                  model_spcv4k_reptile[[i]]@data@data[model_spcv4k_reptile[[i]]@data@pa==0,],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                     SDMtune::predict(model_spcv4k_reptile[[i]],
                                     model_spcv4k_reptile[[i]]@data@data[model_spcv4k_reptile[[i]]@data@pa==1,],
                                                       fun = "mean",
                                                       type = "cloglog")
                                )} #배경은 [[1]]에, 출현은 [[2]]에

raw_spcv4k.pcnm.nofix_amphibian <- list()
for(i in 1:length(model_spcv4k_amphibian)){
raw_spcv4k.pcnm.nofix_amphibian[[i]] <- list(SDMtune::predict(model_spcv4k_amphibian[[i]], 
                                                  model_spcv4k_amphibian[[i]]@data@data[model_spcv4k_amphibian[[i]]@data@pa==0,],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                     SDMtune::predict(model_spcv4k_amphibian[[i]],
                                     model_spcv4k_amphibian[[i]]@data@data[model_spcv4k_amphibian[[i]]@data@pa==1,],
                                                       fun = "mean",
                                                       type = "cloglog")
)}
```




```{r}
# RANDOM PCNM
names.variables.rndcv4k.pcnm_reptile <- list()
for(i in 1:length(model_rndcv4k.pcnm_reptile)){
names.variables.rndcv4k.pcnm_reptile[[i]] <- names(model_rndcv4k.pcnm_reptile[[i]]@data@data)  
}

for(i in 1:length(names.variables.rndcv4k.pcnm_reptile)){
  names.variables.rndcv4k.pcnm_reptile[[i]][names.variables.rndcv4k.pcnm_reptile[[i]] %in% c("PCNM1", "PCNM2", "PCNM3", "PCNM4", "PCNM5", "PCNM6", "PCNM7", "PCNM8", "PCNM9")] <- c("PCNM01", "PCNM02", "PCNM03", "PCNM04", "PCNM05", "PCNM06", "PCNM07", "PCNM08", "PCNM09")
}

names.variables.rndcv4k.pcnm_amphibian <- list()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
names.variables.rndcv4k.pcnm_amphibian[[i]] <- names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)  
}

for(i in 1:length(names.variables.rndcv4k.pcnm_amphibian)){
  names.variables.rndcv4k.pcnm_amphibian[[i]][names.variables.rndcv4k.pcnm_amphibian[[i]] %in% c("PCNM1", "PCNM2", "PCNM3", "PCNM4", "PCNM5", "PCNM6", "PCNM7", "PCNM8", "PCNM9")] <- c("PCNM01", "PCNM02", "PCNM03", "PCNM04", "PCNM05", "PCNM06", "PCNM07", "PCNM08", "PCNM09")
}


# SPATIAL PCNM
names.variables.spcv4k.pcnm_reptile <- list()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
names.variables.spcv4k.pcnm_reptile[[i]] <- names(model_spcv4k.pcnm_reptile[[i]]@data@data)  
}

for(i in 1:length(names.variables.spcv4k.pcnm_reptile)){
  names.variables.spcv4k.pcnm_reptile[[i]][names.variables.spcv4k.pcnm_reptile[[i]] %in% c("PCNM1", "PCNM2", "PCNM3", "PCNM4", "PCNM5", "PCNM6", "PCNM7", "PCNM8", "PCNM9")] <- c("PCNM01", "PCNM02", "PCNM03", "PCNM04", "PCNM05", "PCNM06", "PCNM07", "PCNM08", "PCNM09")
}

names.variables.spcv4k.pcnm_amphibian <- list()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
names.variables.spcv4k.pcnm_amphibian[[i]] <- names(model_spcv4k.pcnm_amphibian[[i]]@data@data)  
}

for(i in 1:length(names.variables.spcv4k.pcnm_amphibian)){
  names.variables.spcv4k.pcnm_amphibian[[i]][names.variables.spcv4k.pcnm_amphibian[[i]] %in% c("PCNM1", "PCNM2", "PCNM3", "PCNM4", "PCNM5", "PCNM6", "PCNM7", "PCNM8", "PCNM9")] <- c("PCNM01", "PCNM02", "PCNM03", "PCNM04", "PCNM05", "PCNM06", "PCNM07", "PCNM08", "PCNM09")
}


```

```{r}
RESPONSE.rndcv4k.bio_reptile <- list()
for(i in 1:length(model_rndcv4k.bio_reptile)){
  RESPONSE.rndcv4k.bio_reptile[[i]] <- 
                        list(my.plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[1], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[2], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[3], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[4], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[5], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[6], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[7], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[8], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[9], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[10], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[11], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[12], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[13], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[14], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[15], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[16], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[17], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[18], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_reptile[[i]], var = names(model_rndcv4k.bio_reptile[[i]]@data@data)[19], type = "cloglog"))}

RESPONSE.rndcv4k.bio_amphibian <- list()
for(i in 1:length(model_rndcv4k.bio_amphibian)){
  RESPONSE.rndcv4k.bio_amphibian[[i]] <- 
                        list(SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[1], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[2], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[3], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[4], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[5], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[6], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[7], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[8], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[9], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[10], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[11], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[12], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[13], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[14], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[15], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[16], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[17], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[18], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.bio_amphibian[[i]], var = names(model_rndcv4k.bio_amphibian[[i]]@data@data)[19], type = "cloglog"))}
                             
```

```{r}
SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[2], type = "cloglog")
```


```{r}
RESPONSE.rndcv4k.nofix_reptile <- list()
for(i in 1:length(model_rndcv4k_reptile)){
  RESPONSE.rndcv4k.nofix_reptile[[i]] <- 
                        list(SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[1], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[2], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[3], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[4], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[5], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[6], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[7], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[8], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[9], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[10], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[11], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[12], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[13], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[14], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[15], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[16], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[17], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[18], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_reptile[[i]], var = names(model_rndcv4k_reptile[[i]]@data@data)[19], type = "cloglog"))}

RESPONSE.rndcv4k_amphibian <- list()
for(i in 1:length(model_rndcv4k_amphibian)){
  RESPONSE.rndcv4k_amphibian[[i]] <- 
                        list(SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[1], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[2], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[3], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[4], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[5], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[6], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[7], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[8], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[9], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[10], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[11], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[12], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[13], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[14], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[15], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[16], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[17], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[18], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k_amphibian[[i]], var = names(model_rndcv4k_amphibian[[i]]@data@data)[19], type = "cloglog"))}
                             
```


```{r}
RESPONSE.rndcv4k.pcnm_reptile <- list()
for(i in 48:length(model_rndcv4k.pcnm_reptile)){
  RESPONSE.rndcv4k.pcnm_reptile[[i]] <- 
                        list(SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[1]),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[2], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[3], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[4], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[5], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[6], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[7], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[8], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[9], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[10], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[11], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[12], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[13], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[14], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[15], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[16], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[17], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[18], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_reptile[[i]], var = names(model_rndcv4k.pcnm_reptile[[i]]@data@data)[19], type = "cloglog"))}

RESPONSE.rndcv4k.pcnm_amphibian <- list()
for(i in 14:length(model_rndcv4k.pcnm_amphibian)){
  RESPONSE.rndcv4k.pcnm_amphibian[[i]] <- 
                        list(SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[1], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[2], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[3], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[4], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[5], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[6], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[7], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[8], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[9], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[10], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[11], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[12], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[13], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[14], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[15], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[16], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[17], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[18], type = "cloglog"),
                             SDMtune::plotResponse(model_rndcv4k.pcnm_amphibian[[i]], var = names(model_rndcv4k.pcnm_amphibian[[i]]@data@data)[19], type = "cloglog"))}
                             
```



왜 특정 종에서는 PCNM 변수가 AUC, TSS, Boyce 증가를 불러오는가?
특정 종에서는 Boyce 그래프가 오히려 더 예쁘게 나오는 경우가 존재한다!
왜 그렇지?
그리고 왜 대부분은 그렇지 못했는가?
이 결과의 매커니즘은 무엇인가?


범인 찾기.
1. AUC와 TSS, Boyce의 공식
1-1. Response curve 분포
2. 지도 상 분포와 밀집도 
3. 




How response curve built?
        





```{r}

df.merow <- list()
for(j in 29:length(model_rndcv4k.pcnm_reptile)){

df.var <- list()
for(i in 1:19){
  rbind(data.frame(type = "0",
                y = raw_rndcv4k.pcnm_reptile[[j]][[1]],
                x = model_rndcv4k.pcnm_reptile[[j]]@data@data[model_rndcv4k.pcnm_reptile[[j]]@data@pa==0,i],
                var = names.variables.rndcv4k.pcnm_reptile[[j]][i]),
     data.frame(type = "1",
                y = raw_rndcv4k.pcnm_reptile[[j]][[2]],
                x = model_rndcv4k.pcnm_reptile[[j]]@data@data[model_rndcv4k.pcnm_reptile[[j]]@data@pa==1,i],
                var = names.variables.rndcv4k.pcnm_reptile[[j]][i]),
     data.frame(type = "RC",
                y = RESPONSE.rndcv4k.pcnm_reptile[[j]][[i]]$data$y, #1st speceis 1st variables
                x = RESPONSE.rndcv4k.pcnm_reptile[[j]][[i]]$data$x,
                var = names.variables.rndcv4k.pcnm_reptile[[j]][i])) -> df.var[[i]]} 

df.merow[[j]] <- do.call(rbind, df.var)}

plot.merow.title <- list()
for(i in 1:length(plot.merow)){
  plot.merow.title[[i]] <- paste0("Model output from training presence/background points and response curve of *", model_rndcv4k.pcnm_reptile[[i]]@data@species,"*")
}

plot.merow <- list()
for(i in 1:length(model_rndcv4k.pcnm_reptile)){plot.merow[[i]] <- df.merow[[i]] %>%
ggplot2::ggplot(aes(x = x, y = y)
                ) +
  facet_wrap( ~ var, scale = "free") +
  geom_smooth(alpha = 0.2, method = "loess", aes(color = type)) +
  labs(x = "variable value", 
       y = "raw model output",
       title = plot.merow.title[[i]]) +
  theme_light() +
  theme(legend.title = element_text(size = 15),
        legend.text = element_text(size = 13, colour = "black"),
        legend.key = element_rect(fill = "white", color = "white"),
        legend.position = c(0.9, 0.15),
        strip.text.x = element_text(size = 10, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white"),
        plot.title = element_markdown(size = 18, vjust = 2, margin = margin(t = 4, r = 4, b = 4,l = 4)) 
  ) + 
  scale_color_discrete(name = "data type", labels = c("background", "presence", "response curve"))
}

df <- expand.grid(X1 = 1:10, X2 = 1:10)
df$value <- df$X1 * df$X2

p1 <- ggplot(df, aes(X1, X2)) + geom_tile(aes(fill = value))
p2 <- p1 + labs(x = "variable value", 
       y = "raw model output",
       title = plot.merow.title[[i]]) + 
  geom_point(aes(size = value)) + 
  theme_light() +
  theme(legend.title = element_text(size = 12),
        legend.text = element_text(size = 10, colour = "black"),
        legend.key = element_rect(fill = "#ffffFF", colour = "gray"),
        strip.text.x = element_text(size = 10, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white"),
        plot.title = element_markdown(size = 14, vjust = 5, margin = margin(t = 20, r = 20, b = 20, l = 20)) 
  )

for(i in 1:length(plot.merow)){
ggsave(plot.merow[[i]], filename = paste0("plot/response/",model_rndcv4k.pcnm_reptile[[i]]@data@species,"_RESPONSE.png"), scale = 2, width = 24, height = 16, units = "cm", dpi = 200, limitsize = F)}


ggsave(plot.merow[[1]], filename = paste0("plot/response/",model_rndcv4k.pcnm_reptile[[i]]@data@species,"_RESPONSE.png"),  scale = 2, width = 24, height = 16, units = "cm", dpi = 200, limitsize = F)
```

```{r df.boxplot.pred}
df.boxplot.pred <- list()
for(i in 29:length(raw_rndcv4k.pcnm_reptile)){
rbind(
data.frame(data.type = "PCNM Background",
           CV = "rnd",
           var.type = "PCNM",
           pred = raw_rndcv4k.pcnm_reptile[[i]][[1]]),
data.frame(data.type = "PCNM Presence",
           CV = "rnd",
           var.type = "PCNM",
           pred = raw_rndcv4k.pcnm_reptile[[i]][[2]]),
data.frame(data.type = "Bioclimate Background",
           CV = "rnd",
           var.type = "Bioclimate",
           pred = raw_rndcv4k.bio_reptile[[i]][[1]]),
data.frame(data.type = "Bioclimate Presence",
           CV = "rnd",
           var.type = "Bioclimate",
           pred = raw_rndcv4k.bio_reptile[[i]][[2]]),
data.frame(data.type = "PCNM Background",
           CV = "sp",
           var.type = "PCNM",
           pred = raw_spcv4k.pcnm_reptile[[i]][[1]]),
data.frame(data.type = "PCNM Presence",
           CV = "sp",
           var.type = "PCNM",
           pred = raw_spcv4k.pcnm_reptile[[i]][[2]]),
data.frame(data.type = "Bioclimate Background",
           CV = "sp",
           var.type = "Bioclimate",
           pred = raw_spcv4k.bio_reptile[[i]][[1]]),
data.frame(data.type = "Bioclimate Presence",
           CV = "sp",
           var.type = "Bioclimate",
           pred = raw_spcv4k.bio_reptile[[i]][[2]]),
data.frame(data.type = "PCNM.nofix Background",
           CV = "rnd",
           var.type = "PCNM nofix",
           pred = raw_rndcv4k.pcnm.nofix_reptile[[i]][[1]]),
data.frame(data.type = "PCNM.nofix Presence",
           CV = "rnd",
           var.type = "PCNM nofix",
           pred = raw_rndcv4k.pcnm.nofix_reptile[[i]][[2]]),
data.frame(data.type = "PCNM.nofix Background",
           CV = "sp",
           var.type = "PCNM nofix",
           pred = raw_spcv4k.pcnm.nofix_reptile[[i]][[1]]),
data.frame(data.type = "PCNM.nofix Presence",
           CV = "sp",
           var.type = "PCNM nofix",
           pred = raw_spcv4k.pcnm.nofix_reptile[[i]][[2]])) -> df.boxplot.pred[[i]]}



plot.box.pred <- list()
for(i in 1:length(df.boxplot.pred)){
  ggplot(df.boxplot.pred[[i]]) + 
  geom_boxplot(aes(x = data.type, y = pred, fill = var.type)) + 
  theme_light() +
  theme(strip.text.x = element_text(size = 9, colour = "black"),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        strip.background = element_rect(colour="gray",
                                        fill="white")) + 
  labs(title= paste0("Prediction to training data ",model_rndcv4k.pcnm_reptile[[i]]@data@species), 
       x="Data type",
       y="Prediction(cloglog)") + 
  facet_wrap(~ CV) -> plot.box.pred[[i]]}

for(i in 29:length(plot.box.pred)){
ggsave(filename = paste0(model_rndcv4k.pcnm_reptile[[i]]@data@species,".png") , plot = plot.box.pred[[i]], device = "png", path = "plot/plot.box.pred/")}
```

descriptive stat
```{r}
mean.PCNM.b <- vector()
for(i in 29:length(df.boxplot.pred)){
mean(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Background",
                   CV == "rnd")[,4]) -> mean.PCNM.b[i]}

mean.PCNM.p <- vector()
for(i in 29:length(df.boxplot.pred)){
mean(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Presence",
                   CV == "rnd")[,4]) -> mean.PCNM.p[i]}

mean.PCNM_nofix.b <- vector()
for(i in 29:length(df.boxplot.pred)){
mean(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Background",
                   CV == "rnd")[,4]) -> mean.PCNM_nofix.b[i]}

mean.PCNM_nofix.p <- vector()
for(i in 29:length(df.boxplot.pred)){
mean(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Presence",
                   CV == "rnd")[,4]) -> mean.PCNM_nofix.p[i]}

mean.bioclimate.b <- vector()  
for(i in 29:length(df.boxplot.pred)){
mean(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Background",
                   CV == "rnd")[,4]) -> mean.bioclimate.b[i]}

mean.bioclimate.p <- vector()  
for(i in 29:length(df.boxplot.pred)){
mean(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Presence",
                   CV == "rnd")[,4]) -> mean.bioclimate.p[i]}



mean(na.omit(mean.bioclimate.b))
mean(na.omit(mean.bioclimate.p))

mean(na.omit(mean.PCNM.b))
mean(na.omit(mean.PCNM.p))

mean(na.omit(mean.PCNM_nofix.b))
mean(na.omit(mean.PCNM_nofix.p))


#SD
sd.PCNM.b <- vector()
for(i in 29:length(df.boxplot.pred)){
sd(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Background",
                   CV == "rnd")[,4]) -> sd.PCNM.b[i]}

sd.PCNM.p <- vector()
for(i in 29:length(df.boxplot.pred)){
sd(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Presence",
                   CV == "rnd")[,4]) -> sd.PCNM.p[i]}

sd.PCNM_nofix.b <- vector()
for(i in 29:length(df.boxplot.pred)){
sd(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Background",
                   CV == "rnd")[,4]) -> sd.PCNM_nofix.b[i]}

sd.PCNM_nofix.p <- vector()
for(i in 29:length(df.boxplot.pred)){
sd(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Presence",
                   CV == "rnd")[,4]) -> sd.PCNM_nofix.p[i]}

sd.bioclimate.b <- vector()  
for(i in 29:length(df.boxplot.pred)){
sd(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Background",
                   CV == "rnd")[,4]) -> sd.bioclimate.b[i]}

sd.bioclimate.p <- vector()  
for(i in 29:length(df.boxplot.pred)){
sd(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Presence",
                   CV == "rnd")[,4]) -> sd.bioclimate.p[i]}



mean(na.omit(sd.bioclimate.b))
mean(na.omit(sd.bioclimate.p))

mean(na.omit(sd.PCNM.b))
mean(na.omit(sd.PCNM.p))

mean(na.omit(sd.PCNM_nofix.b))
mean(na.omit(sd.PCNM_nofix.p))

# median

median.PCNM.b <- vector()
for(i in 1:length(df.boxplot.pred)){
median(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Background",
                   CV == "rnd")[,4]) -> median.PCNM.b[i]}

median.PCNM.p <- vector()
for(i in 29:length(df.boxplot.pred)){
median(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Presence",
                   CV == "rnd")[,4]) -> median.PCNM.p[i]}

median.PCNM_nofix.b <- vector()
for(i in 29:length(df.boxplot.pred)){
median(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Background",
                   CV == "rnd")[,4]) -> median.PCNM_nofix.b[i]}

median.PCNM_nofix.p <- vector()
for(i in 29:length(df.boxplot.pred)){
median(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Presence",
                   CV == "rnd")[,4]) -> median.PCNM_nofix.p[i]}

median.bioclimate.b <- vector()  
for(i in 29:length(df.boxplot.pred)){
median(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Background",
                   CV == "rnd")[,4]) -> median.bioclimate.b[i]}

median.bioclimate.p <- vector()  
for(i in 29:length(df.boxplot.pred)){
median(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Presence",
                   CV == "rnd")[,4]) -> median.bioclimate.p[i]}



mean(na.omit(median.bioclimate.b))
mean(na.omit(median.bioclimate.p))

mean(na.omit(median.PCNM.b))
mean(na.omit(median.PCNM.p))

mean(na.omit(median.PCNM_nofix.b))
mean(na.omit(median.PCNM_nofix.p))

#min

min.PCNM.b <- vector()
for(i in 29:length(df.boxplot.pred)){
min(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Background",
                   CV == "rnd")[,4]) -> min.PCNM.b[i]}

min.PCNM.p <- vector()
for(i in 29:length(df.boxplot.pred)){
min(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Presence",
                   CV == "rnd")[,4]) -> min.PCNM.p[i]}

min.PCNM_nofix.b <- vector()
for(i in 29:length(df.boxplot.pred)){
min(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Background",
                   CV == "rnd")[,4]) -> min.PCNM_nofix.b[i]}

min.PCNM_nofix.p <- vector()
for(i in 29:length(df.boxplot.pred)){
min(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Presence",
                   CV == "rnd")[,4]) -> min.PCNM_nofix.p[i]}

min.bioclimate.b <- vector()  
for(i in 29:length(df.boxplot.pred)){
min(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Background",
                   CV == "rnd")[,4]) -> min.bioclimate.b[i]}

min.bioclimate.p <- vector()  
for(i in 29:length(df.boxplot.pred)){
min(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Presence",
                   CV == "rnd")[,4]) -> min.bioclimate.p[i]}



mean(na.omit(min.bioclimate.b))
mean(na.omit(min.bioclimate.p))

mean(na.omit(min.PCNM.b))
mean(na.omit(min.PCNM.p))

mean(na.omit(min.PCNM_nofix.b))
mean(na.omit(min.PCNM_nofix.p))

# max

max.PCNM.b <- vector()
for(i in 29:length(df.boxplot.pred)){
max(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Background",
                   CV == "rnd")[,4]) -> max.PCNM.b[i]}

max.PCNM.p <- vector()
for(i in 29:length(df.boxplot.pred)){
max(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Presence",
                   CV == "rnd")[,4]) -> max.PCNM.p[i]}

max.PCNM_nofix.b <- vector()
for(i in 29:length(df.boxplot.pred)){
max(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Background",
                   CV == "rnd")[,4]) -> max.PCNM_nofix.b[i]}

max.PCNM_nofix.p <- vector()
for(i in 29:length(df.boxplot.pred)){
max(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Presence",
                   CV == "rnd")[,4]) -> max.PCNM_nofix.p[i]}

max.bioclimate.b <- vector()  
for(i in 29:length(df.boxplot.pred)){
max(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Background",
                   CV == "rnd")[,4]) -> max.bioclimate.b[i]}

max.bioclimate.p <- vector()  
for(i in 29:length(df.boxplot.pred)){
max(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Presence",
                   CV == "rnd")[,4]) -> max.bioclimate.p[i]}



mean(na.omit(max.bioclimate.b))
mean(na.omit(max.bioclimate.p))

mean(na.omit(max.PCNM.b))
mean(na.omit(max.PCNM.p))

mean(na.omit(max.PCNM_nofix.b))
mean(na.omit(max.PCNM_nofix.p))


```

spatial cv reptile 
```{r}
mean.PCNM.b <- vector()
for(i in 29:length(df.boxplot.pred)){
mean(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Background",
                   CV == "sp")[,4]) -> mean.PCNM.b[i]}

mean.PCNM.p <- vector()
for(i in 29:length(df.boxplot.pred)){
mean(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Presence",
                   CV == "sp")[,4]) -> mean.PCNM.p[i]}

mean.PCNM_nofix.b <- vector()
for(i in 29:length(df.boxplot.pred)){
mean(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Background",
                   CV == "sp")[,4]) -> mean.PCNM_nofix.b[i]}

mean.PCNM_nofix.p <- vector()
for(i in 29:length(df.boxplot.pred)){
mean(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Presence",
                   CV == "sp")[,4]) -> mean.PCNM_nofix.p[i]}

mean.bioclimate.b <- vector()  
for(i in 29:length(df.boxplot.pred)){
mean(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Background",
                   CV == "sp")[,4]) -> mean.bioclimate.b[i]}

mean.bioclimate.p <- vector()  
for(i in 29:length(df.boxplot.pred)){
mean(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Presence",
                   CV == "sp")[,4]) -> mean.bioclimate.p[i]}



mean(na.omit(mean.bioclimate.b))
mean(na.omit(mean.bioclimate.p))

mean(na.omit(mean.PCNM.b))
mean(na.omit(mean.PCNM.p))

mean(na.omit(mean.PCNM_nofix.b))
mean(na.omit(mean.PCNM_nofix.p))


#SD
sd.PCNM.b <- vector()
for(i in 29:length(df.boxplot.pred)){
sd(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Background",
                   CV == "sp")[,4]) -> sd.PCNM.b[i]}

sd.PCNM.p <- vector()
for(i in 29:length(df.boxplot.pred)){
sd(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Presence",
                   CV == "sp")[,4]) -> sd.PCNM.p[i]}

sd.PCNM_nofix.b <- vector()
for(i in 29:length(df.boxplot.pred)){
sd(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Background",
                   CV == "sp")[,4]) -> sd.PCNM_nofix.b[i]}

sd.PCNM_nofix.p <- vector()
for(i in 29:length(df.boxplot.pred)){
sd(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Presence",
                   CV == "sp")[,4]) -> sd.PCNM_nofix.p[i]}

sd.bioclimate.b <- vector()  
for(i in 29:length(df.boxplot.pred)){
sd(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Background",
                   CV == "sp")[,4]) -> sd.bioclimate.b[i]}

sd.bioclimate.p <- vector()  
for(i in 29:length(df.boxplot.pred)){
sd(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Presence",
                   CV == "sp")[,4]) -> sd.bioclimate.p[i]}



mean(na.omit(sd.bioclimate.b))
mean(na.omit(sd.bioclimate.p))

mean(na.omit(sd.PCNM.b))
mean(na.omit(sd.PCNM.p))

mean(na.omit(sd.PCNM_nofix.b))
mean(na.omit(sd.PCNM_nofix.p))

# median

median.PCNM.b <- vector()
for(i in 29:length(df.boxplot.pred)){
median(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Background",
                   CV == "sp")[,4]) -> median.PCNM.b[i]}

median.PCNM.p <- vector()
for(i in 29:length(df.boxplot.pred)){
median(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Presence",
                   CV == "sp")[,4]) -> median.PCNM.p[i]}

median.PCNM_nofix.b <- vector()
for(i in 29:length(df.boxplot.pred)){
median(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Background",
                   CV == "sp")[,4]) -> median.PCNM_nofix.b[i]}

median.PCNM_nofix.p <- vector()
for(i in 29:length(df.boxplot.pred)){
median(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Presence",
                   CV == "sp")[,4]) -> median.PCNM_nofix.p[i]}

median.bioclimate.b <- vector()  
for(i in 29:length(df.boxplot.pred)){
median(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Background",
                   CV == "sp")[,4]) -> median.bioclimate.b[i]}

median.bioclimate.p <- vector()  
for(i in 29:length(df.boxplot.pred)){
median(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Presence",
                   CV == "sp")[,4]) -> median.bioclimate.p[i]}



mean(na.omit(median.bioclimate.b))
mean(na.omit(median.bioclimate.p))

mean(na.omit(median.PCNM.b))
mean(na.omit(median.PCNM.p))

mean(na.omit(median.PCNM_nofix.b))
mean(na.omit(median.PCNM_nofix.p))

#min

min.PCNM.b <- vector()
for(i in 29:length(df.boxplot.pred)){
min(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Background",
                   CV == "sp")[,4]) -> min.PCNM.b[i]}

min.PCNM.p <- vector()
for(i in 29:length(df.boxplot.pred)){
min(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Presence",
                   CV == "sp")[,4]) -> min.PCNM.p[i]}

min.PCNM_nofix.b <- vector()
for(i in 29:length(df.boxplot.pred)){
min(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Background",
                   CV == "sp")[,4]) -> min.PCNM_nofix.b[i]}

min.PCNM_nofix.p <- vector()
for(i in 29:length(df.boxplot.pred)){
min(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Presence",
                   CV == "sp")[,4]) -> min.PCNM_nofix.p[i]}

min.bioclimate.b <- vector()  
for(i in 29:length(df.boxplot.pred)){
min(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Background",
                   CV == "sp")[,4]) -> min.bioclimate.b[i]}

min.bioclimate.p <- vector()  
for(i in 29:length(df.boxplot.pred)){
min(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Presence",
                   CV == "sp")[,4]) -> min.bioclimate.p[i]}



mean(na.omit(min.bioclimate.b))
mean(na.omit(min.bioclimate.p))

mean(na.omit(min.PCNM.b))
mean(na.omit(min.PCNM.p))

mean(na.omit(min.PCNM_nofix.b))
mean(na.omit(min.PCNM_nofix.p))

# max

max.PCNM.b <- vector()
for(i in 29:length(df.boxplot.pred)){
max(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Background",
                   CV == "sp")[,4]) -> max.PCNM.b[i]}

max.PCNM.p <- vector()
for(i in 29:length(df.boxplot.pred)){
max(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM", 
                   data.type == "PCNM Presence",
                   CV == "sp")[,4]) -> max.PCNM.p[i]}

max.PCNM_nofix.b <- vector()
for(i in 29:length(df.boxplot.pred)){
max(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Background",
                   CV == "sp")[,4]) -> max.PCNM_nofix.b[i]}

max.PCNM_nofix.p <- vector()
for(i in 29:length(df.boxplot.pred)){
max(dplyr::filter(df.boxplot.pred[[i]], 
                   var.type == "PCNM nofix",
                   data.type == "PCNM.nofix Presence",
                   CV == "sp")[,4]) -> max.PCNM_nofix.p[i]}

max.bioclimate.b <- vector()  
for(i in 29:length(df.boxplot.pred)){
max(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Background",
                   CV == "sp")[,4]) -> max.bioclimate.b[i]}

max.bioclimate.p <- vector()  
for(i in 29:length(df.boxplot.pred)){
max(dplyr::filter(df.boxplot.pred[[i]],
                   var.type == "Bioclimate",
                   data.type == "Bioclimate Presence",
                   CV == "sp")[,4]) -> max.bioclimate.p[i]}



mean(na.omit(max.bioclimate.b))
mean(na.omit(max.bioclimate.p))

mean(na.omit(max.PCNM.b))
mean(na.omit(max.PCNM.p))

mean(na.omit(max.PCNM_nofix.b))
mean(na.omit(max.PCNM_nofix.p))


```



```{r plot.diff.pred}

for(i in 1:length(raw_rndcv4k.pcnm_reptile)){
print(length(raw_rndcv4k.pcnm_reptile[[i]][[2]]) - length(raw_rndcv4k.bio_reptile[[i]][[2]]))}


df.diff.pred_reptile <- list()
for(i in 29:length(raw_rndcv4k.pcnm_reptile)){
  df.diff.pred_reptile[[i]] <- rbind(data.frame(diff = raw_rndcv4k.pcnm_reptile[[i]][[2]] - raw_rndcv4k.bio_reptile[[i]][[2]],
                                                cv = "rnd"),
                                     data.frame(diff = raw_spcv4k.pcnm_reptile[[i]][[2]] - raw_spcv4k.bio_reptile[[i]][[2]],
                                                cv = "sp"))}
plot.diff.pred_reptile <- list()
for(i in 1:length(df.diff.pred_reptile)){
  plot.diff.pred_reptile[[i]] <- 
    ggplot(df.diff.pred_reptile[[i]], aes(x = diff, color = cv)) + 
    geom_histogram(fill = "white", alpha = 0.5)
}
    

  
  


```









```{r my.plotResponse}
my.plotResponse <- function (model, var, type = NULL, only_presence = FALSE, marginal = FALSE, 
  fun = mean, rug = FALSE, color = "red") 
{
  if (!var %in% names(model@data@data)) 
    stop(paste(var, "is not used to train the model!"))
  p <- .get_presence(model@data)
  a <- .get_absence(model@data)
  if (only_presence) {
    df <- p
  }
  else {
    df <- model@data@data
  }
  cont_vars <- names(Filter(is.numeric, p))
  cat_vars <- names(Filter(is.factor, p))
  if (var %in% cat_vars) {
    categ <- unique(as.numeric(levels(df[, var]))[df[, var]])
    n_rows <- length(categ)
  }
  else {
    n_rows <- 509
  }
  p_rug <- data.frame(x = p[, var])
  a_rug <- data.frame(x = a[, var])
  if (class(model) == "SDMmodel") {
    plot_data <- .get_plot_data(model, var, df, cont_vars, 
      cat_vars, n_rows, fun, marginal, type, categ)
    if (var %in% cont_vars) {
      my_plot <- ggplot(plot_data, aes(x = .data$x, y = .data$y)) + 
        ggplot2::geom_line(colour = color)
    }
    else {
      my_plot <- ggplot(plot_data, aes(x = .data$x, y = .data$y)) + 
        ggplot2::geom_bar(stat = "identity", fill = color) + 
        ggplot2::scale_x_continuous(breaks = seq(min(plot_data$x), 
          max(plot_data$x), 1))
    }
  }
  else {
    nf <- length(model@models)
    plot_data <- .get_plot_data(model@models[[1]], var, 
      df, cont_vars, cat_vars, n_rows, fun, marginal, 
      type, categ)
    colnames(plot_data) <- c("x", "y_1")
    for (i in 2:nf) plot_data[paste0("y_", i)] <- .get_plot_data(model@models[[i]], 
      var, df, cont_vars, cat_vars, n_rows, fun, marginal, 
      type, categ)$y
    plot_data$y <- rowMeans(plot_data[, -1])
    plot_data$sd <- apply(plot_data[, 2:(nf + 1)], 1, sd, 
      na.rm = TRUE)
    plot_data$y_min <- plot_data$y - plot_data$sd
    plot_data$y_max <- plot_data$y + plot_data$sd
    if (var %in% cont_vars) {
      my_plot <- ggplot(plot_data, aes(x = .data$x, y = .data$y, 
        ymin = .data$y_min, ymax = .data$y_max)) + ggplot2::geom_line(colour = color) + 
        ggplot2::geom_ribbon(fill = color, alpha = 0.2)
    }
    else {
      my_plot <- ggplot(plot_data, aes(x = .data$x, y = .data$y)) + 
        ggplot2::geom_bar(stat = "identity", fill = color) + 
        ggplot2::geom_errorbar(aes(ymin = .data$y_min, 
          ymax = .data$y_max), width = 0.2, size = 0.3) + 
        ggplot2::scale_x_continuous(breaks = seq(min(plot_data$x), 
          max(plot_data$x), 1))
    }
  }
  my_plot <- my_plot + ggplot2::labs(x = var, y = ifelse(!is.null(type), 
    paste(type, "output"), "Probability of presence")) + 
    ggplot2::theme_minimal() + ggplot2::theme(text = ggplot2::element_text(colour = "#666666"))
  if (rug == TRUE & var %in% cont_vars) {
    my_plot <- my_plot + ggplot2::geom_rug(data = p_rug, 
      inherit.aes = FALSE, aes(.data$x), sides = "t", 
      color = "#4C4C4C") + ggplot2::geom_rug(data = a_rug, 
      inherit.aes = FALSE, aes(.data$x), sides = "b", 
      color = "#4C4C4C")
  }
  return(my_plot)
}

.get_presence <- function (swd)
{
  return(swd@data[swd@pa == 1, , drop = FALSE])
}

.get_absence <- function (swd) 
{
  return(swd@data[swd@pa == 0, , drop = FALSE])
}

.get_plot_data <- function (model, var, df, cont_vars, cat_vars, n_rows, fun, 
  marginal, type, categ) 
{
  data <- data.frame(matrix(NA, nrow = 1, ncol = ncol(df)))
  colnames(data) <- colnames(df)
  data[cont_vars] <- apply(df[cont_vars], 2, fun)
  data[cat_vars] <- as.factor(apply(df[cat_vars], 2, raster::modal))
  data <- do.call("rbind", replicate(n_rows, data, simplify = FALSE))
  if (var %in% cont_vars) {
    var_min <- min(model@data@data[var])
    var_max <- max(model@data@data[var])
    data[var] <- seq(var_min, var_max, length.out = n_rows)
  }
  else {
    data[var] <- categ
  }
  if (!marginal) {
    new_data <- model@data
    new_data@data <- new_data@data[, var, drop = FALSE]
    settings <- list(data = new_data)
    model <- .create_model_from_settings(model, settings)
  }
  pred <- predict(model, data, type = type)
  plot_data <- data.frame(x = data[, var], y = pred)
  return(plot_data)
}

.create_model_from_settings <- function (model, settings, verbose = FALSE) 
{
  args <- .get_train_args(model)
  args[names(settings)] <- settings
  args$verbose <- verbose
  output <- suppressMessages(do.call("train", args))
  return(output)
}

.get_train_args <- function (model) 
{
  args <- list(data = model@data)
  if (class(model) == "SDMmodelCV") {
    args$folds <- model@folds
    model <- model@models[[1]]@model
  }
  else {
    args$folds <- NULL
    model <- model@model
  }
  args$method <- class(model)
  if (args$method == "Maxent") {
    args$fc <- model@fc
    args$reg <- model@reg
    args$iter <- model@iter
  }
  else if (args$method == "Maxnet") {
    args$fc <- model@fc
    args$reg <- model@reg
  }
  else if (args$method == "ANN") {
    args$size <- model@size
    args$decay <- model@decay
    args$rang <- model@rang
    args$maxit <- model@maxit
  }
  else if (args$method == "RF") {
    args$mtry <- model@mtry
    args$ntree <- model@ntree
    args$nodesize <- model@nodesize
  }
  else {
    args$distribution <- model@distribution
    args$n.trees <- model@n.trees
    args$interaction.depth <- model@interaction.depth
    args$shrinkage <- model@shrinkage
    args$bag.fraction <- model@bag.fraction
  }
  return(args)
}


```

# Endgame

```{r}
library(tidyverse)
library(SDMtune)
library(blockCV)
library(ENMeval)
library(raster)
library(sf)
library(sp)
library(zeallot)
library(rJava)
library(dismo)
library(vegan)
```
```{r}
library(furrr)
future::plan(multisession, workers = 32)
memory.limit(9999999999)
```

```{r}

names.data.reptile <- vector()
for(i in 1:length(data.reptile)){
names.data.reptile[i] <- data.reptile[[i]]@species  
}
names.data.amphibian <- vector()
for(i in 1:length(data.amphibian)){
names.data.amphibian[i] <- data.amphibian[[i]]@species  
}




data.all <- rbind(data.frame(species = names.data.pcnm.reptile,
                             p.long = data.pcnm.reptile))
```



















load PCNM model
```{r}

data.pcnm.reptile






df.model.p <- list()
for(i in 1:length(data.pcnm.reptile)){
df.model.p[[i]] <- cbind(data.pcnm.reptile[[i]]@coords[data.pcnm.reptile[[i]]@pa == 1,],
                         data.pcnm.reptile[[i]]@data[data.pcnm.reptile[[i]]@pa == 1,])
}

df.model.a <- list()
for(i in 1:length(data.pcnm.reptile)){
df.model.a[[i]] <- cbind(data.pcnm.reptile[[i]]@coords[data.pcnm.reptile[[i]]@pa == 0,],
                         data.pcnm.reptile[[i]]@data[data.pcnm.reptile[[i]]@pa == 0,])
}

df.model.p <- list()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
df.model.p[[i]] <- cbind(model_spcv4k.pcnm_reptile[[i]]@data@coords[model_spcv4k.pcnm_reptile[[i]]@data@pa == 1,],
                         model_spcv4k.pcnm_reptile[[i]]@data@data[model_spcv4k.pcnm_reptile[[i]]@data@pa == 1,])
}

df.model.a <- list()
for(i in 1:length(model_spcv4k.pcnm_reptile)){
df.model.a[[i]] <- cbind(model_spcv4k.pcnm_reptile[[i]]@data@coords[model_spcv4k.pcnm_reptile[[i]]@data@pa == 0,],
                         model_spcv4k.pcnm_reptile[[i]]@data@data[model_spcv4k.pcnm_reptile[[i]]@data@pa == 0,])
}


df.model.p <- list()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
df.model.p[[i]] <- cbind(model_rndcv4k.pcnm_amphibian[[i]]@data@coords[model_rndcv4k.pcnm_amphibian[[i]]@data@pa == 1,],
                         model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@data@pa == 1,])
}

df.model.a <- list()
for(i in 1:length(model_rndcv4k.pcnm_amphibian)){
df.model.a[[i]] <- cbind(model_rndcv4k.pcnm_amphibian[[i]]@data@coords[model_rndcv4k.pcnm_amphibian[[i]]@data@pa == 0,],
                         model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@data@pa == 0,])
}

df.model.p <- list()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
df.model.p[[i]] <- cbind(model_spcv4k.pcnm_amphibian[[i]]@data@coords[model_spcv4k.pcnm_amphibian[[i]]@data@pa == 1,],
                         model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@data@pa == 1,])
}

df.model.a <- list()
for(i in 1:length(model_spcv4k.pcnm_amphibian)){
df.model.a[[i]] <- cbind(model_spcv4k.pcnm_amphibian[[i]]@data@coords[model_spcv4k.pcnm_amphibian[[i]]@data@pa == 0,],
                         model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@data@pa == 0,])
}












sf.model.p  <- list()
for(i in 1:length(df.model.p)){
sf.model.p[[i]] <- st_as_sf(df.model.p[[i]],
                            coords = c("X", "Y"), 
                            crs = 4326,
                            remove = F)
}

sf.model.a  <- list()
for(i in 1:length(df.model.a)){
sf.model.a[[i]] <-  st_as_sf(df.model.a[[i]],
                            coords = c("X", "Y"), 
                            crs = 4326,
                            remove = F)
}



for(i in 1:length(sf.model.p)){
st_join(sf.model.p[[i]], 
        sf.model.a[[i]], 
 join = st_nearest_feature) -> sf.model.p[[i]]}



for(i in 1:length(sf.model.p)){
  sf.model.p[[i]] <- sf.model.p[[i]][,-(8:28)] #get pcnm variables only from background 
}

for(i in 1:length(sf.model.p)){
names(sf.model.p[[i]])[-22] <- str_sub(names(sf.model.p[[i]]), 1,-3)[-22]} #fix names

for( i in 1:length(sf.model.p)){#erase geometry
  st_geometry(sf.model.p[[i]]) <- NULL
}



for(i in 1:length(sf.model.p)){
  data.pcnm.reptile[[i]]@coords <- sf.model.p[[i]][,c("X","Y")]
  data.pcnm.reptile[[i]]@data[data.pcnm.reptile[[i]]@pa==1,] <- sf.model.p[[i]][,3:21]
}





t.t.pcnm.reptile_0.2 <- list()
for (i in 1:length(data.pcnm.reptile)){t.t.pcnm.reptile_0.2[[i]] <- trainValTest(data.pcnm.reptile[[i]], test = 0.2, only_presence = FALSE, seed = 1)}

rnd4k <- function(x){randomFolds(x[[1]], 
                                 k = 4,
                                 only_presence = FALSE,
                                 seed = 1)}

folds.rnd4k_reptile <- map(t.t.pcnm.reptile_0.2, rnd4k)

```

```{r}

my.maxent <- function(x,y){
  SDMtune::train(method = "Maxent",
                 data = x[[1]],
                 folds = y)
}

my.maxnet <- function(x,y){
  SDMtune::train(method = "Maxnet",
                 data = x[[1]],
                 folds = y)
}


maxent_rndcv4k.pcnm_reptile <- future_map2(t.t.pcnm.reptile_0.2, folds.rnd4k_reptile,
                                    my.maxent, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)


maxnet_rndcv4k.pcnm_reptile <- future_map2(t.t.pcnm.reptile_0.2, folds.rnd4k_reptile,
                                    my.maxnet, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

```


```{r}





for(i in 1:length(sf.model.p)){
  model_rndcv4k.pcnm_reptile[[i]]@data@coords <- sf.model.p[[i]][,c("X","Y")]
  model_rndcv4k.pcnm_reptile[[i]]@data@data[model_rndcv4k.pcnm_reptile[[i]]@data@pa==1,] <- sf.model.p[[i]][,3:21]
}

for(i in 1:length(sf.model.p)){
  model_spcv4k.pcnm_reptile[[i]]@data@coords <- sf.model.p[[i]][,c("X","Y")]
  model_spcv4k.pcnm_reptile[[i]]@data@data[model_spcv4k.pcnm_reptile[[i]]@data@pa==1,] <- sf.model.p[[i]][,3:21]
  }

for(i in 1:length(sf.model.p)){
  model_rndcv4k.pcnm_amphibian[[i]]@data@coords <- sf.model.p[[i]][,c("X","Y")]
  model_rndcv4k.pcnm_amphibian[[i]]@data@data[model_rndcv4k.pcnm_amphibian[[i]]@data@pa==1,] <- sf.model.p[[i]][,3:21]
}

for(i in 1:length(sf.model.p)){
  model_spcv4k.pcnm_amphibian[[i]]@data@coords <- sf.model.p[[i]][,c("X","Y")]
  model_spcv4k.pcnm_amphibian[[i]]@data@data[model_spcv4k.pcnm_amphibian[[i]]@data@pa==1,] <- sf.model.p[[i]][,3:21]
  }




model_rndcv4k.pcnm_reptile <- future_map(model_rndcv4k.pcnm_reptile,
                                    my.maxent, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

model_spcv4k.pcnm_reptile <- future_map(model_spcv4k.pcnm_reptile,
                                    my.maxent, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

model_rndcv4k.pcnm_amphibian <- future_map(model_rndcv4k.pcnm_amphibian,
                                    my.maxent, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

model_spcv4k.pcnm_amphibian <- future_map(model_spcv4k.pcnm_amphibian,
                                    my.maxent, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

model_spcv4k.pcnm_amphibian <- future_map(model_spcv4k.pcnm_amphibian, #omitted rror...
                                    my.maxnet, 
                                    .options = furrr_options(seed = TRUE),
                                    .progress = T)

```



```{r}
test_rndcv4k.pcnm.maxent_reptile <- list()
for(i in 1:length(maxent_rndcv4k.pcnm_reptile)){
test_rndcv4k.pcnm.maxent_reptile[[i]] <- list(SDMtune::predict(maxent_rndcv4k.pcnm_reptile[[i]], 
                                                  t.t.pcnm.reptile_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(maxent_rndcv4k.pcnm_reptile[[i]],
                                 t.t.pcnm.reptile_0.2[[i]][[2]]@data[t.t.pcnm.reptile_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))}



test_rndcv4k.pcnm.maxnet_reptile <- list()
for(i in 1:length(maxnet_rndcv4k.pcnm_reptile)){
test_rndcv4k.pcnm.maxnet_reptile[[i]] <- list(SDMtune::predict(maxnet_rndcv4k.pcnm_reptile[[i]], 
                                                  t.t.pcnm.reptile_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(maxnet_rndcv4k.pcnm_reptile[[i]],
                                 t.t.pcnm.reptile_0.2[[i]][[2]]@data[t.t.pcnm.reptile_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog"))}
```




```{r}
hist(test_rndcv4k.pcnm.maxent_reptile[[1]][[2]], 25)
hist(test_rndcv4k.pcnm.maxnet_reptile[[1]][[2]], 10)
```
```{r}
which(test_rndcv4k.pcnm.maxent_reptile[[1]][[2]] == test_rndcv4k.pcnm.maxnet_reptile[[1]][[2]])
```
```{r}
sd(test_rndcv4k.pcnm.maxent_reptile[[1]][[2]] - test_rndcv4k.pcnm.maxnet_reptile[[1]][[2]])
```



```{r}
AUC_rnd.train.bio.reptile<- vector()
for(i in 1:length(model_rndcv4k.bio_reptile)){
AUC_rnd.train.bio.reptile[i] <- SDMtune::auc(model = model_rndcv4k.bio_reptile[[i]])
}

AUC_rnd.train.bio.amphibian<- vector()
for(i in 1:length(model_rndcv4k.bio_amphibian)){
AUC_rnd.train.bio.amphibian[i] <- SDMtune::auc(model = model_rndcv4k.bio_amphibian[[i]])
}

AUC_sp.train.bio.reptile<- vector()
for(i in 1:length(model_spcv4k.bio_reptile)){
AUC_sp.train.bio.reptile[i] <- SDMtune::auc(model = model_spcv4k.bio_reptile[[i]])
}

AUC_sp.train.bio.amphibian<- vector()
for(i in 1:length(model_spcv4k.bio_amphibian)){
AUC_sp.train.bio.amphibian[i] <- SDMtune::auc(model = model_spcv4k.bio_amphibian[[i]])
}

which(AUC_rnd.train.bio.reptile < AUC_rnd.train.pcnm.reptile)
```



```{r}

auc  <- vector()
for(i in 1:length(newmodel)){
auc[i] <- SDMtune::auc(newmodel[[i]])
}

auc2  <- vector()
for(i in 1:length(newmodel)){
auc2[i] <- SDMtune::auc(newmodel[[i]], t.t.pcnm.reptile_0.2[[i]][[2]])
}

auc3  <- vector()
for(i in 1:length(newmodel2)){
auc3[i] <- SDMtune::auc(newmodel2[[i]])
}

auc2  <- vector()
for(i in 1:length(newmodel)){
auc2[i] <- SDMtune::auc(newmodel[[i]], t.t.pcnm.reptile_0.2[[i]][[2]])
}


df <- data.frame(auc = auc,
                 auc2 = auc2)

ggplot(data = df) +
      geom_point(aes(x = auc, y = auc2), size = 1) +
      geom_abline(intercept = 0, slope = 1, size = 0.5) +
      labs(title = "Boyce P/E plot(Amphibian)",
           y = "출현/기대 비율",
           x = "서식처 적합도",
           size = 15) +
      theme_light() +
      theme(strip.text.x = element_text(size = 9, colour = "black"),
        strip.background = element_rect(colour="gray",
                                        fill="white")) -> plot


test_rndcv4k.pcnm_reptile <- list()
for(i in 1:length(model_rndcv4k.pcnm_reptile)){
test_rndcv4k.pcnm_reptile[[i]] <- list(SDMtune::predict(model_rndcv4k.pcnm_reptile[[i]], 
                                                  t.t.pcnm.reptile_0.2[[i]][[2]],
                                                  fun = "mean",
                                                  type = "cloglog"),
                                 SDMtune::predict(model_rndcv4k.pcnm_reptile[[i]],
                                 t.t.pcnm.reptile_0.2[[i]][[2]]@data[t.t.pcnm.reptile_0.2[[i]][[2]]@pa == 1,],
                                                   fun = "mean",
                                                   type = "cloglog")
                                )} #전부다는 [[1]]에, 출현은 [[2]]에


boyce.test.rnd.pcnm_reptile <- list()
for(i in 1:length(test_rndcv4k.pcnm_reptile)){
boyce.test.rnd.pcnm_reptile[[i]] <- my.boyce(test_rndcv4k.pcnm_reptile[[i]][[1]], test_rndcv4k.pcnm_reptile[[i]][[2]])  
}

BOYCE_rnd.test.pcnm.reptile <- vector()
for(i in 1:length(boyce.test.rnd.pcnm_reptile)){
 BOYCE_rnd.test.pcnm.reptile[i] <- boyce.test.rnd.pcnm_reptile[[i]]$Spearman.cor  
}

```





